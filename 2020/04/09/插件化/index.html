<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="魏超,weichao,android" />








  <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico?v=5.1.1" />






<meta name="description" content="ClassLoader 加载 dex 文件继承关系  BootClassLoader：加载 Android Framework 层的 class 文件。 PathClassLoader：加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。 DexClassLoader：加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。  ClassLoader 加载 Clas">
<meta property="og:type" content="article">
<meta property="og:title" content="插件化">
<meta property="og:url" content="http://www.weichao.io/2020/04/09/插件化/index.html">
<meta property="og:site_name" content="『魏超』的 blog">
<meta property="og:description" content="ClassLoader 加载 dex 文件继承关系  BootClassLoader：加载 Android Framework 层的 class 文件。 PathClassLoader：加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。 DexClassLoader：加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。  ClassLoader 加载 Clas">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004091.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004092.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004093.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004094.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004095.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004096.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004097.png">
<meta property="og:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004098.png">
<meta property="og:updated_time" content="2020-04-09T10:17:59.346Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="插件化">
<meta name="twitter:description" content="ClassLoader 加载 dex 文件继承关系  BootClassLoader：加载 Android Framework 层的 class 文件。 PathClassLoader：加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。 DexClassLoader：加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。  ClassLoader 加载 Clas">
<meta name="twitter:image" content="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004091.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://www.weichao.io/2020/04/09/插件化/"/>





  <title>插件化 | 『魏超』的 blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  














</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail ">
    <div class="headband"></div>
	
	<img style="position: absolute; top: 0; right: 0; border: 0;" src="/images/wanted.png">

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">『魏超』的 blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://www.weichao.io/2020/04/09/插件化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="魏超">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="『魏超』的 blog">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">插件化</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-04-09T18:00:52+08:00">
                2020-04-09
              </time>
            

            

            
          </span>

          

          
            
          

          

          
            <div class="post-wordcount">
              
                
                  <span class="post-meta-divider">|</span>
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计</span>
                
                <span title="字数统计">
                  3,048 字
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长</span>
                
                <span title="阅读时长">
                  15 分钟
                </span>
              
            </div>
          

          
          
             <span id="/2020/04/09/插件化/" class="leancloud_visitors" data-flag-title="插件化">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               
                 <span class="post-meta-item-text">热度 </span>
               
                 <span class="leancloud-visitors-count"></span>
				 <span> ℃</span>
             </span>
          

          

        </div>
      </header>
    

    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="ClassLoader-加载-dex-文件"><a href="#ClassLoader-加载-dex-文件" class="headerlink" title="ClassLoader 加载 dex 文件"></a><strong>ClassLoader 加载 dex 文件</strong></h1><h2 id="继承关系"><a href="#继承关系" class="headerlink" title="继承关系"></a><strong>继承关系</strong></h2><p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004091.png" alt=""></p>
<blockquote>
<p>BootClassLoader：<br>加载 Android Framework 层的 class 文件。</p>
<p>PathClassLoader：<br>加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。</p>
<p>DexClassLoader：<br>加载 dex 文件，包括 jar、zip、apk 中的 dex 文件。</p>
</blockquote>
<h2 id="ClassLoader-加载-Class-的流程"><a href="#ClassLoader-加载-Class-的流程" class="headerlink" title="ClassLoader 加载 Class 的流程"></a><strong>ClassLoader 加载 Class 的流程</strong></h2><p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004092.png" alt=""></p>
<blockquote>
<p>双亲委托机制：<br>首先检测这个类是否已经被加载了，如果已经加载了，直接获取并返回。如果没有被加载，当 parent 不为 null 时，调用 parent 的 loadClass() 进行加载；当 parent 为 null 时，调用 findClass() 方法，依次递归，如果找到了或者加载了就返回，如果既没找到也加载不了，才自己去加载。</p>
</blockquote>
<p>BootClassLoader#findClass() 是直接调用了 Class.classForName() 方法；<br>DexClassLoader#findClass() 是加载传入的 APK 文件中的所有 dexFile 到 dexElements 数组，然后再调用 Element#findClass() 查找 dexFile 中是否包含指定的 class。</p>
<hr>
<h1 id="执行插件中的方法"><a href="#执行插件中的方法" class="headerlink" title="执行插件中的方法"></a><strong>执行插件中的方法</strong></h1><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a><strong>原理</strong></h2><p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004093.png" alt=""></p>
<p>1、创建插件的 DexClassLoader 类加载器，然后通过反射获取插件的 dexElements 值；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">DexClassLoader</div><div class="line">----dexElements[]</div></pre></td></tr></table></figure></p>
<p>2、获取宿主的 PathClassLoader 类加载器，然后通过反射获取宿主的 dexElements 值；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BaseDexClassLoader</div><div class="line">----pathList</div><div class="line">--------dexElements[]</div></pre></td></tr></table></figure></p>
<p>3、合并宿主的 dexElements 与插件的 dexElements，生成新的 Element[]；<br>4、最后通过反射将新的 Element[] 赋值给宿主的 dexElements。</p>
<h2 id="核心代码"><a href="#核心代码" class="headerlink" title="核心代码"></a><strong>核心代码</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">loadPluginDex</span><span class="params">(String apkPath)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        <span class="comment">// 1.获取 pathList 的字段</span></div><div class="line">        Class baseDexClassLoader = Class.forName(<span class="string">"dalvik.system.BaseDexClassLoader"</span>);</div><div class="line">        Field pathListField = baseDexClassLoader.getDeclaredField(<span class="string">"pathList"</span>);</div><div class="line">        pathListField.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 2.获取 DexClassLoader 类中的属性 pathList 的值</span></div><div class="line">        DexClassLoader dexClassLoader = <span class="keyword">new</span> DexClassLoader(apkPath, getCacheDir().getAbsolutePath(), <span class="keyword">null</span>, getClassLoader());</div><div class="line">        Object pluginPathList = pathListField.get(dexClassLoader);</div><div class="line"></div><div class="line">        <span class="comment">// 3.获取 pathList 中的属性 dexElements[] 的值--- 插件的 dexElements[]</span></div><div class="line">        Class pluginPathListClass = pluginPathList.getClass();</div><div class="line">        Field pluginDexElementsField = pluginPathListClass.getDeclaredField(<span class="string">"dexElements"</span>);</div><div class="line">        pluginDexElementsField.setAccessible(<span class="keyword">true</span>);</div><div class="line">        Object[] pluginDexElements = (Object[]) pluginDexElementsField.get(pluginPathList);</div><div class="line"></div><div class="line">        <span class="comment">// 4.获取 PathClassLoader 类中的属性 pathList 的值</span></div><div class="line">        PathClassLoader pathClassLoader = (PathClassLoader) getClassLoader();</div><div class="line">        Object hostPathList = pathListField.get(pathClassLoader);</div><div class="line"></div><div class="line">        <span class="comment">// 5.获取 pathList 中的属性 dexElements[] 的值--- 宿主的 dexElements[]</span></div><div class="line">        Class hostPathListClass = hostPathList.getClass();</div><div class="line">        Field hostDexElementsField = hostPathListClass.getDeclaredField(<span class="string">"dexElements"</span>);</div><div class="line">        hostDexElementsField.setAccessible(<span class="keyword">true</span>);</div><div class="line">        Object[] hostDexElements = (Object[]) hostDexElementsField.get(hostPathList);</div><div class="line"></div><div class="line">        <span class="comment">// 6.创建一个新的空数组，第一个参数是数组的类型，第二个参数是数组的长度</span></div><div class="line">        Object[] dexElements = (Object[]) Array.newInstance(hostDexElements.getClass().getComponentType(), pluginDexElements.length + hostDexElements.length);</div><div class="line"></div><div class="line">        <span class="comment">// 7.将插件和宿主的 dexElements[] 的值放入新的数组中</span></div><div class="line">        System.arraycopy(pluginDexElements, <span class="number">0</span>, dexElements, <span class="number">0</span>, pluginDexElements.length);</div><div class="line">        System.arraycopy(hostDexElements, <span class="number">0</span>, dexElements, pluginDexElements.length, hostDexElements.length);</div><div class="line"></div><div class="line">        hostDexElementsField.set(hostPathList, dexElements);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> String <span class="title">loadPluginMethod</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class&lt;?&gt; threadClazz = Class.forName(<span class="string">"io.weichao.plugin.util.PluginUtil"</span>);</div><div class="line">        Method method = threadClazz.getMethod(<span class="string">"getMessage"</span>);</div><div class="line">        <span class="keyword">return</span> (String) method.invoke(<span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h1 id="启动插件中的-Activity"><a href="#启动插件中的-Activity" class="headerlink" title="启动插件中的 Activity"></a><strong>启动插件中的 Activity</strong></h1><h2 id="关键难点——无法通过-AMS-检测"><a href="#关键难点——无法通过-AMS-检测" class="headerlink" title="关键难点——无法通过 AMS 检测"></a><strong>关键难点——无法通过 AMS 检测</strong></h2><p>插件的 Activity 没有在宿主的清单文件中注册。</p>
<h3 id="启动-Activity-流程"><a href="#启动-Activity-流程" class="headerlink" title="启动 Activity 流程"></a><strong>启动 Activity 流程</strong></h3><p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004094.png" alt=""></p>
<h2 id="绕过-AMS-检测——hook"><a href="#绕过-AMS-检测——hook" class="headerlink" title="绕过 AMS 检测——hook"></a><strong>绕过 AMS 检测——hook</strong></h2><blockquote>
<p>hook：<br>劫持，改变代码的正常执行流程。</p>
</blockquote>
<p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004095.png" alt=""></p>
<p>1、在宿主中创建一个 ProxyActivity 继承自 Activity，并且在 manifest 中注册；<br>2、当启动插件的 Activity 时，在 AMS 检测前，找到一个 hook 点，然后通过 hook 将启动插件 Activity 的 Intent 替换成启动 ProxyActivity 的 Intent；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// API 26、28</span></div><div class="line">Activity#startActivity()</div><div class="line">----startActivityForResult()</div><div class="line">Instrumentation#execStartActivity()</div><div class="line">----ActivityManager.getService().startActivity(..., intent, ...) <span class="comment">// ActivityManager.getService() 是 AMS 检测前的最后的 hook 机会，ActivityManager.getService() 的返回值是 IActivityManager，所以需要对 IActivityManager 进行动态代理，hook IActivityManager#startActivity()</span></div><div class="line"></div><div class="line"><span class="comment">// 1. IActivityManager 可使用 IActivityManagerSingleton 获取</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> IActivityManager <span class="title">getService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> IActivityManagerSingleton.get();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 2. IActivityManagerSingleton 在 ActivityManager 中是 static，反射时容易获取</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; IActivityManagerSingleton = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">final</span> IBinder b = ServiceManager.getService(Context.ACTIVITY_SERVICE);</div><div class="line">        <span class="keyword">final</span> IActivityManager am = IActivityManager.Stub.asInterface(b);</div><div class="line">        <span class="keyword">return</span> am;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 3. IActivityManager 在 Singleton 中以变量 mInstance 存在</span></div><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">private</span> T mInstance;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> T <span class="title">create</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> T <span class="title">get</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (mInstance == <span class="keyword">null</span>) &#123;</div><div class="line">                mInstance = create();</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> mInstance;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 总结：反射获取 ActivityManager 中的 IActivityManagerSingleton，再获取 IActivityManagerSingleton 中的 mInstance，这个 mInstance 本质是 IActivityManager，对其进行动态代理</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// API 23、24、25</span></div><div class="line">Activity#startActivity()</div><div class="line">----startActivityForResult()</div><div class="line">Instrumentation#execStartActivity()</div><div class="line">----ActivityManagerNative.getDefault().startActivity(..., intent, ...) <span class="comment">// API 23 不同点，ActivityManagerNative.getDefault() 返回值是 IActivityManager，所以还是动态代理 IActivityManager，但是获取 IActivityManager 的方法不一样</span></div><div class="line"></div><div class="line"><span class="comment">// 1. IActivityManager 可使用 gDefault 获取：</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">public</span> IActivityManager <span class="title">getDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> gDefault.get();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 2. gDefault 在 ActivityManagerNative 中是 static，反射时容易获取</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Singleton&lt;IActivityManager&gt; gDefault = <span class="keyword">new</span> Singleton&lt;IActivityManager&gt;() &#123;</div><div class="line">    <span class="function"><span class="keyword">protected</span> IActivityManager <span class="title">create</span><span class="params">()</span> </span>&#123;</div><div class="line">        IBinder b = ServiceManager.getService(<span class="string">"activity"</span>);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service binder = "</span> + b);</div><div class="line">        &#125;</div><div class="line">        IActivityManager am = asInterface(b);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">false</span>) &#123;</div><div class="line">            Log.v(<span class="string">"ActivityManager"</span>, <span class="string">"default service = "</span> + am);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> am;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 3. IActivityManager 在 Singleton 中以变量 mInstance 存在，和前面一样</span></div><div class="line"></div><div class="line"><span class="comment">// 总结：反射获取 ActivityManagerNative 中的 gDefault，再获取 gDefault 中的 mInstance，这个 mInstance 本质是 IActivityManager，对其进行动态代理</span></div></pre></td></tr></table></figure></p>
<p>3、在 AMS 检测完后，找到一个 hook 点，然后通过 hook 将启动 ProxyActivity 的 Intent 替换成启动插件 Activity 的 Intent；<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// API 26 及以前</span></div><div class="line">ActivityStackSupervisor#realStartActivityLocked()</div><div class="line">ActivityThread#scheduleLaunchActivity(intent, ...)</div><div class="line">----sendMessage(H.LAUNCH_ACTIVITY, r) <span class="comment">// r 含 Intent</span></div><div class="line">Handler#dispatchMessage(msg) // msg.obj = r</div><div class="line">----callback(msg)</div><div class="line">Callback</div><div class="line">----mCallback <span class="comment">// 劫持 mCallback，修改 Intent</span></div><div class="line"></div><div class="line"><span class="comment">// 1. Handler 在 ActivityThread 中以 mH 存在，所以需要先拿到 ActivityThread</span></div><div class="line"><span class="keyword">final</span> H mH = <span class="keyword">new</span> H();</div><div class="line"></div><div class="line"><span class="comment">// 2. ActivityThread 中存在 sCurrentActivityThread，且是 static，反射时容易获取</span></div><div class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> ActivityThread sCurrentActivityThread;</div><div class="line"></div><div class="line"><span class="comment">// 3. 拿到 mH 以后，给 mH 设置新的 Callback，重写其 handleMessage()，将 msg.obj 中的 Intent 改为插件的 Intent</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// API 28</span></div><div class="line">ActivityStackSupervisor#realStartActivityLocked()</div><div class="line">clientTransaction.addCallback(LaunchActivityItem.obtain(<span class="keyword">new</span> Intent(r.intent), ...) <span class="comment">// API 28 不同点</span></div><div class="line">ClientTransaction</div><div class="line">----List&lt;ClientTransactionItem&gt; <span class="comment">// 包含 Intent</span></div><div class="line">mService.getLifecycleManager().scheduleTransaction(clientTransaction)</div><div class="line">ActivityThread#scheduleLaunchActivity(clientTransaction)</div><div class="line">----sendMessage(ActivityThread.H.EXECUTE_TRANSACTION, clientTransaction) <span class="comment">// API 28 不同点</span></div><div class="line">Handler#dispatchMessage(msg) // msg.obj = clientTransaction</div><div class="line">----callback(msg)</div><div class="line">Callback</div><div class="line">----mCallback <span class="comment">// 劫持 mCallback，修改 Intent</span></div><div class="line"></div><div class="line"><span class="comment">// 1. 和上面一样，Handler 在 ActivityThread 中以 mH 存在，所以需要先拿到 ActivityThread</span></div><div class="line"></div><div class="line"><span class="comment">// 2. 和上面一样，ActivityThread 中存在 sCurrentActivityThread，且是 static，反射时容易获取</span></div><div class="line"></div><div class="line"><span class="comment">// 3. 拿到 mH 以后，给 mH 设置新的 Callback，重写其 handleMessage()，这里 msg.what 变了，同时 msg.obj 变了，不是 r 了，而是 clientTransaction，通过反射获取 clientTransaction 中的 mActivityCallbacks，修改 Intent</span></div></pre></td></tr></table></figure></p>
<p>4、启动插件的 Activity。</p>
<h2 id="核心代码-1"><a href="#核心代码-1" class="headerlink" title="核心代码"></a><strong>核心代码</strong></h2><h3 id="将启动插件-Activity-的-Intent-替换成启动-ProxyActivity-的-Intent"><a href="#将启动插件-Activity-的-Intent-替换成启动-ProxyActivity-的-Intent" class="headerlink" title="将启动插件 Activity 的 Intent 替换成启动 ProxyActivity 的 Intent"></a><strong>将启动插件 Activity 的 Intent 替换成启动 ProxyActivity 的 Intent</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 获取 Singleton&lt;T&gt; 类的对象</span></div><div class="line">    Object singleton = <span class="keyword">null</span>;</div><div class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</div><div class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">"android.app.ActivityManager"</span>);</div><div class="line">        Field singletonField = clazz.getDeclaredField(<span class="string">"IActivityManagerSingleton"</span>);</div><div class="line">        singletonField.setAccessible(<span class="keyword">true</span>);</div><div class="line">        singleton = singletonField.get(<span class="keyword">null</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Class&lt;?&gt; clazz = Class.forName(<span class="string">"android.app.ActivityManagerNative"</span>);</div><div class="line">        Field singletonField = clazz.getDeclaredField(<span class="string">"gDefault"</span>);</div><div class="line">        singletonField.setAccessible(<span class="keyword">true</span>);</div><div class="line">        singleton = singletonField.get(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取 mInstance 对象</span></div><div class="line">    Class&lt;?&gt; singletonClass = Class.forName(<span class="string">"android.util.Singleton"</span>);</div><div class="line">    Field mInstanceField = singletonClass.getDeclaredField(<span class="string">"mInstance"</span>);</div><div class="line">    mInstanceField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    <span class="keyword">final</span> Object mInstance = mInstanceField.get(singleton);</div><div class="line"></div><div class="line">    <span class="comment">// 创建 IActivityManager 的代理对象</span></div><div class="line">    Class&lt;?&gt; iActivityManagerClass = Class.forName(<span class="string">"android.app.IActivityManager"</span>);</div><div class="line">    Object proxyInstance = Proxy.newProxyInstance(Thread.currentThread().getContextClassLoader(),</div><div class="line">            <span class="keyword">new</span> Class[]&#123;iActivityManagerClass&#125;, <span class="keyword">new</span> InvocationHandler() &#123;</div><div class="line">                <span class="meta">@Override</span></div><div class="line">                <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</div><div class="line">                    <span class="comment">/**</span></div><div class="line"><span class="comment">                     * int result = ActivityManager.getService()</span></div><div class="line"><span class="comment">                     *                 .startActivity(whoThread, who.getBasePackageName(), intent,</span></div><div class="line"><span class="comment">                     *                         intent.resolveTypeIfNeeded(who.getContentResolver()),</span></div><div class="line"><span class="comment">                     *                         token, target != null ? target.mEmbeddedID : null,</span></div><div class="line"><span class="comment">                     *                         requestCode, 0, null, options);</span></div><div class="line"><span class="comment">                     */</span></div><div class="line">                    <span class="comment">// 当执行的方法是 startActivity 时作处理</span></div><div class="line">                    <span class="keyword">if</span> (<span class="string">"startActivity"</span>.equals(method.getName())) &#123;</div><div class="line">                        <span class="keyword">int</span> index = <span class="number">0</span>;</div><div class="line"></div><div class="line">                        <span class="comment">// 获取插件的 intent</span></div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; args.length; i++) &#123;</div><div class="line">                            <span class="keyword">if</span> (args[i] <span class="keyword">instanceof</span> Intent) &#123;</div><div class="line">                                index = i;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        Intent intent = (Intent) args[index];</div><div class="line"></div><div class="line">                        <span class="comment">// 创建代理的 intent</span></div><div class="line">                        Intent proxyIntent = <span class="keyword">new</span> Intent();</div><div class="line">                        proxyIntent.setClassName(<span class="string">"io.weichao.plugin_demo"</span>, ProxyActivity.class.getName());</div><div class="line">                        <span class="comment">// 保存插件的 intent 到代理的 intent 中</span></div><div class="line">                        proxyIntent.putExtra(TARGET_INTENT, intent);</div><div class="line"></div><div class="line">                        <span class="comment">// 将插件的 intent 替换为代理的 intent</span></div><div class="line">                        args[index] = proxyIntent;</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    <span class="comment">// IActivityManager 对象 --- 通过反射</span></div><div class="line">                    <span class="keyword">return</span> method.invoke(mInstance, args);</div><div class="line">                &#125;</div><div class="line">            &#125;);</div><div class="line"></div><div class="line">    <span class="comment">// 使用代理对象替换原有的 mInstance 对象</span></div><div class="line">    mInstanceField.set(singleton, proxyInstance);</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">    Log.e(<span class="string">"aaaaa"</span>, <span class="string">"aaaaa"</span> + e.getMessage());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="将启动-ProxyActivity-的-Intent-替换成启动插件-Activity-的-Intent"><a href="#将启动-ProxyActivity-的-Intent-替换成启动插件-Activity-的-Intent" class="headerlink" title="将启动 ProxyActivity 的 Intent 替换成启动插件 Activity 的 Intent"></a><strong>将启动 ProxyActivity 的 Intent 替换成启动插件 Activity 的 Intent</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 获取 ActivityThread 对象</span></div><div class="line">    Class&lt;?&gt; clazz = Class.forName(<span class="string">"android.app.ActivityThread"</span>);</div><div class="line">    Field sCurrentActivityThreadField = clazz.getDeclaredField(<span class="string">"sCurrentActivityThread"</span>);</div><div class="line">    sCurrentActivityThreadField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    Object activityThread = sCurrentActivityThreadField.get(<span class="keyword">null</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 获取 Handler 对象</span></div><div class="line">    Field mHField = clazz.getDeclaredField(<span class="string">"mH"</span>);</div><div class="line">    mHField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    Object mH = mHField.get(activityThread);</div><div class="line"></div><div class="line">    <span class="comment">// 创建一个 Callback 替换系统的 Callback 对象</span></div><div class="line">    Class&lt;?&gt; handlerClass = Class.forName(<span class="string">"android.os.Handler"</span>);</div><div class="line">    Field mCallbackField = handlerClass.getDeclaredField(<span class="string">"mCallback"</span>);</div><div class="line">    mCallbackField.setAccessible(<span class="keyword">true</span>);</div><div class="line">    mCallbackField.set(mH, <span class="keyword">new</span> Handler.Callback() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">handleMessage</span><span class="params">(@NonNull Message msg)</span> </span>&#123;</div><div class="line">            <span class="keyword">switch</span> (msg.what) &#123;</div><div class="line">                <span class="keyword">case</span> <span class="number">100</span>:</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        <span class="comment">// 获取保存在代理的 intent 中的插件的 intent</span></div><div class="line">                        Field intentField = msg.obj.getClass().getDeclaredField(<span class="string">"intent"</span>);</div><div class="line">                        intentField.setAccessible(<span class="keyword">true</span>);</div><div class="line">                        Intent proxyIntent = (Intent) intentField.get(msg.obj);</div><div class="line">                        Intent intent = proxyIntent.getParcelableExtra(TARGET_INTENT);</div><div class="line">                        <span class="comment">// 判断调用的是否是插件的，如果不是插件的，intent 就会为空</span></div><div class="line">                        <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">                            intentField.set(msg.obj, intent);</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        Log.e(<span class="string">"aaaaa"</span>, <span class="string">"aaaaa"</span> + e.getMessage());</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> <span class="number">159</span>:</div><div class="line">                    <span class="keyword">try</span> &#123;</div><div class="line">                        Class&lt;?&gt; clazz = Class.forName(<span class="string">"android.app.servertransaction.ClientTransaction"</span>);</div><div class="line">                        Field mActivityCallbacksField = clazz.getDeclaredField(<span class="string">"mActivityCallbacks"</span>);</div><div class="line">                        mActivityCallbacksField.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">                        List activityCallbacks = (List) mActivityCallbacksField.get(msg.obj);</div><div class="line">                        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; activityCallbacks.size(); i++) &#123;</div><div class="line">                            <span class="keyword">if</span> (activityCallbacks.get(i).getClass().getName() .equals(<span class="string">"android.app.servertransaction.LaunchActivityItem"</span>)) &#123;</div><div class="line">                                Object launchActivityItem = activityCallbacks.get(i);</div><div class="line">                                Field mIntentField = launchActivityItem.getClass().getDeclaredField(<span class="string">"mIntent"</span>);</div><div class="line">                                mIntentField.setAccessible(<span class="keyword">true</span>);</div><div class="line">                                Intent proxyIntent = (Intent) mIntentField.get(launchActivityItem);</div><div class="line">                                <span class="comment">// 判断调用的是否是插件的，如果不是插件的，intent 就会为空</span></div><div class="line">                                Intent intent = proxyIntent.getParcelableExtra(TARGET_INTENT);</div><div class="line">                                <span class="keyword">if</span> (intent != <span class="keyword">null</span>) &#123;</div><div class="line">                                    mIntentField.set(launchActivityItem, intent);</div><div class="line">                                &#125;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                        e.printStackTrace();</div><div class="line">                        Log.e(<span class="string">"aaaaa"</span>, <span class="string">"aaaaa"</span> + e.getMessage());</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">    Log.e(<span class="string">"aaaaa"</span>, <span class="string">"aaaaa"</span> + e.getMessage());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="启动插件的-Activity"><a href="#启动插件的-Activity" class="headerlink" title="启动插件的 Activity"></a><strong>启动插件的 Activity</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Intent intent = <span class="keyword">new</span> Intent();</div><div class="line">intent.setComponent(<span class="keyword">new</span> ComponentName(<span class="string">"io.weichao.plugin"</span>, <span class="string">"io.weichao.plugin.activity.MainActivity"</span>));</div><div class="line">startActivity(intent);</div></pre></td></tr></table></figure>
<hr>
<h1 id="让插件中的-Activity-加载插件中的资源"><a href="#让插件中的-Activity-加载插件中的资源" class="headerlink" title="让插件中的 Activity 加载插件中的资源"></a><strong>让插件中的 Activity 加载插件中的资源</strong></h1><h2 id="前期铺垫"><a href="#前期铺垫" class="headerlink" title="前期铺垫"></a><strong>前期铺垫</strong></h2><p>1、加载 res 中的资源是通过 Resources，但是最后也是调用 AssetManager，只是会先通过 id 查找。AssetManager 可以加载未编译过的资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">getResources().getString(R.string.app_name);</div><div class="line"></div><div class="line"><span class="comment">// Resources</span></div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getString</span><span class="params">(@StringRes <span class="keyword">int</span> id)</span> <span class="keyword">throws</span> NotFoundException </span>&#123;</div><div class="line">    <span class="keyword">return</span> getText(id).toString();</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@NonNull</span> <span class="function"><span class="keyword">public</span> CharSequence <span class="title">getText</span><span class="params">(@StringRes <span class="keyword">int</span> id)</span> <span class="keyword">throws</span> NotFoundException </span>&#123;</div><div class="line">    CharSequence res = mResourcesImpl.getAssets().getResourceText(id);</div><div class="line">    <span class="keyword">if</span> (res != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">return</span> res;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NotFoundException(<span class="string">"String resource ID #0x"</span></div><div class="line">            + Integer.toHexString(id));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2、启动 Activity 时会调用 ActivityThread#performLaunchActivity()，此时建立了 Resources、AssetManager 和 Context 的绑定关系，并且指定了资源目录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ActivityThread</span></div><div class="line"><span class="function"><span class="keyword">private</span> Activity <span class="title">performLaunchActivity</span><span class="params">(ActivityClientRecord r, Intent customIntent)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ContextImpl appContext = createBaseContextForActivity(r);</div><div class="line">    ...</div><div class="line">    activity.attach(appContext, ...);</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> activity;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ContextImpl <span class="title">createBaseContextForActivity</span><span class="params">(ActivityClientRecord r)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ContextImpl appContext = ContextImpl.createActivityContext(</div><div class="line">            <span class="keyword">this</span>, r.packageInfo, r.activityInfo, r.token, displayId, r.overrideConfig);</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> appContext;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ContextImpl</span></div><div class="line"><span class="function"><span class="keyword">static</span> ContextImpl <span class="title">createActivityContext</span><span class="params">(ActivityThread mainThread,</span></span></div><div class="line"><span class="function"><span class="params">        LoadedApk packageInfo, ActivityInfo activityInfo, IBinder activityToken, <span class="keyword">int</span> displayId,</span></span></div><div class="line"><span class="function"><span class="params">        Configuration overrideConfiguration)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ContextImpl context = <span class="keyword">new</span> ContextImpl(<span class="keyword">null</span>, mainThread, packageInfo, activityInfo.splitName, activityToken, <span class="keyword">null</span>, <span class="number">0</span>, classLoader);</div><div class="line">    ...</div><div class="line">    <span class="comment">// Context 绑定 Resources</span></div><div class="line">    <span class="keyword">final</span> ResourcesManager resourcesManager = ResourcesManager.getInstance();</div><div class="line">    context.setResources(resourcesManager.createBaseActivityResources(activityToken,</div><div class="line">            packageInfo.getResDir(),</div><div class="line">            splitDirs,</div><div class="line">            packageInfo.getOverlayDirs(),</div><div class="line">            packageInfo.getApplicationInfo().sharedLibraryFiles,</div><div class="line">            displayId,</div><div class="line">            overrideConfiguration,</div><div class="line">            compatInfo,</div><div class="line">            classLoader));</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> context;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ResourcesManager</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">createBaseActivityResources</span><span class="params">(@NonNull IBinder activityToken,</span></span></div><div class="line"><span class="function"><span class="params">        @Nullable String resDir,</span></span></div><div class="line"><span class="function"><span class="params">        @Nullable String[] splitResDirs,</span></span></div><div class="line"><span class="function"><span class="params">        @Nullable String[] overlayDirs,</span></span></div><div class="line"><span class="function"><span class="params">        @Nullable String[] libDirs,</span></span></div><div class="line"><span class="function"><span class="params">        <span class="keyword">int</span> displayId,</span></span></div><div class="line"><span class="function"><span class="params">        @Nullable Configuration overrideConfig,</span></span></div><div class="line"><span class="function"><span class="params">        @NonNull CompatibilityInfo compatInfo,</span></span></div><div class="line"><span class="function"><span class="params">        @Nullable ClassLoader classLoader)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> getOrCreateResources(activityToken, key, classLoader);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">Resources <span class="title">getOrCreateResources</span><span class="params">(@Nullable IBinder activityToken,</span></span></div><div class="line"><span class="function"><span class="params">        @NonNull ResourcesKey key, @NonNull ClassLoader classLoader)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    ResourcesImpl resourcesImpl = createResourcesImpl(key);</div><div class="line">    ...</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="meta">@Nullable</span> <span class="function">ResourcesImpl <span class="title">createResourcesImpl</span><span class="params">(@NonNull ResourcesKey key)</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="keyword">final</span> AssetManager assets = createAssetManager(key);</div><div class="line">    ...</div><div class="line">    <span class="comment">// Resources 绑定 AssetManager</span></div><div class="line">    <span class="keyword">final</span> ResourcesImpl impl = <span class="keyword">new</span> ResourcesImpl(assets, dm, config, daj);</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> impl;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">protected</span> <span class="meta">@Nullable</span> <span class="function">AssetManager <span class="title">createAssetManager</span><span class="params">(@NonNull <span class="keyword">final</span> ResourcesKey key)</span> </span>&#123;</div><div class="line">    AssetManager assets = <span class="keyword">new</span> AssetManager();</div><div class="line">    <span class="keyword">if</span> (key.mResDir != <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="comment">// 调用 AssetManager#addAssetPath() 添加资源目录</span></div><div class="line">        <span class="keyword">if</span> (assets.addAssetPath(key.mResDir) == <span class="number">0</span>) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"failed to add asset path "</span> + key.mResDir);</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="原理-1"><a href="#原理-1" class="headerlink" title="原理"></a><strong>原理</strong></h2><ol>
<li>创建 AssetManager，反射 addAssetPath 方法设置插件的资源目录；</li>
<li>创建 Resources，绑定该 AssetManager；</li>
<li>在 Application 中重写 getResources()，使用该 Resources；</li>
<li>在插件的 Activity 中重写 getResources()，使用 Application 中的 Resources。</li>
</ol>
<h2 id="核心代码-2"><a href="#核心代码-2" class="headerlink" title="核心代码"></a><strong>核心代码</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// LoadUtil.java</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Resources <span class="title">loadResource</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        AssetManager assetManager = AssetManager.class.newInstance();</div><div class="line">        Method addAssetPathMethod = assetManager.getClass().getDeclaredMethod(<span class="string">"addAssetPath"</span>, String.class);</div><div class="line">        addAssetPathMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line">        <span class="comment">// 参数就是插件的资源路径</span></div><div class="line">        addAssetPathMethod.invoke(assetManager, apkPath);</div><div class="line">        Resources resources = context.getResources();</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Resources(assetManager, resources.getDisplayMetrics(), resources.getConfiguration());</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Resources resources;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        resources = LoadUtil.loadResource(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> resources == <span class="keyword">null</span> ? <span class="keyword">super</span>.getResources() : resources;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> Resources <span class="title">getResources</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (getApplication() != <span class="keyword">null</span> &amp;&amp; getApplication().getResources() != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> getApplication().getResources();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.getResources();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="当宿主的-Activity-和插件的-Activity-都继承于-AppCompatActivity-时会报错"><a href="#当宿主的-Activity-和插件的-Activity-都继承于-AppCompatActivity-时会报错" class="headerlink" title="当宿主的 Activity 和插件的 Activity 都继承于 AppCompatActivity 时会报错"></a><strong>当宿主的 Activity 和插件的 Activity 都继承于 AppCompatActivity 时会报错</strong></h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">java.lang.RuntimeException: Unable to start activity ComponentInfo&#123;io.weichao.plugin/io.weichao.plugin.activity.MainActivity&#125;: java.lang.NullPointerException: Attempt to invoke interface method &apos;void androidx.appcompat.widget.DecorContentParent.setWindowCallback(android.view.Window$Callback)&apos; on a null object reference</div><div class="line">        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2913)</div><div class="line">        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3048)</div><div class="line">        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78)</div><div class="line">        at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108)</div><div class="line">        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68)</div><div class="line">        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1808)</div><div class="line">        at android.os.Handler.dispatchMessage(Handler.java:106)</div><div class="line">        at android.os.Looper.loop(Looper.java:193)</div><div class="line">        at android.app.ActivityThread.main(ActivityThread.java:6669)</div><div class="line">        at java.lang.reflect.Method.invoke(Native Method)</div><div class="line">        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493)</div><div class="line">        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)</div><div class="line">     Caused by: java.lang.NullPointerException: Attempt to invoke interface method &apos;void androidx.appcompat.widget.DecorContentParent.setWindowCallback(android.view.Window$Callback)&apos; on a null object reference</div><div class="line">        at androidx.appcompat.app.AppCompatDelegateImpl.createSubDecor(AppCompatDelegateImpl.java:753)</div><div class="line">        at androidx.appcompat.app.AppCompatDelegateImpl.ensureSubDecor(AppCompatDelegateImpl.java:659)</div><div class="line">        at androidx.appcompat.app.AppCompatDelegateImpl.setContentView(AppCompatDelegateImpl.java:552)</div><div class="line">        at androidx.appcompat.app.AppCompatActivity.setContentView(AppCompatActivity.java:161)</div><div class="line">        at io.weichao.plugin.activity.MainActivity.onCreate(MainActivity.java:15)</div><div class="line">        at android.app.Activity.performCreate(Activity.java:7136)</div><div class="line">        at android.app.Activity.performCreate(Activity.java:7127)</div><div class="line">        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1271)</div><div class="line">        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:2893)</div><div class="line">        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:3048) </div><div class="line">        at android.app.servertransaction.LaunchActivityItem.execute(LaunchActivityItem.java:78) </div><div class="line">        at android.app.servertransaction.TransactionExecutor.executeCallbacks(TransactionExecutor.java:108) </div><div class="line">        at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:68) </div><div class="line">        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1808) </div><div class="line">        at android.os.Handler.dispatchMessage(Handler.java:106) </div><div class="line">        at android.os.Looper.loop(Looper.java:193) </div><div class="line">        at android.app.ActivityThread.main(ActivityThread.java:6669) </div><div class="line">        at java.lang.reflect.Method.invoke(Native Method) </div><div class="line">        at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:493) </div><div class="line">        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:858)</div></pre></td></tr></table></figure>
<h3 id="报错的原因"><a href="#报错的原因" class="headerlink" title="报错的原因"></a><strong>报错的原因</strong></h3><p>当宿主和插件都使用 AppCompatActivity 时，由于编译时会将资源建立映射关系，在宿主和插件中分别建立了 1 次映射关系，且这 2 次映射关系基本上不会相同。在宿主中 key1 -&gt; value1，在插件中 key2 -&gt; value2。<br>但是 AppCompatDelegateImpl 类只会在宿主中被加载一次，也就是宿主和插件都使用 key1 查找资源。</p>
<p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004096.png" alt=""></p>
<p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004097.png" alt=""></p>
<p><img src="https://weichao-io-1257283924.cos.ap-beijing.myqcloud.com/qldownload/%E6%8F%92%E4%BB%B6%E5%8C%96202004098.png" alt=""></p>
<h3 id="解决办法"><a href="#解决办法" class="headerlink" title="解决办法"></a><strong>解决办法</strong></h3><p>让插件使用自己的 Resource。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">protected</span> Context mContext;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line"></div><div class="line">        Resources resource = LoadUtil.getResource(getApplication());</div><div class="line">        mContext = <span class="keyword">new</span> ContextThemeWrapper(getBaseContext(), <span class="number">0</span>);</div><div class="line">        Class&lt;? extends Context&gt; clazz = mContext.getClass();</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            Field mResourcesField = clazz.getDeclaredField(<span class="string">"mResources"</span>);</div><div class="line">            mResourcesField.setAccessible(<span class="keyword">true</span>);</div><div class="line">            mResourcesField.set(mContext, resource);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        View view = LayoutInflater.from(mContext).inflate(R.layout.activity_main, <span class="keyword">null</span>);</div><div class="line">        setContentView(view);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>

      
    </div>
	
	<div>
	  
		
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>

  <!-- JS库 sweetalert 可修改路径 -->
  <script type="text/javascript" src="http://jslibs.wuxubj.cn/sweetalert_mini/jquery-1.7.1.min.js"></script>
  <script src="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.min.js"></script>
  <link rel="stylesheet" type="text/css" href="http://jslibs.wuxubj.cn/sweetalert_mini/sweetalert.mini.css">
  <p><span>本文标题:</span><a href="/2020/04/09/插件化/">插件化</a></p>
  <p><span>文章作者:</span><a href="/" title="访问 魏超 的个人博客">魏超</a></p>
  <p><span>发布时间:</span>2020年04月09日 - 18:04</p>
  <p><span>最后更新:</span>2020年04月09日 - 18:04</p>
  <p><span>原始链接:</span><a href="/2020/04/09/插件化/" title="插件化">http://www.weichao.io/2020/04/09/插件化/</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://www.weichao.io/2020/04/09/插件化/"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
    clipboard.on('success', $(function(){
      $(".fa-clipboard").click(function(){
        swal({   
          title: "",   
          text: '复制成功',   
          html: false,
          timer: 500,   
          showConfirmButton: false
        });
      });
    }));  
</script>

	  
	</div>

    <div>
      
        

      
    </div>
	
	<div>
	  
		<div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">---------------------本文结束---------------------</div>
    
</div>
	  
	</div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/03/23/《剑指-Offer》算法题（20-68）/" rel="next" title="《剑指 Offer》算法题（20/68）">
                <i class="fa fa-chevron-left"></i> 《剑指 Offer》算法题（20/68）
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/13/热修复/" rel="prev" title="热修复">
                热修复 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <!-- JiaThis Button BEGIN -->
<div class="jiathis_style">
  <a class="jiathis_button_tsina"></a>
  <a class="jiathis_button_tqq"></a>
  <a class="jiathis_button_weixin"></a>
  <a class="jiathis_button_cqq"></a>
  <a class="jiathis_button_douban"></a>
  <a class="jiathis_button_renren"></a>
  <a class="jiathis_button_qzone"></a>
  <a class="jiathis_button_kaixin001"></a>
  <a class="jiathis_button_copy"></a>
  <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
  <a class="jiathis_counter_style"></a>
</div>
<script type="text/javascript" >
  var jiathis_config={
    hideMore:false
  }
</script>
<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js" charset="utf-8"></script>
<!-- JiaThis Button END -->

      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div id="lv-container" data-id="city" data-uid="MTAyMC8yOTY2Ny82MjM1"></div>
    
  </div>

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.png"
               alt="魏超" />
          <p class="site-author-name" itemprop="name">魏超</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
           
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives/">
                <span class="site-state-item-count">58</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/weichao66666" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.jsxfedu.com/" target="_blank" title="北京京师讯飞教育科技有限公司">
                  
                    <i class="fa fa-fw fa-building"></i>
                  
                  北京京师讯飞教育科技有限公司
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ClassLoader-加载-dex-文件"><span class="nav-number">1.</span> <span class="nav-text">ClassLoader 加载 dex 文件</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#继承关系"><span class="nav-number">1.1.</span> <span class="nav-text">继承关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ClassLoader-加载-Class-的流程"><span class="nav-number">1.2.</span> <span class="nav-text">ClassLoader 加载 Class 的流程</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#执行插件中的方法"><span class="nav-number">2.</span> <span class="nav-text">执行插件中的方法</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">2.1.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码"><span class="nav-number">2.2.</span> <span class="nav-text">核心代码</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#启动插件中的-Activity"><span class="nav-number">3.</span> <span class="nav-text">启动插件中的 Activity</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#关键难点——无法通过-AMS-检测"><span class="nav-number">3.1.</span> <span class="nav-text">关键难点——无法通过 AMS 检测</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动-Activity-流程"><span class="nav-number">3.1.1.</span> <span class="nav-text">启动 Activity 流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#绕过-AMS-检测——hook"><span class="nav-number">3.2.</span> <span class="nav-text">绕过 AMS 检测——hook</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码-1"><span class="nav-number">3.3.</span> <span class="nav-text">核心代码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#将启动插件-Activity-的-Intent-替换成启动-ProxyActivity-的-Intent"><span class="nav-number">3.3.1.</span> <span class="nav-text">将启动插件 Activity 的 Intent 替换成启动 ProxyActivity 的 Intent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#将启动-ProxyActivity-的-Intent-替换成启动插件-Activity-的-Intent"><span class="nav-number">3.3.2.</span> <span class="nav-text">将启动 ProxyActivity 的 Intent 替换成启动插件 Activity 的 Intent</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动插件的-Activity"><span class="nav-number">3.3.3.</span> <span class="nav-text">启动插件的 Activity</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#让插件中的-Activity-加载插件中的资源"><span class="nav-number">4.</span> <span class="nav-text">让插件中的 Activity 加载插件中的资源</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#前期铺垫"><span class="nav-number">4.1.</span> <span class="nav-text">前期铺垫</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原理-1"><span class="nav-number">4.2.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#核心代码-2"><span class="nav-number">4.3.</span> <span class="nav-text">核心代码</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#当宿主的-Activity-和插件的-Activity-都继承于-AppCompatActivity-时会报错"><span class="nav-number">4.4.</span> <span class="nav-text">当宿主的 Activity 和插件的 Activity 都继承于 AppCompatActivity 时会报错</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#报错的原因"><span class="nav-number">4.4.1.</span> <span class="nav-text">报错的原因</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决办法"><span class="nav-number">4.4.2.</span> <span class="nav-text">解决办法</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">魏超</span>
</div>

<!--在网站底部加上访问量-->
<script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<span id="busuanzi_container_site_pv">
	本站总访问量 <span id="busuanzi_value_site_pv"></span> 次
</span>

<!--网站底部字数统计-->
<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">本站总字数 179.7k 字 </span>
</div>

<!--
<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
-->

        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>

  
  <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.1"></script>



  


  




	





  





  
    <script type="text/javascript">
      (function(d, s) {
        var j, e = d.getElementsByTagName(s)[0];
        if (typeof LivereTower === 'function') { return; }
        j = d.createElement(s);
        j.src = 'https://cdn-city.livere.com/js/embed.dist.js';
        j.async = true;
        e.parentNode.insertBefore(j, e);
      })(document, 'script');
    </script>
  






  





  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("tcrb9doXO1TJ1AjcOG6cyo6V-gzGzoHsz", "ntQmtcVgiBuYcDtx6pHTRJUv");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><!-- hexo-inject:begin --><!-- hexo-inject:end -->


  

  
  


  

  

</body>
</html>
