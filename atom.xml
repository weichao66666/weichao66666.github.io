<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>『魏超』的 blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://www.weichao.io/"/>
  <updated>2018-05-11T14:26:41.459Z</updated>
  <id>http://www.weichao.io/</id>
  
  <author>
    <name>魏超</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>使用 JIMU 框架实现组件化</title>
    <link href="http://www.weichao.io/2018/04/19/%E4%BD%BF%E7%94%A8-JIMU-%E6%A1%86%E6%9E%B6%E5%AE%9E%E7%8E%B0%E7%BB%84%E4%BB%B6%E5%8C%96/"/>
    <id>http://www.weichao.io/2018/04/19/使用-JIMU-框架实现组件化/</id>
    <published>2018-04-19T13:44:58.000Z</published>
    <updated>2018-05-11T14:26:41.459Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://www.jianshu.com/p/1b1d77f58e84" title="https://www.jianshu.com/p/1b1d77f58e84" target="_blank" rel="external">Android彻底组件化方案实践</a></li><li><a href="https://www.jianshu.com/p/5746e50ed572" title="https://www.jianshu.com/p/5746e50ed572" target="_blank" rel="external">全面组件化—DDComponentForAndroid分析(1)</a></li></ul><hr><h1 id="最后实现的效果"><a href="#最后实现的效果" class="headerlink" title="最后实现的效果"></a><strong>最后实现的效果</strong></h1><p>一个模块既可以作为 application 进行单独打包，也可以作为其他模块的 library 进行打包。</p><hr><h1 id="从零开始实现功能"><a href="#从零开始实现功能" class="headerlink" title="从零开始实现功能"></a><strong>从零开始实现功能</strong></h1><h2 id="下载-JIMU-项目"><a href="#下载-JIMU-项目" class="headerlink" title="下载 JIMU 项目"></a><strong>下载 JIMU 项目</strong></h2><p>JIMU 项目<a href="https://github.com/mqzhangw/JIMU/tree/master" title="https://github.com/mqzhangw/JIMU/tree/master" target="_blank" rel="external">下载地址</a>，后面需要用到其中的 module。</p><h2 id="新建项目"><a href="#新建项目" class="headerlink" title="新建项目"></a><strong>新建项目</strong></h2><p>比如 component_demo。</p><h2 id="新建-module"><a href="#新建-module" class="headerlink" title="新建 module"></a><strong>新建 module</strong></h2><p>比如 component1。</p><h2 id="按照-JIMU-使用指南配置"><a href="#按照-JIMU-使用指南配置" class="headerlink" title="按照 JIMU 使用指南配置"></a><strong>按照<a href="https://github.com/mqzhangw/JIMU#%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97" title="https://github.com/mqzhangw/JIMU#%E4%BD%BF%E7%94%A8%E6%8C%87%E5%8D%97" target="_blank" rel="external"> JIMU 使用指南</a>配置</strong></h2><h3 id="主项目引用编译脚本"><a href="#主项目引用编译脚本" class="headerlink" title="主项目引用编译脚本"></a><strong>主项目引用编译脚本</strong></h3><p>1、修改<code>component_demo\gradle.properties</code>为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line">org.gradle.jvmargs=-Xmx1536m</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div><div class="line"></div><div class="line">mainmodulename=app</div></pre></td></tr></table></figure><p>2、修改<code>component_demo\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></div><div class="line"></div><div class="line"><span class="keyword">buildscript</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        google()</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">dependencies</span> &#123;</div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.android.tools.build:gradle:3.1.1'</span></div><div class="line">        <span class="keyword">classpath</span> <span class="string">'com.luojilab.ddcomponent:build-gradle:1.2.0'</span></div><div class="line"></div><div class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></div><div class="line">        <span class="comment">// in the individual module build.gradle files</span></div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">allprojects</span> &#123;</div><div class="line">    <span class="keyword">repositories</span> &#123;</div><div class="line">        google()</div><div class="line">        jcenter()</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">task</span> clean(type: <span class="keyword">Delete</span>) &#123;</div><div class="line">    <span class="keyword">delete</span> rootProject.buildDir</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="设置组件可独立打包"><a href="#设置组件可独立打包" class="headerlink" title="设置组件可独立打包"></a><strong>设置组件可独立打包</strong></h3><p>新建<code>component_demo\app\gradle.properties</code>和<code>component_demo\component1\gradle.properties</code>，并写入内容：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line">org.gradle.jvmargs=-Xmx1536m</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div><div class="line"></div><div class="line">isRunAlone=true</div><div class="line">debugComponent=sharecomponent</div><div class="line">compileComponent=sharecomponent</div></pre></td></tr></table></figure><h3 id="应用组件化编译脚本"><a href="#应用组件化编译脚本" class="headerlink" title="应用组件化编译脚本"></a><strong>应用组件化编译脚本</strong></h3><p>1、修改<code>component_demo\app\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.dd.comgradle'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"io.weichao.component_demo"</span></div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">combuild &#123;</div><div class="line">    applicationName = <span class="string">'com.luojilab.reader.runalone.application.ReaderApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2、修改<code>component_demo\component1\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.dd.comgradle'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"io.weichao.component1"</span></div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">combuild &#123;</div><div class="line">    applicationName = <span class="string">'com.luojilab.reader.runalone.application.ReaderApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a><strong>混淆</strong></h3><p>修改<code>component_demo\app\proguard-rules.pro</code>和<code>component_demo\component1\proguard-rules.pro</code>为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">-keep interface * &#123;</div><div class="line">  &lt;methods&gt;;</div><div class="line">&#125;</div><div class="line">-keep class com.luojilab.component.componentlib.** &#123;*;&#125;</div><div class="line">-keep class com.luojilab.router.** &#123;*;&#125;</div><div class="line">-keep class * implements com.luojilab.component.componentlib.router.ISyringe &#123;*;&#125;</div><div class="line">-keep class * implements com.luojilab.component.componentlib.applicationlike.IApplicationLike &#123;*;&#125;</div></pre></td></tr></table></figure><h2 id="application-式打包（运行-component1）"><a href="#application-式打包（运行-component1）" class="headerlink" title="application 式打包（运行 component1）"></a><strong>application 式打包（运行 component1）</strong></h2><h3 id="报错：Project-with-path-‘-sharecomponent’-could-not-be-found-in-project-‘-xx’"><a href="#报错：Project-with-path-‘-sharecomponent’-could-not-be-found-in-project-‘-xx’" class="headerlink" title="报错：Project with path ‘:sharecomponent’ could not be found in project ‘:xx’."></a><strong>报错：Project with path ‘:sharecomponent’ could not be found in project ‘:xx’.</strong></h3><p>修改<code>component_demo\app\gradle.properties</code>和<code>component_demo\component1\gradle.properties</code>为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line">org.gradle.jvmargs=-Xmx1536m</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div><div class="line"></div><div class="line">isRunAlone=true</div></pre></td></tr></table></figure><h3 id="报错：Cannot-read-packageName-from-xx-src-main-runalone-AndroidManifest-xml"><a href="#报错：Cannot-read-packageName-from-xx-src-main-runalone-AndroidManifest-xml" class="headerlink" title="报错：Cannot read packageName from xx\src\main\runalone\AndroidManifest.xml"></a><strong>报错：Cannot read packageName from xx\src\main\runalone\AndroidManifest.xml</strong></h3><p>新建<code>component_demo\component1\src\main\runalone</code>，在该文件夹中新建<code>AndroidManifest.xml</code>并写入：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"io.weichao.component1"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">application</span></span></div><div class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.MAIN"</span> /&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.LAUNCHER"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="运行成功"><a href="#运行成功" class="headerlink" title="运行成功"></a><strong>运行成功</strong></h3><p>为了便于展示，修改<code>component_demo\component1\src\main\res\layout\activity_main.xml</code>为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"component1"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="library-式打包（运行-app）"><a href="#library-式打包（运行-app）" class="headerlink" title="library 式打包（运行 app）"></a><strong>library 式打包（运行 app）</strong></h2><p>【非必须】修改<code>component_demo\component1\src\main\AndroidManifest.xml</code>为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"io.weichao.component1"</span> /&gt;</span></div></pre></td></tr></table></figure><h3 id="app-集成-component1"><a href="#app-集成-component1" class="headerlink" title="app 集成 component1"></a><strong>app 集成 component1</strong></h3><p>修改<code>component_demo\app\gradle.properties</code>为：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># Project-wide Gradle settings.</div><div class="line"></div><div class="line"># IDE (e.g. Android Studio) users:</div><div class="line"># Gradle settings configured through the IDE *will override*</div><div class="line"># any settings specified in this file.</div><div class="line"></div><div class="line"># For more details on how to configure your build environment visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/build_environment.html</div><div class="line"></div><div class="line"># Specifies the JVM arguments used for the daemon process.</div><div class="line"># The setting is particularly useful for tweaking memory settings.</div><div class="line">org.gradle.jvmargs=-Xmx1536m</div><div class="line"></div><div class="line"># When configured, Gradle will run in incubating parallel mode.</div><div class="line"># This option should only be used with decoupled projects. More details, visit</div><div class="line"># http://www.gradle.org/docs/current/userguide/multi_project_builds.html#sec:decoupled_projects</div><div class="line"># org.gradle.parallel=true</div><div class="line"></div><div class="line">isRunAlone=true</div><div class="line">debugComponent=component1</div><div class="line">compileComponent=component1</div></pre></td></tr></table></figure><h3 id="组件数据交互"><a href="#组件数据交互" class="headerlink" title="组件数据交互"></a><strong>组件数据交互</strong></h3><h4 id="新建专用于数据交互的-module"><a href="#新建专用于数据交互的-module" class="headerlink" title="新建专用于数据交互的 module"></a><strong>新建专用于数据交互的 module</strong></h4><p>新建<code>component_demo\component_service\src\main\java\io\weichao\component_service\Component1Service.java</code>用于其他 module 和 component1 的交互：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component_service;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Component1Service</span> </span>&#123;</div><div class="line">    <span class="function">String <span class="title">getComponentStr</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="component1-引入-component-service"><a href="#component1-引入-component-service" class="headerlink" title="component1 引入 component_service"></a><strong>component1 引入 component_service</strong></h4><p>修改<code>component_demo\component1\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.dd.comgradle'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':component_service'</span>)</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">combuild &#123;</div><div class="line">    applicationName = <span class="string">'com.luojilab.reader.runalone.application.ReaderApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="component1-实现-Component1Service-接口"><a href="#component1-实现-Component1Service-接口" class="headerlink" title="component1 实现 Component1Service 接口"></a><strong>component1 实现 Component1Service 接口</strong></h4><p>新建<code>component_demo\component1\src\main\java\io\weichao\component1\Component1ServiceImpl.java</code>，并写入内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.weichao.component_service.Component1Service;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Component1ServiceImpl</span> <span class="keyword">implements</span> <span class="title">Component1Service</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getComponentStr</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"component1"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="将-Component1ServiceImpl-注册到-Router-中"><a href="#将-Component1ServiceImpl-注册到-Router-中" class="headerlink" title="将 Component1ServiceImpl 注册到 Router 中"></a><strong>将 Component1ServiceImpl 注册到 Router 中</strong></h4><p>1、导入已下载的 JIMU 项目中的 componentlib。</p><h5 id="报错：Plugin-with-id-‘com-github-dcendents-android-maven’-not-found"><a href="#报错：Plugin-with-id-‘com-github-dcendents-android-maven’-not-found" class="headerlink" title="报错：Plugin with id ‘com.github.dcendents.android-maven’ not found."></a><strong>报错：Plugin with id ‘com.github.dcendents.android-maven’ not found.</strong></h5><p>修改<code>component_demo\componentlib\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.library'</span></div><div class="line"></div><div class="line"><span class="keyword">sourceCompatibility</span> = <span class="string">"1.7"</span></div><div class="line"><span class="keyword">targetCompatibility</span> = <span class="string">"1.7"</span></div><div class="line"></div><div class="line"></div><div class="line">ext &#123;</div><div class="line">    bintrayName = <span class="string">'componentlib'</span></div><div class="line">    artifact = bintrayName</div><div class="line">    libraryName = <span class="string">'component build lib '</span></div><div class="line">    libraryDescription = <span class="string">'component build lib '</span></div><div class="line">    libraryVersion = <span class="string">"1.3.1"</span></div><div class="line">    licenseName = <span class="string">'The Apache Software License, Version 2.0'</span></div><div class="line">    licenseUrl = <span class="string">'http://www.apache.org/licenses/LICENSE-2.0.txt'</span></div><div class="line">    allLicenses = [<span class="string">"Apache-2.0"</span>]</div><div class="line">&#125;</div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">26</span></div><div class="line">    buildToolsVersion <span class="string">"26.0.0"</span></div><div class="line"></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">15</span></div><div class="line">        targetSdkVersion <span class="number">26</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line"></div><div class="line">        testInstrumentationRunner <span class="string">"android.support.test.runner.AndroidJUnitRunner"</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    <span class="keyword">compile</span> <span class="keyword">fileTree</span>(<span class="keyword">include</span>: [<span class="string">'*.jar'</span>], dir: <span class="string">'libs'</span>)</div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.android.support:appcompat-v7:26.+'</span></div><div class="line">    androidTestCompile(<span class="string">'com.android.support.test.espresso:espresso-core:2.2.2'</span>, &#123;</div><div class="line">        <span class="keyword">exclude</span> <span class="keyword">group</span>: <span class="string">'com.android.support'</span>, module: <span class="string">'support-annotations'</span></div><div class="line">    &#125;)</div><div class="line">    testCompile <span class="string">'junit:junit:4.12'</span></div><div class="line"><span class="comment">//    compile project(':router-annotation')</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.github.jimu:router-annotation:1.0.1'</span></div><div class="line">    <span class="keyword">compile</span> <span class="string">'com.google.code.gson:gson:2.8.2'</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//apply from: 'https://raw.githubusercontent.com/nuuneoi/JCenter/master/installv1.gradle'</span></div><div class="line"><span class="comment">//apply from: 'https://raw.githubusercontent.com/nuuneoi/JCenter/master/bintrayv1.gradle'</span></div></pre></td></tr></table></figure><p>2、修改<code>component_demo\component_service\build.gradle</code>：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.android.library'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':componentlib'</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>3、新建<code>component_demo\component1\src\main\java\io\weichao\component1\Component1ApplicationLike.java</code>，并写入内容：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.applicationlike.IApplicationLike;</div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.router.Router;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.weichao.component_service.Component1Service;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Component1ApplicationLike</span> <span class="keyword">implements</span> <span class="title">IApplicationLike</span> </span>&#123;</div><div class="line">    Router router = Router.getInstance();</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.addService(Component1Service.class.getSimpleName(), <span class="keyword">new</span> Component1ServiceImpl());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.removeService(Component1Service.class.getSimpleName());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="app-调用-Component1"><a href="#app-调用-Component1" class="headerlink" title="app 调用 Component1"></a><strong>app 调用 Component1</strong></h4><p>1、修改<code>component_demo\app\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.dd.comgradle'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        applicationId <span class="string">"io.weichao.component_demo"</span></div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':component_service'</span>)</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">combuild &#123;</div><div class="line">    applicationName = <span class="string">'io.weichao.component_demo.MainApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2、修改<code>component_demo\app\src\main\java\io\weichao\component_demo\MainActivity.java</code>为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component_demo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.widget.Toast;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.router.Router;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.weichao.component_service.Component1Service;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        Router router = Router.getInstance();</div><div class="line">        <span class="keyword">if</span> (router.getService(Component1Service.class.getSimpleName()) != <span class="keyword">null</span>) &#123;</div><div class="line">            Component1Service service = (Component1Service) router.getService(Component1Service.class.getSimpleName());</div><div class="line">            Toast.makeText(<span class="keyword">this</span>, service.getComponentStr(), Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="报错：Library-projects-cannot-set-applicationId-applicationId-is-set-to-‘xx’-in-default-config"><a href="#报错：Library-projects-cannot-set-applicationId-applicationId-is-set-to-‘xx’-in-default-config" class="headerlink" title="报错：Library projects cannot set applicationId. applicationId is set to ‘xx’ in default config."></a><strong>报错：Library projects cannot set applicationId. applicationId is set to ‘xx’ in default config.</strong></h3><p>修改<code>component_demo\component1\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.dd.comgradle'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">combuild &#123;</div><div class="line">    applicationName = <span class="string">'com.luojilab.reader.runalone.application.ReaderApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="报错：Unable-to-find-source-java-class-‘xx’-because-it-does-not-belong-to-any-of-the-source-dirs-‘xx’"><a href="#报错：Unable-to-find-source-java-class-‘xx’-because-it-does-not-belong-to-any-of-the-source-dirs-‘xx’" class="headerlink" title="报错：Unable to find source java class: ‘xx’ because it does not belong to any of the source dirs: ‘xx’"></a><strong>报错：Unable to find source java class: ‘xx’ because it does not belong to any of the source dirs: ‘xx’</strong></h3><p>clean 项目。</p><h3 id="运行成功-1"><a href="#运行成功-1" class="headerlink" title="运行成功"></a><strong>运行成功</strong></h3><h2 id="UI-跳转"><a href="#UI-跳转" class="headerlink" title="UI 跳转"></a><strong>UI 跳转</strong></h2><h3 id="组件添加必要的依赖"><a href="#组件添加必要的依赖" class="headerlink" title="组件添加必要的依赖"></a><strong>组件添加必要的依赖</strong></h3><p>修改<code>component_demo\component1\build.gradle</code>为：</p><figure class="highlight gradle"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">apply plugin: <span class="string">'com.dd.comgradle'</span></div><div class="line"></div><div class="line">android &#123;</div><div class="line">    compileSdkVersion <span class="number">27</span></div><div class="line">    defaultConfig &#123;</div><div class="line">        minSdkVersion <span class="number">21</span></div><div class="line">        targetSdkVersion <span class="number">27</span></div><div class="line">        versionCode <span class="number">1</span></div><div class="line">        versionName <span class="string">"1.0"</span></div><div class="line">        javaCompileOptions &#123;</div><div class="line">            annotationProcessorOptions &#123;</div><div class="line">                arguments = [host: <span class="string">"component1"</span>]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    buildTypes &#123;</div><div class="line">        release &#123;</div><div class="line">            minifyEnabled <span class="keyword">false</span></div><div class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android.txt'</span>), <span class="string">'proguard-rules.pro'</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">dependencies</span> &#123;</div><div class="line">    implementation <span class="keyword">fileTree</span>(dir: <span class="string">'libs'</span>, <span class="keyword">include</span>: [<span class="string">'*.jar'</span>])</div><div class="line">    <span class="keyword">compile</span> <span class="keyword">project</span>(<span class="string">':component_service'</span>)</div><div class="line">    implementation <span class="string">'com.android.support:appcompat-v7:27.1.1'</span></div><div class="line">    annotationProcessor <span class="string">'com.github.jimu:router-anno-compiler:1.0.1'</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">combuild &#123;</div><div class="line">    applicationName = <span class="string">'io.weichao.component1.MainApplication'</span></div><div class="line">    isRegisterCompoAuto = <span class="keyword">true</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="注册组件到-UIRouter-中"><a href="#注册组件到-UIRouter-中" class="headerlink" title="注册组件到 UIRouter 中"></a><strong>注册组件到 UIRouter 中</strong></h3><p>修改<code>component_demo\component1\src\main\java\io\weichao\component1\Component1ApplicationLike.java</code>为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.applicationlike.IApplicationLike;</div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.router.Router;</div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.router.ui.UIRouter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.weichao.component_service.Component1Service;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Component1ApplicationLike</span> <span class="keyword">implements</span> <span class="title">IApplicationLike</span> </span>&#123;</div><div class="line">    Router router = Router.getInstance();</div><div class="line">    UIRouter uiRouter = UIRouter.getInstance();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.addService(Component1Service.class.getSimpleName(), <span class="keyword">new</span> Component1ServiceImpl());</div><div class="line">        uiRouter.registerUI(<span class="string">"component1"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        router.removeService(Component1Service.class.getSimpleName());</div><div class="line">        uiRouter.unregisterUI(<span class="string">"component1"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="目标页面添加注解"><a href="#目标页面添加注解" class="headerlink" title="目标页面添加注解"></a><strong>目标页面添加注解</strong></h3><p>修改<code>component_demo\component1\src\main\java\io\weichao\component1\MainActivity.java</code>为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component1;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.text.TextUtils;</div><div class="line"><span class="keyword">import</span> android.widget.TextView;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.service.AutowiredService;</div><div class="line"><span class="keyword">import</span> com.luojilab.router.facade.annotation.Autowired;</div><div class="line"><span class="keyword">import</span> com.luojilab.router.facade.annotation.RouteNode;</div><div class="line"></div><div class="line"><span class="meta">@RouteNode</span>(path = <span class="string">"/main"</span>, desc = <span class="string">"主页面"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@Autowired</span></div><div class="line">    String arg;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.component1_activity_main);</div><div class="line">        TextView tv = findViewById(R.id.textview);</div><div class="line"></div><div class="line">        AutowiredService.Factory.getSingletonImpl().autowire(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(arg)) &#123;</div><div class="line">            tv.setText(arg);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Intent intent = <span class="keyword">new</span> Intent();</div><div class="line">        intent.putExtra(<span class="string">"callbackArg"</span>, <span class="string">"success"</span>);</div><div class="line">        setResult(RESULT_OK, intent);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="跳转"><a href="#跳转" class="headerlink" title="跳转"></a><strong>跳转</strong></h3><p>1、修改<code>component_demo\app\src\main\res\layout\activity_main.xml</code>为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">"vertical"</span></span></div><div class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_bundle"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"Bundle 方式"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_uri"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"URI 方式"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_callback"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"有 callback 方式"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>2、修改<code>component_demo\app\src\main\java\io\weichao\component_demo\MainActivity.java</code>为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.component_demo;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Intent;</div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.text.TextUtils;</div><div class="line"><span class="keyword">import</span> android.view.View;</div><div class="line"><span class="keyword">import</span> android.widget.Button;</div><div class="line"><span class="keyword">import</span> android.widget.Toast;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.router.Router;</div><div class="line"><span class="keyword">import</span> com.luojilab.component.componentlib.router.ui.UIRouter;</div><div class="line"></div><div class="line"><span class="keyword">import</span> io.weichao.component_service.Component1Service;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        Button bundleBtn = findViewById(R.id.btn_bundle);</div><div class="line">        Button uriBtn = findViewById(R.id.btn_uri);</div><div class="line">        Button callbackBtn = findViewById(R.id.btn_callback);</div><div class="line">        bundleBtn.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        uriBtn.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        callbackBtn.setOnClickListener(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        Router router = Router.getInstance();</div><div class="line">        <span class="keyword">if</span> (router.getService(Component1Service.class.getSimpleName()) != <span class="keyword">null</span>) &#123;</div><div class="line">            Component1Service service = (Component1Service) router.getService(Component1Service.class.getSimpleName());</div><div class="line">            Toast.makeText(<span class="keyword">this</span>, service.getComponentStr(), Toast.LENGTH_LONG).show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        String arg = <span class="string">"app arg"</span>;</div><div class="line"></div><div class="line">        Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">        bundle.putString(<span class="string">"arg"</span>, arg);</div><div class="line"></div><div class="line">        <span class="keyword">final</span> String URI_LEGAL = <span class="string">"DDComp://component1/main?arg="</span> + arg;</div><div class="line"></div><div class="line">        <span class="keyword">switch</span> (v.getId()) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_bundle:</div><div class="line">                UIRouter.getInstance().openUri(<span class="keyword">this</span>, <span class="string">"DDComp://component1/main"</span>, bundle);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.btn_uri:</div><div class="line">                UIRouter.getInstance().openUri(<span class="keyword">this</span>, URI_LEGAL, <span class="keyword">null</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.btn_callback:</div><div class="line">                UIRouter.getInstance().openUri(<span class="keyword">this</span>, URI_LEGAL, <span class="keyword">null</span>, <span class="number">7777</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, data);</div><div class="line">        <span class="keyword">if</span> (data != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (requestCode == <span class="number">7777</span> &amp;&amp; resultCode == RESULT_OK) &#123;</div><div class="line">                String callbackArg = data.getStringExtra(<span class="string">"callbackArg"</span>);</div><div class="line">                <span class="keyword">if</span> (!TextUtils.isEmpty(callbackArg)) &#123;</div><div class="line">                    Toast.makeText(<span class="keyword">this</span>, callbackArg, Toast.LENGTH_LONG).show();</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="报错：android-content-ActivityNotFoundException-Unable-to-find-explicit-activity-class-xxActivity-have-you-declared-this-activity-in-your-AndroidManifest-xml"><a href="#报错：android-content-ActivityNotFoundException-Unable-to-find-explicit-activity-class-xxActivity-have-you-declared-this-activity-in-your-AndroidManifest-xml" class="headerlink" title="报错：android.content.ActivityNotFoundException: Unable to find explicit activity class {xxActivity}; have you declared this activity in your AndroidManifest.xml?"></a><strong>报错：android.content.ActivityNotFoundException: Unable to find explicit activity class {xxActivity}; have you declared this activity in your AndroidManifest.xml?</strong></h4><p>修改<code>component_demo\component1\src\main\AndroidManifest.xml</code>为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"io.weichao.component1"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">application</span></span></div><div class="line"><span class="tag">        <span class="attr">android:allowBackup</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:icon</span>=<span class="string">"@mipmap/ic_launcher"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:label</span>=<span class="string">"@string/app_name"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:roundIcon</span>=<span class="string">"@mipmap/ic_launcher_round"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:supportsRtl</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:theme</span>=<span class="string">"@style/AppTheme"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">".MainActivity"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></div></pre></td></tr></table></figure><h4 id="报错：java-lang-NoSuchFieldError-No-field-xx-in-class-Lxx-R-id-or-its-superclasses-declaration-of-‘xx-R-id’-appears-in-data-app-xx-base-apk"><a href="#报错：java-lang-NoSuchFieldError-No-field-xx-in-class-Lxx-R-id-or-its-superclasses-declaration-of-‘xx-R-id’-appears-in-data-app-xx-base-apk" class="headerlink" title="报错：java.lang.NoSuchFieldError: No field xx in class Lxx/R$id; or its superclasses (declaration of ‘xx.R$id’ appears in /data/app/xx/base.apk)"></a><strong>报错：java.lang.NoSuchFieldError: No field xx in class Lxx/R$id; or its superclasses (declaration of ‘xx.R$id’ appears in /data/app/xx/base.apk)</strong></h4><p>重命名<code>component_demo\component1\src\main\res\layout\activity_main.xml</code>为<code>component_demo\component1\src\main\res\layout\component1_activity_main.xml</code>。</p><p>修改<code>component_demo\component1\src\main\res\layout\component1_activity_main.xml</code>为：</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">".MainActivity"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/textview"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"component1"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="运行成功-2"><a href="#运行成功-2" class="headerlink" title="运行成功"></a><strong>运行成功</strong></h3><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://ww
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>使用 libstreaming 实现同屏时的代码执行流程</title>
    <link href="http://www.weichao.io/2018/03/11/%E4%BD%BF%E7%94%A8-libstreaming-%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F%E6%97%B6%E7%9A%84%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B/"/>
    <id>http://www.weichao.io/2018/03/11/使用-libstreaming-实现同屏时的代码执行流程/</id>
    <published>2018-03-11T10:39:10.000Z</published>
    <updated>2018-03-11T10:45:16.396Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://github.com/fyhertz/libstreaming" title="https://github.com/fyhertz/libstreaming" target="_blank" rel="external">libstreaming</a></li><li><a href="https://github.com/weichao66666/MediaMirror" title="https://github.com/weichao66666/MediaMirror" target="_blank" rel="external">MediaMirror</a></li></ul><hr><h1 id="概述"><a href="#概述" class="headerlink" title="概述"></a><strong>概述</strong></h1><p>实现同屏需要一个服务端和至少一个客户端。服务端是发送音视频数据的，数据来源可以是相机、屏幕捕捉等。客户端是接收音视频数据的，接收到的数据会实时在屏幕上显示。</p><p><code>MediaMirror</code>是<code>libstreaming</code>的 demo，实现了服务端通过相机采集数据，并发送数据给客户端，客户端实时在屏幕上显示的功能。</p><p>实现同屏的操作是：<br>1、服务端和客户端连接同一个 AP。<br>2、服务端安装在 Android 6.0+ 系统上需要手动授权。<br>3、客户端需要修改 IP 地址指向服务端。<br>4、先启动服务端，再启动客户端。</p><p><code>MediaMirror</code>基于<code>libstreaming</code>，对代码有修改，以下分析基于<code>MediaMirror</code>。</p><hr><h1 id="启动服务端"><a href="#启动服务端" class="headerlink" title="启动服务端"></a><strong>启动服务端</strong></h1><h2 id="入口-Activity"><a href="#入口-Activity" class="headerlink" title="入口 Activity"></a><strong>入口 Activity</strong></h2><p>代码很少，全部贴出来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">SurfaceHolder</span>.<span class="title">Callback</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> SurfaceView surfaceView;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Session session;</div><div class="line">    <span class="keyword">private</span> RtspServer rtspServer;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        surfaceView = findViewById(R.id.surface);</div><div class="line"></div><div class="line">        surfaceView.getHolder().addCallback(<span class="keyword">this</span>);</div><div class="line">        startRtspServer();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        stopRtspServer();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startRtspServer</span><span class="params">()</span> </span>&#123;</div><div class="line">        rtspServer = <span class="keyword">new</span> RtspServer();</div><div class="line">        rtspServer.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopRtspServer</span><span class="params">()</span> </span>&#123;</div><div class="line">        rtspServer.stop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildSession</span><span class="params">()</span> </span>&#123;</div><div class="line">        session = SessionBuilder.getInstance()</div><div class="line">                .setSurfaceView(surfaceView)</div><div class="line">                .setPreviewOrientation(<span class="number">90</span>)</div><div class="line">                .setContext(<span class="keyword">this</span>)</div><div class="line">                .setAudioEncoder(SessionBuilder.AUDIO_AAC)</div><div class="line">                .setAudioQuality(<span class="keyword">new</span> AudioQuality(<span class="number">16000</span>, <span class="number">32000</span>))</div><div class="line">                .setVideoEncoder(SessionBuilder.VIDEO_H264)</div><div class="line">                .setVideoQuality(<span class="keyword">new</span> VideoQuality(<span class="number">320</span>, <span class="number">240</span>, <span class="number">20</span>, <span class="number">500000</span>))</div><div class="line">                .build();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*SurfaceHolder.Callback start*/</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</div><div class="line">        buildSession();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="keyword">int</span> format, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</div><div class="line">        session.release();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*SurfaceHolder.Callback end*/</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>布局文件中只有一个普通的<code>SurfaceView</code>，在<code>SurfaceView</code>回调<code>surfaceCreated(SurfaceHolder holder)</code>方法时会调用<code>buildSession()</code>方法，<code>buildSession()</code>设置了<code>Session</code>的参数并最终调用<code>SessionBuilder#build()</code>方法进行初始化。</p><p>然后，创建了<code>RtspServer</code>实例并启动。</p><h3 id="SessionBuilder-build"><a href="#SessionBuilder-build" class="headerlink" title="SessionBuilder#build()"></a><strong>SessionBuilder#build()</strong></h3><p>创建 H.264 视频的对应流并设置给<code>Session</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">H264Stream stream = <span class="keyword">new</span> H264Stream(mCameraFacing);</div><div class="line"><span class="keyword">if</span> (mContext != <span class="keyword">null</span>) &#123;</div><div class="line">    stream.setSharedPreferences(PreferenceManager.getDefaultSharedPreferences(mContext));</div><div class="line">&#125;</div><div class="line">session.addVideoTrack(stream);</div></pre></td></tr></table></figure><p>创建 AAC 音频的对应流并设置给<code>Session</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AacStream stream = <span class="keyword">new</span> AacStream();</div><div class="line">session.addAudioTrack(stream);</div><div class="line"><span class="keyword">if</span> (mContext != <span class="keyword">null</span>) &#123;</div><div class="line">    stream.setPreferences(PreferenceManager.getDefaultSharedPreferences(mContext));</div><div class="line">&#125;</div></pre></td></tr></table></figure><h4 id="H264Stream-构造函数"><a href="#H264Stream-构造函数" class="headerlink" title="H264Stream 构造函数"></a><strong>H264Stream 构造函数</strong></h4><p><code>H264Stream</code>是<code>VideoStream</code>的子类，这里调用了<code>VideoStream</code>的有参构造函数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">super</span>(cameraId);</div></pre></td></tr></table></figure><p>创建了<code>H264Packetizer</code>实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">packetizer = <span class="keyword">new</span> H264Packetizer();</div></pre></td></tr></table></figure><h5 id="VideoStream-有参构造函数"><a href="#VideoStream-有参构造函数" class="headerlink" title="VideoStream 有参构造函数"></a><strong>VideoStream 有参构造函数</strong></h5><p><code>VideoStream</code>是<code>MediaStream</code>的子类，这里调用了<code>MediaStream</code>的无参构造函数。</p><h5 id="H264Packetizer-构造函数"><a href="#H264Packetizer-构造函数" class="headerlink" title="H264Packetizer 构造函数"></a><strong>H264Packetizer 构造函数</strong></h5><p><code>H264Packetizer</code>是<code>AbstractPacketizer</code>的子类，这里调用了<code>AbstractPacketizer</code>的无参构造函数。</p><h6 id="AbstractPacketizer-构造函数"><a href="#AbstractPacketizer-构造函数" class="headerlink" title="AbstractPacketizer 构造函数"></a><strong>AbstractPacketizer 构造函数</strong></h6><p>创建了<code>RtpSocket</code>实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rtpSocket = <span class="keyword">new</span> RtpSocket();</div></pre></td></tr></table></figure><p>####### <strong>RtpSocket 构造函数</strong></p><p>创建 UDP 的数据包数组：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">datagramPackets = <span class="keyword">new</span> DatagramPacket[bufferCount];</div></pre></td></tr></table></figure><p>创建<code>MulticastSocket</code>实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">multicastSocket = <span class="keyword">new</span> MulticastSocket();</div></pre></td></tr></table></figure><h4 id="AacStream-构造函数"><a href="#AacStream-构造函数" class="headerlink" title="AacStream 构造函数"></a><strong>AacStream 构造函数</strong></h4><p><code>AacStream</code>是<code>AudioStream</code>的子类，这里调用了<code>AudioStream</code>的无参构造函数。</p><h5 id="AudioStream-构造函数"><a href="#AudioStream-构造函数" class="headerlink" title="AudioStream 构造函数"></a><strong>AudioStream 构造函数</strong></h5><p><code>AudioStream</code>是<code>MediaStream</code>的子类，这里调用了<code>MediaStream</code>的无参构造函数。</p><h3 id="RtspServer-start"><a href="#RtspServer-start" class="headerlink" title="RtspServer#start()"></a><strong>RtspServer#start()</strong></h3><p>创建<code>RequestListener</code>实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">requestListener = <span class="keyword">new</span> RequestListener();</div></pre></td></tr></table></figure><h4 id="RequestListener-构造函数"><a href="#RequestListener-构造函数" class="headerlink" title="RequestListener 构造函数"></a><strong>RequestListener 构造函数</strong></h4><p><code>RequestListener</code>是一个线程，在构造函数中会创建<code>ServerSocket</code>实例，并开启这个线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">serverSocket = <span class="keyword">new</span> ServerSocket(port);</div><div class="line">start();</div></pre></td></tr></table></figure><h5 id="RequestListener-run"><a href="#RequestListener-run" class="headerlink" title="RequestListener#run()"></a><strong>RequestListener#run()</strong></h5><p>创建<code>WorkerThread</code>实例，<code>WorkerThread</code>同样是个线程，创建后立刻开启线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> WorkerThread(serverSocket.accept()).start();</div></pre></td></tr></table></figure><h6 id="WorkerThread-有参构造函数"><a href="#WorkerThread-有参构造函数" class="headerlink" title="WorkerThread 有参构造函数"></a><strong>WorkerThread 有参构造函数</strong></h6><p>创建客户端输入流的缓冲流和输出流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mInput = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(client.getInputStream()));</div><div class="line">mOutput = client.getOutputStream();</div></pre></td></tr></table></figure><p>创建<code>Session</code>实例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session = <span class="keyword">new</span> Session();</div></pre></td></tr></table></figure><p>####### <strong>WorkerThread#run()</strong></p><p>等待客户端连接，如果接收到客户端请求，解析该请求，并做出对应的响应，最后发送响应给客户端。</p><p>当客户端断开连接后，停止流传输并释放资源：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">boolean</span> streaming = isStreaming();</div><div class="line">session.syncStop();</div><div class="line"><span class="keyword">if</span> (streaming &amp;&amp; !isStreaming()) &#123;</div><div class="line">    postMessage(MESSAGE_STREAMING_STOPPED);</div><div class="line">&#125;</div><div class="line">session.release();</div><div class="line"></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    mClient.close();</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">    e.printStackTrace();</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="启动客户端"><a href="#启动客户端" class="headerlink" title="启动客户端"></a><strong>启动客户端</strong></h1><h2 id="入口-Activity-1"><a href="#入口-Activity-1" class="headerlink" title="入口 Activity"></a><strong>入口 Activity</strong></h2><p>代码很少，全部贴出来：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> <span class="keyword">implements</span> <span class="title">SurfaceHolder</span>.<span class="title">Callback</span>, <span class="title">MediaPlayer</span>.<span class="title">OnPreparedListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VIDEO_URL_HOST = <span class="string">"192.168.0.114"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String VIDEO_URL_PORT = <span class="string">"8086"</span>;<span class="comment">// RtspServer.DEFAULT_RTSP_PORT</span></div><div class="line"></div><div class="line">    <span class="keyword">private</span> SurfaceView surfaceView;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MediaPlayer mediaPlayer;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        surfaceView = findViewById(R.id.surface);</div><div class="line"></div><div class="line">        surfaceView.getHolder().addCallback(<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">configureMediaPlayer</span><span class="params">(Uri videoUri)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mediaPlayer == <span class="keyword">null</span>) &#123;</div><div class="line">            mediaPlayer = <span class="keyword">new</span> MediaPlayer();</div><div class="line">        &#125;</div><div class="line">        mediaPlayer.setDisplay(surfaceView.getHolder());</div><div class="line">        mediaPlayer.setOnPreparedListener(<span class="keyword">this</span>);</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            mediaPlayer.setDataSource(<span class="keyword">this</span>, videoUri);</div><div class="line">            mediaPlayer.prepareAsync();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">releaseMediaPlayer</span><span class="params">()</span> </span>&#123;</div><div class="line">        surfaceView.getHolder().removeCallback(<span class="keyword">this</span>);</div><div class="line">        mediaPlayer.release();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*SurfaceHolder.Callback start*/</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceCreated</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</div><div class="line">        StringBuilder videoUrlBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">        videoUrlBuilder.append(<span class="string">"rtsp://"</span> + VIDEO_URL_HOST + <span class="string">":"</span> + VIDEO_URL_PORT + <span class="string">"/"</span>);</div><div class="line">        Uri videoUri = Uri.parse(videoUrlBuilder.toString());</div><div class="line">        configureMediaPlayer(videoUri);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceChanged</span><span class="params">(SurfaceHolder holder, <span class="keyword">int</span> format, <span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">surfaceDestroyed</span><span class="params">(SurfaceHolder holder)</span> </span>&#123;</div><div class="line">        releaseMediaPlayer();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*SurfaceHolder.Callback end*/</span></div><div class="line"></div><div class="line">    <span class="comment">/*MediaPlayer.OnPreparedListener start*/</span></div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(MediaPlayer mp)</span> </span>&#123;</div><div class="line">        mp.start();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/*MediaPlayer.OnPreparedListener end*/</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>布局文件中只有一个 Android 原生的<code>VideoView</code>，<code>VideoView</code>是<code>SurfaceView</code>的子类，在<code>SurfaceView</code>回调<code>surfaceCreated(SurfaceHolder holder)</code>方法时，调用<code>configureMediaPlayer()</code>方法，该方法中会创建<code>MediaPlayer</code>实例，并在设置<code>MediaPlayer</code>的参数后开始准备，最后在<code>onPrepared(MediaPlayer mp)</code>回调中开始播放。</p><p><code>VideoView</code>支持<code>RTSP</code>，<code>RTSP</code>请求都是自发的。</p><h3 id="服务端接收到请求"><a href="#服务端接收到请求" class="headerlink" title="服务端接收到请求"></a><strong>服务端接收到请求</strong></h3><p>解析该请求：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">request = Request.parseRequest(mInput);</div></pre></td></tr></table></figure><p>并做出对应的响应：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response = processRequest(request);</div></pre></td></tr></table></figure><p>最后发送响应给客户端。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">response.send(mOutput);</div></pre></td></tr></table></figure><h4 id="RtspServer-processRequest-Request-request"><a href="#RtspServer-processRequest-Request-request" class="headerlink" title="RtspServer#processRequest(Request request)"></a><strong>RtspServer#processRequest(Request request)</strong></h4><p>该方法会根据不同的客户端请求，执行相应处理，并拼接响应报文，最后返回给客户端。</p><p>1、当是<code>DESCRIBE</code>请求时，调用了<code>handleRequest()</code>方法（该方法创建了<code>Session</code>，所以该请求是建立同步的入口）：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session = handleRequest(request.uri, mClient);</div></pre></td></tr></table></figure><p>拼接会话描述信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">builder.append(<span class="string">"Content-Base: "</span> + mClient.getLocalAddress().getHostAddress() + <span class="string">":"</span> + mClient.getLocalPort() + <span class="string">"/"</span>)<span class="comment">// Content-Base: 10.4.70.229:8086/</span></div><div class="line">        .append(<span class="string">"\r\n"</span>)</div><div class="line">        .append(<span class="string">"Content-Type: application/sdp"</span>)<span class="comment">// Content-Type: application/sdp</span></div><div class="line">        .append(<span class="string">"\r\n"</span>);</div><div class="line">response.attributes = builder.toString();</div><div class="line">response.content = session.getSessionDescription();</div><div class="line">response.status = Response.STATUS_OK;</div></pre></td></tr></table></figure><p>2、当是<code>SETUP</code>请求时，会将音视频通道分别映射到客户端指定的端口，如果客户端没有指定端口，则使用默认端口：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Pattern pattern;</div><div class="line">Matcher matcher;</div><div class="line"><span class="keyword">int</span> port1, port2, ssrc, trackId, src[];</div><div class="line">String destination;</div><div class="line"></div><div class="line">pattern = Pattern.compile(<span class="string">"trackID=(\\w+)"</span>, Pattern.CASE_INSENSITIVE);</div><div class="line">matcher = pattern.matcher(request.uri);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!matcher.find()) &#123;</div><div class="line">    response.status = Response.STATUS_BAD_REQUEST;</div><div class="line">    <span class="keyword">return</span> response;</div><div class="line">&#125;</div><div class="line"></div><div class="line">trackId = Integer.parseInt(matcher.group(<span class="number">1</span>));</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!session.isTrackExist(trackId)) &#123;</div><div class="line">    response.status = Response.STATUS_NOT_FOUND;</div><div class="line">    <span class="keyword">return</span> response;</div><div class="line">&#125;</div><div class="line"></div><div class="line">pattern = Pattern.compile(<span class="string">"client_port=(\\d+)-(\\d+)"</span>, Pattern.CASE_INSENSITIVE);</div><div class="line">matcher = pattern.matcher(request.headers.get(<span class="string">"transport"</span>));</div><div class="line">IStream track = session.getTrack(trackId);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (!matcher.find()) &#123;</div><div class="line">    <span class="keyword">int</span>[] ports = track.getDestinationPorts();</div><div class="line">    port1 = ports[<span class="number">0</span>];</div><div class="line">    port2 = ports[<span class="number">1</span>];</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    port1 = Integer.parseInt(matcher.group(<span class="number">1</span>));</div><div class="line">    port2 = Integer.parseInt(matcher.group(<span class="number">2</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line">ssrc = track.getSsrc();</div><div class="line">src = track.getLocalPorts();</div><div class="line">destination = session.getDestination();</div><div class="line"></div><div class="line">track.setDestinationPorts(port1, port2);</div></pre></td></tr></table></figure><p>调用了<code>Session#syncStart()</code>方法，该方法用于开始同步：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">session.syncStart(trackId);</div></pre></td></tr></table></figure><p>拼接会话描述信息：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">StringBuilder builder = <span class="keyword">new</span> StringBuilder();</div><div class="line">builder.append(<span class="string">"Transport: RTP/AVP/UDP;"</span> + (InetAddress.getByName(destination).isMulticastAddress() ? <span class="string">"multicast"</span> : <span class="string">"unicast"</span>)</div><div class="line">        + <span class="string">";destination="</span> + session.getDestination()</div><div class="line">        + <span class="string">";client_port="</span> + port1 + <span class="string">"-"</span> + port2</div><div class="line">        + <span class="string">";server_port="</span> + src[<span class="number">0</span>] + <span class="string">"-"</span> + src[<span class="number">1</span>]</div><div class="line">        + <span class="string">";ssrc="</span> + Integer.toHexString(ssrc)</div><div class="line">        + <span class="string">";mode=play"</span></div><div class="line">)<span class="comment">// Transport: RTP/AVP/UDP;unicast;destination=10.4.70.110;client_port=57148-57149;server_port=39848-33032;ssrc=4b5eeef9;mode=play</span></div><div class="line">        .append(<span class="string">"\r\n"</span>)</div><div class="line">        .append(<span class="string">"Session: "</span> + <span class="string">"1185d20035702ca"</span>)<span class="comment">// Session: 1185d20035702ca</span></div><div class="line">        .append(<span class="string">"\r\n"</span>)</div><div class="line">        .append(<span class="string">"Cache-Control: no-cache"</span>)<span class="comment">// Cache-Control: no-cache</span></div><div class="line">        .append(<span class="string">"\r\n"</span>);</div><div class="line">response.attributes = builder.toString();</div><div class="line">response.status = Response.STATUS_OK;</div></pre></td></tr></table></figure><h5 id="RtspServer-handleRequest-String-uri-Socket-client"><a href="#RtspServer-handleRequest-String-uri-Socket-client" class="headerlink" title="RtspServer#handleRequest(String uri, Socket client)"></a><strong>RtspServer#handleRequest(String uri, Socket client)</strong></h5><p>调用了<code>UriParser#parse()</code>方法，该方法用于解析客户端传递的参数：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Session session = UriParser.parse(uri);</div></pre></td></tr></table></figure><p>设置会话的源地址和目的地址：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">session.setOrigin(client.getLocalAddress().getHostAddress());</div><div class="line"><span class="keyword">if</span> (session.getDestination() == <span class="keyword">null</span>) &#123;</div><div class="line">    session.setDestination(client.getInetAddress().getHostAddress());</div><div class="line">&#125;</div></pre></td></tr></table></figure><h5 id="Session-syncStart-int-id"><a href="#Session-syncStart-int-id" class="headerlink" title="Session#syncStart(int id)"></a><strong>Session#syncStart(int id)</strong></h5><p>开始同步流：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">stream.start();</div></pre></td></tr></table></figure><p>对于<code>H264</code>视频，依次调用了<code>H264Stream#start()</code>-&gt;<code>VideoStream#start()</code>-&gt;<code>MediaStream#start()</code>-&gt;<code>MediaStream#encodeWithMediaCodec()</code>-&gt;<code>VideoStream#encodeWithMediaCodec()</code>-&gt;<code>VideoStream#encodeWithMediaCodecMethod1()</code>。</p><h6 id="VideoStream-encodeWithMediaCodecMethod1"><a href="#VideoStream-encodeWithMediaCodecMethod1" class="headerlink" title="VideoStream#encodeWithMediaCodecMethod1()"></a><strong>VideoStream#encodeWithMediaCodecMethod1()</strong></h6><p>开始相机预览：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">camera.startPreview();</div></pre></td></tr></table></figure><p>调试编码参数后运行编码器：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">EncoderDebugger debugger = EncoderDebugger.debug(mSharedPreferences, mQuality.resX, mQuality.resY);</div><div class="line"><span class="keyword">final</span> Nv21Convertor convertor = debugger.getNv21Convertor();</div><div class="line">mediaCodec = MediaCodec.createByCodecName(debugger.getEncoderName());</div><div class="line">MediaFormat mediaFormat = MediaFormat.createVideoFormat(<span class="string">"video/avc"</span>, mQuality.resX, mQuality.resY);</div><div class="line">mediaFormat.setInteger(MediaFormat.KEY_BIT_RATE, mQuality.bitrate);</div><div class="line">mediaFormat.setInteger(MediaFormat.KEY_FRAME_RATE, mQuality.framerate);</div><div class="line">mediaFormat.setInteger(MediaFormat.KEY_COLOR_FORMAT, debugger.getEncoderColorFormat());</div><div class="line">mediaFormat.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, <span class="number">1</span>);</div><div class="line">mediaCodec.configure(mediaFormat, <span class="keyword">null</span>, <span class="keyword">null</span>, MediaCodec.CONFIGURE_FLAG_ENCODE);</div><div class="line">mediaCodec.start();</div></pre></td></tr></table></figure><p>将预览回调的帧数据进行转换，再由编码器编码：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</div><div class="line">    camera.addCallbackBuffer(<span class="keyword">new</span> <span class="keyword">byte</span>[convertor.getBufferSize()]);</div><div class="line">&#125;</div><div class="line">camera.setPreviewCallbackWithBuffer(<span class="keyword">new</span> Camera.PreviewCallback() &#123;</div><div class="line">    ByteBuffer[] inputBuffers = mediaCodec.getInputBuffers();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onPreviewFrame</span><span class="params">(<span class="keyword">byte</span>[] data, Camera camera)</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="keyword">int</span> bufferIndex = mediaCodec.dequeueInputBuffer(<span class="number">500000</span>);</div><div class="line">            <span class="keyword">if</span> (bufferIndex &gt;= <span class="number">0</span>) &#123;</div><div class="line">                inputBuffers[bufferIndex].clear();</div><div class="line">                <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"Symptom of the \"Callback buffer was to small\" problem..."</span>);</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    convertor.convert(data, inputBuffers[bufferIndex]);</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">long</span> now = System.nanoTime() / <span class="number">1000</span>;</div><div class="line">                mediaCodec.queueInputBuffer(bufferIndex, <span class="number">0</span>, inputBuffers[bufferIndex].position(), now, <span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                Log.e(TAG, <span class="string">"No buffer available !"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            VideoStream.<span class="keyword">this</span>.camera.addCallbackBuffer(data);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>将数据写入打包器，启动打包器线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">packetizer.setInputStream(<span class="keyword">new</span> MediaCodecInputStream(mediaCodec));</div><div class="line">packetizer.start();</div></pre></td></tr></table></figure><p>####### <strong>H264Packetizer#run()</strong></p><p>调用了<code>send()</code>方法发送数据。</p><p>######## <strong>H264Packetizer#send()</strong></p><p>生成<code>NAL</code>单元<code>LENGTH</code>：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fill(header, <span class="number">0</span>, NALU_LENGTH_LENGTH);</div></pre></td></tr></table></figure><p>生成时间戳和<code>NAL</code>单元长度：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">timestamp = ((MediaCodecInputStream) inputStream).getLastBufferInfo().presentationTimeUs * <span class="number">1000L</span>;</div><div class="line">naluLength = inputStream.available() + <span class="number">1</span>;</div></pre></td></tr></table></figure><p>如果出现<code>NAL</code>单元类型为<code>IDR</code>类型，需要调用<code>AbstractPacketizer#send()</code>方法发送该数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">buffer = rtpSocket.requestBuffer();</div><div class="line">rtpSocket.markNextPacket();</div><div class="line">rtpSocket.updateTimestamp(timestamp);</div><div class="line">System.arraycopy(mStapA, <span class="number">0</span>, buffer, RtpSocket.RTP_HEADER_LENGTH, mStapA.length);</div><div class="line"><span class="keyword">super</span>.send(RtpSocket.RTP_HEADER_LENGTH + mStapA.length);</div></pre></td></tr></table></figure><p>如果<code>NAL</code>长度低于设置的最大包大小，会调用<code>AbstractPacketizer#send()</code>方法发送该数据，否则，拆分<code>NAL</code>单元为<code>FU-A</code>单元再调用<code>AbstractPacketizer#send()</code>方法发送：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Small NAL unit =&gt; Single NAL unit</span></div><div class="line"><span class="keyword">if</span> (naluLength &lt;= MAX_PACKET_SIZE - RtpSocket.RTP_HEADER_LENGTH - <span class="number">2</span>) &#123;</div><div class="line">    buffer = rtpSocket.requestBuffer();</div><div class="line">    <span class="comment">// RTP 头后面的一个字节用于表示前一个 NALU 的长度</span></div><div class="line">    buffer[RtpSocket.RTP_HEADER_LENGTH] = header[<span class="number">4</span>];</div><div class="line">    fill(buffer, RtpSocket.RTP_HEADER_LENGTH + <span class="number">1</span>, naluLength - <span class="number">1</span>);</div><div class="line">    rtpSocket.updateTimestamp(timestamp);</div><div class="line">    rtpSocket.markNextPacket();</div><div class="line">    <span class="keyword">super</span>.send(naluLength + RtpSocket.RTP_HEADER_LENGTH);</div><div class="line">    <span class="comment">// Log.d(TAG,"----- Single NAL unit - len:"+len+" delay: "+delay);</span></div><div class="line">&#125;</div><div class="line"><span class="comment">// Large NAL unit =&gt; Split nal unit</span></div><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// Set FU-A header</span></div><div class="line">    header[<span class="number">1</span>] = (<span class="keyword">byte</span>) (header[<span class="number">4</span>] &amp; <span class="number">0x1F</span>);  <span class="comment">// FU header type</span></div><div class="line">    header[<span class="number">1</span>] += <span class="number">0x80</span>; <span class="comment">// Start bit</span></div><div class="line">    <span class="comment">// Set FU-A indicator</span></div><div class="line">    header[<span class="number">0</span>] = (<span class="keyword">byte</span>) ((header[<span class="number">4</span>] &amp; <span class="number">0x60</span>) &amp; <span class="number">0xFF</span>); <span class="comment">// FU indicator NRI</span></div><div class="line">    header[<span class="number">0</span>] += <span class="number">28</span>;</div><div class="line"></div><div class="line">    <span class="keyword">while</span> (sum &lt; naluLength) &#123;</div><div class="line">        buffer = rtpSocket.requestBuffer();</div><div class="line">        buffer[RtpSocket.RTP_HEADER_LENGTH] = header[<span class="number">0</span>];</div><div class="line">        buffer[RtpSocket.RTP_HEADER_LENGTH + <span class="number">1</span>] = header[<span class="number">1</span>];</div><div class="line">        rtpSocket.updateTimestamp(timestamp);</div><div class="line">        <span class="keyword">if</span> ((len = fill(buffer, RtpSocket.RTP_HEADER_LENGTH + <span class="number">2</span>, Math.min(naluLength - sum, MAX_PACKET_SIZE - RtpSocket.RTP_HEADER_LENGTH - <span class="number">2</span>))) &lt; <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        sum += len;</div><div class="line">        <span class="comment">// Last packet before next NAL</span></div><div class="line">        <span class="comment">// 下一个 NAL 前的最后一个包</span></div><div class="line">        <span class="keyword">if</span> (sum &gt;= naluLength) &#123;</div><div class="line">            <span class="comment">// End bit on</span></div><div class="line">            buffer[RtpSocket.RTP_HEADER_LENGTH + <span class="number">1</span>] += <span class="number">0x40</span>;</div><div class="line">            rtpSocket.markNextPacket();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.send(len + RtpSocket.RTP_HEADER_LENGTH + <span class="number">2</span>);</div><div class="line">        <span class="comment">// Switch start bit</span></div><div class="line">        header[<span class="number">1</span>] = (<span class="keyword">byte</span>) (header[<span class="number">1</span>] &amp; <span class="number">0x7F</span>);</div><div class="line">        <span class="comment">// Log.d(TAG,"----- FU-A unit, sum:"+sum);</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>######### <strong>AbstractPacketizer#send(int length)</strong></p><p>调用了<code>RtpSocket#commitBuffer()</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rtpSocket.commitBuffer(length);</div></pre></td></tr></table></figure><p>########## <strong>RtpSocket#commitBuffer(int length)</strong></p><p>调用<code>updateSequence()</code>方法，<code>updateSequence()</code>方法调用了<code>setLong()</code>方法，<code>setLong()</code>方法用于扩充数组索引长度。原来是 1 个字节表示一个索引，则最多可以表示 256 个索引，现在用连续的 2 个字节表示一个索引。</p><p>设置<code>UDP</code>包当前索引对应数据的长度：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">datagramPackets[bufferInputIndex].setLength(length);</div></pre></td></tr></table></figure><p>如果<code>UDP</code>包下一个索引已超过设置的缓冲大小时，从头开始替换：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (++bufferInputIndex &gt;= bufferCount) &#123;</div><div class="line">    bufferInputIndex = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果<code>RtpSocket</code>线程未启动，则启动该线程：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mThread == <span class="keyword">null</span>) &#123;</div><div class="line">    mThread = <span class="keyword">new</span> Thread(<span class="keyword">this</span>);</div><div class="line">    mThread.start();</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>########### <strong>RtpSocket#run()</strong></p><p>调用<code>SenderReport#update()</code>方法更新数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">senderReport.update(datagramPackets[bufferOutputIndex].getLength(), (timestamps[bufferOutputIndex] / <span class="number">100L</span>) * (mClock / <span class="number">1000L</span>) / <span class="number">10000L</span>);</div></pre></td></tr></table></figure><p>忽略前 30 帧，之后发送缓冲区中的数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (count++ &gt; <span class="number">30</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (transport == TRANSPORT_UDP) &#123;</div><div class="line">        multicastSocket.send(datagramPackets[bufferOutputIndex]);<span class="comment">// TODO</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        sendTcp();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果<code>UDP</code>包下一个索引已超过设置的缓冲大小时，从头开始发送：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (++bufferOutputIndex &gt;= BUFFER_COUNT) &#123;</div><div class="line">    bufferOutputIndex = <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>############ <strong>SenderReport#update(int length, long rtpTimestamp)</strong></p><p>更新数据，最后调用了<code>send()</code>方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">send(System.nanoTime(), rtpTimestamp);</div></pre></td></tr></table></figure><p>############ <strong>SenderReport#send(long ntpTimestamp, long rtpTimestamp)</strong></p><p>发送<code>RTCP</code>数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">multicastSocket.send(datagramPacket);</div></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://gi
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>触摸事件传递机制</title>
    <link href="http://www.weichao.io/2018/03/04/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B6/"/>
    <id>http://www.weichao.io/2018/03/04/触摸事件传递机制/</id>
    <published>2018-03-04T15:19:30.000Z</published>
    <updated>2018-03-11T01:11:22.561Z</updated>
    
    <content type="html"><![CDATA[<h1 id="触摸事件传递的三个阶段"><a href="#触摸事件传递的三个阶段" class="headerlink" title="触摸事件传递的三个阶段"></a><strong>触摸事件传递的三个阶段</strong></h1><h2 id="分发"><a href="#分发" class="headerlink" title="分发"></a><strong>分发</strong></h2><p>分发对应<code>dispatchTouchEvent()</code>方法。<br>如果当前视图是<code>ViewGroup</code>及其子类，则会调用<code>onInterceptTouchEvent()</code>方法判断是否拦截该事件。<br>该方法返回<code>true</code>或<code>false</code>表示该事件被当前视图分发过，不继续分发该事件给子视图，其中<code>true</code>表示该事件被当前视图消费掉，<code>false</code>表示该事件未被当前视图消费掉；返回<code>super.dispatchTouchEvent()</code>表示继续分发该事件给子视图。<br>该事件将会按照嵌套层次从外向内传递，到达最内层的视图时，由该视图的<code>onTouchEvent()</code>方法处理，如果该方法能消费该事件，则返回<code>true</code>，如果消费不了，返回<code>false</code>，这时事件开始按照嵌套层次从内向外传递，并由外层的视图的 <code>onTouchEvent()</code>方法进行尝试消费，其中，返回<code>true</code>为消费完毕，返回<code>false</code>为未消费，可继续向外层传递。</p><h2 id="拦截"><a href="#拦截" class="headerlink" title="拦截"></a><strong>拦截</strong></h2><p>拦截对应<code>onInterceptTouchEvent()</code>方法。<br>该方法只在<code>ViewGroup</code>及其子类中存在，在<code>Activity</code>和<code>View</code>中不存在。<br>该方法返回<code>true</code>表示拦截该事件，不继续分发给子视图，同时交给自身的<code>onTouchEvent()</code>方法进行尝试消费，其中，返回<code>true</code>为消费完毕，返回<code>false</code>为未消费，可继续向外层传递；返回<code>false</code>或<code>super.onInterceptTouchEvent</code>表示不拦截该事件，继续分发给子视图。</p><h2 id="消费"><a href="#消费" class="headerlink" title="消费"></a><strong>消费</strong></h2><p>消费对应<code>onTouchEvent()</code>方法。<br>该方法返回<code>true</code>表示处理该事件，不传递该事件给父视图；返回<code>false</code>表示当前视图不处理该事件，传递该事件给父视图的<code>onTouchEvent()</code>方法尝试消费。</p><h1 id="其他说明"><a href="#其他说明" class="headerlink" title="其他说明"></a><strong>其他说明</strong></h1><ul><li>如果同时有<code>Activity</code>、<code>ViewGroup</code>、<code>View</code>时，嵌套层次由外向内是<code>Activity</code>、<code>ViewGroup</code>、<code>View</code>。</li><li><code>View</code>控件的事件触发顺序是先执行<code>onTouch()</code>方法，再执行<code>onClick()</code>方法。如果<code>onTouch()</code>方法中返回<code>true</code>，最后不会调用<code>onClick()</code>方法。</li><li>事件的类型有三种：<ul><li><code>ACTION_DOWN</code>：手指按下操作，表示触摸事件的开始。</li><li><code>ACTION_MOVE</code>：手指移动距离超过阈值会被计为一次<code>ACTION_MOVE</code>，所以一次完整的触摸事件可能包含多个<code>ACTION_MOVE</code>，也可能一个都没有。</li><li><code>ACTION_UP</code>：手指离开屏幕，表示触摸事件的结束。</li></ul></li><li>如果一层级的最外层控件的<code>dispatchTouchEvent()</code>方法返回<code>false</code>，该层级会不响应触摸事件并且事件也不会被消费，会继续让该层级后面的下一层级处理，相当于点击“穿透”了。</li></ul><hr><h1 id="验证触摸事件传递过程"><a href="#验证触摸事件传递过程" class="headerlink" title="验证触摸事件传递过程"></a><strong>验证触摸事件传递过程</strong></h1><h2 id="默认的传递过程"><a href="#默认的传递过程" class="headerlink" title="默认的传递过程"></a><strong>默认的传递过程</strong></h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a><strong>代码</strong></h3><p>1.Test_Touch\app\src\main\java\io\weichao\test_touch\MainActivity.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.test_touch;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.support.v7.app.AppCompatActivity;</div><div class="line"><span class="keyword">import</span> android.os.Bundle;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.MotionEvent;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"MainActivity dispatchTouchEvent"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"MainActivity onTouchEvent"</span>);</div><div class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"MainActivity onTouchEvent MotionEvent.ACTION_DOWN"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"MainActivity onTouchEvent MotionEvent.ACTION_MOVE"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"MainActivity onTouchEvent MotionEvent.ACTION_UP"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2.Test_Touch\app\src\main\res\layout\activity_main.xml</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">io.weichao.test_touch.CustomRelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/CustomRelativeLayout"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@android:color/holo_red_dark"</span></span></div><div class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"io.weichao.test_touch.MainActivity"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">io.weichao.test_touch.CustomButton</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/CustomButton"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"Button"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">io.weichao.test_touch.CustomRelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>3.Test_Touch\app\src\main\java\io\weichao\test_touch\CustomRelativeLayout.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.test_touch;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.util.AttributeSet;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.MotionEvent;</div><div class="line"><span class="keyword">import</span> android.widget.RelativeLayout;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by pi on 2017/7/27.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomRelativeLayout</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomRelativeLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomRelativeLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomRelativeLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomRelativeLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomRelativeLayout dispatchTouchEvent"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onInterceptTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomRelativeLayout onInterceptTouchEvent"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomRelativeLayout onTouchEvent"</span>);</div><div class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomRelativeLayout onTouchEvent MotionEvent.ACTION_DOWN"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomRelativeLayout onTouchEvent MotionEvent.ACTION_MOVE"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomRelativeLayout onTouchEvent MotionEvent.ACTION_UP"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>4.Test_Touch\app\src\main\java\io\weichao\test_touch\CustomButton.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> io.weichao.test_touch;</div><div class="line"></div><div class="line"><span class="keyword">import</span> android.content.Context;</div><div class="line"><span class="keyword">import</span> android.support.v7.widget.AppCompatButton;</div><div class="line"><span class="keyword">import</span> android.util.AttributeSet;</div><div class="line"><span class="keyword">import</span> android.util.Log;</div><div class="line"><span class="keyword">import</span> android.view.MotionEvent;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"><span class="comment"> * Created by pi on 2017/7/27.</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomButton</span> <span class="keyword">extends</span> <span class="title">AppCompatButton</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomButton</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomButton</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CustomButton</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomButton dispatchTouchEvent"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.dispatchTouchEvent(ev);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onTouchEvent</span><span class="params">(MotionEvent event)</span> </span>&#123;</div><div class="line">        Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomButton onTouchEvent"</span>);</div><div class="line">        <span class="keyword">switch</span> (event.getAction()) &#123;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomButton onTouchEvent MotionEvent.ACTION_DOWN"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomButton onTouchEvent MotionEvent.ACTION_MOVE"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</div><div class="line">                Log.d(<span class="string">"test_touch"</span>, <span class="string">"CustomButton onTouchEvent MotionEvent.ACTION_UP"</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onTouchEvent(event);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="显示的界面"><a href="#显示的界面" class="headerlink" title="显示的界面"></a><strong>显示的界面</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B61.png" alt=""></p><h3 id="点击下面的紫色区域，显示-log"><a href="#点击下面的紫色区域，显示-log" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B62.png" alt=""></p><p>按下会触发1次，弹起会触发1次，每判定出一次移动会触发1次。</p><h3 id="点击红色区域，显示-log"><a href="#点击红色区域，显示-log" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B63.png" alt=""></p><p>中间部分每判定出一次移动会触发1次，这里触发了3次。</p><h3 id="点击灰色区域，显示-log"><a href="#点击灰色区域，显示-log" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B64.png" alt=""></p><p>中间部分每判定出一次移动会触发1次，这里触发了3次。</p><h2 id="只修改-Activity"><a href="#只修改-Activity" class="headerlink" title="只修改 Activity"></a><strong>只修改 Activity</strong></h2><h3 id="只修改-dispatchTouchEvent-方法，返回-true-或-false"><a href="#只修改-dispatchTouchEvent-方法，返回-true-或-false" class="headerlink" title="只修改 dispatchTouchEvent()方法，返回 true 或 false"></a><strong>只修改 dispatchTouchEvent()方法，返回 true 或 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-1"><a href="#点击下面的紫色区域，显示-log-1" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B65.png" alt=""></p><h4 id="点击红色区域，显示-log-1"><a href="#点击红色区域，显示-log-1" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B66.png" alt=""></p><h4 id="点击灰色区域，显示-log-1"><a href="#点击灰色区域，显示-log-1" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B67.png" alt=""></p><h4 id="与默认的传递过程对比"><a href="#与默认的传递过程对比" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p>事件被<code>MainActivity</code>分发过，不管是否被消费，都不会再分发，所以不执行任何<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onTouchEvent-方法，返回-true-或-false"><a href="#只修改-onTouchEvent-方法，返回-true-或-false" class="headerlink" title="只修改 onTouchEvent()方法，返回 true 或 false"></a><strong>只修改 onTouchEvent()方法，返回 true 或 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-2"><a href="#点击下面的紫色区域，显示-log-2" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B68.png" alt=""></p><h4 id="点击红色区域，显示-log-2"><a href="#点击红色区域，显示-log-2" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B69.png" alt=""></p><h4 id="点击灰色区域，显示-log-2"><a href="#点击灰色区域，显示-log-2" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B610.png" alt=""></p><h4 id="与默认的传递过程对比-1"><a href="#与默认的传递过程对比-1" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p>无变化，但是返回<code>true</code>时最后不会调用<code>MainAcitivity</code>的<code>onClick()</code>方法。</p><h2 id="只修改-CustomRelativeLayout"><a href="#只修改-CustomRelativeLayout" class="headerlink" title="只修改 CustomRelativeLayout"></a><strong>只修改 CustomRelativeLayout</strong></h2><h3 id="只修改-dispatchTouchEvent-方法，返回-true"><a href="#只修改-dispatchTouchEvent-方法，返回-true" class="headerlink" title="只修改 dispatchTouchEvent()方法，返回 true"></a><strong>只修改 dispatchTouchEvent()方法，返回 true</strong></h3><h4 id="点击下面的紫色区域，显示-log-3"><a href="#点击下面的紫色区域，显示-log-3" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B611.png" alt=""></p><h4 id="点击红色区域，显示-log-3"><a href="#点击红色区域，显示-log-3" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B612.png" alt=""></p><h4 id="点击灰色区域，显示-log-3"><a href="#点击灰色区域，显示-log-3" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B613.png" alt=""></p><h4 id="与默认的传递过程对比-2"><a href="#与默认的传递过程对比-2" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p>事件被<code>CustomRelativeLayout</code>分发过，且被消费了，所以不执行任何<code>onTouchEvent()</code>方法。</p><h3 id="只修改-dispatchTouchEvent-方法，返回-false"><a href="#只修改-dispatchTouchEvent-方法，返回-false" class="headerlink" title="只修改 dispatchTouchEvent()方法，返回 false"></a><strong>只修改 dispatchTouchEvent()方法，返回 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-4"><a href="#点击下面的紫色区域，显示-log-4" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B614.png" alt=""></p><h4 id="点击红色区域，显示-log-4"><a href="#点击红色区域，显示-log-4" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B614_1.png" alt=""></p><h4 id="点击灰色区域，显示-log-4"><a href="#点击灰色区域，显示-log-4" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B615.png" alt=""></p><h4 id="与默认的传递过程对比-3"><a href="#与默认的传递过程对比-3" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p>事件被<code>CustomRelativeLayout</code>分发过，但未被消费过，所以该事件被<code>MainActivity</code>消费掉，执行<code>MainActivity</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onInterceptTouchEvent-方法，返回-true"><a href="#只修改-onInterceptTouchEvent-方法，返回-true" class="headerlink" title="只修改 onInterceptTouchEvent()方法，返回 true"></a><strong>只修改 onInterceptTouchEvent()方法，返回 true</strong></h3><h4 id="点击下面的紫色区域，显示-log-5"><a href="#点击下面的紫色区域，显示-log-5" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B616.png" alt=""></p><h4 id="点击红色区域，显示-log-5"><a href="#点击红色区域，显示-log-5" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B617.png" alt=""></p><h4 id="点击灰色区域，显示-log-5"><a href="#点击灰色区域，显示-log-5" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B618.png" alt=""></p><h4 id="与默认的传递过程对比-4"><a href="#与默认的传递过程对比-4" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p><code>CustomRelativeLayout</code>拦截向下传递，所以执行<code>CustomRelativeLayout</code>和<code>MainActivity</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onInterceptTouchEvent-方法，返回-false"><a href="#只修改-onInterceptTouchEvent-方法，返回-false" class="headerlink" title="只修改 onInterceptTouchEvent()方法，返回 false"></a><strong>只修改 onInterceptTouchEvent()方法，返回 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-6"><a href="#点击下面的紫色区域，显示-log-6" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B619.png" alt=""></p><h4 id="点击红色区域，显示-log-6"><a href="#点击红色区域，显示-log-6" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B620.png" alt=""></p><h4 id="点击灰色区域，显示-log-6"><a href="#点击灰色区域，显示-log-6" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B621.png" alt=""></p><h4 id="与默认的传递过程对比-5"><a href="#与默认的传递过程对比-5" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p><code>CustomRelativeLayout</code>不拦截向下传递，所以当<code>CustomButton</code>有触摸事件时，会消费掉该事件，所以执行<code>CustomButton</code>的<code>onTouchEvent()</code>方法；否则，<code>CustomRelativeLayout</code>不会消费掉该事件，所以执行<code>CustomRelativeLayout</code>和<code>MainActivity</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onTouchEvent-方法，返回-true"><a href="#只修改-onTouchEvent-方法，返回-true" class="headerlink" title="只修改 onTouchEvent()方法，返回 true"></a><strong>只修改 onTouchEvent()方法，返回 true</strong></h3><h4 id="点击下面的紫色区域，显示-log-7"><a href="#点击下面的紫色区域，显示-log-7" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B622.png" alt=""></p><h4 id="点击红色区域，显示-log-7"><a href="#点击红色区域，显示-log-7" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B623.png" alt=""></p><h4 id="点击灰色区域，显示-log-7"><a href="#点击灰色区域，显示-log-7" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B624.png" alt=""></p><h4 id="与默认的传递过程对比-6"><a href="#与默认的传递过程对比-6" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p><code>CustomRelativeLayout</code>不拦截向下传递，所以当<code>CustomButton</code>有触摸事件时，会消费掉该事件，所以执行<code>CustomButton</code>的<code>onTouchEvent()</code>方法；否则，<code>CustomRelativeLayout</code>会消费掉该事件，所以执行<code>CustomRelativeLayout</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onTouchEvent-方法，返回-false"><a href="#只修改-onTouchEvent-方法，返回-false" class="headerlink" title="只修改 onTouchEvent()方法，返回 false"></a><strong>只修改 onTouchEvent()方法，返回 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-8"><a href="#点击下面的紫色区域，显示-log-8" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B625.png" alt=""></p><h4 id="点击红色区域，显示-log-8"><a href="#点击红色区域，显示-log-8" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B626.png" alt=""></p><h4 id="点击灰色区域，显示-log-8"><a href="#点击灰色区域，显示-log-8" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B627.png" alt=""></p><h4 id="与默认的传递过程对比-7"><a href="#与默认的传递过程对比-7" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p>和【只修改 onInterceptTouchEvent()方法，返回 false】一样。</p><h2 id="只修改-CustomButton"><a href="#只修改-CustomButton" class="headerlink" title="只修改 CustomButton"></a><strong>只修改 CustomButton</strong></h2><h3 id="只修改-dispatchTouchEvent-方法，返回-true-1"><a href="#只修改-dispatchTouchEvent-方法，返回-true-1" class="headerlink" title="只修改 dispatchTouchEvent()方法，返回 true"></a><strong>只修改 dispatchTouchEvent()方法，返回 true</strong></h3><h4 id="点击下面的紫色区域，显示-log-9"><a href="#点击下面的紫色区域，显示-log-9" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B628.png" alt=""></p><h4 id="点击红色区域，显示-log-9"><a href="#点击红色区域，显示-log-9" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B629.png" alt=""></p><h4 id="点击灰色区域，显示-log-9"><a href="#点击灰色区域，显示-log-9" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B630.png" alt=""></p><h4 id="与默认的传递过程对比-8"><a href="#与默认的传递过程对比-8" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p><code>CustomRelativeLayout</code>不拦截向下传递，所以当<code>CustomButton</code>有触摸事件时，会试图消费掉该事件，但因为<code>CustomButton</code>已分发过，所以不执行<code>CustomButton</code>的<code>onTouchEvent()</code>方法，同时该事件也被消费了，所以不会再被<code>CustomRelativeLayout</code>或<code>MainActivity</code>消费；否则，默认<code>CustomRelativeLayout</code>也不会消费掉该事件，所以执行<code>CustomRelativeLayout</code>和<code>MainActivity</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-dispatchTouchEvent-方法，返回-false-1"><a href="#只修改-dispatchTouchEvent-方法，返回-false-1" class="headerlink" title="只修改 dispatchTouchEvent()方法，返回 false"></a><strong>只修改 dispatchTouchEvent()方法，返回 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-10"><a href="#点击下面的紫色区域，显示-log-10" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B631.png" alt=""></p><h4 id="点击红色区域，显示-log-10"><a href="#点击红色区域，显示-log-10" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B632.png" alt=""></p><h4 id="点击灰色区域，显示-log-10"><a href="#点击灰色区域，显示-log-10" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B633.png" alt=""></p><h4 id="与默认的传递过程对比-9"><a href="#与默认的传递过程对比-9" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p><code>CustomRelativeLayout</code>不拦截向下传递，所以当<code>CustomButton</code>有触摸事件时，会试图消费掉该事件，但因为<code>CustomButton</code>已分发过，所以不执行<code>CustomButton</code>的<code>onTouchEvent()</code>方法，但同时未消费过，但默认<code>CustomRelativeLayout</code>也不会消费掉该事件，所以执行<code>CustomRelativeLayout</code>和<code>MainActivity</code>的<code>onTouchEvent()</code>方法；否则，默认<code>CustomRelativeLayout</code>也不会消费掉该事件，所以执行<code>CustomRelativeLayout</code>和<code>MainActivity</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onTouchEvent-方法，返回-true-1"><a href="#只修改-onTouchEvent-方法，返回-true-1" class="headerlink" title="只修改 onTouchEvent()方法，返回 true"></a><strong>只修改 onTouchEvent()方法，返回 true</strong></h3><h4 id="点击下面的紫色区域，显示-log-11"><a href="#点击下面的紫色区域，显示-log-11" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B634.png" alt=""></p><h4 id="点击红色区域，显示-log-11"><a href="#点击红色区域，显示-log-11" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B635.png" alt=""></p><h4 id="点击灰色区域，显示-log-11"><a href="#点击灰色区域，显示-log-11" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B636.png" alt=""></p><h4 id="与默认的传递过程对比-10"><a href="#与默认的传递过程对比-10" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p><code>CustomRelativeLayout</code>不拦截向下传递，所以当<code>CustomButton</code>有触摸事件时，会消费掉该事件；否则，默认<code>CustomRelativeLayout</code>也不会消费掉该事件，所以执行<code>CustomRelativeLayout</code>和<code>MainActivity</code>的<code>onTouchEvent()</code>方法。</p><h3 id="只修改-onTouchEvent-方法，返回-false-1"><a href="#只修改-onTouchEvent-方法，返回-false-1" class="headerlink" title="只修改 onTouchEvent()方法，返回 false"></a><strong>只修改 onTouchEvent()方法，返回 false</strong></h3><h4 id="点击下面的紫色区域，显示-log-12"><a href="#点击下面的紫色区域，显示-log-12" class="headerlink" title="点击下面的紫色区域，显示 log"></a><strong>点击下面的紫色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B637.png" alt=""></p><h4 id="点击红色区域，显示-log-12"><a href="#点击红色区域，显示-log-12" class="headerlink" title="点击红色区域，显示 log"></a><strong>点击红色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B638.png" alt=""></p><h4 id="点击灰色区域，显示-log-12"><a href="#点击灰色区域，显示-log-12" class="headerlink" title="点击灰色区域，显示 log"></a><strong>点击灰色区域，显示 log</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/%E8%A7%A6%E6%91%B8%E4%BA%8B%E4%BB%B6%E4%BC%A0%E9%80%92%E6%9C%BA%E5%88%B639.png" alt=""></p><h4 id="与默认的传递过程对比-11"><a href="#与默认的传递过程对比-11" class="headerlink" title="与默认的传递过程对比"></a><strong>与默认的传递过程对比</strong></h4><p>完全一样。</p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;触摸事件传递的三个阶段&quot;&gt;&lt;a href=&quot;#触摸事件传递的三个阶段&quot; class=&quot;headerlink&quot; title=&quot;触摸事件传递的三个阶段&quot;&gt;&lt;/a&gt;&lt;strong&gt;触摸事件传递的三个阶段&lt;/strong&gt;&lt;/h1&gt;&lt;h2 id=&quot;分发&quot;&gt;&lt;a href=
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>HTTP 学习</title>
    <link href="http://www.weichao.io/2018/03/03/HTTP-%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.weichao.io/2018/03/03/HTTP-学习/</id>
    <published>2018-03-03T09:04:59.000Z</published>
    <updated>2018-03-03T09:50:54.973Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://www.w3.org/Protocols/HTTP/1.1/rfc2616.pdf" title="https://www.w3.org/Protocols/HTTP/1.1/rfc2616.pdf" target="_blank" rel="external">Hypertext Transfer Protocol – HTTP/1.1</a></li><li><a href="https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" title="https://zh.wikipedia.org/wiki/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE" target="_blank" rel="external">超文本传输协议</a></li><li><a href="https://zh.wikipedia.org/wiki/HTTP/2" title="https://zh.wikipedia.org/wiki/HTTP/2" target="_blank" rel="external">HTTP/2</a></li><li><a href="https://segmentfault.com/a/1190000009028150" title="https://segmentfault.com/a/1190000009028150" target="_blank" rel="external">Angular 4.x HttpModule 揭秘</a></li><li><a href="https://segmentfault.com/a/1190000004556040" title="https://segmentfault.com/a/1190000004556040" target="_blank" rel="external">聊一聊 cookie</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP" target="_blank" rel="external">HTTP</a></li><li><a href="https://segmentfault.com/a/1190000006689767#articleHeader6" title="https://segmentfault.com/a/1190000006689767#articleHeader6" target="_blank" rel="external">HTTP 请求头与请求体</a></li></ul><hr><h1 id="超文本传输协议"><a href="#超文本传输协议" class="headerlink" title="超文本传输协议"></a><strong>超文本传输协议</strong></h1><p>超文本传输协议（英文：HyperText Transfer Protocol，缩写：<code>HTTP</code>）是一种用于分布式、协作式和超媒体信息系统的应用层协议。<code>HTTP</code>是万维网的数据通信的基础。<br>通常，由<code>HTTP</code>客户端发起一个请求，创建一个到服务器指定端口（默认是<code>80</code>端口）的<code>TCP</code>连接。<code>HTTP</code>服务器则在那个端口监听客户端的请求。一旦收到请求，服务器会向客户端返回一个状态，比如<code>HTTP/1.1 200 OK</code>，以及返回的内容，如请求的文件、错误消息、或者其它信息。</p><hr><h1 id="报文"><a href="#报文" class="headerlink" title="报文"></a><strong>报文</strong></h1><h2 id="请求-响应报文共有内容"><a href="#请求-响应报文共有内容" class="headerlink" title="请求/响应报文共有内容"></a><strong>请求/响应报文共有内容</strong></h2><h3 id="常用符号"><a href="#常用符号" class="headerlink" title="常用符号"></a><strong>常用符号</strong></h3><h4 id="空格"><a href="#空格" class="headerlink" title="空格"></a><strong>空格</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A01.png" alt=""></p><p><code>0x20</code></p><h4 id="回车符"><a href="#回车符" class="headerlink" title="回车符"></a><strong>回车符</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A02.png" alt=""></p><p><code>0x0d</code></p><h4 id="换行符"><a href="#换行符" class="headerlink" title="换行符"></a><strong>换行符</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A03.png" alt=""></p><p><code>0x0a</code></p><h4 id="引号"><a href="#引号" class="headerlink" title="引号"></a><strong>引号</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A04.png" alt=""></p><p><code>0x22</code></p><h4 id="制表符"><a href="#制表符" class="headerlink" title="制表符"></a><strong>制表符</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A05.png" alt=""></p><p><code>0x09</code></p><h3 id="协议版本"><a href="#协议版本" class="headerlink" title="协议版本"></a><strong>协议版本</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A06.png" alt=""></p><h3 id="实体"><a href="#实体" class="headerlink" title="实体"></a><strong>实体</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A07.png" alt=""></p><h4 id="实体头"><a href="#实体头" class="headerlink" title="实体头"></a><strong>实体头</strong></h4><h5 id="协议中的实体头"><a href="#协议中的实体头" class="headerlink" title="协议中的实体头"></a><strong>协议中的实体头</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A08.png" alt=""></p><h6 id="Allow"><a href="#Allow" class="headerlink" title="Allow"></a><strong>Allow</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A09.png" alt=""></p><p>枚举资源所支持的<code>HTTP</code>方法的集合。</p><h6 id="Content-Encoding"><a href="#Content-Encoding" class="headerlink" title="Content-Encoding"></a><strong>Content-Encoding</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A010.png" alt=""></p><p>告知客户端应该怎样解码才能获取在<code>Content-Type</code>中标示的媒体类型内容。</p><h6 id="Content-Language"><a href="#Content-Language" class="headerlink" title="Content-Language"></a><strong>Content-Language</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A011.png" alt=""></p><p>通知客户端应该使用的语言。</p><h6 id="Content-Length"><a href="#Content-Length" class="headerlink" title="Content-Length"></a><strong>Content-Length</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A012.png" alt=""></p><p>指明发送给接收方的消息主体的大小，即用十进制数字表示的字节数。</p><h6 id="Content-Location"><a href="#Content-Location" class="headerlink" title="Content-Location"></a><strong>Content-Location</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A013.png" alt=""></p><p>指向的是可供访问的资源的直接地址。</p><h6 id="Content-MD5"><a href="#Content-MD5" class="headerlink" title="Content-MD5"></a><strong>Content-MD5</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A014.png" alt=""></p><h6 id="Content-Range"><a href="#Content-Range" class="headerlink" title="Content-Range"></a><strong>Content-Range</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A0121.png" alt=""></p><p>一个数据片段在整个文件中的位置。</p><h6 id="Content-Type"><a href="#Content-Type" class="headerlink" title="Content-Type"></a><strong>Content-Type</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A016.png" alt=""></p><p>告诉客户端实际返回的内容的内容类型。</p><h6 id="Expires"><a href="#Expires" class="headerlink" title="Expires"></a><strong>Expires</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A017.png" alt=""></p><p>指定一个时间，在这个时间之后，<code>HTTP</code>响应被认为是过时的。</p><h6 id="Last-Modified"><a href="#Last-Modified" class="headerlink" title="Last-Modified"></a><strong>Last-Modified</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A018.png" alt=""></p><p>包含源头服务器认定的资源做出修改的时间。</p><h6 id="extension-header"><a href="#extension-header" class="headerlink" title="extension-header"></a><strong>extension-header</strong></h6><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A019.png" alt=""></p><p>就是消息头。</p><h4 id="实体体"><a href="#实体体" class="headerlink" title="实体体"></a><strong>实体体</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A021.png" alt=""></p><p>十六进制的数据。</p><h3 id="消息"><a href="#消息" class="headerlink" title="消息"></a><strong>消息</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A022.png" alt=""></p><h4 id="消息头"><a href="#消息头" class="headerlink" title="消息头"></a><strong>消息头</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A023.png" alt=""></p><h5 id="Cache-Control"><a href="#Cache-Control" class="headerlink" title="Cache-Control"></a><strong>Cache-Control</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A0122.png" alt=""></p><p>通过指定指令来实现缓存机制。</p><h5 id="Data"><a href="#Data" class="headerlink" title="Data"></a><strong>Data</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A025.png" alt=""></p><p>包含了消息生成的日期和时间。</p><h4 id="消息体"><a href="#消息体" class="headerlink" title="消息体"></a><strong>消息体</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A026.png" alt=""></p><p>实体体或实体体编码后的。</p><h2 id="请求报文格式"><a href="#请求报文格式" class="headerlink" title="请求报文格式"></a><strong>请求报文格式</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A027.png" alt=""></p><h3 id="图形化看请求报文格式"><a href="#图形化看请求报文格式" class="headerlink" title="图形化看请求报文格式"></a><strong>图形化看请求报文格式</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A028.png" alt=""></p><h3 id="从实际报文看请求报文格式"><a href="#从实际报文看请求报文格式" class="headerlink" title="从实际报文看请求报文格式"></a><strong>从实际报文看请求报文格式</strong></h3><p>报文：</p><pre><code>GET http://google.com/ HTTP/1.1Host: google.comProxy-Connection: keep-aliveUpgrade-Insecure-Requests: 1User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/64.0.3282.140 Safari/537.36Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7Cookie: CONSENT=YES+CN.zh-CN+20180212-01-0; SID=zwW58_4F0D8AzCbilnhAA59AS5u-hSyYn4DVyXcfCX4UYiQymleOqJ2B29o7ztTJ6C0TBw.; HSID=Aytk1MX24fv9cmSGl; APISID=NQCJtL-0Hs86V74b/AwpE5C4kviQOQC7ey; 1P_JAR=2018-3-1-0; NID=124=qmExYKzxr_cAisI1O_YQzj7EZVMl6RIorDC0vFZXYsmurbzi-YsRiYdnsFpNy9wy2e6PlpE67ipRAuvgD9iMMqMuwLzBJgjmbiC2atdGhrNAk52sVzj8B-fCaCKm3TwJV2Z4sWBQXGT1RefjynkwiUji2M4eXHaXXKETVprordDqVpZqxkSZfB8BS0ooJqT4PcnjRk0Hjw-A1xqO8S1yM8XJtmL1a5hyPPLg8PZ9suXNjVcno75ZBaoypOp7igjE3XIQiRAkbejXFbcqfLL97NQP; SIDCC=AAiTGe8ZMSv1kX5ZjP4x1uctVkWNqv7U15nY8YQn0vK2a1yOTVXJM6APXxPJ8ZtXzORc4qw8uw</code></pre><p>报文对应的十六进制：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A029.png" alt=""></p><h3 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a><strong>请求方法</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A030.png" alt=""></p><h4 id="GET"><a href="#GET" class="headerlink" title="GET"></a><strong>GET</strong></h4><p>获取数据。</p><h4 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a><strong>HEAD</strong></h4><p>请求资源的<code>header</code>信息，并且这些<code>header</code>与<code>GET</code>方法请求时返回的一致。 该请求方法的一个使用场景是在下载一个大文件前先获取其大小再决定是否要下载，以此可以节约带宽资源。</p><h4 id="POST"><a href="#POST" class="headerlink" title="POST"></a><strong>POST</strong></h4><p>发送数据给服务器。请求主体的类型由<code>Content-Type header</code>指定。一个<code>POST</code>请求通常是通过<code>HTML</code>表单发送，并返回服务器的修改结果。</p><h3 id="Request-URI"><a href="#Request-URI" class="headerlink" title="Request-URI"></a><strong>Request-URI</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A031.png" alt=""></p><h3 id="请求头"><a href="#请求头" class="headerlink" title="请求头"></a><strong>请求头</strong></h3><h4 id="协议中的请求头"><a href="#协议中的请求头" class="headerlink" title="协议中的请求头"></a><strong>协议中的请求头</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A032.png" alt=""></p><h5 id="Accept"><a href="#Accept" class="headerlink" title="Accept"></a><strong>Accept</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A033.png" alt=""></p><p>说明客户端可以处理的内容类型（<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types" title="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Basics_of_HTTP/MIME_types" target="_blank" rel="external">MIME类型</a>），服务器可以从诸多备选项中选择一项进行应用，并使用<code>Content-Type</code>响应头通知客户端它的选择。</p><h5 id="Accept-Charset"><a href="#Accept-Charset" class="headerlink" title="Accept-Charset"></a><strong>Accept-Charset</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A034.png" alt=""></p><p>说明客户端可以处理的字符集类型，服务器可以从诸多备选项中选择一项进行应用，并使用<code>Content-Type</code>响应头通知客户端它的选择。</p><h5 id="Accept-Encoding"><a href="#Accept-Encoding" class="headerlink" title="Accept-Encoding"></a><strong>Accept-Encoding</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A035.png" alt=""></p><p>说明客户端可以处理的内容编码方式（通常是某种压缩算法），服务器可以从诸多备选项中选择一项进行应用，并使用<code>Content-Encoding</code>响应头通知客户端它的选择。</p><h5 id="Accept-Language"><a href="#Accept-Language" class="headerlink" title="Accept-Language"></a><strong>Accept-Language</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A036.png" alt=""></p><p>说明客户端可以处理的自然语言和优先处理的区域方言，服务器可以从诸多备选项中选择一项进行应用，并使用<code>Content-Language</code>响应头通知客户端它的选择。</p><h5 id="Authorization"><a href="#Authorization" class="headerlink" title="Authorization"></a><strong>Authorization</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A037.png" alt=""></p><p>含有服务器用于验证用户代理身份的凭证。</p><h5 id="Expect"><a href="#Expect" class="headerlink" title="Expect"></a><strong>Expect</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A038.png" alt=""></p><p>表示服务器只有在满足此期望条件的情况下才能妥善地处理请求。</p><h5 id="From"><a href="#From" class="headerlink" title="From"></a><strong>From</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A039.png" alt=""></p><p>包含一个电子邮箱地址。</p><h5 id="Host"><a href="#Host" class="headerlink" title="Host"></a><strong>Host</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A040.png" alt=""></p><p>指明了服务器的域名（对于虚拟主机来说），同时可选择设置服务器监听的<code>TCP</code>端口号。<br>如果没有给定端口号，会自动使用被请求服务的默认端口（比如请求一个<code>HTTP</code>的<code>URL</code>会自动使用<code>80</code>端口）。</p><h5 id="If-Match"><a href="#If-Match" class="headerlink" title="If-Match"></a><strong>If-Match</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A041.png" alt=""></p><p>表示这是一个条件请求。<br>在请求方法为<code>GET</code>和<code>HEAD</code>的情况下，服务器仅在请求的资源满足此<code>header</code>列出的<code>ETag</code>之一时才会返回资源。<br>而对于<code>PUT</code>或其他非安全方法来说，只有在满足条件的情况下才可以将资源上传。</p><h5 id="If-Modified-Since"><a href="#If-Modified-Since" class="headerlink" title="If-Modified-Since"></a><strong>If-Modified-Since</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A042.png" alt=""></p><p>服务器只在所请求的资源在给定的日期时间之后对内容进行过修改的情况下才会将资源返回，状态码为<code>200</code>。<br>如果请求的资源从那时起未经修改，那么返回一个不带有消息主体的<code>304</code>响应，而在<code>Last-Modified</code>中会带有上次修改时间。<br>不同于<code>If-Unmodified-Since</code>，<code>If-Modified-Since</code>只可以用在<code>GET</code>或<code>HEAD</code>请求中。<br>当与<code>If-None-Match</code>一同出现时，它会被忽略掉，除非服务器不支持<code>If-None-Match</code>。</p><h5 id="If-None-Match"><a href="#If-None-Match" class="headerlink" title="If-None-Match"></a><strong>If-None-Match</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A043.png" alt=""></p><p>对于<code>GET</code>和<code>HEAD</code>请求方法来说，当且仅当服务器上没有任何资源的<code>ETag</code>属性值与这个<code>header</code>中列出的相匹配的时候，服务器端才会返回所请求的资源，响应码为<code>200</code>。<br>对于其他方法来说，当且仅当最终确认没有已存在的资源的<code>ETag</code>属性值与这个<code>header</code>中所列出的相匹配的时候，才会对请求进行相应的处理。</p><h5 id="If-Range"><a href="#If-Range" class="headerlink" title="If-Range"></a><strong>If-Range</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A044.png" alt=""></p><p>当字段值中的条件得到满足时，<code>Range</code>字段才会起作用，同时服务器回复<code>206</code>部分内容状态码，以及<code>Range</code>字段请求的相应部分；如果字段值中的条件没有得到满足，服务器将会返回<code>200</code>状态码，并返回完整的请求资源。</p><h5 id="If-Unmodified-Since"><a href="#If-Unmodified-Since" class="headerlink" title="If-Unmodified-Since"></a><strong>If-Unmodified-Since</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A045.png" alt=""></p><p>只有当资源在指定的时间之后没有进行过修改的情况下，服务器才会返回请求的资源，或是接受<code>POST</code>或其他非安全方法的请求；如果所请求的资源在指定的时间之后发生了修改，那么会返回<code>412</code>错误。</p><h5 id="Max-Forwards"><a href="#Max-Forwards" class="headerlink" title="Max-Forwards"></a><strong>Max-Forwards</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A0123.png" alt=""></p><p>通过<code>TRACE</code>方法或<code>OPTIONS</code>方法，发送包含<code>Max-Forwards</code>的请求时，该字段以十进制整数形式指定可经过的服务器最大数目。<br>服务器在往下一个服务器转发请求之前，会将<code>Max-Forwards</code>的值减<code>1</code>后重新赋值。当服务器接收到<code>Max-Forwards</code>值为<code>0</code>的请求时，则不再进行转发，而是直接返回响应。</p><h5 id="Proxy-Authorization"><a href="#Proxy-Authorization" class="headerlink" title="Proxy-Authorization"></a><strong>Proxy-Authorization</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A046.png" alt=""></p><p>包含了用户代理提供给代理服务器的用于身份验证的凭证。</p><h5 id="Range"><a href="#Range" class="headerlink" title="Range"></a><strong>Range</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A0147.png" alt=""></p><p>告知服务器返回文件的哪一部分。在一个<code>Range</code>中，可以一次性请求多个部分，服务器会以<code>multipart</code>文件的形式将其返回。如果服务器返回的是范围响应，需要使用<code>206</code>状态码。假如所请求的范围不合法，那么服务器会返回<code>416</code>状态码，表示客户端错误。服务器允许忽略<code>Range</code>，从而返回整个文件，状态码用<code>200</code>。</p><h5 id="Referer"><a href="#Referer" class="headerlink" title="Referer"></a><strong>Referer</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A0124.png" alt=""></p><p>包含了当前请求页面的来源页面的地址，即表示当前页面是通过此来源页面里的链接进入的。</p><h5 id="TE"><a href="#TE" class="headerlink" title="TE"></a><strong>TE</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A048.png" alt=""></p><p>指定用户代理希望使用的传输编码类型。</p><h5 id="User-Agent"><a href="#User-Agent" class="headerlink" title="User-Agent"></a><strong>User-Agent</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A049.png" alt=""></p><p>包含了一个特征字符串，用来让网络协议的对端来识别发起请求的用户代理软件的应用类型、操作系统、软件开发商以及版本号。</p><h4 id="其他请求头"><a href="#其他请求头" class="headerlink" title="其他请求头"></a><strong>其他请求头</strong></h4><h5 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a><strong>Cookie</strong></h5><pre><code>Cookie: &lt;cookie-list&gt;Cookie: name=valueCookie: name=value; name2=value2; name3=value3</code></pre><p>含有先前由服务器通过<code>Set-Cookie</code>投放并存储到客户端的<code>HTTP</code> <code>cookies</code>。</p><h5 id="Upgrade-Insecure-Requests"><a href="#Upgrade-Insecure-Requests" class="headerlink" title="Upgrade-Insecure-Requests"></a><strong>Upgrade-Insecure-Requests</strong></h5><pre><code>Upgrade-Insecure-Requests: 1</code></pre><p>表示客户端优先选择加密及带有身份验证的响应，并且它可以成功处理<code>upgrade-insecure-requests</code> <code>CSP</code>指令。</p><h5 id="Origin"><a href="#Origin" class="headerlink" title="Origin"></a><strong>Origin</strong></h5><pre><code>Origin: &quot;&quot;Origin: &lt;scheme&gt; &quot;://&quot; &lt;host&gt; [ &quot;:&quot; &lt;port&gt; ]</code></pre><p>指示了请求来自于哪个站点。该字段仅指示服务器名称，并不包含任何路径信息。</p><h3 id="请求体"><a href="#请求体" class="headerlink" title="请求体"></a><strong>请求体</strong></h3><p>就是消息体。<br>请求体有 3 种类型：</p><h4 id="任意类型"><a href="#任意类型" class="headerlink" title="任意类型"></a><strong>任意类型</strong></h4><p>服务器不会解析请求体，请求体的处理需要自己解析。</p><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A050.png" alt=""></p><p>如<code>POST</code> <code>JSON</code>时就是这类，建议使用<code>Content-Type:application/json</code>。</p><h4 id="application-x-www-form-urlencoded"><a href="#application-x-www-form-urlencoded" class="headerlink" title="application/x-www-form-urlencoded"></a><strong>application/x-www-form-urlencoded</strong></h4><p>多个键值对之间用<code>&amp;</code>连接，键与值之前用<code>=</code>连接，且只能用<code>ASCII</code>字符，非<code>ASCII</code>字符需使用<code>UrlEncode</code>编码。</p><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A051.png" alt=""></p><h4 id="multipart-form-data"><a href="#multipart-form-data" class="headerlink" title="multipart/form-data"></a><strong>multipart/form-data</strong></h4><p>请求体被分成为多个部分，文件上传时会被使用，每个字段/文件都被<code>boundary</code>（<code>Content-Type</code>中指定）分成单独的段，每段以<code>--</code>加 boundary 开头，然后是该段的描述头，描述头之后空一行接内容，请求结束的标志为 boundary 后面加<code>--</code>。</p><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A052.png" alt=""></p><p>区分是否被当成文件的关键是<code>Content-Disposition</code>是否包含<code>filename</code>，因为文件有不同的类型，所以还要使用<code>Content-Type</code>指示文件的类型，如果不知道是什么类型取值可以为<code>application/octet-stream</code>表示该文件是个二进制文件，如果不是文件则<code>Content-Type</code>可以省略。</p><h2 id="响应报文格式"><a href="#响应报文格式" class="headerlink" title="响应报文格式"></a><strong>响应报文格式</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A053.png" alt=""></p><h3 id="图形化看响应报文格式"><a href="#图形化看响应报文格式" class="headerlink" title="图形化看响应报文格式"></a><strong>图形化看响应报文格式</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A054.png" alt=""></p><h3 id="从实际报文看响应报文格式"><a href="#从实际报文看响应报文格式" class="headerlink" title="从实际报文看响应报文格式"></a><strong>从实际报文看响应报文格式</strong></h3><p>报文：</p><pre><code>HTTP/1.1 302 FoundCache-Control: privateContent-Type: text/html; charset=UTF-8Referrer-Policy: no-referrerLocation: http://www.google.com.hk/?gfe_rd=cr&amp;dcr=0&amp;ei=w1yXWu_sAabj8weo7rPIDwContent-Length: 272Date: Thu, 01 Mar 2018 01:52:03 GMTConnection: closeProxy-Connection: keep-alive&lt;HTML&gt;&lt;HEAD&gt;&lt;meta http-equiv=&quot;content-type&quot; content=&quot;text/html;charset=utf-8&quot;&gt;&lt;TITLE&gt;302 Moved&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;&lt;H1&gt;302 Moved&lt;/H1&gt;The document has moved&lt;A HREF=&quot;http://www.google.com.hk/?gfe_rd=cr&amp;amp;dcr=0&amp;amp;ei=w1yXWu_sAabj8weo7rPIDw&quot;&gt;here&lt;/A&gt;.&lt;/BODY&gt;&lt;/HTML&gt;</code></pre><p>报文对应的十六进制：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A055.png" alt=""></p><h3 id="状态码-amp-状态码描述"><a href="#状态码-amp-状态码描述" class="headerlink" title="状态码 &amp; 状态码描述"></a><strong>状态码 &amp; 状态码描述</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A056.png" alt=""></p><h3 id="响应头"><a href="#响应头" class="headerlink" title="响应头"></a><strong>响应头</strong></h3><h4 id="协议中的响应头"><a href="#协议中的响应头" class="headerlink" title="协议中的响应头"></a><strong>协议中的响应头</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A057.png" alt=""></p><h5 id="Accept-Ranges"><a href="#Accept-Ranges" class="headerlink" title="Accept-Ranges"></a><strong>Accept-Ranges</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A058.png" alt=""></p><p>标识自身支持请求的范围。</p><h5 id="Age"><a href="#Age" class="headerlink" title="Age"></a><strong>Age</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A059.png" alt=""></p><p>消息对象在缓存代理中存贮的时长，以秒为单位。</p><h5 id="ETag"><a href="#ETag" class="headerlink" title="ETag"></a><strong>ETag</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A061.png" alt=""></p><p>资源的特定版本的标识符。这可以让缓存更高效，并节省带宽，因为如果内容没有改变，Web 服务器不需要发送完整的响应。</p><h5 id="Location"><a href="#Location" class="headerlink" title="Location"></a><strong>Location</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A062.png" alt=""></p><p>需要将页面重新定向至的地址。</p><h5 id="Proxy-Authenticate"><a href="#Proxy-Authenticate" class="headerlink" title="Proxy-Authenticate"></a><strong>Proxy-Authenticate</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A063.png" alt=""></p><p>指定了为获取代理服务器上的资源访问权限而使用的身份验证方式。</p><h5 id="Retry-After"><a href="#Retry-After" class="headerlink" title="Retry-After"></a><strong>Retry-After</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A064.png" alt=""></p><p>表示用户代理需要等待多长时间之后才能继续发送请求。</p><h5 id="Server"><a href="#Server" class="headerlink" title="Server"></a><strong>Server</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A065.png" alt=""></p><p>包含了处理请求的源头服务器所用到的软件相关信息。</p><h5 id="Vary"><a href="#Vary" class="headerlink" title="Vary"></a><strong>Vary</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A066.png" alt=""></p><p>决定了对于未来的一个请求头，应该用一个缓存的回复还是向源服务器请求一个新的回复。</p><h5 id="WWW-Authenticate"><a href="#WWW-Authenticate" class="headerlink" title="WWW-Authenticate"></a><strong>WWW-Authenticate</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A067.png" alt=""></p><p>定义了使用何种验证方式获取资源的连接。</p><h4 id="其他响应头"><a href="#其他响应头" class="headerlink" title="其他响应头"></a><strong>其他响应头</strong></h4><h5 id="Content-Disposition"><a href="#Content-Disposition" class="headerlink" title="Content-Disposition"></a><strong>Content-Disposition</strong></h5><p>1、作为消息主体中的消息头</p><pre><code>Content-Disposition: inlineContent-Disposition: attachmentContent-Disposition: attachment; filename=&quot;filename.jpg&quot;</code></pre><p>在<code>HTTP</code>场景中，第一个参数或者是<code>inline</code>（默认值，表示回复中的消息体会以页面的一部分或者整个页面的形式展示），或者是<code>attachment</code>（意味着消息体应该被下载到本地；大多数浏览器会呈现一个“保存为”的对话框，将<code>filename</code>的值预填为下载后的文件名，假如它存在的话）。</p><p>2、作为 multipart body 中的消息头</p><pre><code>Content-Disposition: form-dataContent-Disposition: form-data; name=&quot;fieldName&quot;Content-Disposition: form-data; name=&quot;fieldName&quot;; filename=&quot;filename.jpg&quot;</code></pre><p>在<code>HTTP</code>场景中。第一个参数总是固定不变的<code>form-data</code>；附加的参数不区分大小写，并且拥有参数值，参数名与参数值用<code>=</code>连接，参数值用<code>&quot;</code>括起来。参数之间用<code>;</code>分隔。</p><h5 id="Set-Cookie"><a href="#Set-Cookie" class="headerlink" title="Set-Cookie"></a><strong>Set-Cookie</strong></h5><pre><code>Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt; Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; Expires=&lt;date&gt;Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; Max-Age=&lt;non-zero-digit&gt;Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; Domain=&lt;domain-value&gt;Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; Path=&lt;path-value&gt;Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; SecureSet-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; HttpOnlySet-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; SameSite=StrictSet-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; SameSite=Lax// Multiple directives are also possible, for example:Set-Cookie: &lt;cookie-name&gt;=&lt;cookie-value&gt;; Domain=&lt;domain-value&gt;; Secure; HttpOnly</code></pre><p>服务器端向客户端发送<code>cookie</code>。</p><h5 id="Transfer-Encoding"><a href="#Transfer-Encoding" class="headerlink" title="Transfer-Encoding"></a><strong>Transfer-Encoding</strong></h5><p><img src="http://otkw6sse5.bkt.clouddn.com/HTTP-%E5%AD%A6%E4%B9%A068.png" alt=""></p><p>逐跳传输消息首部，即仅应用于两个节点之间的消息传递，而不是所请求的资源本身。一个多节点连接中的每一段都可以应用不同的<code>Transfer-Encoding</code>值。</p><h3 id="响应体"><a href="#响应体" class="headerlink" title="响应体"></a><strong>响应体</strong></h3><p>就是消息体。</p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://ww
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>FLV 封装格式</title>
    <link href="http://www.weichao.io/2018/02/28/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F/"/>
    <id>http://www.weichao.io/2018/02/28/FLV-封装格式/</id>
    <published>2018-02-28T13:25:09.000Z</published>
    <updated>2018-02-28T13:46:57.648Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://wwwimages2.adobe.com/content/dam/acom/en/devnet/flv/video_file_format_spec_v10_1.pdf" title="https://wwwimages2.adobe.com/content/dam/acom/en/devnet/flv/video_file_format_spec_v10_1.pdf" target="_blank" rel="external">F4V/FLV file format spec v10.1</a></li><li><a href="https://www.jianshu.com/p/74a13250fa1b" title="https://www.jianshu.com/p/74a13250fa1b" target="_blank" rel="external">FLV 文件格式简析</a></li><li><a href="https://www.jianshu.com/p/f2b31ddcf200" title="https://www.jianshu.com/p/f2b31ddcf200" target="_blank" rel="external">FLV文件的第一个Tag: onMetaData</a></li><li><a href="https://www.jianshu.com/p/e1e417eee2e7" title="https://www.jianshu.com/p/e1e417eee2e7" target="_blank" rel="external">H.264/AVC编码的FLV文件的第二个Tag: AVCDecoderConfigurationRecord</a></li></ul><h1 id="FLV-格式"><a href="#FLV-格式" class="headerlink" title="FLV 格式"></a><strong>FLV 格式</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F1.png" alt=""></p><hr><h1 id="FLV-header"><a href="#FLV-header" class="headerlink" title="FLV header"></a><strong>FLV header</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F2.png" alt=""></p><h2 id="从-FLV-报文看-FLV-header-数据结构"><a href="#从-FLV-报文看-FLV-header-数据结构" class="headerlink" title="从 FLV 报文看 FLV header 数据结构"></a><strong>从 FLV 报文看 FLV header 数据结构</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F3.png" alt=""></p><table><thead><tr><th>数据</th><th>数据位置的说明</th></tr></thead><tbody><tr><td>0x46 0x4c 0x56</td><td>字符<code>FLV</code></td></tr><tr><td>0x01</td><td>版本号</td></tr><tr><td>0x05</td><td>右起第 0 位和第 2 位分别表示 video 与 audio 存在的情况（1 表示存在，0 表示不存在）</td></tr><tr><td>0x00 0x00 0x00 0x09</td><td>报头数据长度</td></tr></tbody></table><hr><h1 id="FLV-body"><a href="#FLV-body" class="headerlink" title="FLV body"></a><strong>FLV body</strong></h1><h2 id="FLV-TAG-header"><a href="#FLV-TAG-header" class="headerlink" title="FLV TAG header"></a><strong>FLV TAG header</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8FQQ%E6%88%AA%E5%9B%BE20180228213618.png" alt=""></p><h2 id="第一个-TAG"><a href="#第一个-TAG" class="headerlink" title="第一个 TAG"></a><strong>第一个 TAG</strong></h2><p><code>onMetaData</code>和<code>header</code>之间存在 4 个空字节。</p><h3 id="rtmp-中，FLV-body-的第一个-TAG-必须是-onMetaData"><a href="#rtmp-中，FLV-body-的第一个-TAG-必须是-onMetaData" class="headerlink" title="rtmp 中，FLV body 的第一个 TAG 必须是 onMetaData"></a><strong>rtmp 中，FLV body 的第一个 TAG 必须是 onMetaData</strong></h3><p>首先是 11 个字节的<code>FLV TAG header</code>，<code>TagType=0x12</code>。然后是<code>onMetaData</code>的<code>header</code>。最后是<code>onMetaData</code>的<code>body</code>。</p><h4 id="onMetaData-的-header"><a href="#onMetaData-的-header" class="headerlink" title="onMetaData 的 header"></a><strong>onMetaData 的 header</strong></h4><p>1个字节的<code>2</code> + 12个字节的<code>onMetaData</code>字符串。</p><h4 id="onMetaData-的-body"><a href="#onMetaData-的-body" class="headerlink" title="onMetaData 的 body"></a><strong>onMetaData 的 body</strong></h4><p>将数据按照写入规则排在<code>header</code>后面。</p><p>参数包括：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F6.png" alt=""></p><p>其中，<code>audiocodecid</code>范围：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F7.png" alt=""></p><p><code>videocodecid</code>范围：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F8.png" alt=""></p><p>参数写入规则根据数据类型而定。</p><p>数据类型包括：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F9.png" alt=""></p><table><thead><tr><th>数据类型</th><th>参数写入规则</th></tr></thead><tbody><tr><td>String</td><td>1个字节的<code>2</code> + 2个字节的value长度 + value长度个字节的value</td></tr><tr><td>ECMA array</td><td>4个字节的<code>8</code> + 每个元素（key长度个字节的key + 1个字节的数据类型 + value长度个字节的value）</td></tr></tbody></table><p><code>onMetaData</code>结尾是 3 个字节的<code>0x00 0x00 0x09</code>。</p><h2 id="第二个-TAG"><a href="#第二个-TAG" class="headerlink" title="第二个 TAG"></a><strong>第二个 TAG</strong></h2><p>第二个 TAG 和前面的<code>onMetaData</code>之间存在 4 个字节（用于表示<code>onMetaData</code>长度）。</p><h3 id="如果有-AVC，rtmp-中，FLV-body-下一个-TAG-必须是-AVCDecoderConfigurationRecord"><a href="#如果有-AVC，rtmp-中，FLV-body-下一个-TAG-必须是-AVCDecoderConfigurationRecord" class="headerlink" title="如果有 AVC，rtmp 中，FLV body 下一个 TAG 必须是 AVCDecoderConfigurationRecord"></a><strong>如果有 AVC，rtmp 中，FLV body 下一个 TAG 必须是 AVCDecoderConfigurationRecord</strong></h3><p>首先是 11 个字节的<code>FLV TAG header</code>，<code>TagType=0x09</code>。然后是<code>AVC</code>编码格式的<code>header</code>，<code>AVCPacketType=0x00</code>。最后是<code>AVCDecoderConfigurationRecord</code>。</p><hr><h3 id="如果有-AAC，rtmp-中，FLV-body-下一个-TAG-必须是-AudioSpecificConfig"><a href="#如果有-AAC，rtmp-中，FLV-body-下一个-TAG-必须是-AudioSpecificConfig" class="headerlink" title="如果有 AAC，rtmp 中，FLV body 下一个 TAG 必须是 AudioSpecificConfig"></a><strong>如果有 AAC，rtmp 中，FLV body 下一个 TAG 必须是 AudioSpecificConfig</strong></h3><p>首先是 11 个字节的<code>FLV TAG header</code>，<code>TagType=0x08</code>。然后是<code>AAC</code>编码格式的<code>header</code>，<code>AACPacketType=0x00</code>。最后是<code>AudioSpecificConfig</code>。</p><h2 id="后续-TAG"><a href="#后续-TAG" class="headerlink" title="后续 TAG"></a><strong>后续 TAG</strong></h2><p>每个 TAG 都和前面的 TAG 之间存在 4 个字节（用于表示前一个 TAG 长度）。</p><p>首先是 11 个字节的<code>FLV TAG header</code>。然后是<code>AVC/AAC</code>编码格式的<code>header</code>，最后是<code>AVC/AAC</code>编码格式的<code>body</code>。</p><h3 id="TAG-header"><a href="#TAG-header" class="headerlink" title="TAG header"></a><strong>TAG header</strong></h3><h4 id="AVC-编码格式的-header"><a href="#AVC-编码格式的-header" class="headerlink" title="AVC 编码格式的 header"></a><strong>AVC 编码格式的 header</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F10.png" alt=""></p><h4 id="AAC-编码格式的-header"><a href="#AAC-编码格式的-header" class="headerlink" title="AAC 编码格式的 header"></a><strong>AAC 编码格式的 header</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8FQQ%E6%88%AA%E5%9B%BE20180228213649.png" alt=""></p><h3 id="TAG-body"><a href="#TAG-body" class="headerlink" title="TAG body"></a><strong>TAG body</strong></h3><h4 id="AVC-编码格式的-body"><a href="#AVC-编码格式的-body" class="headerlink" title="AVC 编码格式的 body"></a><strong>AVC 编码格式的 body</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8F13.png" alt=""></p><h4 id="AAC-编码格式的-body"><a href="#AAC-编码格式的-body" class="headerlink" title="AAC 编码格式的 body"></a><strong>AAC 编码格式的 body</strong></h4><p><img src="http://otkw6sse5.bkt.clouddn.com/FLV-%E5%B0%81%E8%A3%85%E6%A0%BC%E5%BC%8FQQ%E6%88%AA%E5%9B%BE20180228213710.png" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://ww
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ScreenRecorder 代码解读</title>
    <link href="http://www.weichao.io/2018/02/27/ScreenRecorder-%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    <id>http://www.weichao.io/2018/02/27/ScreenRecorder-代码解读/</id>
    <published>2018-02-26T17:33:52.000Z</published>
    <updated>2018-02-28T14:38:54.873Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://github.com/eterrao/ScreenRecorder" title="https://github.com/eterrao/ScreenRecorder" target="_blank" rel="external">ScreenRecorder</a></li><li><a href="http://blog.csdn.net/zxccxzzxz/article/details/55230272" title="http://blog.csdn.net/zxccxzzxz/article/details/55230272" target="_blank" rel="external">Android实现录屏直播（三）MediaProjection + VirtualDisplay + librtmp + MediaCodec实现视频编码并推流到rtmp服务器</a></li><li><a href="https://github.com/ele828/blog/blob/master/source/_posts/Android%E5%B1%8F%E5%B9%95%E7%9B%B4%E6%92%AD%E6%96%B9%E6%A1%88.md" title="https://github.com/ele828/blog/blob/master/source/_posts/Android%E5%B1%8F%E5%B9%95%E7%9B%B4%E6%92%AD%E6%96%B9%E6%A1%88.md" target="_blank" rel="external">Android获取实时屏幕画面</a></li><li><a href="https://developer.android.com/reference/android/media/MediaCodec.html" title="https://developer.android.com/reference/android/media/MediaCodec.html" target="_blank" rel="external">MediaCodec</a></li><li><a href="https://developer.android.com/reference/android/media/MediaFormat.html" title="https://developer.android.com/reference/android/media/MediaFormat.html" target="_blank" rel="external">MediaFormat</a></li><li><a href="https://developer.android.com/reference/android/media/projection/MediaProjection.html" title="https://developer.android.com/reference/android/media/projection/MediaProjection.html" target="_blank" rel="external">MediaProjection</a></li><li><a href="https://developer.android.com/reference/java/nio/Buffer.html" title="https://developer.android.com/reference/java/nio/Buffer.html" target="_blank" rel="external">Buffer</a></li><li><a href="https://developer.android.com/reference/java/nio/ByteBuffer.html" title="https://developer.android.com/reference/java/nio/ByteBuffer.html" target="_blank" rel="external">ByteBuffer</a></li><li><a href="https://zhuanlan.zhihu.com/p/27896239" title="https://zhuanlan.zhihu.com/p/27896239" target="_blank" rel="external">H264码流中SPS PPS详解</a></li><li><a href="http://blog.csdn.net/newthinker_wei/article/details/8748442" title="http://blog.csdn.net/newthinker_wei/article/details/8748442" target="_blank" rel="external">H.264 NALU语法结构</a></li><li><a href="http://blog.csdn.net/zgyulongfei/article/details/7538523" title="http://blog.csdn.net/zgyulongfei/article/details/7538523" target="_blank" rel="external">H264 获取SPS与PPS（附源码）</a></li><li><a href="http://blog.csdn.net/sweibd/article/details/52189907" title="http://blog.csdn.net/sweibd/article/details/52189907" target="_blank" rel="external">通过RTMP play分析FLV格式详解</a></li><li><a href="http://www.cnblogs.com/chef/archive/2012/07/18/2597279.html" target="_blank" rel="external">RTMP中FLV流到标准h264、aac的转换</a></li><li><a href="http://blog.csdn.net/leixiaohua1020/article/details/14229543" target="_blank" rel="external">libRTMP使用说明</a></li><li><a href="http://mingyangshang.github.io/2016/03/06/RTMP%E5%8D%8F%E8%AE%AE/" title="http://mingyangshang.github.io/2016/03/06/RTMP%E5%8D%8F%E8%AE%AE/" target="_blank" rel="external">带你吃透RTMP</a></li><li><a href="https://www.jianshu.com/p/00aceabce944" title="https://www.jianshu.com/p/00aceabce944" target="_blank" rel="external">直播推流实现RTMP协议的一些注意事项</a></li><li><a href="http://blog.csdn.net/leixiaohua1020/article/details/12958747" title="http://blog.csdn.net/leixiaohua1020/article/details/12958747" target="_blank" rel="external">RTMPdump（libRTMP） 源代码分析 8： 发送消息（Message）</a></li><li><a href="https://juejin.im/post/5a57272f6fb9a01cb0493ca0" title="https://juejin.im/post/5a57272f6fb9a01cb0493ca0" target="_blank" rel="external">简单的iOS直播推流——flv 编码与音视频时间戳同步</a></li></ul><hr><h1 id="MyApplication"><a href="#MyApplication" class="headerlink" title="MyApplication"></a><strong>MyApplication</strong></h1><p>加载<code>screenrecorderrtmp</code>JNI库；保存 Context。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line">    <span class="keyword">static</span> &#123;</div><div class="line">        System.loadLibrary(<span class="string">"screenrecorderrtmp"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Context context;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        context = getApplicationContext();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Context <span class="title">getContext</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> context;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="LaunchActivity"><a href="#LaunchActivity" class="headerlink" title="LaunchActivity"></a><strong>LaunchActivity</strong></h1><p>获取权限；设置按钮点击后跳转到屏幕捕捉界面或相机捕捉界面。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LaunchActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_STREAM = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String[] PERMISSIONS_STREAM = &#123;</div><div class="line">            Manifest.permission.CAMERA,</div><div class="line">            Manifest.permission.RECORD_AUDIO,</div><div class="line">            Manifest.permission.WRITE_EXTERNAL_STORAGE</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@BindView</span>(R.id.btn_screen_record)</div><div class="line">    Button btnScreenRecord;</div><div class="line">    <span class="meta">@BindView</span>(R.id.btn_camera_record)</div><div class="line">    Button btnCameraRecord;</div><div class="line"></div><div class="line">    <span class="keyword">boolean</span> authorized = <span class="keyword">false</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_launch);</div><div class="line">        ButterKnife.bind(<span class="keyword">this</span>);</div><div class="line">        verifyPermissions();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@OnClick</span>(&#123;R.id.btn_screen_record, R.id.btn_camera_record&#125;)</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewClicked</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</div><div class="line">            <span class="keyword">case</span> R.id.btn_screen_record:</div><div class="line">                ScreenRecordActivity.launchActivity(<span class="keyword">this</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> R.id.btn_camera_record:</div><div class="line">                CameraActivity.launchActivity(<span class="keyword">this</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">verifyPermissions</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> CAMERA_permission = ActivityCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.CAMERA);</div><div class="line">        <span class="keyword">int</span> RECORD_AUDIO_permission = ActivityCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.RECORD_AUDIO);</div><div class="line">        <span class="keyword">int</span> WRITE_EXTERNAL_STORAGE_permission = ActivityCompat.checkSelfPermission(<span class="keyword">this</span>, Manifest.permission.WRITE_EXTERNAL_STORAGE);</div><div class="line">        <span class="keyword">if</span> (CAMERA_permission != PackageManager.PERMISSION_GRANTED</div><div class="line">                || RECORD_AUDIO_permission != PackageManager.PERMISSION_GRANTED</div><div class="line">                || WRITE_EXTERNAL_STORAGE_permission != PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">            ActivityCompat.requestPermissions(<span class="keyword">this</span>, PERMISSIONS_STREAM, REQUEST_CODE_STREAM);</div><div class="line">            authorized = <span class="keyword">false</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            authorized = <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRequestPermissionsResult</span><span class="params">(<span class="keyword">int</span> requestCode, String[] permissions, <span class="keyword">int</span>[] grantResults)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults);</div><div class="line">        <span class="keyword">if</span> (requestCode == REQUEST_CODE_STREAM) &#123;</div><div class="line">            <span class="keyword">if</span> (grantResults[<span class="number">0</span>] == PackageManager.PERMISSION_GRANTED</div><div class="line">                    &amp;&amp; grantResults[<span class="number">1</span>] == PackageManager.PERMISSION_GRANTED</div><div class="line">                    &amp;&amp; grantResults[<span class="number">2</span>] == PackageManager.PERMISSION_GRANTED) &#123;</div><div class="line">                authorized = <span class="keyword">true</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="ScreenRecordListenerService"><a href="#ScreenRecordListenerService" class="headerlink" title="ScreenRecordListenerService"></a><strong>ScreenRecordListenerService</strong></h1><p>通知开始屏幕捕捉；监听推流进度。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SuppressLint</span>(<span class="string">"LongLogTag"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScreenRecordListenerService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ScreenRecordListenerService"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE_PENDING = <span class="number">0x01</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NOTIFICATION_ID = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> NotificationManager notificationManager;</div><div class="line">    <span class="keyword">private</span> NotificationCompat.Builder builder;</div><div class="line">    <span class="keyword">private</span> IScreenRecorderAidlInterface.Stub binder = <span class="keyword">new</span> IScreenRecorderAidlInterface.Stub() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startScreenRecord</span><span class="params">(Intent bundleData)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendDanmaku</span><span class="params">(List&lt;DanmakuBean&gt; danmakuBeanList)</span> <span class="keyword">throws</span> RemoteException </span>&#123;</div><div class="line">            Log.d(TAG, <span class="string">"danmaku msg: "</span> + danmakuBeanList.get(<span class="number">0</span>).getMessage());</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate();</div><div class="line">        initNotification();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> binder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        <span class="keyword">if</span> (notificationManager != <span class="keyword">null</span>) &#123;</div><div class="line">            notificationManager.cancel(NOTIFICATION_ID);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initNotification</span><span class="params">()</span> </span>&#123;</div><div class="line">        builder = <span class="keyword">new</span> NotificationCompat.Builder(<span class="keyword">this</span>)</div><div class="line">                .setSmallIcon(R.drawable.ic_launcher)</div><div class="line">                .setContentTitle(getResources().getString(R.string.app_name))</div><div class="line">                .setContentText(<span class="string">"您正在录制视频内容哦"</span>)</div><div class="line">                .setOngoing(<span class="keyword">true</span>)</div><div class="line">                .setDefaults(Notification.DEFAULT_VIBRATE);</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ScreenRecordActivity.class);</div><div class="line">        PendingIntent pendingIntent = PendingIntent.getActivity(<span class="keyword">this</span>, REQUEST_CODE_PENDING, intent, PendingIntent.FLAG_UPDATE_CURRENT);</div><div class="line">        builder.setContentIntent(pendingIntent);</div><div class="line">        notificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);</div><div class="line">        notificationManager.notify(NOTIFICATION_ID, builder.build());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="Packager"><a href="#Packager" class="headerlink" title="Packager"></a><strong>Packager</strong></h1><h2 id="AvcPackager"><a href="#AvcPackager" class="headerlink" title="AvcPackager"></a><strong>AvcPackager</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AvcPackager</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] generateAvcDecoderConfigurationRecord(MediaFormat mediaFormat) &#123;</div><div class="line">        <span class="comment">// 获取 csd-0 缓冲区的值，该值对应 SPS；csd-1 对应 PPS</span></div><div class="line">        ByteBuffer spsByteBuff = mediaFormat.getByteBuffer(<span class="string">"csd-0"</span>);</div><div class="line">        ByteBuffer ppsByteBuff = mediaFormat.getByteBuffer(<span class="string">"csd-1"</span>);</div><div class="line">        <span class="comment">// 跳过 4 个字节</span></div><div class="line">        spsByteBuff.position(<span class="number">4</span>);</div><div class="line">        ppsByteBuff.position(<span class="number">4</span>);</div><div class="line">        <span class="comment">// 获取缓冲区剩余字节数</span></div><div class="line">        <span class="keyword">int</span> spsLength = spsByteBuff.remaining();</div><div class="line">        <span class="keyword">int</span> ppsLength = ppsByteBuff.remaining();</div><div class="line">        <span class="comment">// 11 字节包括：</span></div><div class="line">        <span class="comment">// configurationVersion（1 字节）、</span></div><div class="line">        <span class="comment">// AVCProfileIndication（1 字节）、</span></div><div class="line">        <span class="comment">// profile_compatibility（1 字节）、</span></div><div class="line">        <span class="comment">// AVCLevelIndication（1 字节）、</span></div><div class="line">        <span class="comment">// 6bit的reserved + 2bit的lengthSizeMinusOne（1 字节）、</span></div><div class="line">        <span class="comment">// 3bit的reserved + 5bit的numOfSequenceParameterSets（1 字节）、</span></div><div class="line">        <span class="comment">// SPS 的长度（2 字节）、</span></div><div class="line">        <span class="comment">// numOfPictureParameterSets（1 字节）、</span></div><div class="line">        <span class="comment">// PPS 的长度（2 字节）</span></div><div class="line">        <span class="keyword">int</span> length = <span class="number">11</span> + spsLength + ppsLength;</div><div class="line">        <span class="keyword">byte</span>[] result = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</div><div class="line">        <span class="comment">// 从 result 数组第 9 位开始放置 spsByteBuff，一直放置完</span></div><div class="line">        spsByteBuff.get(result, <span class="number">8</span>, spsLength);</div><div class="line">        <span class="comment">// 从 result 数组第 9+spsLength+3 位开始放置 ppsByteBuff，一直放置完</span></div><div class="line">        ppsByteBuff.get(result, <span class="number">8</span> + spsLength + <span class="number">3</span>, ppsLength);</div><div class="line">        result[<span class="number">0</span>] = (<span class="keyword">byte</span>) <span class="number">0x01</span>;<span class="comment">// configurationVersion，实际测试时发现总为0x01</span></div><div class="line">        result[<span class="number">1</span>] = result[<span class="number">9</span>];<span class="comment">// AVCProfileIndication</span></div><div class="line">        result[<span class="number">2</span>] = result[<span class="number">10</span>];<span class="comment">// profile_compatibility</span></div><div class="line">        result[<span class="number">3</span>] = result[<span class="number">11</span>];<span class="comment">// AVCLevelIndication</span></div><div class="line">        result[<span class="number">4</span>] = (<span class="keyword">byte</span>) <span class="number">0xFF</span>;<span class="comment">// 6bit的reserved + 2bit的lengthSizeMinusOne，实际测试时发现总为0xff</span></div><div class="line">        result[<span class="number">5</span>] = (<span class="keyword">byte</span>) <span class="number">0xE1</span>;<span class="comment">// 3bit的reserved + 5bit的numOfSequenceParameterSets，实际测试时发现总为0xe1</span></div><div class="line">        <span class="comment">// result 数组第 7 位放置 spsLength 的高 8 位</span></div><div class="line">        <span class="comment">// result 数组第 8 位放置 spsLength 的低 8 位</span></div><div class="line">        ByteArrayTools.intToTwoByteArray(result, <span class="number">6</span>, spsLength);</div><div class="line">        <span class="keyword">int</span> pos = <span class="number">8</span> + spsLength;</div><div class="line">        result[pos] = (<span class="keyword">byte</span>) <span class="number">0x01</span>;<span class="comment">// numOfPictureParameterSets，实际测试时发现总为0x01</span></div><div class="line">        <span class="comment">// result 数组第 8+spsLength+1 位放置 ppsLength 的高 8 位</span></div><div class="line">        <span class="comment">// result 数组第 8+spsLength+2 位放置 ppsLength 的低 8 位</span></div><div class="line">        ByteArrayTools.intToTwoByteArray(result, pos + <span class="number">1</span>, ppsLength);</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="generateAvcDecoderConfigurationRecord-MediaFormat-mediaFormat"><a href="#generateAvcDecoderConfigurationRecord-MediaFormat-mediaFormat" class="headerlink" title="generateAvcDecoderConfigurationRecord(MediaFormat mediaFormat)"></a><strong>generateAvcDecoderConfigurationRecord(MediaFormat mediaFormat)</strong></h3><p>按<code>FLV</code>要求的<code>AVC</code>的<code>AVCDecoderConfigurationRecord</code>格式编码。</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ScreenRecorder-%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB1519666280252_1.png" alt="" title="Android 中 codec-specific data（编解码特征数据）"></p><p>其中可以看到<code>AVC</code>格式的<code>SPS</code>、<code>PPS</code>分别对应<code>csd-0</code>和<code>csd-1</code>。</p><h2 id="FlvPackager"><a href="#FlvPackager" class="headerlink" title="FlvPackager"></a><strong>FlvPackager</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FlvPackager</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLV_TAG_HEADER_LENGTH = <span class="number">11</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLV_VIDEO_TAG_HEADER_LENGTH = <span class="number">5</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLV_AUDIO_TAG_HEADER_LENGTH = <span class="number">2</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FLV_TAG_FOOTER_LENGTH = <span class="number">4</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NALU_HEADER_LENGTH = <span class="number">4</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAvcTag</span><span class="params">(<span class="keyword">byte</span>[] dst, <span class="keyword">int</span> pos, <span class="keyword">boolean</span> isAvcSequenceHeader, <span class="keyword">boolean</span> isIdr, <span class="keyword">int</span> readDataLength)</span> </span>&#123;</div><div class="line">        <span class="comment">// 高 4 位表示 FrameType：1 为关键帧，2 为非关键帧</span></div><div class="line">        <span class="comment">// 低 4 位表示 CodecID：7 为 AVC</span></div><div class="line">        dst[pos] = isIdr ? (<span class="keyword">byte</span>) <span class="number">0x17</span> : (<span class="keyword">byte</span>) <span class="number">0x27</span>;<span class="comment">// FrameType | CodecID</span></div><div class="line">        <span class="comment">// 0 为 AVCDecoderConfigurationRecord，1 为 AVC NALU</span></div><div class="line">        dst[pos + <span class="number">1</span>] = isAvcSequenceHeader ? (<span class="keyword">byte</span>) <span class="number">0x00</span> : (<span class="keyword">byte</span>) <span class="number">0x01</span>;<span class="comment">// AVCPacketType</span></div><div class="line">        dst[pos + <span class="number">2</span>] = (<span class="keyword">byte</span>) <span class="number">0x00</span>;<span class="comment">// CompositionTime</span></div><div class="line">        dst[pos + <span class="number">3</span>] = (<span class="keyword">byte</span>) <span class="number">0x00</span>;<span class="comment">// CompositionTime</span></div><div class="line">        dst[pos + <span class="number">4</span>] = (<span class="keyword">byte</span>) <span class="number">0x00</span>;<span class="comment">// CompositionTime</span></div><div class="line">        <span class="keyword">if</span> (!isAvcSequenceHeader) &#123;</div><div class="line">            <span class="comment">// 4 个字节的 readDataLength</span></div><div class="line">            ByteArrayTools.intToFourByteArray(dst, pos + <span class="number">5</span>, readDataLength);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">setAacTag</span><span class="params">(<span class="keyword">byte</span>[] dst, <span class="keyword">int</span> pos, <span class="keyword">boolean</span> isAACSequenceHeader)</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line"><span class="comment">         * UB[4] 10=AAC</span></div><div class="line"><span class="comment">         * UB[2] 3=44kHz</span></div><div class="line"><span class="comment">         * UB[1] 1=16-bit</span></div><div class="line"><span class="comment">         * UB[1] 0=MonoSound</span></div><div class="line"><span class="comment">         */</span></div><div class="line">        dst[pos] = (<span class="keyword">byte</span>) <span class="number">0xAE</span>;</div><div class="line">        dst[pos + <span class="number">1</span>] = isAACSequenceHeader ? (<span class="keyword">byte</span>) <span class="number">0x00</span> : (<span class="keyword">byte</span>) <span class="number">0x01</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="setAvcTag-byte-dst-int-pos-boolean-isAvcSequenceHeader-boolean-isIdr-int-readDataLength"><a href="#setAvcTag-byte-dst-int-pos-boolean-isAvcSequenceHeader-boolean-isIdr-int-readDataLength" class="headerlink" title="setAvcTag(byte[] dst, int pos, boolean isAvcSequenceHeader, boolean isIdr, int readDataLength)"></a><strong>setAvcTag(byte[] dst, int pos, boolean isAvcSequenceHeader, boolean isIdr, int readDataLength)</strong></h3><p>按<code>FLV</code>要求的<code>AVC</code>的<code>TAG body</code>格式编码。</p><h3 id="setAacTag-byte-dst-int-pos-boolean-isAACSequenceHeader"><a href="#setAacTag-byte-dst-int-pos-boolean-isAACSequenceHeader" class="headerlink" title="setAacTag(byte[] dst, int pos, boolean isAACSequenceHeader)"></a><strong>setAacTag(byte[] dst, int pos, boolean isAACSequenceHeader)</strong></h3><p>按<code>FLV</code>要求的<code>AAC</code>的<code>TAG body</code>格式编码。</p><hr><h1 id="ScreenRecorder"><a href="#ScreenRecorder" class="headerlink" title="ScreenRecorder"></a><strong>ScreenRecorder</strong></h1><p>获取数据，并按照<code>FLV</code>封装格式编码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScreenRecorder</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ScreenRecorder"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String MIME_TYPE = <span class="string">"video/avc"</span>; <span class="comment">// H.264 Advanced Video Coding</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> FRAME_RATE = <span class="number">30</span>; <span class="comment">// 30fps</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IFRAME_INTERVAL = <span class="number">2</span>; <span class="comment">// 2s between I-frames</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TIMEOUT_US = <span class="number">10000</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> ResFlvDataCollecter mDataCollecter;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mHeight;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mBitRate;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDpi;</div><div class="line">    <span class="keyword">private</span> MediaProjection mMediaProjection;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> startTime = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> MediaCodec mediaCodec;</div><div class="line">    <span class="keyword">private</span> Surface surface;</div><div class="line">    <span class="keyword">private</span> AtomicBoolean quit = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">    <span class="keyword">private</span> MediaCodec.BufferInfo bufferInfo = <span class="keyword">new</span> MediaCodec.BufferInfo();</div><div class="line">    <span class="keyword">private</span> VirtualDisplay virtualDisplay;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ScreenRecorder</span><span class="params">(ResFlvDataCollecter dataCollecter, <span class="keyword">int</span> width, <span class="keyword">int</span> height, <span class="keyword">int</span> bitRate, <span class="keyword">int</span> dpi, MediaProjection mediaProjection)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(TAG);</div><div class="line">        mDataCollecter = dataCollecter;</div><div class="line">        mWidth = width;</div><div class="line">        mHeight = height;</div><div class="line">        mBitRate = bitRate;</div><div class="line">        mDpi = dpi;</div><div class="line">        mMediaProjection = mediaProjection;</div><div class="line">        startTime = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">release</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mediaCodec != <span class="keyword">null</span>) &#123;</div><div class="line">            mediaCodec.stop();</div><div class="line">            mediaCodec.release();</div><div class="line">            mediaCodec = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (virtualDisplay != <span class="keyword">null</span>) &#123;</div><div class="line">            virtualDisplay.release();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (mMediaProjection != <span class="keyword">null</span>) &#123;</div><div class="line">            mMediaProjection.stop();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            prepareEncoder();</div><div class="line">            <span class="comment">/*将画面投影到 VirtualDisplay 中*/</span></div><div class="line">            virtualDisplay = mMediaProjection.createVirtualDisplay(TAG, mWidth, mHeight, mDpi,</div><div class="line">                    DisplayManager.VIRTUAL_DISPLAY_FLAG_PUBLIC<span class="comment">/*设置可以将其他显示器的内容反射到该 VirtualDisplay 上（TODO 默认只能是自身应用？）*/</span>,</div><div class="line">                    surface<span class="comment">/*VirtualDisplay 将图像渲染到 Surface 中*/</span>,</div><div class="line">                    <span class="keyword">null</span>, <span class="keyword">null</span>);</div><div class="line">            Log.d(TAG, <span class="string">"created virtual display: "</span> + virtualDisplay);</div><div class="line">            recordVirtualDisplay();</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            release();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">prepareEncoder</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            <span class="comment">// 创建 video/avc 类型的编码器，在这个场景下，MediaCodec 只允许使用 video/avc 编码类型，使用其他的编码会 crash</span></div><div class="line">            mediaCodec = MediaCodec.createEncoderByType(MIME_TYPE);</div><div class="line">            <span class="comment">// 设置视频格式：video/avc</span></div><div class="line">            MediaFormat format = MediaFormat.createVideoFormat(MIME_TYPE, mWidth, mHeight);</div><div class="line">            <span class="comment">// 设置颜色格式：Surface</span></div><div class="line">            format.setInteger(MediaFormat.KEY_COLOR_FORMAT, MediaCodecInfo.CodecCapabilities.COLOR_FormatSurface);</div><div class="line">            <span class="comment">// 设置比特率</span></div><div class="line">            format.setInteger(MediaFormat.KEY_BIT_RATE, mBitRate);</div><div class="line">            <span class="comment">// 设置帧率：30fps</span></div><div class="line">            format.setInteger(MediaFormat.KEY_FRAME_RATE, FRAME_RATE);</div><div class="line">            <span class="comment">// 设置关键帧间隔时间：2s</span></div><div class="line">            format.setInteger(MediaFormat.KEY_I_FRAME_INTERVAL, IFRAME_INTERVAL);</div><div class="line">            <span class="comment">// 编码器应用格式</span></div><div class="line">            mediaCodec.configure(format, <span class="keyword">null</span>, <span class="keyword">null</span>,</div><div class="line">                    MediaCodec.CONFIGURE_FLAG_ENCODE<span class="comment">/*设置该 MediaCodec 作为编码器使用*/</span>);</div><div class="line">            <span class="comment">// 创建 Surface</span></div><div class="line">            surface = mediaCodec.createInputSurface();</div><div class="line">            mediaCodec.start();</div><div class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recordVirtualDisplay</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (!quit.get()) &#123;</div><div class="line">            <span class="comment">// 最多阻塞 10s，用于获取已成功解码的输出缓冲区的索引（缓冲的元数据会放到 bufferInfo 中）或者一个状态值</span></div><div class="line">            <span class="keyword">int</span> eobIndex = mediaCodec.dequeueOutputBuffer(bufferInfo, TIMEOUT_US);</div><div class="line">            <span class="keyword">switch</span> (eobIndex) &#123;</div><div class="line">                <span class="keyword">case</span> MediaCodec.INFO_OUTPUT_FORMAT_CHANGED:</div><div class="line">                    LogTools.d(<span class="string">"MediaCodec.INFO_OUTPUT_FORMAT_CHANGED:"</span> + mediaCodec.getOutputFormat().toString());</div><div class="line">                    sendAvcDecoderConfigurationRecord(<span class="number">0</span>, mediaCodec.getOutputFormat());</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> MediaCodec.INFO_TRY_AGAIN_LATER:</div><div class="line">                    LogTools.d(<span class="string">"MediaCodec.INFO_TRY_AGAIN_LATER"</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">default</span>:</div><div class="line">                    LogTools.d(<span class="string">"mediaCodec eobIndex="</span> + eobIndex);</div><div class="line">                    <span class="comment">/**</span></div><div class="line"><span class="comment">                     * we send sps pps already in INFO_OUTPUT_FORMAT_CHANGED</span></div><div class="line"><span class="comment">                     * so we ignore MediaCodec.BUFFER_FLAG_CODEC_CONFIG</span></div><div class="line"><span class="comment">                     */</span></div><div class="line">                    <span class="keyword">if</span> (bufferInfo.flags != MediaCodec.BUFFER_FLAG_CODEC_CONFIG &amp;&amp; bufferInfo.size != <span class="number">0</span>) &#123;</div><div class="line">                        <span class="keyword">if</span> (startTime == <span class="number">0</span>) &#123;</div><div class="line">                            startTime = bufferInfo.presentationTimeUs / <span class="number">1000</span>;</div><div class="line">                        &#125;</div><div class="line">                        <span class="comment">//</span></div><div class="line">                        ByteBuffer realData = mediaCodec.getOutputBuffer(eobIndex);</div><div class="line">                        <span class="keyword">if</span> (realData != <span class="keyword">null</span>) &#123;</div><div class="line">                            realData.position(bufferInfo.offset + <span class="number">4</span>);<span class="comment">// 跳过用于表示上个 TAG 大小的 4 个字节</span></div><div class="line">                            realData.limit(bufferInfo.offset + bufferInfo.size);</div><div class="line">                            sendAvcData((bufferInfo.presentationTimeUs / <span class="number">1000</span>) - startTime, realData);</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                    mediaCodec.releaseOutputBuffer(eobIndex, <span class="keyword">false</span>);</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendAvcDecoderConfigurationRecord</span><span class="params">(<span class="keyword">long</span> timeMs, MediaFormat format)</span> </span>&#123;</div><div class="line">        <span class="keyword">byte</span>[] avcDecoderConfigurationRecord = Packager.AvcPackager.generateAvcDecoderConfigurationRecord(format);</div><div class="line">        <span class="keyword">int</span> packetLen = Packager.FlvPackager.FLV_VIDEO_TAG_HEADER_LENGTH + avcDecoderConfigurationRecord.length;</div><div class="line">        <span class="keyword">byte</span>[] finalBuff = <span class="keyword">new</span> <span class="keyword">byte</span>[packetLen];</div><div class="line">        <span class="comment">// 在 finalBuff 数组最前面插入 5 个字节的 FLV video TAG header</span></div><div class="line">        Packager.FlvPackager.setAvcTag(finalBuff, <span class="number">0</span>, <span class="keyword">true</span>, <span class="keyword">true</span>, avcDecoderConfigurationRecord.length);</div><div class="line">        <span class="comment">// 将 avcDecoderConfigurationRecord 数组的数据拼接到 finalBuff 数组后面</span></div><div class="line">        System.arraycopy(avcDecoderConfigurationRecord, <span class="number">0</span>, finalBuff, Packager.FlvPackager.FLV_VIDEO_TAG_HEADER_LENGTH, avcDecoderConfigurationRecord.length);</div><div class="line">        ResFlvData resFlvData = <span class="keyword">new</span> ResFlvData();</div><div class="line">        resFlvData.droppable = <span class="keyword">false</span>;</div><div class="line">        resFlvData.byteBuffer = finalBuff;</div><div class="line">        resFlvData.size = finalBuff.length;</div><div class="line">        resFlvData.dts = (<span class="keyword">int</span>) timeMs;</div><div class="line">        resFlvData.flvTagType = FLV_TAGTYPE_VIDEO;</div><div class="line">        resFlvData.videoFrameType = ResFlvData.AVC_NALU_TYPE_IDR;</div><div class="line">        mDataCollecter.collect(resFlvData, FLV_TAGTYPE_VIDEO);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sendAvcData</span><span class="params">(<span class="keyword">long</span> timeMs, ByteBuffer data)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> realDataLength = data.remaining();</div><div class="line">        <span class="keyword">int</span> packetLen = Packager.FlvPackager.FLV_VIDEO_TAG_HEADER_LENGTH + Packager.FlvPackager.NALU_HEADER_LENGTH + realDataLength;</div><div class="line">        <span class="keyword">byte</span>[] finalBuff = <span class="keyword">new</span> <span class="keyword">byte</span>[packetLen];</div><div class="line">        <span class="comment">// 将 data 数组的数据放到 finalBuff 数组的第 Packager.FlvPackager.FLV_VIDEO_TAG_HEADER_LENGTH+Packager.FlvPackager.NALU_HEADER_LENGTH+1 个位置到结束</span></div><div class="line">        data.get(finalBuff, Packager.FlvPackager.FLV_VIDEO_TAG_HEADER_LENGTH + Packager.FlvPackager.NALU_HEADER_LENGTH, realDataLength);</div><div class="line">        <span class="comment">// 获取 NALU 类型，计算后得 5 表示 NALU 类型是 AVC_NALU_TYPE_IDR</span></div><div class="line">        <span class="keyword">int</span> frameType = finalBuff[Packager.FlvPackager.FLV_VIDEO_TAG_HEADER_LENGTH + Packager.FlvPackager.NALU_HEADER_LENGTH] &amp; <span class="number">0x1F</span>;</div><div class="line">        <span class="comment">// 在 finalBuff 数组最前面插入 9 个字节的 FLV video TAG（含 5 个字节的 header 和 4 个字节的 length）</span></div><div class="line">        Packager.FlvPackager.setAvcTag(finalBuff, <span class="number">0</span>, <span class="keyword">false</span>, frameType == <span class="number">5</span>, realDataLength);</div><div class="line">        ResFlvData resFlvData = <span class="keyword">new</span> ResFlvData();</div><div class="line">        resFlvData.droppable = <span class="keyword">true</span>;</div><div class="line">        resFlvData.byteBuffer = finalBuff;</div><div class="line">        resFlvData.size = finalBuff.length;</div><div class="line">        resFlvData.dts = (<span class="keyword">int</span>) timeMs;</div><div class="line">        resFlvData.flvTagType = FLV_TAGTYPE_VIDEO;</div><div class="line">        resFlvData.videoFrameType = frameType;</div><div class="line">        mDataCollecter.collect(resFlvData, FLV_TAGTYPE_VIDEO);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getStatus</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> !quit.get();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        quit.set(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="prepareEncoder"><a href="#prepareEncoder" class="headerlink" title="prepareEncoder()"></a><strong>prepareEncoder()</strong></h2><p>准备编码器。</p><h2 id="recordVirtualDisplay"><a href="#recordVirtualDisplay" class="headerlink" title="recordVirtualDisplay()"></a><strong>recordVirtualDisplay()</strong></h2><p>获取已解码的输出缓冲的索引，或者一个状态值。当是状态值<code>MediaCodec.INFO_OUTPUT_FORMAT_CHANGED</code>时，生成并发送<code>AVC</code>的<code>AVCDecoderConfigurationRecord</code>；否则，生成并发送<code>AVC</code>数据。</p><h2 id="sendAvcDecoderConfigurationRecord-long-timeMs-MediaFormat-format"><a href="#sendAvcDecoderConfigurationRecord-long-timeMs-MediaFormat-format" class="headerlink" title="sendAvcDecoderConfigurationRecord(long timeMs, MediaFormat format)"></a><strong>sendAvcDecoderConfigurationRecord(long timeMs, MediaFormat format)</strong></h2><p>生成并发送<code>AVC</code>的<code>AVCDecoderConfigurationRecord</code>。</p><h2 id="sendAvcData-long-timeMs-ByteBuffer-data"><a href="#sendAvcData-long-timeMs-ByteBuffer-data" class="headerlink" title="sendAvcData(long timeMs, ByteBuffer data)"></a><strong>sendAvcData(long timeMs, ByteBuffer data)</strong></h2><p>生成并发送<code>AVC</code>数据。</p><hr><h1 id="FlvMetaData"><a href="#FlvMetaData" class="headerlink" title="FlvMetaData"></a><strong>FlvMetaData</strong></h1><p>按<code>FLV</code>要求的<code>onMetaData</code>格式编码。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlvMetaData</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NAME = <span class="string">"onMetaData"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODEC_ID_AAC = <span class="number">7</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> CODEC_ID_AVC = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_NUMBER = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_STRING = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> TYPE_ECMA_ARRAY = <span class="number">8</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> EMPTY_SIZE = <span class="number">21</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] END_MARKER = &#123;<span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x09</span>&#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dataSize;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] metaData;</div><div class="line">    <span class="keyword">private</span> ArrayList&lt;<span class="keyword">byte</span>[]&gt; metaDataList;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> pointer;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlvMetaData</span><span class="params">()</span> </span>&#123;</div><div class="line">        metaDataList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">        dataSize = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">FlvMetaData</span><span class="params">(ResCoreParameters parameters)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>();</div><div class="line">        <span class="comment">// audio</span></div><div class="line">        setProperty(<span class="string">"audiocodecid"</span>, CODEC_ID_AAC);</div><div class="line">        <span class="keyword">switch</span> (parameters.mediacodecAACBitRate) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="number">32</span> * <span class="number">1024</span>:</div><div class="line">                setProperty(<span class="string">"audiodatarate"</span>, <span class="number">32</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">48</span> * <span class="number">1024</span>:</div><div class="line">                setProperty(<span class="string">"audiodatarate"</span>, <span class="number">48</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> <span class="number">64</span> * <span class="number">1024</span>:</div><div class="line">                setProperty(<span class="string">"audiodatarate"</span>, <span class="number">64</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                LogTools.e(<span class="string">"不支持的 audiodatarate: "</span> + parameters.mediacodecAACBitRate);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">switch</span> (parameters.mediacodecAACSampleRate) &#123;</div><div class="line">            <span class="keyword">case</span> <span class="number">44100</span>:</div><div class="line">                setProperty(<span class="string">"audiosamplerate"</span>, <span class="number">44100</span>);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">default</span>:</div><div class="line">                LogTools.e(<span class="string">"不支持的 audiosamplerate: "</span> + parameters.mediacodecAACSampleRate);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="comment">// video</span></div><div class="line">        setProperty(<span class="string">"videocodecid"</span>, CODEC_ID_AVC);</div><div class="line">        setProperty(<span class="string">"framerate"</span>, parameters.mediacodecAVCFrameRate);</div><div class="line">        setProperty(<span class="string">"width"</span>, parameters.videoWidth);</div><div class="line">        setProperty(<span class="string">"height"</span>, parameters.videoHeight);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setProperty</span><span class="params">(String key, <span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">        addProperty(toFlvBytes(key), (<span class="keyword">byte</span>) TYPE_NUMBER, toFlvBytes(value));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setProperty</span><span class="params">(String key, String value)</span> </span>&#123;</div><div class="line">        addProperty(toFlvBytes(key), (<span class="keyword">byte</span>) TYPE_STRING, toFlvBytes(value));</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addProperty</span><span class="params">(<span class="keyword">byte</span>[] key, <span class="keyword">byte</span> dataType, <span class="keyword">byte</span>[] value)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> propertySize = key.length + <span class="number">1</span> + value.length;</div><div class="line">        <span class="keyword">byte</span>[] property = <span class="keyword">new</span> <span class="keyword">byte</span>[propertySize];</div><div class="line"></div><div class="line">        <span class="comment">// property 数组的前 key.length 个元素是 key 数组</span></div><div class="line">        System.arraycopy(key, <span class="number">0</span>, property, <span class="number">0</span>, key.length);</div><div class="line">        <span class="comment">// property 数组的第 key.length+1 个元素是 dataType</span></div><div class="line">        property[key.length] = dataType;</div><div class="line">        <span class="comment">// property 数组的后 value.length 个元素是 value 数组</span></div><div class="line">        System.arraycopy(value, <span class="number">0</span>, property, key.length + <span class="number">1</span>, value.length);</div><div class="line"></div><div class="line">        metaDataList.add(property);</div><div class="line">        dataSize += propertySize;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 将 double 类型的值转为 8 字节的数组</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] toFlvBytes(<span class="keyword">double</span> value) &#123;</div><div class="line">        <span class="keyword">long</span> l = Double.doubleToLongBits(value);</div><div class="line">        <span class="keyword">return</span> toUI(l, <span class="number">8</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 将 String 类型的值转为 值长度+2 字节的数组，其中前 2 个字节表示数组的长度，后面的是数据</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] toFlvBytes(String value) &#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[value.length() + <span class="number">2</span>];</div><div class="line">        <span class="comment">// bytes 数组的前 2 个元素表示 value 的长度</span></div><div class="line">        System.arraycopy(toUI(value.length(), <span class="number">2</span>), <span class="number">0</span>, bytes, <span class="number">0</span>, <span class="number">2</span>);</div><div class="line">        <span class="comment">// bytes 数组第 3 个元素到最后一个元素是数据</span></div><div class="line">        System.arraycopy(value.getBytes(), <span class="number">0</span>, bytes, <span class="number">2</span>, value.length());</div><div class="line">        <span class="keyword">return</span> bytes;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 将 value 转为指定字节数的数组</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> value</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> length</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] toUI(<span class="keyword">long</span> value, <span class="keyword">int</span> length) &#123;</div><div class="line">        <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[length];</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</div><div class="line">            bytes[length - <span class="number">1</span> - i] = (<span class="keyword">byte</span>) (value &gt;&gt; (<span class="number">8</span> * i) &amp; <span class="number">0xff</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> bytes;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 构建 SCRIPT TAG</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@return</span></span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getMetaData() &#123;</div><div class="line">        metaData = <span class="keyword">new</span> <span class="keyword">byte</span>[dataSize + EMPTY_SIZE];</div><div class="line">        pointer = <span class="number">0</span>;</div><div class="line">        <span class="comment">// 设置下一个内容的类型</span></div><div class="line">        addByte(TYPE_STRING);<span class="comment">// 1 个字节</span></div><div class="line">        addByteArray(toFlvBytes(NAME));<span class="comment">// 12 个字节</span></div><div class="line">        <span class="comment">// 设置下一个内容的类型</span></div><div class="line">        addByte(TYPE_ECMA_ARRAY);<span class="comment">// 1 个字节</span></div><div class="line">        addByteArray(toUI(metaDataList.size(), <span class="number">4</span>));<span class="comment">// 4 个字节</span></div><div class="line">        <span class="keyword">for</span> (<span class="keyword">byte</span>[] property : metaDataList) &#123;</div><div class="line">            addByteArray(property);<span class="comment">// property长度 个字节</span></div><div class="line">        &#125;</div><div class="line">        addByteArray(END_MARKER);<span class="comment">// 3 个字节</span></div><div class="line">        <span class="keyword">return</span> metaData;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addByte</span><span class="params">(<span class="keyword">int</span> value)</span> </span>&#123;</div><div class="line">        metaData[pointer] = (<span class="keyword">byte</span>) value;</div><div class="line">        pointer++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addByteArray</span><span class="params">(<span class="keyword">byte</span>[] value)</span> </span>&#123;</div><div class="line">        System.arraycopy(value, <span class="number">0</span>, metaData, pointer, value.length);</div><div class="line">        pointer += value.length;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="screenrecorderrtmp"><a href="#screenrecorderrtmp" class="headerlink" title="screenrecorderrtmp"></a><strong>screenrecorderrtmp</strong></h1><p>通过和<code>librtmp</code>C库交互，实现数据流读/写。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;screenrecorderrtmp.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;malloc.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"rtmp.h"</span></span></div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Class:     net_yrom_screenrecorder_rtmp_RtmpClient</span></div><div class="line"><span class="comment"> * Method:    open</span></div><div class="line"><span class="comment"> * Signature: (Ljava/lang/String;Z)J</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">JNIEXPORT jlong JNICALL <span class="title">Java_net_yrom_screenrecorder_rtmp_RtmpClient_open</span><span class="params">(JNIEnv * env, jobject thiz, jstring url_, jboolean isPublishMode)</span> </span>&#123;</div><div class="line"> LOGD(<span class="string">"Java_net_yrom_screenrecorder_rtmp_RtmpClient_open(%s, %b)"</span>, url_, isPublishMode);</div><div class="line">   <span class="keyword">const</span> <span class="keyword">char</span> *url = (*env)-&gt;GetStringUTFChars(env, url_, <span class="number">0</span>);</div><div class="line"></div><div class="line">    <span class="comment">// 创建一个 RTMP 会话的句柄</span></div><div class="line">   RTMP* rtmp = RTMP_Alloc();</div><div class="line">   <span class="keyword">if</span> (rtmp == <span class="literal">NULL</span>) &#123;</div><div class="line">   LOGD(<span class="string">"rtmp == NULL"</span>);</div><div class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">   &#125;</div><div class="line">   <span class="comment">// 初始化句柄</span></div><div class="line">   RTMP_Init(rtmp);</div><div class="line"></div><div class="line">    <span class="comment">// 设置参数</span></div><div class="line">   <span class="keyword">int</span> ret = RTMP_SetupURL(rtmp, url);</div><div class="line">   <span class="keyword">if</span> (!ret) &#123;</div><div class="line">       <span class="comment">// 清理会话</span></div><div class="line">   RTMP_Free(rtmp);</div><div class="line">   rtmp = <span class="literal">NULL</span>;</div><div class="line">   LOGD(<span class="string">"RTMP_SetupURL: %d"</span>, ret);</div><div class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (isPublishMode) &#123;</div><div class="line">       <span class="comment">// 设置可写</span></div><div class="line">   RTMP_EnableWrite(rtmp);</div><div class="line">   &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 建立 RTMP 链接中的网络连接</span></div><div class="line">   ret = RTMP_Connect(rtmp, <span class="literal">NULL</span>);</div><div class="line">   <span class="keyword">if</span> (!ret) &#123;</div><div class="line">       <span class="comment">// 清理会话</span></div><div class="line">   RTMP_Free(rtmp);</div><div class="line">   rtmp = <span class="literal">NULL</span>;</div><div class="line">   LOGD(<span class="string">"RTMP_Connect: %d"</span>, ret);</div><div class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 建立 RTMP 链接中的网络流</span></div><div class="line">   ret = RTMP_ConnectStream(rtmp, <span class="number">0</span>);</div><div class="line">   <span class="keyword">if</span> (!ret) &#123;</div><div class="line">       <span class="comment">// 关闭 RTMP 链接</span></div><div class="line">   RTMP_Close(rtmp);</div><div class="line">       <span class="comment">// 清理会话</span></div><div class="line">   RTMP_Free(rtmp);</div><div class="line">   rtmp = <span class="literal">NULL</span>;</div><div class="line">   LOGD(<span class="string">"RTMP_ConnectStream: %d"</span>, ret);</div><div class="line">   <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   (*env)-&gt;ReleaseStringUTFChars(env, url_, url);</div><div class="line">   LOGD(<span class="string">"RTMP_OPENED"</span>);</div><div class="line">   <span class="keyword">return</span> rtmp;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Class:     net_yrom_screenrecorder_rtmp_RtmpClient</span></div><div class="line"><span class="comment"> * Method:    read</span></div><div class="line"><span class="comment"> * Signature: (J[BII)I</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_net_yrom_screenrecorder_rtmp_RtmpClient_read</span><span class="params">(JNIEnv * env, jobject thiz, jlong rtmp, jbyteArray data_, jint offset, jint size)</span> </span>&#123;</div><div class="line"> LOGD(<span class="string">"Java_net_yrom_screenrecorder_rtmp_RtmpClient_read(%d, %d, %d)"</span>, rtmp, offset, size);</div><div class="line"> <span class="keyword">char</span>* data = <span class="built_in">malloc</span>(size*<span class="keyword">sizeof</span>(<span class="keyword">char</span>));</div><div class="line"> <span class="keyword">int</span> readCount = RTMP_Read((RTMP*)rtmp, data, size);</div><div class="line"> <span class="keyword">if</span> (readCount &gt; <span class="number">0</span>) &#123;</div><div class="line">        (*env)-&gt;SetByteArrayRegion(env, data_, offset, readCount, data);</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">free</span>(data);</div><div class="line">    <span class="keyword">return</span> readCount;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Class:     net_yrom_screenrecorder_rtmp_RtmpClient</span></div><div class="line"><span class="comment"> * Method:    write</span></div><div class="line"><span class="comment"> * Signature: (J[BIII)I</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_net_yrom_screenrecorder_rtmp_RtmpClient_write</span><span class="params">(JNIEnv * env, jobject thiz, jlong rtmp, jbyteArray data, jint size, jint type, jint ts)</span> </span>&#123;</div><div class="line"> LOGD(<span class="string">"Java_net_yrom_screenrecorder_rtmp_RtmpClient_write(%d, %d, %d, %d)"</span>, rtmp, size, type, ts);</div><div class="line"> RTMPPacket *packet = (RTMPPacket*)<span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(RTMPPacket));</div><div class="line"> RTMPPacket_Alloc(packet, size);</div><div class="line"> RTMPPacket_Reset(packet);</div><div class="line"> <span class="comment">// 设置 Chunk Stream ID</span></div><div class="line">    <span class="keyword">if</span> (type == RTMP_PACKET_TYPE_INFO) &#123;<span class="comment">// metadata</span></div><div class="line">    packet-&gt;m_nChannel = <span class="number">0x03</span>;<span class="comment">// 自定义 Chunk Stream ID</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RTMP_PACKET_TYPE_VIDEO) &#123;<span class="comment">// video</span></div><div class="line">    packet-&gt;m_nChannel = <span class="number">0x04</span>;<span class="comment">// 自定义 Chunk Stream ID</span></div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type == RTMP_PACKET_TYPE_AUDIO) &#123;<span class="comment">// audio</span></div><div class="line">    packet-&gt;m_nChannel = <span class="number">0x05</span>;<span class="comment">// 自定义 Chunk Stream ID</span></div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">    packet-&gt;m_nChannel = <span class="number">-1</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 设置 Stream ID</span></div><div class="line">    packet-&gt;m_nInfoField2  =  ((RTMP*)rtmp)-&gt;m_stream_id;</div><div class="line"> LOGD(<span class="string">"((RTMP*)rtmp)-&gt;m_stream_id: %d"</span>, ((RTMP*)rtmp)-&gt;m_stream_id);</div><div class="line"></div><div class="line"> jbyte *buffer = (*env)-&gt;GetByteArrayElements(env, data, <span class="literal">NULL</span>);</div><div class="line">    <span class="built_in">memcpy</span>(packet-&gt;m_body, buffer, size);</div><div class="line">    <span class="comment">// 设置 Message Header 的格式和长度：0</span></div><div class="line">    packet-&gt;m_headerType = RTMP_PACKET_SIZE_LARGE;</div><div class="line">    <span class="comment">// 设置是否使用绝对时间戳：不使用</span></div><div class="line">    packet-&gt;m_hasAbsTimestamp = FALSE;</div><div class="line">    <span class="comment">// 设置时间戳</span></div><div class="line">    packet-&gt;m_nTimeStamp = ts;</div><div class="line">    <span class="comment">// 设置包类型</span></div><div class="line">    packet-&gt;m_packetType = type;</div><div class="line">    <span class="comment">// 设置消息长度</span></div><div class="line">    packet-&gt;m_nBodySize  = size;</div><div class="line"></div><div class="line">    <span class="keyword">int</span> ret = RTMP_SendPacket((RTMP*)rtmp, packet, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (!ret) &#123;</div><div class="line">    LOGD(<span class="string">"end write error: %d"</span>, ret);</div><div class="line"><span class="keyword">return</span> ret;</div><div class="line">    &#125;<span class="keyword">else</span>&#123;</div><div class="line">    LOGD(<span class="string">"end write success"</span>);</div><div class="line"><span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    RTMPPacket_Free(packet);</div><div class="line">    <span class="built_in">free</span>(packet);</div><div class="line">    (*env)-&gt;ReleaseByteArrayElements(env, data, buffer, <span class="number">0</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Class:     net_yrom_screenrecorder_rtmp_RtmpClient</span></div><div class="line"><span class="comment"> * Method:    close</span></div><div class="line"><span class="comment"> * Signature: (J)I</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_net_yrom_screenrecorder_rtmp_RtmpClient_close</span><span class="params">(JNIEnv * env, jlong rtmp, jobject thiz)</span> </span>&#123;</div><div class="line"> LOGD(<span class="string">"Java_net_yrom_screenrecorder_rtmp_RtmpClient_close(%d)"</span>, rtmp);</div><div class="line"> RTMP_Close((RTMP*)rtmp);</div><div class="line"> RTMP_Free((RTMP*)rtmp);</div><div class="line"> <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/*</span></div><div class="line"><span class="comment"> * Class:     net_yrom_screenrecorder_rtmp_RtmpClient</span></div><div class="line"><span class="comment"> * Method:    getIpAddr</span></div><div class="line"><span class="comment"> * Signature: (J)Ljava/lang/String;</span></div><div class="line"><span class="comment"> */</span></div><div class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_net_yrom_screenrecorder_rtmp_RtmpClient_getIpAddr</span><span class="params">(JNIEnv * env, jobject thiz, jlong rtmp)</span> </span>&#123;</div><div class="line"> LOGD(<span class="string">"Java_net_yrom_screenrecorder_rtmp_RtmpClient_getIpAddr(%d)"</span>, rtmp);</div><div class="line"><span class="keyword">if</span>(rtmp!=<span class="number">0</span>)&#123;</div><div class="line">RTMP* r= (RTMP*)rtmp;</div><div class="line"><span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, r-&gt;ipaddr);</div><div class="line">&#125;<span class="keyword">else</span> &#123;</div><div class="line"><span class="keyword">return</span> (*env)-&gt;NewStringUTF(env, <span class="string">""</span>);</div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="RtmpStreamingSender"><a href="#RtmpStreamingSender" class="headerlink" title="RtmpStreamingSender"></a><strong>RtmpStreamingSender</strong></h1><p>维护一个发送队列，在连接服务端成功后，不断发送数据到服务端，如果发送速率低于添加速率，会跳过部分帧。当屏幕捕捉后，尝试添加到队列中，如果队列已满，则放弃添加到队列中。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RtmpStreamingSender</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"RtmpStreamingSender"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">STATE</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> START = <span class="number">0</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> RUNNING = <span class="number">1</span>;</div><div class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STOPPED = <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">int</span> state;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String mRtmpAddr = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object lock = <span class="keyword">new</span> Object();</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_QUEUE_CAPACITY = <span class="number">50</span>;</div><div class="line">    <span class="keyword">private</span> LinkedBlockingDeque&lt;ResFlvData&gt; frameQueue = <span class="keyword">new</span> LinkedBlockingDeque&lt;&gt;(MAX_QUEUE_CAPACITY);</div><div class="line">    <span class="keyword">private</span> AtomicBoolean quit = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</div><div class="line">    <span class="keyword">private</span> FlvMetaData flvMetaData;</div><div class="line">    <span class="keyword">private</span> ResCoreParameters coreParameters;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">long</span> jniRtmpPointer = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> writeMsgNum = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RtmpStreamingSender</span><span class="params">()</span> </span>&#123;</div><div class="line">        coreParameters = <span class="keyword">new</span> ResCoreParameters();</div><div class="line">        coreParameters.mediacodecAACBitRate = ResFlvData.AAC_BITRATE;</div><div class="line">        coreParameters.mediacodecAACSampleRate = ResFlvData.AAC_SAMPLE_RATE;</div><div class="line">        coreParameters.mediacodecAVCFrameRate = ResFlvData.FPS;</div><div class="line">        coreParameters.videoWidth = ResFlvData.VIDEO_WIDTH;</div><div class="line">        coreParameters.videoHeight = ResFlvData.VIDEO_HEIGHT;</div><div class="line"></div><div class="line">        flvMetaData = <span class="keyword">new</span> FlvMetaData(coreParameters);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">while</span> (!quit.get()) &#123;</div><div class="line">            <span class="keyword">if</span> (frameQueue.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">                <span class="keyword">switch</span> (state) &#123;</div><div class="line">                    <span class="keyword">case</span> STATE.START:</div><div class="line">                        <span class="keyword">if</span> (TextUtils.isEmpty(mRtmpAddr)) &#123;</div><div class="line">                            LogTools.e(<span class="string">"rtmp address is null!"</span>);</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// 建立 RTMP 链接</span></div><div class="line">                        jniRtmpPointer = RtmpClient.open(mRtmpAddr, <span class="keyword">true</span>);</div><div class="line">                        <span class="keyword">if</span> (jniRtmpPointer != <span class="number">0</span>) &#123;</div><div class="line">                            <span class="comment">// 获取地址</span></div><div class="line">                            String serverIpAddr = RtmpClient.getIpAddr(jniRtmpPointer);</div><div class="line">                            LogTools.d(<span class="string">"server ip address: "</span> + serverIpAddr);</div><div class="line"></div><div class="line">                            <span class="comment">// 发送 onMetaData TAG</span></div><div class="line">                            <span class="keyword">byte</span>[] metaData = flvMetaData.getMetaData();</div><div class="line">                            RtmpClient.write(jniRtmpPointer, metaData, metaData.length, ResFlvData.FLV_TAGTYPE_SCRIPT_DATA, <span class="number">0</span>);</div><div class="line"></div><div class="line">                            state = STATE.RUNNING;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> STATE.RUNNING:</div><div class="line">                        <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">                            --writeMsgNum;</div><div class="line">                        &#125;</div><div class="line">                        ResFlvData flvData = frameQueue.pop();</div><div class="line"></div><div class="line">                        <span class="comment">// 如果发送队列中的数据过多，在条件满足的情况下，忽略这个数据</span></div><div class="line">                        <span class="keyword">if</span> (writeMsgNum &gt;= (MAX_QUEUE_CAPACITY * <span class="number">2</span> / <span class="number">3</span>) &amp;&amp; flvData.flvTagType == ResFlvData.FLV_TAGTYPE_VIDEO &amp;&amp; flvData.droppable) &#123;</div><div class="line">                            LogTools.d(<span class="string">"senderQueue is crowded, abort a frame"</span>);</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line"></div><div class="line">                        <span class="comment">// 发送 AVC TAG</span></div><div class="line">                        <span class="keyword">int</span> result = RtmpClient.write(jniRtmpPointer, flvData.byteBuffer, flvData.byteBuffer.length, flvData.flvTagType, flvData.dts);</div><div class="line">                        <span class="keyword">if</span> (result == <span class="number">0</span>) &#123;</div><div class="line">                            <span class="keyword">switch</span> (flvData.flvTagType) &#123;</div><div class="line">                                <span class="keyword">case</span> ResFlvData.FLV_TAGTYPE_VIDEO:</div><div class="line">                                    LogTools.d(<span class="string">"video frame sent: "</span> + flvData.size);</div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                                <span class="keyword">case</span> ResFlvData.FLV_TAGTYPE_AUDIO:</div><div class="line">                                    LogTools.d(<span class="string">"audio frame sent: "</span> + flvData.size);</div><div class="line">                                    <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            LogTools.e(<span class="string">"write error: "</span> + result);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="keyword">case</span> STATE.STOPPED:</div><div class="line">                        <span class="comment">// 关闭 RTMP 链接</span></div><div class="line">                        result = RtmpClient.close(jniRtmpPointer);</div><div class="line">                        LogTools.d(<span class="string">"close result: "</span> + result);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> result = RtmpClient.close(jniRtmpPointer);</div><div class="line">        LogTools.e(<span class="string">"close result: "</span> + result);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendStart</span><span class="params">(String rtmpAddr)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">            writeMsgNum = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        mRtmpAddr = rtmpAddr;</div><div class="line">        state = STATE.START;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">            writeMsgNum = <span class="number">0</span>;</div><div class="line">        &#125;</div><div class="line">        state = STATE.STOPPED;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendFood</span><span class="params">(ResFlvData flvData, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">        <span class="keyword">synchronized</span> (lock) &#123;</div><div class="line">            <span class="keyword">if</span> (writeMsgNum &lt;= MAX_QUEUE_CAPACITY) &#123;</div><div class="line">                frameQueue.add(flvData);</div><div class="line">                ++writeMsgNum;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                LogTools.d(<span class="string">"senderQueue is full, abort a frame"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">quit</span><span class="params">()</span> </span>&#123;</div><div class="line">        quit.set(<span class="keyword">true</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="ScreenRecordActivity"><a href="#ScreenRecordActivity" class="headerlink" title="ScreenRecordActivity"></a><strong>ScreenRecordActivity</strong></h1><p>控制屏幕捕捉和推流。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScreenRecordActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">View</span>.<span class="title">OnClickListener</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"ScreenRecordActivity"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> REQUEST_CODE = <span class="number">1</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Button button;</div><div class="line">    <span class="keyword">private</span> EditText rtmpAddrET;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> String rtmpAddr;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isRecording;</div><div class="line">    <span class="keyword">private</span> MediaProjectionManager mediaProjectionManager;</div><div class="line">    <span class="keyword">private</span> ScreenRecorder screenRecorder;</div><div class="line">    <span class="keyword">private</span> RtmpStreamingSender streamingSender;</div><div class="line">    <span class="keyword">private</span> ExecutorService executorService;</div><div class="line">    <span class="keyword">private</span> ResAudioClient audioClient;</div><div class="line">    <span class="keyword">private</span> ResCoreParameters coreParameters;</div><div class="line">    <span class="keyword">private</span> ServiceConnection connection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">launchActivity</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(context, ScreenRecordActivity.class);</div><div class="line">        intent.setFlags(Intent.FLAG_ACTIVITY_NEW_TASK);</div><div class="line">        context.startActivity(intent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line"></div><div class="line">        button = findViewById(R.id.button);</div><div class="line">        button.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        rtmpAddrET = findViewById(R.id.et_rtmp_address);</div><div class="line"></div><div class="line">        mediaProjectionManager = (MediaProjectionManager) getSystemService(MEDIA_PROJECTION_SERVICE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onResume</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onResume();</div><div class="line">        <span class="keyword">if</span> (isRecording) &#123;</div><div class="line">            stopScreenRecordService();<span class="comment">// 在录屏状态，切换回应用，则停止录屏</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onStop();</div><div class="line">        <span class="keyword">if</span> (isRecording) &#123;</div><div class="line">            startScreenRecordService();<span class="comment">// 最小化应用后，开始录屏</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onDestroy();</div><div class="line">        <span class="keyword">if</span> (screenRecorder != <span class="keyword">null</span>) &#123;</div><div class="line">            stopScreenRecord();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (screenRecorder != <span class="keyword">null</span>) &#123;</div><div class="line">            stopScreenRecord();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            startScreenCapture();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onActivityResult</span><span class="params">(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode, Intent data)</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"onActivityResult("</span> + requestCode + <span class="string">", "</span> + resultCode + <span class="string">")"</span>);</div><div class="line">        MediaProjection mediaProjection = mediaProjectionManager.getMediaProjection(resultCode, data);<span class="comment">// 获取屏幕捕捉</span></div><div class="line">        <span class="keyword">if</span> (mediaProjection == <span class="keyword">null</span>) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"media projection is null"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        rtmpAddr = rtmpAddrET.getText().toString().trim();</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(rtmpAddr)) &#123;</div><div class="line">            Log.e(TAG, <span class="string">"rtmp address cannot be null"</span>);</div><div class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">"rtmp address cannot be null"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        coreParameters = <span class="keyword">new</span> ResCoreParameters();</div><div class="line">        audioClient = <span class="keyword">new</span> ResAudioClient(coreParameters);</div><div class="line">        <span class="keyword">if</span> (!audioClient.prepare()) &#123;</div><div class="line">            LogTools.d(<span class="string">"!!!!!audioClient.prepare() failed"</span>);</div><div class="line">            <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        streamingSender = <span class="keyword">new</span> RtmpStreamingSender();</div><div class="line">        streamingSender.sendStart(rtmpAddr);</div><div class="line">        ResFlvDataCollecter collecter = <span class="keyword">new</span> ResFlvDataCollecter() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(ResFlvData flvData, <span class="keyword">int</span> type)</span> </span>&#123;</div><div class="line">                streamingSender.sendFood(flvData, type);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        screenRecorder = <span class="keyword">new</span> ScreenRecorder(collecter, ResFlvData.VIDEO_WIDTH, ResFlvData.VIDEO_HEIGHT, ResFlvData.VIDEO_BITRATE, <span class="number">1</span>, mediaProjection);</div><div class="line">        screenRecorder.start();</div><div class="line">        audioClient.start(collecter);</div><div class="line"></div><div class="line">        executorService = Executors.newCachedThreadPool();</div><div class="line">        executorService.execute(streamingSender);</div><div class="line"></div><div class="line">        button.setText(<span class="string">"Stop Recorder"</span>);</div><div class="line">        Toast.makeText(<span class="keyword">this</span>, <span class="string">"Screen recorder is running..."</span>, Toast.LENGTH_LONG).show();</div><div class="line">        moveTaskToBack(<span class="keyword">true</span>);<span class="comment">// 最小化应用</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScreenCapture</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"startScreenCapture()"</span>);</div><div class="line">        isRecording = <span class="keyword">true</span>;</div><div class="line">        Intent captureIntent = mediaProjectionManager.createScreenCaptureIntent();<span class="comment">// 获取封装好的用于开始屏幕捕捉的 intent</span></div><div class="line">        startActivityForResult(captureIntent, REQUEST_CODE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopScreenRecord</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"stopScreenRecord()"</span>);</div><div class="line">        screenRecorder.quit();</div><div class="line">        screenRecorder = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">if</span> (streamingSender != <span class="keyword">null</span>) &#123;</div><div class="line">            streamingSender.sendStop();</div><div class="line">            streamingSender.quit();</div><div class="line">            streamingSender = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (executorService != <span class="keyword">null</span>) &#123;</div><div class="line">            executorService.shutdown();</div><div class="line">            executorService = <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line">        button.setText(<span class="string">"Restart recorder"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startScreenRecordService</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"startScreenRecordService()"</span>);</div><div class="line">        <span class="keyword">if</span> (screenRecorder != <span class="keyword">null</span> &amp;&amp; screenRecorder.getStatus()) &#123;</div><div class="line">            Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ScreenRecordListenerService.class);</div><div class="line">            bindService(intent, connection, BIND_AUTO_CREATE);</div><div class="line">            startService(intent);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">stopScreenRecordService</span><span class="params">()</span> </span>&#123;</div><div class="line">        Log.d(TAG, <span class="string">"stopScreenRecordService()"</span>);</div><div class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, ScreenRecordListenerService.class);</div><div class="line">        stopService(intent);</div><div class="line">        <span class="keyword">if</span> (screenRecorder != <span class="keyword">null</span> &amp;&amp; screenRecorder.getStatus()) &#123;</div><div class="line">            Toast.makeText(<span class="keyword">this</span>, <span class="string">"现在正在进行录屏直播哦"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="onActivityResult-int-requestCode-int-resultCode-Intent-data"><a href="#onActivityResult-int-requestCode-int-resultCode-Intent-data" class="headerlink" title="onActivityResult(int requestCode, int resultCode, Intent data)"></a><strong>onActivityResult(int requestCode, int resultCode, Intent data)</strong></h2><p>向输入框中的地址进行<code>RTMP</code>推流。</p><h2 id="startScreenCapture"><a href="#startScreenCapture" class="headerlink" title="startScreenCapture()"></a><strong>startScreenCapture()</strong></h2><p>开始屏幕捕捉。</p><h2 id="stopScreenRecord"><a href="#stopScreenRecord" class="headerlink" title="stopScreenRecord()"></a><strong>stopScreenRecord()</strong></h2><p>停止屏幕捕捉。</p><h2 id="startScreenRecordService"><a href="#startScreenRecordService" class="headerlink" title="startScreenRecordService()"></a><strong>startScreenRecordService()</strong></h2><p>开始监听推流进度。</p><h2 id="stopScreenRecordService"><a href="#stopScreenRecordService" class="headerlink" title="stopScreenRecordService()"></a><strong>stopScreenRecordService()</strong></h2><p>停止监听推流进度。</p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://gi
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>实现同屏</title>
    <link href="http://www.weichao.io/2018/02/24/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F/"/>
    <id>http://www.weichao.io/2018/02/24/实现同屏/</id>
    <published>2018-02-24T15:49:48.000Z</published>
    <updated>2018-02-24T16:05:07.610Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="http://nginx.org/en/download.html" title="http://nginx.org/en/download.html" target="_blank" rel="external">nginx: download</a></li><li><a href="http://www.voidcn.com/article/p-bmtzuklh-xa.html" title="http://www.voidcn.com/article/p-bmtzuklh-xa.html" target="_blank" rel="external">nginx hls rtmp 环境搭建</a></li><li><a href="http://blog.csdn.net/luyaran/article/details/53908846" title="http://blog.csdn.net/luyaran/article/details/53908846" target="_blank" rel="external">使用 nginx 与 nginx-rtmp-module 搭建流媒体服务器</a></li><li><a href="http://blog.csdn.net/zxccxzzxz/article/details/55230272" title="http://blog.csdn.net/zxccxzzxz/article/details/55230272" target="_blank" rel="external">Android实现录屏直播（三）MediaProjection + VirtualDisplay + librtmp + MediaCodec实现视频编码并推流到rtmp服务器</a></li><li><a href="https://github.com/eterrao/ScreenRecorder" title="https://github.com/eterrao/ScreenRecorder" target="_blank" rel="external">ScreenRecorder</a></li></ul><hr><h1 id="nginx-rtmp-环境搭建"><a href="#nginx-rtmp-环境搭建" class="headerlink" title="nginx + rtmp 环境搭建"></a><strong>nginx + rtmp 环境搭建</strong></h1><h2 id="创建-nginx-文件夹"><a href="#创建-nginx-文件夹" class="headerlink" title="创建 nginx 文件夹"></a><strong>创建 nginx 文件夹</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd ~</div><div class="line">mkdir nginx</div><div class="line">cd nginx</div></pre></td></tr></table></figure><h2 id="下载最新稳定版-nginx"><a href="#下载最新稳定版-nginx" class="headerlink" title="下载最新稳定版 nginx"></a><strong>下载最新稳定版 nginx</strong></h2><p>1、登录<a href="http://nginx.org/en/download.html" title="http://nginx.org/en/download.html" target="_blank" rel="external">nginx 官方下载页面</a>，查看最新稳定版本号</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F1.png" alt=""></p><p>可以看到版本号为<code>1.12.2</code></p><p>2、下载并解压缩 nginx 包</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget http://nginx.org/download/nginx-1.12.2.tar.gz</div><div class="line">tar -zxvf nginx-1.12.2.tar.gz</div></pre></td></tr></table></figure><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F2.png" alt=""></p><p>然后在<code>nginx</code>文件夹中会出现<code>nginx-1.12.2</code>文件夹</p><h2 id="下载-nginx-rtmp-module"><a href="#下载-nginx-rtmp-module" class="headerlink" title="下载 nginx-rtmp-module"></a><strong>下载 nginx-rtmp-module</strong></h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/arut/nginx-rtmp-module.git</div></pre></td></tr></table></figure><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F3.png" alt=""></p><p>然后在<code>nginx</code>文件夹中会出现<code>nginx-rtmp-module</code>文件夹</p><h2 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a><strong>安装 nginx</strong></h2><p>1、切换到 root</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">su root</div></pre></td></tr></table></figure><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F4.png" alt=""></p><p>2、安装 nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd nginx-1.12.2 </div><div class="line">./configure --prefix=/usr/local/nginx  --add-module=../nginx-rtmp-module  --with-http_ssl_module    </div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure><p>3、浏览器访问<code>localhost</code>，如果出现以下页面说明安装成功</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F5.png" alt=""></p><h2 id="修改-nginx-配置文件"><a href="#修改-nginx-配置文件" class="headerlink" title="修改 nginx 配置文件"></a><strong>修改 nginx 配置文件</strong></h2><p>1、查看端口是否被占用（比如端口<code>1395</code>）</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">lsof -i:1395</div></pre></td></tr></table></figure><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F6.png" alt=""></p><p>如果未查询到端口信息，说明端口未被占用</p><p>2、编辑 nginx 配置文件</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gedit /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure><p>使用端口<code>1395</code>作为<code>rtmp</code>推流端口，端口<code>81</code>作为拉流端口：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line"><span class="meta">#</span>error_log  logs/error.log;</div><div class="line"><span class="meta">#</span>error_log  logs/error.log  notice;</div><div class="line"><span class="meta">#</span>error_log  logs/error.log  info;</div><div class="line"></div><div class="line"><span class="meta">#</span>pid        logs/nginx.pid;</div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</div><div class="line">    #                  '$status $body_bytes_sent "$http_referer" '</div><div class="line">    #                  '"$http_user_agent" "$http_x_forwarded_for"';</div><div class="line"></div><div class="line">    #access_log  logs/access.log  main;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    #tcp_nopush     on;</div><div class="line"></div><div class="line">    #keepalive_timeout  0;</div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    #gzip  on;</div><div class="line"></div><div class="line">    server &#123;  </div><div class="line">        listen       81;  </div><div class="line">        server_name  localhost;  </div><div class="line">  </div><div class="line">        #charset koi8-r;  </div><div class="line">  </div><div class="line">        #access_log  logs/host.access.log  main;  </div><div class="line">  </div><div class="line">        location / &#123;  </div><div class="line">            root   /usr/share/nginx/html;  </div><div class="line">            index  index.html index.htm;  </div><div class="line">        &#125;  </div><div class="line">  </div><div class="line">        #error_page  404              /404.html;  </div><div class="line">  </div><div class="line">        # redirect server error pages to the static page /50x.html  </div><div class="line">        #  </div><div class="line">        error_page   500 502 503 504  /50x.html;  </div><div class="line">        location = /50x.html &#123;  </div><div class="line">            root   html;  </div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">rtmp &#123;    </div><div class="line">    server &#123;    </div><div class="line">        listen 1935;  #监听的端口  </div><div class="line">    </div><div class="line">        chunk_size 4000;    </div><div class="line">           </div><div class="line">        application hls &#123;  #rtmp推流请求路径  </div><div class="line">            live on;    </div><div class="line">            hls on;    </div><div class="line">            hls_path /usr/share/nginx/html/hls;    </div><div class="line">            hls_fragment 5s;    </div><div class="line">        &#125;    </div><div class="line">    &#125;    </div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="启动-nginx"><a href="#启动-nginx" class="headerlink" title="启动 nginx"></a><strong>启动 nginx</strong></h2><p>1、启动 nginx</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F7.png" alt=""></p><p>2、查看端口</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F8.png" alt=""></p><p>可以看到拉流端口已经启用，可以开始拉流了，但是推流端口还没有数据</p><hr><h1 id="录屏推流"><a href="#录屏推流" class="headerlink" title="录屏推流"></a><strong>录屏推流</strong></h1><p>1、clone <a href="https://github.com/eterrao/ScreenRecorder" title="https://github.com/eterrao/ScreenRecorder" target="_blank" rel="external">ScreenRecorder</a></p><p>2、查看 ip</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ifconfig</div></pre></td></tr></table></figure><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F9.png" alt=""></p><p>ip 是<code>192.168.1.3</code></p><p>3、修改推流地址</p><p><code>rtmp://192.168.1.3:1935/hls/test</code></p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F10.png" alt=""></p><p>然后开始录屏推流，但是推流端口没有被占用？</p><h1 id="拉流"><a href="#拉流" class="headerlink" title="拉流"></a><strong>拉流</strong></h1><h2 id="直接访问地址"><a href="#直接访问地址" class="headerlink" title="直接访问地址"></a><strong>直接访问地址</strong></h2><p><code>http://192.168.1.3:81/hls/test.m3u8</code></p><h3 id="PC-端-Chrome-浏览器"><a href="#PC-端-Chrome-浏览器" class="headerlink" title="PC 端 Chrome 浏览器"></a><strong>PC 端 Chrome 浏览器</strong></h3><p>访问该地址直接下载了一个<code>test.m3u8</code>文件，打开后报错</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F11.png" alt=""></p><h3 id="PC-端-FireFox-浏览器"><a href="#PC-端-FireFox-浏览器" class="headerlink" title="PC 端 FireFox 浏览器"></a><strong>PC 端 FireFox 浏览器</strong></h3><p>访问该地址会弹框提示</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F12.png" alt=""></p><p>点击<code>OK</code>后会报错</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F11.png" alt=""></p><h3 id="M-端-Chrome-浏览器"><a href="#M-端-Chrome-浏览器" class="headerlink" title="M 端 Chrome 浏览器"></a><strong>M 端 Chrome 浏览器</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%90%8C%E5%B1%8F13.gif" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://ngi
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>AutoLayout 代码解读</title>
    <link href="http://www.weichao.io/2018/02/16/AutoLayout-%E4%BB%A3%E7%A0%81%E8%A7%A3%E8%AF%BB/"/>
    <id>http://www.weichao.io/2018/02/16/AutoLayout-代码解读/</id>
    <published>2018-02-16T08:09:11.000Z</published>
    <updated>2018-02-16T08:12:33.192Z</updated>
    
    <content type="html"><![CDATA[<h1 id="AutoLayout-代码解读"><a href="#AutoLayout-代码解读" class="headerlink" title="AutoLayout 代码解读"></a><center><strong>AutoLayout 代码解读</strong></center></h1><hr><h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="http://blog.csdn.net/lmj623565791/article/details/49990941" title="http://blog.csdn.net/lmj623565791/article/details/49990941" target="_blank" rel="external">Android AutoLayout全新的适配方式 堪称适配终结者</a></li></ul><hr><h1 id="AutoLayoutConifg"><a href="#AutoLayoutConifg" class="headerlink" title="AutoLayoutConifg"></a><strong>AutoLayoutConifg</strong></h1><p>该类的作用是获取屏幕宽高、<code>AndroidManifest.xml</code>中的<code>design_width</code>和<code>design_width</code>字段的值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoLayoutConifg</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AutoLayoutConifg sIntance = <span class="keyword">new</span> AutoLayoutConifg();</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_DESIGN_WIDTH = <span class="string">"design_width"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_DESIGN_HEIGHT = <span class="string">"design_height"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mScreenWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mScreenHeight;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDesignWidth;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mDesignHeight;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> useDeviceSize;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">AutoLayoutConifg</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutoLayoutConifg <span class="title">getInstance</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> sIntance;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        getMetaData(context);</div><div class="line"></div><div class="line">        <span class="keyword">int</span>[] screenSize = ScreenUtils.getScreenSize(context, useDeviceSize);</div><div class="line">        mScreenWidth = screenSize[<span class="number">0</span>];</div><div class="line">        mScreenHeight = screenSize[<span class="number">1</span>];</div><div class="line">        L.e(<span class="string">"screenWidth = "</span> + mScreenWidth + <span class="string">", screenHeight = "</span> + mScreenHeight);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">getMetaData</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        PackageManager packageManager = context.getPackageManager();</div><div class="line">        ApplicationInfo applicationInfo;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            applicationInfo = packageManager.getApplicationInfo(context.getPackageName(), PackageManager.GET_META_DATA);</div><div class="line">            <span class="keyword">if</span> (applicationInfo != <span class="keyword">null</span> &amp;&amp; applicationInfo.metaData != <span class="keyword">null</span>) &#123;</div><div class="line">                mDesignWidth = (<span class="keyword">int</span>) applicationInfo.metaData.get(KEY_DESIGN_WIDTH);</div><div class="line">                mDesignHeight = (<span class="keyword">int</span>) applicationInfo.metaData.get(KEY_DESIGN_HEIGHT);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (PackageManager.NameNotFoundException e) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"you must set "</span> + KEY_DESIGN_WIDTH + <span class="string">" and "</span> + KEY_DESIGN_HEIGHT + <span class="string">" in your manifest file."</span>, e);</div><div class="line">        &#125;</div><div class="line">        L.e(<span class="string">"designWidth = "</span> + mDesignWidth + <span class="string">", designHeight = "</span> + mDesignHeight);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">checkParams</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mDesignHeight &lt;= <span class="number">0</span> || mDesignWidth &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"you must set "</span> + KEY_DESIGN_WIDTH + <span class="string">" and "</span> + KEY_DESIGN_HEIGHT + <span class="string">" in your manifest file."</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> AutoLayoutConifg <span class="title">useDeviceSize</span><span class="params">()</span> </span>&#123;</div><div class="line">        useDeviceSize = <span class="keyword">true</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getScreenWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mScreenWidth;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getScreenHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mScreenHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDesignWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mDesignWidth;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getDesignHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mDesignHeight;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="init-Context-context"><a href="#init-Context-context" class="headerlink" title="init(Context context)"></a><strong>init(Context context)</strong></h2><p>获取屏幕宽高。</p><h2 id="getMetaData-Context-context"><a href="#getMetaData-Context-context" class="headerlink" title="getMetaData(Context context)"></a><strong>getMetaData(Context context)</strong></h2><p>获取<code>AndroidManifest.xml</code>中位于<code>application</code>节点下的<code>design_width</code>和<code>design_width</code>字段的值。</p><hr><h1 id="AutoLayoutHelper"><a href="#AutoLayoutHelper" class="headerlink" title="AutoLayoutHelper"></a><strong>AutoLayoutHelper</strong></h1><p>该类的作用是计算属性的值并保存到<code>AutoLayoutInfo</code>对象中，在需要的时候将<code>AutoLayoutInfo</code>对象中值替换给对应的属性。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoLayoutHelper</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String TAG = <span class="string">"AutoLayoutHelper"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ViewGroup mHost;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span>[] LL = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;</div><div class="line">            android.R.attr.textSize,</div><div class="line">            android.R.attr.padding,</div><div class="line">            android.R.attr.paddingLeft,</div><div class="line">            android.R.attr.paddingTop,</div><div class="line">            android.R.attr.paddingRight,</div><div class="line">            android.R.attr.paddingBottom,</div><div class="line">            android.R.attr.layout_width,</div><div class="line">            android.R.attr.layout_height,</div><div class="line">            android.R.attr.layout_margin,</div><div class="line">            android.R.attr.layout_marginLeft,</div><div class="line">            android.R.attr.layout_marginTop,</div><div class="line">            android.R.attr.layout_marginRight,</div><div class="line">            android.R.attr.layout_marginBottom,</div><div class="line">            android.R.attr.maxWidth,</div><div class="line">            android.R.attr.maxHeight,</div><div class="line">            android.R.attr.minWidth,</div><div class="line">            android.R.attr.minHeight,</div><div class="line">            android.R.attr.layout_marginStart,</div><div class="line">            android.R.attr.layout_marginEnd,</div><div class="line">            android.R.attr.paddingStart,</div><div class="line">            android.R.attr.paddingEnd,</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_TEXT_SIZE = <span class="number">0</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING = <span class="number">1</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING_LEFT = <span class="number">2</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING_TOP = <span class="number">3</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING_RIGHT = <span class="number">4</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING_BOTTOM = <span class="number">5</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_WIDTH = <span class="number">6</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_HEIGHT = <span class="number">7</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN = <span class="number">8</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN_LEFT = <span class="number">9</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN_TOP = <span class="number">10</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN_RIGHT = <span class="number">11</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN_BOTTOM = <span class="number">12</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MAX_WIDTH = <span class="number">13</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MAX_HEIGHT = <span class="number">14</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MIN_WIDTH = <span class="number">15</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MIN_HEIGHT = <span class="number">16</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN_START = <span class="number">17</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_MARGIN_END = <span class="number">18</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING_START = <span class="number">19</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> INDEX_PADDING_END = <span class="number">20</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoLayoutHelper</span><span class="params">(ViewGroup host)</span> </span>&#123;</div><div class="line">        mHost = host;</div><div class="line"></div><div class="line">        initAutoLayoutConfig(host);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initAutoLayoutConfig</span><span class="params">(ViewGroup host)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (host != <span class="keyword">null</span>) &#123;</div><div class="line">            AutoLayoutConifg autoLayoutConifg = AutoLayoutConifg.getInstance();</div><div class="line">            autoLayoutConifg.init(host.getContext());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.e(TAG, <span class="string">"host == null"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">adjustChildren</span><span class="params">()</span> </span>&#123;</div><div class="line">        AutoLayoutConifg.getInstance().checkParams();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = mHost.getChildCount(); i &lt; n; i++) &#123;</div><div class="line">            View view = mHost.getChildAt(i);</div><div class="line">            ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">            <span class="keyword">if</span> (params <span class="keyword">instanceof</span> AutoLayoutParams) &#123;</div><div class="line">                AutoLayoutInfo info = ((AutoLayoutParams) params).getAutoLayoutInfo();</div><div class="line">                <span class="keyword">if</span> (info != <span class="keyword">null</span>) &#123;</div><div class="line">                    info.fillAttrs(view);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutoLayoutInfo <span class="title">getAutoLayoutInfo</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.AutoLayout_Layout);</div><div class="line">        <span class="keyword">int</span> baseWidth = a.getInt(R.styleable.AutoLayout_Layout_layout_auto_basewidth, <span class="number">0</span>);</div><div class="line">        <span class="keyword">int</span> baseHeight = a.getInt(R.styleable.AutoLayout_Layout_layout_auto_baseheight, <span class="number">0</span>);</div><div class="line">        a.recycle();</div><div class="line"></div><div class="line">        AutoLayoutInfo info = <span class="keyword">new</span> AutoLayoutInfo();</div><div class="line">        TypedArray array = context.obtainStyledAttributes(attrs, LL);</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, n = array.getIndexCount(); i &lt; n; i++) &#123;</div><div class="line">            <span class="keyword">int</span> index = array.getIndex(i);</div><div class="line"></div><div class="line">            <span class="keyword">if</span> (!DimenUtils.isPxVal(array.peekValue(index))) &#123;</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            <span class="keyword">int</span> pxVal;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                pxVal = array.getDimensionPixelOffset(index, <span class="number">0</span>);</div><div class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                e.printStackTrace();</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">switch</span> (index) &#123;</div><div class="line">                <span class="keyword">case</span> INDEX_TEXT_SIZE:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> TextSizeAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> PaddingAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING_LEFT:</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING_START:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> PaddingLeftAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING_TOP:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> PaddingTopAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING_RIGHT:</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING_END:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> PaddingRightAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_PADDING_BOTTOM:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> PaddingBottomAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_WIDTH:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> WidthAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_HEIGHT:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> HeightAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MarginAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN_LEFT:</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN_START:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MarginLeftAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN_TOP:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MarginTopAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN_RIGHT:</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN_END:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MarginRightAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MARGIN_BOTTOM:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MarginBottomAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MAX_WIDTH:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MaxWidthAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MAX_HEIGHT:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MaxHeightAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MIN_WIDTH:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MinWidthAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                <span class="keyword">case</span> INDEX_MIN_HEIGHT:</div><div class="line">                    info.addAttr(<span class="keyword">new</span> MinHeightAttr(pxVal, baseWidth, baseHeight));</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        array.recycle();</div><div class="line">        L.e(<span class="string">"getAutoLayoutInfo "</span> + info.toString());</div><div class="line">        <span class="keyword">return</span> info;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AutoLayoutParams</span> </span>&#123;</div><div class="line">        <span class="function">AutoLayoutInfo <span class="title">getAutoLayoutInfo</span><span class="params">()</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="adjustChildren"><a href="#adjustChildren" class="headerlink" title="adjustChildren()"></a><strong>adjustChildren()</strong></h2><p>遍历子 View，如果其布局参数是<code>AutoLayoutParams</code>，则将计算后的属性的值替换给对应的属性。</p><h2 id="getAutoLayoutInfo-Context-context-AttributeSet-attrs"><a href="#getAutoLayoutInfo-Context-context-AttributeSet-attrs" class="headerlink" title="getAutoLayoutInfo(Context context, AttributeSet attrs)"></a><strong>getAutoLayoutInfo(Context context, AttributeSet attrs)</strong></h2><p>遍历属性，重新计算属性的值后保存到<code>AutoLayoutInfo</code>对象中。</p><hr><h1 id="AutoLayoutInfo"><a href="#AutoLayoutInfo" class="headerlink" title="AutoLayoutInfo"></a><strong>AutoLayoutInfo</strong></h1><p>该类的作用是替换属性的值为计算后的值。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoLayoutInfo</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> List&lt;AutoAttr&gt; autoAttrs = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fillAttrs</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">for</span> (AutoAttr autoAttr : autoAttrs) &#123;</div><div class="line">            autoAttr.apply(view);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutoLayoutInfo <span class="title">getAttrFromView</span><span class="params">(View view, <span class="keyword">int</span> attrs, <span class="keyword">int</span> base)</span> </span>&#123;</div><div class="line">        ViewGroup.LayoutParams params = view.getLayoutParams();</div><div class="line">        <span class="keyword">if</span> (params == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        AutoLayoutInfo autoLayoutInfo = <span class="keyword">new</span> AutoLayoutInfo();</div><div class="line"></div><div class="line">        <span class="comment">// width, height</span></div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.WIDTH) != <span class="number">0</span> &amp;&amp; params.width &gt; <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(WidthAttr.generate(params.width, base));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.HEIGHT) != <span class="number">0</span> &amp;&amp; params.height &gt; <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(HeightAttr.generate(params.height, base));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// margin</span></div><div class="line">        <span class="keyword">if</span> (params <span class="keyword">instanceof</span> ViewGroup.MarginLayoutParams) &#123;</div><div class="line">            <span class="keyword">if</span> ((attrs &amp; Attrs.MARGIN) != <span class="number">0</span>) &#123;</div><div class="line">                autoLayoutInfo.addAttr(MarginLeftAttr.generate(((ViewGroup.MarginLayoutParams) params).leftMargin, base));</div><div class="line">                autoLayoutInfo.addAttr(MarginTopAttr.generate(((ViewGroup.MarginLayoutParams) params).topMargin, base));</div><div class="line">                autoLayoutInfo.addAttr(MarginRightAttr.generate(((ViewGroup.MarginLayoutParams) params).rightMargin, base));</div><div class="line">                autoLayoutInfo.addAttr(MarginBottomAttr.generate(((ViewGroup.MarginLayoutParams) params).bottomMargin, base));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((attrs &amp; Attrs.MARGIN_LEFT) != <span class="number">0</span>) &#123;</div><div class="line">                autoLayoutInfo.addAttr(MarginLeftAttr.generate(((ViewGroup.MarginLayoutParams) params).leftMargin, base));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((attrs &amp; Attrs.MARGIN_TOP) != <span class="number">0</span>) &#123;</div><div class="line">                autoLayoutInfo.addAttr(MarginTopAttr.generate(((ViewGroup.MarginLayoutParams) params).topMargin, base));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((attrs &amp; Attrs.MARGIN_RIGHT) != <span class="number">0</span>) &#123;</div><div class="line">                autoLayoutInfo.addAttr(MarginRightAttr.generate(((ViewGroup.MarginLayoutParams) params).rightMargin, base));</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> ((attrs &amp; Attrs.MARGIN_BOTTOM) != <span class="number">0</span>) &#123;</div><div class="line">                autoLayoutInfo.addAttr(MarginBottomAttr.generate(((ViewGroup.MarginLayoutParams) params).bottomMargin, base));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// padding</span></div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.PADDING) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(PaddingLeftAttr.generate(view.getPaddingLeft(), base));</div><div class="line">            autoLayoutInfo.addAttr(PaddingTopAttr.generate(view.getPaddingTop(), base));</div><div class="line">            autoLayoutInfo.addAttr(PaddingRightAttr.generate(view.getPaddingRight(), base));</div><div class="line">            autoLayoutInfo.addAttr(PaddingBottomAttr.generate(view.getPaddingBottom(), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.PADDING_LEFT) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MarginLeftAttr.generate(view.getPaddingLeft(), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.PADDING_TOP) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MarginTopAttr.generate(view.getPaddingTop(), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.PADDING_RIGHT) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MarginRightAttr.generate(view.getPaddingRight(), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.PADDING_BOTTOM) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MarginBottomAttr.generate(view.getPaddingBottom(), base));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// minWidth, maxWidth, minHeight, maxHeight</span></div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.MIN_WIDTH) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MinWidthAttr.generate(MinWidthAttr.getMinWidth(view), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.MAX_WIDTH) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MaxWidthAttr.generate(MaxWidthAttr.getMaxWidth(view), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.MIN_HEIGHT) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MinHeightAttr.generate(MinHeightAttr.getMinHeight(view), base));</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> ((attrs &amp; Attrs.MAX_HEIGHT) != <span class="number">0</span>) &#123;</div><div class="line">            autoLayoutInfo.addAttr(MaxHeightAttr.generate(MaxHeightAttr.getMaxHeight(view), base));</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// textSize</span></div><div class="line">        <span class="keyword">if</span> (view <span class="keyword">instanceof</span> TextView) &#123;</div><div class="line">            <span class="keyword">if</span> ((attrs &amp; Attrs.TEXTSIZE) != <span class="number">0</span>) &#123;</div><div class="line">                autoLayoutInfo.addAttr(TextSizeAttr.generate((<span class="keyword">int</span>) ((TextView) view).getTextSize(), base));</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> autoLayoutInfo;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAttr</span><span class="params">(AutoAttr autoAttr)</span> </span>&#123;</div><div class="line">        autoAttrs.add(autoAttr);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"AutoLayoutInfo &#123; autoAttrs = "</span> + autoAttrs + <span class="string">" &#125;"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="getAttrFromView-View-view-int-attrs-int-base"><a href="#getAttrFromView-View-view-int-attrs-int-base" class="headerlink" title="getAttrFromView(View view, int attrs, int base)"></a><strong>getAttrFromView(View view, int attrs, int base)</strong></h2><p>遍历属性，重新计算属性的值并保存。</p><h2 id="fillAttrs-View-view"><a href="#fillAttrs-View-view" class="headerlink" title="fillAttrs(View view)"></a><strong>fillAttrs(View view)</strong></h2><p>遍历属性，将属性应用到给定的 View 上。</p><hr><h1 id="AutoUtils"><a href="#AutoUtils" class="headerlink" title="AutoUtils"></a><strong>AutoUtils</strong></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoUtils</span> </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * 会直接将view的LayoutParams上设置的width，height直接进行百分比处理</span></div><div class="line"><span class="comment">     *</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> view</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">auto</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        autoSize(view);</div><div class="line">        autoPadding(view);</div><div class="line">        autoMargin(view);</div><div class="line">        autoTextSize(view, AutoAttr.BASE_DEFAULT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> view</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> attrs #Attrs.WIDTH|Attrs.HEIGHT</span></div><div class="line"><span class="comment">     * <span class="doctag">@param</span> base  AutoAttr.BASE_WIDTH|AutoAttr.BASE_HEIGHT|AutoAttr.BASE_DEFAULT</span></div><div class="line"><span class="comment">     */</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">auto</span><span class="params">(View view, <span class="keyword">int</span> attrs, <span class="keyword">int</span> base)</span> </span>&#123;</div><div class="line">        AutoLayoutInfo autoLayoutInfo = AutoLayoutInfo.getAttrFromView(view, attrs, base);</div><div class="line">        <span class="keyword">if</span> (autoLayoutInfo != <span class="keyword">null</span>) &#123;</div><div class="line">            autoLayoutInfo.fillAttrs(view);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoTextSize</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.TEXTSIZE, AutoAttr.BASE_DEFAULT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoTextSize</span><span class="params">(View view, <span class="keyword">int</span> base)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.TEXTSIZE, base);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoMargin</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.MARGIN, AutoAttr.BASE_DEFAULT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoMargin</span><span class="params">(View view, <span class="keyword">int</span> base)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.MARGIN, base);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoPadding</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.PADDING, AutoAttr.BASE_DEFAULT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoPadding</span><span class="params">(View view, <span class="keyword">int</span> base)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.PADDING, base);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoSize</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.WIDTH | Attrs.HEIGHT, AutoAttr.BASE_DEFAULT);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">autoSize</span><span class="params">(View view, <span class="keyword">int</span> base)</span> </span>&#123;</div><div class="line">        auto(view, Attrs.WIDTH | Attrs.HEIGHT, base);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">autoed</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        Object tag = view.getTag(R.id.id_tag_autolayout_size);</div><div class="line">        <span class="keyword">if</span> (tag != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        view.setTag(R.id.id_tag_autolayout_size, <span class="string">"Just Identify"</span>);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">getPercentWidth1px</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> screenWidth = AutoLayoutConifg.getInstance().getScreenWidth();</div><div class="line">        <span class="keyword">int</span> designWidth = AutoLayoutConifg.getInstance().getDesignWidth();</div><div class="line">        <span class="keyword">return</span> <span class="number">1.0f</span> * screenWidth / designWidth;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">float</span> <span class="title">getPercentHeight1px</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> screenHeight = AutoLayoutConifg.getInstance().getScreenHeight();</div><div class="line">        <span class="keyword">int</span> designHeight = AutoLayoutConifg.getInstance().getDesignHeight();</div><div class="line">        <span class="keyword">return</span> <span class="number">1.0f</span> * screenHeight / designHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPercentWidthSize</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> screenWidth = AutoLayoutConifg.getInstance().getScreenWidth();</div><div class="line">        <span class="keyword">int</span> designWidth = AutoLayoutConifg.getInstance().getDesignWidth();</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (val * <span class="number">1.0f</span> / designWidth * screenWidth);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPercentHeightSize</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> screenHeight = AutoLayoutConifg.getInstance().getScreenHeight();</div><div class="line">        <span class="keyword">int</span> designHeight = AutoLayoutConifg.getInstance().getDesignHeight();</div><div class="line">        <span class="keyword">return</span> (<span class="keyword">int</span>) (val * <span class="number">1.0f</span> / designHeight * screenHeight);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPercentWidthSizeBigger</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> screenWidth = AutoLayoutConifg.getInstance().getScreenWidth();</div><div class="line">        <span class="keyword">int</span> designWidth = AutoLayoutConifg.getInstance().getDesignWidth();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> res = val * screenWidth;</div><div class="line">        <span class="keyword">if</span> (res % designWidth == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> res / designWidth;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> res / designWidth + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getPercentHeightSizeBigger</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> screenHeight = AutoLayoutConifg.getInstance().getScreenHeight();</div><div class="line">        <span class="keyword">int</span> designHeight = AutoLayoutConifg.getInstance().getDesignHeight();</div><div class="line"></div><div class="line">        <span class="keyword">int</span> res = val * screenHeight;</div><div class="line">        <span class="keyword">if</span> (res % designHeight == <span class="number">0</span>) &#123;</div><div class="line">            <span class="keyword">return</span> res / designHeight;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">return</span> res / designHeight + <span class="number">1</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="getPercentWidth1px"><a href="#getPercentWidth1px" class="headerlink" title="getPercentWidth1px()"></a><strong>getPercentWidth1px()</strong></h2><p>获取设计图中的<code>1px</code>在当前设备上的宽度。</p><h2 id="getPercentHeight1px"><a href="#getPercentHeight1px" class="headerlink" title="getPercentHeight1px()"></a><strong>getPercentHeight1px()</strong></h2><p>获取设计图中的<code>1px</code>在当前设备上的高度。</p><h2 id="getPercentWidthSize-int-val"><a href="#getPercentWidthSize-int-val" class="headerlink" title="getPercentWidthSize(int val)"></a><strong>getPercentWidthSize(int val)</strong></h2><p>获取基于宽度计算的设计图中的指定的值在当前设备上的值。</p><h2 id="getPercentHeightSize-int-val"><a href="#getPercentHeightSize-int-val" class="headerlink" title="getPercentHeightSize(int val)"></a><strong>getPercentHeightSize(int val)</strong></h2><p>获取基于高度计算的设计图中的指定的值在当前设备上的值。</p><h2 id="getPercentWidthSizeBigger-int-val"><a href="#getPercentWidthSizeBigger-int-val" class="headerlink" title="getPercentWidthSizeBigger(int val)"></a><strong>getPercentWidthSizeBigger(int val)</strong></h2><p>获取基于宽度计算的设计图中的指定的值在当前设备上的值，当为<code>0</code>时，修改为<code>1</code>。</p><h2 id="getPercentHeightSizeBigger-int-val"><a href="#getPercentHeightSizeBigger-int-val" class="headerlink" title="getPercentHeightSizeBigger(int val)"></a><strong>getPercentHeightSizeBigger(int val)</strong></h2><p>获取基于高度计算的设计图中的指定的值在当前设备上的值，当为<code>0</code>时，修改为<code>1</code>。</p><hr><h1 id="AutoAttr"><a href="#AutoAttr" class="headerlink" title="AutoAttr"></a><strong>AutoAttr</strong></h1><p>判断是否未设置<code>app:layout_auto_basewidth</code>或<code>app:layout_auto_baseheight</code>，如果未设置，则判断该属性是基于宽度还是基于高度计算，并进行相应的计算；如果设置了基于宽度或高度计算，则进行对应的计算。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoAttr</span> </span>&#123;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BASE_WIDTH = <span class="number">1</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BASE_HEIGHT = <span class="number">2</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> BASE_DEFAULT = <span class="number">3</span>;</div><div class="line"></div><div class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> pxVal;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> baseWidth;</div><div class="line">    <span class="keyword">protected</span> <span class="keyword">int</span> baseHeight;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoAttr</span><span class="params">(<span class="keyword">int</span> pxVal, <span class="keyword">int</span> baseWidth, <span class="keyword">int</span> baseHeight)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.pxVal = pxVal;</div><div class="line">        <span class="keyword">this</span>.baseWidth = baseWidth;</div><div class="line">        <span class="keyword">this</span>.baseHeight = baseHeight;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span><span class="params">(View view)</span> </span>&#123;</div><div class="line">        <span class="keyword">boolean</span> log = view.getTag() != <span class="keyword">null</span> &amp;&amp; view.getTag().toString().equals(<span class="string">"auto"</span>);</div><div class="line">        <span class="keyword">if</span> (log) &#123;</div><div class="line">            L.e(<span class="string">"pxVal = "</span> + pxVal + <span class="string">" ,"</span> + getClass().getSimpleName());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">int</span> val;</div><div class="line">        <span class="keyword">if</span> (useDefault()) &#123;</div><div class="line">            val = defaultBaseWidth() ? getPercentWidthSize() : getPercentHeightSize();</div><div class="line">            <span class="keyword">if</span> (log) &#123;</div><div class="line">                L.e(<span class="string">"useDefault val = "</span> + val);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (baseWidth()) &#123;</div><div class="line">            val = getPercentWidthSize();</div><div class="line">            <span class="keyword">if</span> (log) &#123;</div><div class="line">                L.e(<span class="string">"baseWidth val = "</span> + val);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            val = getPercentHeightSize();</div><div class="line">            <span class="keyword">if</span> (log) &#123;</div><div class="line">                L.e(<span class="string">"baseHeight val = "</span> + val);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (val &gt; <span class="number">0</span>) &#123;</div><div class="line">            val = Math.max(val, <span class="number">1</span>);<span class="comment">// for very thin divider</span></div><div class="line">        &#125;</div><div class="line">        execute(view, val);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">useDefault</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> !contains(baseHeight, attrVal()) &amp;&amp; !contains(baseWidth, attrVal());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">baseWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> contains(baseWidth, attrVal());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">contains</span><span class="params">(<span class="keyword">int</span> baseVal, <span class="keyword">int</span> flag)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> (baseVal &amp; flag) != <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPercentWidthSize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> AutoUtils.getPercentWidthSizeBigger(pxVal);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getPercentHeightSize</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> AutoUtils.getPercentHeightSizeBigger(pxVal);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"AutoAttr&#123;"</span> +</div><div class="line">                <span class="string">"pxVal = "</span> + pxVal +</div><div class="line">                <span class="string">", baseWidth = "</span> + baseWidth() +</div><div class="line">                <span class="string">", defaultBaseWidth = "</span> + defaultBaseWidth() +</div><div class="line">                <span class="string">'&#125;'</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">attrVal</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">boolean</span> <span class="title">defaultBaseWidth</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">execute</span><span class="params">(View view, <span class="keyword">int</span> val)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="attrVal"><a href="#attrVal" class="headerlink" title="attrVal()"></a><strong>attrVal()</strong></h2><p>该属性在<code>attrs.xml</code>中对应的值。</p><h2 id="defaultBaseWidth"><a href="#defaultBaseWidth" class="headerlink" title="defaultBaseWidth()"></a><strong>defaultBaseWidth()</strong></h2><p>是否默认依赖于宽度进行百分比计算。</p><h2 id="execute-View-view-int-val"><a href="#execute-View-view-int-val" class="headerlink" title="execute(View view, int val)"></a><strong>execute(View view, int val)</strong></h2><p>将属性修改后的值替换给对应的属性。</p><h2 id="apply-View-view"><a href="#apply-View-view" class="headerlink" title="apply(View view)"></a><strong>apply(View view)</strong></h2><p>计算属性的值并将属性修改后的值替换给对应的属性。</p><h3 id="useDefault"><a href="#useDefault" class="headerlink" title="useDefault()"></a><strong>useDefault()</strong></h3><p>判断是否未设置<code>app:layout_auto_basewidth</code>或<code>app:layout_auto_baseheight</code>。</p><h3 id="baseWidth"><a href="#baseWidth" class="headerlink" title="baseWidth()"></a><strong>baseWidth()</strong></h3><p>判断是否设置了<code>app:layout_auto_basewidth</code>。</p><h3 id="contains-int-baseVal-int-flag"><a href="#contains-int-baseVal-int-flag" class="headerlink" title="contains(int baseVal, int flag)"></a><strong>contains(int baseVal, int flag)</strong></h3><p>判断是否对应的标志位是否置为了<code>1</code>。</p><h3 id="getPercentWidthSize"><a href="#getPercentWidthSize" class="headerlink" title="getPercentWidthSize()"></a><strong>getPercentWidthSize()</strong></h3><p>基于宽度计算百分比的值。</p><h3 id="getPercentHeightSize"><a href="#getPercentHeightSize" class="headerlink" title="getPercentHeightSize()"></a><strong>getPercentHeightSize()</strong></h3><p>基于高度计算百分比的值。</p><hr><h1 id="AutoLayoutActivity"><a href="#AutoLayoutActivity" class="headerlink" title="AutoLayoutActivity"></a><strong>AutoLayoutActivity</strong></h1><p>继承<code>AutoLayoutActivity</code>的 Activity 可以使布局实现百分比化。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoLayoutActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAYOUT_LINEARLAYOUT = <span class="string">"LinearLayout"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAYOUT_FRAMELAYOUT = <span class="string">"FrameLayout"</span>;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String LAYOUT_RELATIVELAYOUT = <span class="string">"RelativeLayout"</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(String name, Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        View view = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">switch</span> (name) &#123;</div><div class="line">            <span class="keyword">case</span> LAYOUT_FRAMELAYOUT:</div><div class="line">                view = <span class="keyword">new</span> AutoFrameLayout(context, attrs);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_LINEARLAYOUT:</div><div class="line">                view = <span class="keyword">new</span> AutoLinearLayout(context, attrs);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">case</span> LAYOUT_RELATIVELAYOUT:</div><div class="line">                view = <span class="keyword">new</span> AutoRelativeLayout(context, attrs);</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (view != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">return</span> view;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onCreateView(name, context, attrs);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="onCreateView-String-name-Context-context-AttributeSet-attrs"><a href="#onCreateView-String-name-Context-context-AttributeSet-attrs" class="headerlink" title="onCreateView(String name, Context context, AttributeSet attrs)"></a><strong>onCreateView(String name, Context context, AttributeSet attrs)</strong></h2><p>替换<code>LinearLayout</code>为<code>AutoLinearLayout</code>，替换<code>FrameLayout</code>为<code>AutoFrameLayout</code>，替换<code>RelativeLayout</code>为<code>AutoRelativeLayout</code>。</p><hr><h1 id="AutoRelativeLayout"><a href="#AutoRelativeLayout" class="headerlink" title="AutoRelativeLayout"></a><strong>AutoRelativeLayout</strong></h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AutoRelativeLayout</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AutoLayoutHelper mHelper = <span class="keyword">new</span> AutoLayoutHelper(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoRelativeLayout</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoRelativeLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AutoRelativeLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyle)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(context, attrs, defStyle);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(AttributeSet attrs)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> LayoutParams(getContext(), attrs);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (!isInEditMode()) &#123;</div><div class="line">            mHelper.adjustChildren();</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">super</span>.onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">LayoutParams</span> <span class="keyword">extends</span> <span class="title">RelativeLayout</span>.<span class="title">LayoutParams</span> <span class="keyword">implements</span> <span class="title">AutoLayoutHelper</span>.<span class="title">AutoLayoutParams</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> AutoLayoutInfo mAutoLayoutInfo;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(Context c, AttributeSet attrs)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(c, attrs);</div><div class="line">            mAutoLayoutInfo = AutoLayoutHelper.getAutoLayoutInfo(c, attrs);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(width, height);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(ViewGroup.LayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">LayoutParams</span><span class="params">(MarginLayoutParams source)</span> </span>&#123;</div><div class="line">            <span class="keyword">super</span>(source);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> AutoLayoutInfo <span class="title">getAutoLayoutInfo</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">return</span> mAutoLayoutInfo;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="generateLayoutParams-AttributeSet-attrs"><a href="#generateLayoutParams-AttributeSet-attrs" class="headerlink" title="generateLayoutParams(AttributeSet attrs)"></a><strong>generateLayoutParams(AttributeSet attrs)</strong></h2><p>当父容器添加子 View 时调用。返回内部类<code>LayoutParams</code>的对象。</p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;AutoLayout-代码解读&quot;&gt;&lt;a href=&quot;#AutoLayout-代码解读&quot; class=&quot;headerlink&quot; title=&quot;AutoLayout 代码解读&quot;&gt;&lt;/a&gt;&lt;center&gt;&lt;strong&gt;AutoLayout 代码解读&lt;/strong&gt;&lt;
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>百分比布局方案对比</title>
    <link href="http://www.weichao.io/2018/02/12/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%94/"/>
    <id>http://www.weichao.io/2018/02/12/百分比布局方案对比/</id>
    <published>2018-02-12T04:40:06.000Z</published>
    <updated>2018-02-16T10:29:40.803Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://developer.android.com/guide/practices/screens_support.html" title="https://developer.android.com/guide/practices/screens_support.html" target="_blank" rel="external">支持多种屏幕</a></li></ul><hr><h1 id="设计图示例"><a href="#设计图示例" class="headerlink" title="设计图示例"></a><strong>设计图示例</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%941.png" alt=""></p><hr><h1 id="标注"><a href="#标注" class="headerlink" title="标注"></a><strong>标注</strong></h1><p>有时候从设计那里拿到的直接是 psd 文件，打开后是这样的：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%941.png" alt=""></p><p>也就是未加任何标注，仅提供可供导出图片的图层，这对写布局基本没有帮助<br>我需要的至少是这样的：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%943.png" alt=""></p><hr><h1 id="稍微调整设计图便于写布局"><a href="#稍微调整设计图便于写布局" class="headerlink" title="稍微调整设计图便于写布局"></a><strong>稍微调整设计图便于写布局</strong></h1><h2 id="设置全部内容的-padding"><a href="#设置全部内容的-padding" class="headerlink" title="设置全部内容的 padding"></a><strong>设置全部内容的 padding</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%944.png" alt=""></p><h2 id="统一高度近似的分隔部分"><a href="#统一高度近似的分隔部分" class="headerlink" title="统一高度近似的分隔部分"></a><strong>统一高度近似的分隔部分</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%945.png" alt=""></p><h2 id="统一高度近似的输入部分"><a href="#统一高度近似的输入部分" class="headerlink" title="统一高度近似的输入部分"></a><strong>统一高度近似的输入部分</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%946.png" alt=""></p><h2 id="统一宽度近似的输入类型部分"><a href="#统一宽度近似的输入类型部分" class="headerlink" title="统一宽度近似的输入类型部分"></a><strong>统一宽度近似的输入类型部分</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%947.png" alt=""></p><h1 id="ConstraintLayout"><a href="#ConstraintLayout" class="headerlink" title="ConstraintLayout"></a><strong>ConstraintLayout</strong></h1><h2 id="布局"><a href="#布局" class="headerlink" title="布局"></a><strong>布局</strong></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/bg"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_top"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.051056338028169"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.0625"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.0625"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/logo"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">"@drawable/logo"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.1707746478873239"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_top"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_2"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/logo"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/flatte"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:letterSpacing</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"FLATTE"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0387323943661972"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_2"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_3"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/flatte"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/socail_app"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:letterSpacing</span>=<span class="string">"0.1"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"SOCAIL APP"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#fff048"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0140845070422535"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_3"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_4"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0889084507042254"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/socail_app"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_user"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0440140845070423"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_4"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/user_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.1125"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/user_icon"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/user_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/form_user"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"1dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"#8f9399"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"@null"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:hint</span>=<span class="string">"USERNAME OR EMAIL"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textColorHint</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">"@id/form_user"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_5"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/container_user"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_password"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0440140845070423"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_5"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/password_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.1125"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/password_icon"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/password_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/form_password"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"1dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"#8f9399"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"@null"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:inputType</span>=<span class="string">"textPassword"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">"password"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textColorHint</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">"@id/form_password"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_6"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/container_password"</span> /&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/login"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@drawable/bg_login"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"LOGIN"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#434a54"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0809859154929577"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_6"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_7"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/login"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/forget_password"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"FORGET PASSWORD"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#fcfcfc"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0140845070422535"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_7"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_8"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/forget_password"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/register"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@drawable/bg_register"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"REGISTER"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#ffee58"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0809859154929577"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_8"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_9"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/register"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_login_with_third_part_center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0845070422535211"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_9"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/facebook"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/twitter"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/google"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="效果"><a href="#效果" class="headerlink" title="效果"></a><strong>效果</strong></h2><table><thead><tr><th style="text-align:center">设备</th><th style="text-align:center">9.6吋 1280x800（mdpi）的荣耀畅玩平板2 真机</th><th style="text-align:center">4吋 800x480（hdpi）的谷歌NexusS 模拟器</th><th style="text-align:center">5.65吋 1440x720（xhdpi）的荣耀9Lite 真机</th><th style="text-align:center">5.5吋 1920x1080（xxhdpi）的红米Note4X 真机</th><th>5.5吋 2560x1440（xxxhdpi）的谷歌PixelXL 真机</th></tr></thead><tbody><tr><td style="text-align:center">效果（压缩成 480p 的）</td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9411.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9412.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9413.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9414.png" alt=""></td><td><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9415.png" alt=""></td></tr></tbody></table><h2 id="存在的问题"><a href="#存在的问题" class="headerlink" title="存在的问题"></a><strong>存在的问题</strong></h2><p>文本内容显示不全或特别小是因为：文本字号使用的是默认的 14sp，不能和容器尺寸关联</p><hr><h1 id="AutoLayout"><a href="#AutoLayout" class="headerlink" title="AutoLayout"></a><strong>AutoLayout</strong></h1><h2 id="布局-1"><a href="#布局-1" class="headerlink" title="布局"></a><strong>布局</strong></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/bg"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:paddingLeft</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:paddingRight</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:paddingTop</span>=<span class="string">"58px"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/logo"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"194px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"194px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/logo"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/flatte"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"44px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/logo"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:letterSpacing</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"FLATTE"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"44px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/socail_app"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/flatte"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_centerHorizontal</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:letterSpacing</span>=<span class="string">"0.1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"SOCAIL APP"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#fff048"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/container_user"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"50px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/socail_app"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"102px"</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span></span></div><div class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/user_icon"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"72px"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">                <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:src</span>=<span class="string">"@drawable/user_icon"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_toRightOf</span>=<span class="string">"@id/user_icon"</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">                <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:id</span>=<span class="string">"@+id/form_user"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"1px"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:background</span>=<span class="string">"#8f9399"</span> /&gt;</span></div><div class="line"></div><div class="line">                <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_above</span>=<span class="string">"@id/form_user"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:background</span>=<span class="string">"@null"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:hint</span>=<span class="string">"USERNAME OR EMAIL"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:textColorHint</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:textSize</span>=<span class="string">"18px"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/container_password"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"50px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/container_user"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/password_icon"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"72px"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">                <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:src</span>=<span class="string">"@drawable/password_icon"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoRelativeLayout</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_toRightOf</span>=<span class="string">"@id/password_icon"</span>&gt;</span></div><div class="line"></div><div class="line">                <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:id</span>=<span class="string">"@+id/form_password"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"1px"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_alignParentBottom</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:background</span>=<span class="string">"#8f9399"</span> /&gt;</span></div><div class="line"></div><div class="line">                <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:layout_above</span>=<span class="string">"@id/form_password"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:background</span>=<span class="string">"@null"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:inputType</span>=<span class="string">"textPassword"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:text</span>=<span class="string">"password"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:textColorHint</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">                    <span class="attr">android:textSize</span>=<span class="string">"18px"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/login"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"92px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/container_password"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"@drawable/bg_login"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"LOGIN"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#434a54"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"20px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/forget_password"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/login"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"FORGET PASSWORD"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#fcfcfc"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/register"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"92px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/forget_password"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">"@drawable/bg_register"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"REGISTER"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#ffee58"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"20px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span> /&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">com.zhy.autolayout.AutoLinearLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/container_login_with_third_part_center"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"96px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_below</span>=<span class="string">"@id/register"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_marginTop</span>=<span class="string">"40px"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/facebook"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/twitter"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/google"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoLinearLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">com.zhy.autolayout.AutoRelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a><strong>效果</strong></h2><table><thead><tr><th style="text-align:center">设备</th><th style="text-align:center">9.6吋 1280x800（mdpi）的荣耀畅玩平板2 真机</th><th style="text-align:center">4吋 800x480（hdpi）的谷歌NexusS 模拟器</th><th style="text-align:center">5.65吋 1440x720（xhdpi）的荣耀9Lite 真机</th><th style="text-align:center">5.5吋 1920x1080（xxhdpi）的红米Note4X 真机</th><th>5.5吋 2560x1440（xxxhdpi）的谷歌PixelXL 真机</th></tr></thead><tbody><tr><td style="text-align:center">效果（压缩成 480p 的）</td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9421.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9422.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9423.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9424.png" alt=""></td><td><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9425.png" alt=""></td></tr></tbody></table><h2 id="存在的问题-1"><a href="#存在的问题-1" class="headerlink" title="存在的问题"></a><strong>存在的问题</strong></h2><p>1、当存在虚拟按键时，布局不随虚拟按键的隐藏/显示而动态改变<br>2、当虚拟按键是在设备 root 后强制隐藏的，此时获取的屏幕高度不正确</p><hr><h1 id="ConstraintLayout-amp-amp-AutoLayout"><a href="#ConstraintLayout-amp-amp-AutoLayout" class="headerlink" title="ConstraintLayout &amp;&amp; AutoLayout"></a><strong>ConstraintLayout &amp;&amp; AutoLayout</strong></h1><h2 id="布局-2"><a href="#布局-2" class="headerlink" title="布局"></a><strong>布局</strong></h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">"@drawable/bg"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_top"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.051056338028169"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.0625"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.0625"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/logo"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">"@drawable/logo"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.1707746478873239"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_top"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_2"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/logo"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/flatte"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:letterSpacing</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"FLATTE"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"44px"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0387323943661972"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_2"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_3"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/flatte"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/socail_app"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:letterSpacing</span>=<span class="string">"0.1"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"SOCAIL APP"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#fff048"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0140845070422535"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_3"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_4"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0889084507042254"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/socail_app"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_user"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0440140845070423"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_4"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/user_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.1125"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/user_icon"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/user_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/form_user"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"1dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"#8f9399"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"@null"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:hint</span>=<span class="string">"USERNAME OR EMAIL"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textColorHint</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">"@id/form_user"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_5"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/container_user"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_password"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0440140845070423"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_5"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">RelativeLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/password_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.1125"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:src</span>=<span class="string">"@drawable/password_icon"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/password_icon"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span>&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">                <span class="attr">android:id</span>=<span class="string">"@+id/form_password"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"1dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"#8f9399"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">            <span class="tag">&lt;<span class="name">EditText</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:background</span>=<span class="string">"@null"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:gravity</span>=<span class="string">"center_vertical"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:inputType</span>=<span class="string">"textPassword"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:text</span>=<span class="string">"password"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textColorHint</span>=<span class="string">"#ffffff"</span></span></div><div class="line"><span class="tag">                <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintBottom_toTopOf</span>=<span class="string">"@id/form_password"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">                <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_6"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/container_password"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_login"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@drawable/bg_login"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0809859154929577"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_6"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/view_10"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.391304347826087"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/login"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"LOGIN"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#434a54"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"20px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.2173913043478261"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_10"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_7"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/container_login"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/forget_password"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"FORGET PASSWORD"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textColor</span>=<span class="string">"#fcfcfc"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textSize</span>=<span class="string">"16px"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0140845070422535"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_7"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_8"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/forget_password"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_register"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@drawable/bg_register"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0809859154929577"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_8"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/view_11"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.391304347826087"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">"@+id/register"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:gravity</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">"false"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:text</span>=<span class="string">"REGISTER"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">"#ffee58"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">"20px"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">"bold"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.2173913043478261"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_11"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">View</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/view_9"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0352112676056338"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/container_register"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/container_login_with_third_part_center"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHeight_percent</span>=<span class="string">"0.0845070422535211"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/view_left"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@id/view_right"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toBottomOf</span>=<span class="string">"@id/view_9"</span>&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/facebook"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/twitter"</span> /&gt;</span></div><div class="line"></div><div class="line">        <span class="tag">&lt;<span class="name">ImageView</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">"1"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:adjustViewBounds</span>=<span class="string">"true"</span></span></div><div class="line"><span class="tag">            <span class="attr">android:src</span>=<span class="string">"@drawable/google"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">io.weichao.autolayout.widget.AutoConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="效果-2"><a href="#效果-2" class="headerlink" title="效果"></a><strong>效果</strong></h2><table><thead><tr><th style="text-align:center">设备</th><th style="text-align:center">9.6吋 1280x800（mdpi）的荣耀畅玩平板2 真机</th><th style="text-align:center">4吋 800x480（hdpi）的谷歌NexusS 模拟器</th><th style="text-align:center">5.65吋 1440x720（xhdpi）的荣耀9Lite 真机</th><th style="text-align:center">5.5吋 1920x1080（xxhdpi）的红米Note4X 真机</th><th>5.5吋 2560x1440（xxxhdpi）的谷歌PixelXL 真机</th></tr></thead><tbody><tr><td style="text-align:center">效果（压缩成 480p 的）</td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9431.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9432.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9433.png" alt=""></td><td style="text-align:center"><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9434.png" alt=""></td><td><img src="http://otkw6sse5.bkt.clouddn.com/%E7%99%BE%E5%88%86%E6%AF%94%E5%B8%83%E5%B1%80%E6%96%B9%E6%A1%88%E5%AF%B9%E6%AF%9435.png" alt=""></td></tr></tbody></table><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://de
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>ConstraintLayout 学习</title>
    <link href="http://www.weichao.io/2018/02/10/ConstraintLayout-%E5%AD%A6%E4%B9%A0/"/>
    <id>http://www.weichao.io/2018/02/10/ConstraintLayout-学习/</id>
    <published>2018-02-09T17:48:54.000Z</published>
    <updated>2018-02-09T17:59:05.146Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://developer.android.com/reference/android/support/constraint/ConstraintLayout.html" title="https://developer.android.com/reference/android/support/constraint/ConstraintLayout.html" target="_blank" rel="external">ConstraintLayout</a></li><li><a href="http://blog.csdn.net/zxt0601/article/details/72683379" title="http://blog.csdn.net/zxt0601/article/details/72683379" target="_blank" rel="external">ConstraintLayout 属性详解 和Chain的使用</a></li></ul><hr><h1 id="Relative-positioning"><a href="#Relative-positioning" class="headerlink" title="Relative positioning"></a><strong>Relative positioning</strong></h1><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>app:layout_constraintLeft_toLeftOf</td><td>该控件以xx控件的左端为左端</td></tr><tr><td>app:layout_constraintLeft_toRightOf</td><td>该控件以xx控件的右端为左端</td></tr><tr><td>app:layout_constraintRight_toLeftOf</td><td>该控件以xx控件的左端为右端</td></tr><tr><td>app:layout_constraintRight_toRightOf</td><td>该控件以xx控件的右端为右端</td></tr><tr><td>app:layout_constraintTop_toTopOf</td><td>该控件以xx控件的上端为上端</td></tr><tr><td>app:layout_constraintTop_toBottomOf</td><td>该控件以xx控件的下端为上端</td></tr><tr><td>app:layout_constraintBottom_toTopOf</td><td>该控件以xx控件的上端为下端</td></tr><tr><td>app:layout_constraintBottom_toBottomOf</td><td>该控件以xx控件的下端为下端</td></tr><tr><td>app:layout_constraintBaseline_toBaselineOf</td><td>该控件以xx控件的基线端为基线端</td></tr><tr><td>app:layout_constraintStart_toEndOf</td><td>该控件以xx控件的结束端为开始端</td></tr><tr><td>app:layout_constraintStart_toStartOf</td><td>该控件以xx控件的开始端为开始端</td></tr><tr><td>app:layout_constraintEnd_toStartOf</td><td>该控件以xx控件的开始端为结束端</td></tr><tr><td>app:layout_constraintEnd_toEndOf</td><td>该控件以xx控件的结束端为结束端</td></tr></tbody></table><p>1、以<code>app:layout_constraintLeft_toRightOf</code>为例</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/btn_A"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A01.png" alt=""></p><p><code>app:layout_constraintBaseline_toBaselineOf</code>简单理解为<code>BTN_A</code>和<code>BTN_B</code>文字的底端对齐，布局修改后效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A02.png" alt=""></p><hr><h1 id="Margins"><a href="#Margins" class="headerlink" title="Margins"></a><strong>Margins</strong></h1><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>android:layout_marginStart</td><td>该控件距开始端控件的间距（设置了<code>app:layout_constraintStart_toStartOf</code>或<code>app:layout_constraintLeft_toLeftOf</code>后有效）</td></tr><tr><td>android:layout_marginEnd</td><td>该控件距结束端控件的间距（设置了<code>app:layout_constraintEnd_toEndOf</code>或<code>app:layout_constraintRight_toRightOf</code>后有效）</td></tr><tr><td>android:layout_marginLeft</td><td>该控件距左端控件的间距（设置了<code>app:layout_constraintStart_toStartOf</code>或<code>app:layout_constraintLeft_toLeftOf</code>后有效）</td></tr><tr><td>android:layout_marginTop</td><td>该控件距上端控件的间距（设置了<code>app:layout_constraintTop_toTopOf</code>后有效）</td></tr><tr><td>android:layout_marginRight</td><td>该控件距右端控件的间距（设置了<code>app:layout_constraintEnd_toEndOf</code>或<code>app:layout_constraintRight_toRightOf</code>后有效）</td></tr><tr><td>android:layout_marginBottom</td><td>该控件距下端控件的间距（设置了<code>app:layout_constraintBottom_toBottomOf</code>后有效）</td></tr><tr><td>app:layout_goneMarginStart</td><td>当开始端控件的可见性为<code>View.GONE</code>时，该控件距开始端控件的间距</td></tr><tr><td>app:layout_goneMarginEnd</td><td>当结束端控件的可见性为<code>View.GONE</code>时，该控件距结束端控件的间距</td></tr><tr><td>app:layout_goneMarginLeft</td><td>当左端控件的可见性为<code>View.GONE</code>时，该控件距左端控件的间距</td></tr><tr><td>app:layout_goneMarginTop</td><td>当上端控件的可见性为<code>View.GONE</code>时，该控件距上端控件的间距</td></tr><tr><td>app:layout_goneMarginRight</td><td>当右端控件的可见性为<code>View.GONE</code>时，该控件距右端控件的间距</td></tr><tr><td>app:layout_goneMarginBottom</td><td>当下端控件的可见性为<code>View.GONE</code>时，该控件距下端控件的间距</td></tr></tbody></table><p>1、以<code>app:layout_goneMarginLeft</code>为例</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:visibility</span>=<span class="string">"gone"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_goneMarginLeft</span>=<span class="string">"10dp"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A03.png" alt=""></p><hr><h1 id="Centering-positioning"><a href="#Centering-positioning" class="headerlink" title="Centering positioning"></a><strong>Centering positioning</strong></h1><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>app:layout_constraintHorizontal_bias</td><td>该控件水平方向占位占父控件的百分比（从左端开始计算）</td></tr><tr><td>app:layout_constraintVertical_bias</td><td>该控件垂直方向占位占父控件的百分比（从上端开始计算）</td></tr></tbody></table><p>1、以<code>app:layout_constraintHorizontal_bias</code>为例</p><p>（1）当百分比为<code>0</code>时</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintHorizontal_bias</span>=<span class="string">"0"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A04.png" alt=""></p><p>（2）当百分比为<code>100</code>时，修改布局参数值为<code>1</code>，效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A05.png" alt=""></p><p>（3）当百分比为<code>30</code>时，修改布局参数值为<code>0.3</code>，效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A06.png" alt=""></p><hr><h1 id="Circular-positioning"><a href="#Circular-positioning" class="headerlink" title="Circular positioning"></a><strong>Circular positioning</strong></h1><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>app:layout_constraintCircle</td><td>该控件所围绕的“圆心”控件</td></tr><tr><td>app:layout_constraintCircleRadius</td><td>圆的半径</td></tr><tr><td>app:layout_constraintCircleAngle</td><td>旋转角度</td></tr></tbody></table><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_C"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"5dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"5dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintCircle</span>=<span class="string">"@id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintCircleAngle</span>=<span class="string">"0"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintCircleRadius</span>=<span class="string">"100dp"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_D"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"5dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"5dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintCircle</span>=<span class="string">"@id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintCircleAngle</span>=<span class="string">"90"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintCircleRadius</span>=<span class="string">"100dp"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A07.png" alt=""></p><hr><h1 id="Visibility-behavior"><a href="#Visibility-behavior" class="headerlink" title="Visibility behavior"></a><strong>Visibility behavior</strong></h1><p>控件的 margin 属于控件自身，当控件可见性为<code>View.GONE</code>时，其 margin 也会失效，所以在计算<code>layout_goneMarginLeft</code>等时，需要加上该值</p><hr><h1 id="Dimension-constraints"><a href="#Dimension-constraints" class="headerlink" title="Dimension constraints"></a><strong>Dimension constraints</strong></h1><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>android:layout_width</td><td>该控件的宽度</td></tr><tr><td>android:layout_height</td><td>该控件的高度</td></tr><tr><td>android:minWidth</td><td>该控件的最小宽度（设置了<code>android:layout_width=&quot;wrap_content&quot;</code>后有效）</td></tr><tr><td>android:minHeight</td><td>该控件的最小高度（设置了<code>android:layout_height=&quot;wrap_content&quot;</code>后有效）</td></tr><tr><td>android:maxWidth</td><td>该控件的最大宽度（设置了<code>android:layout_width=&quot;wrap_content&quot;</code>后有效）</td></tr><tr><td>android:maxHeight</td><td>该控件的最大高度（设置了<code>android:layout_height=&quot;wrap_content&quot;</code>后有效）</td></tr><tr><td>app:layout_constraintDimensionRatio</td><td>该控件的宽高之比（需要宽、高至少一个是<code>0dp</code>）</td></tr><tr><td>app:layout_constrainedWidth</td><td>keep enforcing constraints to limit the resulting dimension</td></tr><tr><td>app:layout_constrainedHeight</td><td>keep enforcing constraints to limit the resulting dimension</td></tr><tr><td>app:layout_constraintWidth_min</td><td>该控件的最小宽度（设置了<code>android:layout_width=&quot;0dp&quot;</code>后有效）</td></tr><tr><td>app:layout_constraintHeight_min</td><td>该控件的最小高度（设置了<code>android:layout_height=&quot;0dp&quot;</code>后有效）</td></tr><tr><td>app:layout_constraintWidth_max</td><td>该控件的最大宽度（设置了<code>android:layout_width=&quot;0dp&quot;</code>后有效）</td></tr><tr><td>app:layout_constraintHeight_max</td><td>该控件的最大高度（设置了<code>android:layout_height=&quot;0dp&quot;</code>后有效）</td></tr><tr><td>app:layout_constraintWidth_percent</td><td>该控件相对于父控件水平方向的比例</td></tr><tr><td>app:layout_constraintHeight_percent</td><td>该控件相对于父控件垂直方向的比例</td></tr></tbody></table><p>1、<code>android:layout_width</code>和<code>android:layout_height</code>取不同值时的效果</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/btn_A"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_C"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_red_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_C"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"@id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A08.png" alt=""></p><p>2、以<code>android:minHeight</code>为例</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:minHeight</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@id/btn_A"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A09.png" alt=""></p><p>3、<code>app:layout_constraintDimensionRatio</code>只有一个方向是<code>0dp</code></p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintDimensionRatio</span>=<span class="string">"2:1"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A010.png" alt=""></p><p>4、<code>app:layout_constraintDimensionRatio</code>两个方向都是<code>0dp</code>，可以使用<code>W</code>或<code>H</code>指定方向</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintDimensionRatio</span>=<span class="string">"H,2:1"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A011.png" alt=""></p><p>5、以<code>app:layout_constraintWidth_percent</code>为例</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintWidth_percent</span>=<span class="string">"0.3"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"0dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A012.png" alt=""></p><hr><h1 id="Chains"><a href="#Chains" class="headerlink" title="Chains"></a><strong>Chains</strong></h1><p>控件之间互相引用可以成为 chain</p><table><thead><tr><th>属性</th><th>说明</th></tr></thead><tbody><tr><td>app:layout_constraintHorizontal_chainStyle</td><td>水平方向 chain 的样式（默认是<code>spread</code>）</td></tr><tr><td>app:layout_constraintVertical_chainStyle</td><td>垂直方向 chain 的样式（默认是<code>spread</code>）</td></tr><tr><td>app:layout_constraintHorizontal_weight</td><td>该控件水平方向权重（设置了<code>android:layout_width=&quot;0dp&quot;</code>后有效）</td></tr><tr><td>app:layout_constraintVertical_weight</td><td>该控件垂直方向权重（设置了<code>android:layout_height=&quot;0dp&quot;</code>后有效）</td></tr></tbody></table><p>1、chain 的样式</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A013.png" alt=""></p><p>2、构成 chain 的布局</p><p>布局</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">android.support.constraint.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">"http://schemas.android.com/apk/res-auto"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"200dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_marginLeft</span>=<span class="string">"50dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/darker_gray"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toLeftOf</span>=<span class="string">"parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toLeftOf</span>=<span class="string">"@+id/btn_B"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"@android:color/holo_orange_light"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"btn_B"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintLeft_toRightOf</span>=<span class="string">"@+id/btn_A"</span></span></div><div class="line"><span class="tag">        <span class="attr">app:layout_constraintRight_toRightOf</span>=<span class="string">"parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">android.support.constraint.ConstraintLayout</span>&gt;</span></div></pre></td></tr></table></figure><p>效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A014.png" alt=""></p><p>3、布局去掉<code>app:layout_constraintRight_toLeftOf=&quot;@+id/btn_B&quot;</code>即不能构成 chain，效果</p><p><img src="http://otkw6sse5.bkt.clouddn.com/ConstraintLayout-%E5%AD%A6%E4%B9%A015.png" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://de
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>实现自定义换行规则的文本框</title>
    <link href="http://www.weichao.io/2018/02/07/%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8D%A2%E8%A1%8C%E8%A7%84%E5%88%99%E7%9A%84%E6%96%87%E6%9C%AC%E6%A1%86/"/>
    <id>http://www.weichao.io/2018/02/07/实现自定义换行规则的文本框/</id>
    <published>2018-02-07T15:59:21.000Z</published>
    <updated>2018-02-08T14:11:58.055Z</updated>
    
    <content type="html"><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a><strong>需求</strong></h1><p>使<code>-</code>不能成为换行的依据，除非该单词超长到一行装不下才可以让<code>-</code>出现在一行的开头或结尾。</p><hr><h1 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a><strong>实现效果</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8D%A2%E8%A1%8C%E8%A7%84%E5%88%99%E7%9A%84%E6%96%87%E6%9C%AC%E6%A1%862018-02-08-21-39-42.png" alt=""></p><hr><h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a><strong>实现过程</strong></h1><h2 id="Word-类"><a href="#Word-类" class="headerlink" title="Word 类"></a><strong>Word 类</strong></h2><p>用于保存单词内容、宽度、高度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Word</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> String text;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> width;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">float</span> height;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Word</span><span class="params">(String text, <span class="keyword">float</span> width, <span class="keyword">float</span> height)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.text = text;</div><div class="line">        <span class="keyword">this</span>.width = width;</div><div class="line">        <span class="keyword">this</span>.height = height;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="Line-类"><a href="#Line-类" class="headerlink" title="Line 类"></a><strong>Line 类</strong></h2><p>用于保存一行中的 Word</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">Line</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> ArrayList&lt;Word&gt; wordList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="将字符串按自定义规则分成单词"><a href="#将字符串按自定义规则分成单词" class="headerlink" title="将字符串按自定义规则分成单词"></a><strong>将字符串按自定义规则分成单词</strong></h2><p>遍历字符串中的每一个字符，如果该字符不是<code>-</code>，且不是在<code>A~Z</code>或<code>a~z</code>之间，则认为已识别到单词的结尾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setText</span><span class="params">(CharSequence charSequence)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(charSequence)) &#123;</div><div class="line">        wordList.clear();</div><div class="line">        StringBuilder stringBuilder = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">int</span> length = charSequence.length();</div><div class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</div><div class="line">            <span class="keyword">char</span> c = charSequence.charAt(i);</div><div class="line">            <span class="keyword">if</span> (c != <span class="string">'-'</span> &amp;&amp; (c &lt; <span class="string">'A'</span> || (c &gt; <span class="string">'Z'</span> &amp;&amp; c &lt; <span class="string">'a'</span>) || c &gt; <span class="string">'z'</span>)) &#123;</div><div class="line">                <span class="keyword">if</span> (stringBuilder != <span class="keyword">null</span>) &#123;</div><div class="line">                    wordList.add(stringBuilder.toString());</div><div class="line">                    stringBuilder = <span class="keyword">null</span>;</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="keyword">if</span> (stringBuilder == <span class="keyword">null</span>) &#123;</div><div class="line">                    stringBuilder = <span class="keyword">new</span> StringBuilder();</div><div class="line">                &#125;</div><div class="line">                stringBuilder.append(c);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (stringBuilder != <span class="keyword">null</span>) &#123;</div><div class="line">            wordList.add(stringBuilder.toString().trim());</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        Log.e(TAG, <span class="string">"TextUtils.isEmpty(charSequence)"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="重写-onMeasure-方法"><a href="#重写-onMeasure-方法" class="headerlink" title="重写 onMeasure 方法"></a><strong>重写 onMeasure 方法</strong></h2><p>1、获取实际可用的宽高</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec) - getPaddingLeft() - getPaddingRight();<span class="comment">// 去掉 padding，实际可用的宽度</span></div><div class="line"><span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec) - getPaddingTop() - getPaddingBottom();<span class="comment">// 去掉 padding，实际可用的高度</span></div></pre></td></tr></table></figure><p>2、清除缓存</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">lineList.clear();</div><div class="line"><span class="keyword">float</span> usedWidth = <span class="number">0</span>;</div><div class="line">Line line = <span class="keyword">null</span>;</div></pre></td></tr></table></figure><p>3、遍历已分成的单词列表，测量每个单词在指定的 paint 下所占用的宽度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> width = paint.measureText(word);</div></pre></td></tr></table></figure><p>（1）如果已占用宽度加上该单词的宽度比实际可用的宽度小或相等，则将该单词添加到行中，并添加一个单词间距的宽度到已占用宽度上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (line == <span class="keyword">null</span>) &#123;</div><div class="line">    line = <span class="keyword">new</span> Line();</div><div class="line">&#125;</div><div class="line">line.wordList.add(<span class="keyword">new</span> Word(word, width, paint.getTextSize()));</div><div class="line">usedWidth += wordHorizontalMargin;</div></pre></td></tr></table></figure><p>（2）如果已占用宽度加上该单词的宽度比实际可用的宽度大，则封闭前一行，创建新行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">lineList.add(line);</div><div class="line">line = <span class="keyword">new</span> Line();</div></pre></td></tr></table></figure><p>同时判断当前这一个单词的宽度是否已经超过实际可用的宽度了，如果超过了，则按照实际可用宽度截取字符串到一行，最后剩余部分单独添加到新的一行，作为该行的第一个单词，并添加一个单词间距的宽度到已占用宽度上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (width &gt; widthSize) &#123;</div><div class="line">    Word restWord = addWordListBySub(word, widthSize);</div><div class="line">    <span class="keyword">if</span> (restWord != <span class="keyword">null</span>) &#123;</div><div class="line">        line = <span class="keyword">new</span> Line();</div><div class="line">        line.wordList.add(restWord);</div><div class="line">        usedWidth = restWord.width;</div><div class="line">        usedWidth += wordHorizontalMargin;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>否则，将该单词作为新行的第一个单词，并添加一个单词间距的宽度到已占用宽度上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">    usedWidth = width;</div><div class="line">    line.wordList.add(<span class="keyword">new</span> Word(word, width, paint.getTextSize()));</div><div class="line">    usedWidth += wordHorizontalMargin;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>4、最后，可能剩余宽度不足一行的情况，将其封闭为一行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!lineList.contains(line)) &#123;</div><div class="line">    lineList.add(line);<span class="comment">// 把最后一行添加到集合中</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>5、计算实际占用的宽度和高度并使用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> totalWidth = widthSize + getPaddingLeft() + getPaddingRight();</div><div class="line"></div><div class="line"><span class="keyword">int</span> totalHeight = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> lineListSize = lineList.size();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lineListSize; i++) &#123;</div><div class="line">    totalHeight += lineList.get(i).wordList.get(<span class="number">0</span>).height;</div><div class="line">&#125;</div><div class="line">totalHeight += (lineListSize - <span class="number">1</span>) * wordVerticalMargin;</div><div class="line">totalHeight += getPaddingTop();</div><div class="line">totalHeight += getPaddingBottom();</div><div class="line"></div><div class="line">setMeasuredDimension(totalWidth, totalHeight);</div></pre></td></tr></table></figure><h3 id="一种提高获取被截取字符串索引的速度的方法"><a href="#一种提高获取被截取字符串索引的速度的方法" class="headerlink" title="一种提高获取被截取字符串索引的速度的方法"></a><strong>一种提高获取被截取字符串索引的速度的方法</strong></h3><p>定义一个递归方法，传入的参数是单词和一行的最大宽度。当传入的单词经过测量后的宽度小于或等于一行的最大宽度时，即认为已完成所有单词的截取，结束递归，或者当传入的字符串为空串时，也会结束递归</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Word <span class="title">addWordListBySub</span><span class="params">(String word, <span class="keyword">int</span> widthSize)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (!TextUtils.isEmpty(word)) &#123;</div><div class="line">        <span class="keyword">float</span> width = getMeasuredWidth(word);</div><div class="line">        <span class="keyword">if</span> (width &lt;= widthSize) &#123;</div><div class="line">            <span class="keyword">return</span> <span class="keyword">new</span> Word(word, width, getTextHeight());</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            ...</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>当传入的单词经过测量后的宽度大于一行的最大宽度时，计算单词中一个字符大概占的宽度，使用一行的最大宽度除以该宽度可得大概能满足字符串截取后的长度刚好等于一行的宽度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> oneCharWidth = width / word.length();</div><div class="line"><span class="keyword">int</span> index = (<span class="keyword">int</span>) (widthSize / oneCharWidth);</div><div class="line">String substring = word.substring(<span class="number">0</span>, index);</div><div class="line"><span class="keyword">float</span> substringWidth = getMeasuredWidth(substring);</div></pre></td></tr></table></figure><p>为了精确，继续对截取字符串所需的索引的值做逼近处理，当获取到宽度不大于一行的宽度的最大值后，截取字符串，将剩余子串继续进行递归。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> realIndex;</div><div class="line">String realSubstring;</div><div class="line"><span class="keyword">if</span> (substringWidth &lt; widthSize) &#123;</div><div class="line">    realIndex = getMinSubstringWidthIndex(word, widthSize, index);</div><div class="line">    realSubstring = word.substring(<span class="number">0</span>, realIndex);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (substringWidth &gt; widthSize) &#123;</div><div class="line">    realIndex = getMaxSubstringWidthIndex(word, widthSize, index);</div><div class="line">    realSubstring = word.substring(<span class="number">0</span>, realIndex);</div><div class="line">&#125; <span class="keyword">else</span> &#123;</div><div class="line">    realIndex = index;</div><div class="line">    realSubstring = substring;</div><div class="line">&#125;</div><div class="line"><span class="keyword">float</span> realWidth = getMeasuredWidth(realSubstring);</div><div class="line">Line line = <span class="keyword">new</span> Line();</div><div class="line">line.wordList.add(<span class="keyword">new</span> Word(realSubstring, realWidth, getTextHeight()));</div><div class="line">lineList.add(line);</div><div class="line">String restSubstring = word.substring(realIndex);</div><div class="line"><span class="keyword">return</span> addWordListBySub(restSubstring, widthSize);</div></pre></td></tr></table></figure><p>大概计算出位置后，再遍历查找</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMinSubstringWidthIndex</span><span class="params">(String word, <span class="keyword">int</span> widthSize, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index + <span class="number">1</span>, size = word.length(); i &lt; size; i++) &#123;</div><div class="line">        String substring = word.substring(i);</div><div class="line">        <span class="keyword">float</span> width = getMeasuredWidth(substring);</div><div class="line">        <span class="keyword">if</span> (width &gt; widthSize) &#123;</div><div class="line">            <span class="keyword">int</span> minSubstringWidthIndex = i - <span class="number">1</span>;</div><div class="line">            <span class="keyword">return</span> minSubstringWidthIndex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> index;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getMaxSubstringWidthIndex</span><span class="params">(String word, <span class="keyword">int</span> widthSize, <span class="keyword">int</span> index)</span> </span>&#123;</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = index - <span class="number">1</span>; i &gt; <span class="number">0</span>; i--) &#123;</div><div class="line">        String substring = word.substring(i);</div><div class="line">        <span class="keyword">float</span> width = getMeasuredWidth(substring);</div><div class="line">        <span class="keyword">if</span> (width &lt; widthSize) &#123;</div><div class="line">            <span class="keyword">int</span> maxSubstringWidthIndex = i;</div><div class="line">            <span class="keyword">return</span> maxSubstringWidthIndex;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> index;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="重写-onDraw-方法"><a href="#重写-onDraw-方法" class="headerlink" title="重写 onDraw 方法"></a><strong>重写 onDraw 方法</strong></h2><p>canvas 在绘制文本时，需要知道的是绘制结束的位置，也就是图中大概红点所表示的位置，其余从哪画、怎么画均交给 paint 处理</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8D%A2%E8%A1%8C%E8%A7%84%E5%88%99%E7%9A%84%E6%96%87%E6%9C%AC%E6%A1%862018-02-08-21-39-42%20-%20%E5%89%AF%E6%9C%AC.png" alt=""></p><p>1、计算第一个 Y，后面的 Y 均在此基础上叠加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> totalY = getPaddingTop() - getViewTop();</div></pre></td></tr></table></figure><p>2、遍历行，当行内文本需要居中时，计算一行中所有单词及单词间的间隔使用的宽度，将剩余宽度作为左端偏移量</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Line line : lineList) &#123;</div><div class="line">    ArrayList&lt;Word&gt; wordList = line.wordList;</div><div class="line"></div><div class="line">    <span class="keyword">float</span> marginLeft = <span class="number">0</span>;</div><div class="line">    <span class="keyword">if</span> (mGravity == GRAVITY_CENTER) &#123;</div><div class="line">        <span class="keyword">float</span> totalUsedWidth = <span class="number">0</span>;</div><div class="line">        <span class="keyword">for</span> (Word word : wordList) &#123;</div><div class="line">            totalUsedWidth += word.width;</div><div class="line">        &#125;</div><div class="line">        totalUsedWidth += (wordList.size() - <span class="number">1</span>) * mWordHorizontalMargin;</div><div class="line">        marginLeft = (getMeasuredWidth() - getPaddingLeft() - getPaddingRight() - totalUsedWidth) / <span class="number">2</span>;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>3、在行中遍历单词，绘制完一个单词后，X 位置需要加上单词宽度和单词间的间距</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">float</span> totalX = getPaddingLeft() + marginLeft;</div><div class="line"><span class="keyword">for</span> (Word word : wordList) &#123;</div><div class="line">    canvas.drawText(word.text, totalX, totalY, paint);<span class="comment">// draw 从左上角开始，需要计算出需要的宽高</span></div><div class="line">    totalX += word.width;</div><div class="line">    totalX += mWordHorizontalMargin;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>4、当一行绘制完后，Y 位置需要加上行高和行间距</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">totalY += wordList.get(<span class="number">0</span>).height;</div><div class="line">totalY += mWordVerticalMargin;</div></pre></td></tr></table></figure><hr><h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a><strong>源码地址</strong></h1><p><a href="https://github.com/weichao66666/CustomLineBreakTextView" title="https://github.com/weichao66666/CustomLineBreakTextView" target="_blank" rel="external">CustomLineBreakTextView</a></p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;&lt;strong&gt;需求&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;使&lt;code&gt;-&lt;/code&gt;不能成为换行的依据，除非该单词超长到一行装不下才可以让&lt;code&gt;-&lt;/co
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>实现带有分隔线的流布局</title>
    <link href="http://www.weichao.io/2018/02/04/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E5%88%86%E9%9A%94%E7%BA%BF%E7%9A%84%E6%B5%81%E5%B8%83%E5%B1%80/"/>
    <id>http://www.weichao.io/2018/02/04/实现带有分隔线的流布局/</id>
    <published>2018-02-04T07:07:55.000Z</published>
    <updated>2018-02-06T14:08:32.169Z</updated>
    
    <content type="html"><![CDATA[<h1 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a><strong>实现效果</strong></h1><p>1、左对齐式流布局</p><p><img src="http://otkw6sse5.bkt.clouddn.com/Screenshot_20180204-151406.jpg" alt=""></p><p>2、左右对齐式流布局</p><p><img src="http://otkw6sse5.bkt.clouddn.com/Screenshot_20180204-151311.jpg" alt=""></p><hr><h1 id="Google-的-FlexboxLayout-不能解决的问题"><a href="#Google-的-FlexboxLayout-不能解决的问题" class="headerlink" title="Google 的 FlexboxLayout 不能解决的问题"></a><strong>Google 的 FlexboxLayout 不能解决的问题</strong></h1><h2 id="左对齐时分隔线不能调整高度"><a href="#左对齐时分隔线不能调整高度" class="headerlink" title="左对齐时分隔线不能调整高度"></a><strong>左对齐时分隔线不能调整高度</strong></h2><h3 id="布局"><a href="#布局" class="headerlink" title="布局"></a><strong>布局</strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.google.android.flexbox.FlexboxLayout</span></span></div><div class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/flexbox_layout"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingBottom</span>=<span class="string">"10dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingEnd</span>=<span class="string">"30dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingStart</span>=<span class="string">"30dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"10dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:alignItems</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:dividerDrawableVertical</span>=<span class="string">"@drawable/ic_divider_horizontal"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:flexDirection</span>=<span class="string">"row"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:flexWrap</span>=<span class="string">"wrap"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:justifyContent</span>=<span class="string">"flex_start"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:showDividerVertical</span>=<span class="string">"beginning|middle|end"</span> /&gt;</span></div></pre></td></tr></table></figure><h3 id="效果"><a href="#效果" class="headerlink" title="效果"></a><strong>效果</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/2018-02-05-22-59-14.png" alt=""></p><h2 id="左右对齐时分隔线不能调整高度且显示效果不理想"><a href="#左右对齐时分隔线不能调整高度且显示效果不理想" class="headerlink" title="左右对齐时分隔线不能调整高度且显示效果不理想"></a><strong>左右对齐时分隔线不能调整高度且显示效果不理想</strong></h2><h3 id="布局-1"><a href="#布局-1" class="headerlink" title="布局"></a><strong>布局</strong></h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">com.google.android.flexbox.FlexboxLayout</span></span></div><div class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">"@+id/flexbox_layout"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingBottom</span>=<span class="string">"10dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingEnd</span>=<span class="string">"30dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingStart</span>=<span class="string">"30dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:paddingTop</span>=<span class="string">"10dp"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:alignItems</span>=<span class="string">"center"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:dividerDrawableVertical</span>=<span class="string">"@drawable/ic_divider_horizontal"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:flexDirection</span>=<span class="string">"row"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:flexWrap</span>=<span class="string">"wrap"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:justifyContent</span>=<span class="string">"space_between"</span></span></div><div class="line"><span class="tag">    <span class="attr">app:showDividerVertical</span>=<span class="string">"beginning|middle|end"</span> /&gt;</span></div></pre></td></tr></table></figure><h3 id="效果-1"><a href="#效果-1" class="headerlink" title="效果"></a><strong>效果</strong></h3><p><img src="http://otkw6sse5.bkt.clouddn.com/2018-02-05-23-04-16.png" alt=""></p><h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a><strong>实现过程</strong></h1><h2 id="重写-onMeasure-方法"><a href="#重写-onMeasure-方法" class="headerlink" title="重写 onMeasure 方法"></a><strong>重写 onMeasure 方法</strong></h2><p>1、判断是否存在 adapter，如果不存在，则不需要执行后续计算</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mFlowLayoutAdapter == <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2、清除数据，否则会导致每执行一次绘制，则添加一遍数据</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">removeAllViews();</div><div class="line">lineList.clear();</div><div class="line">Line line = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">int</span> usedWidth = <span class="number">0</span>;</div></pre></td></tr></table></figure><p>3、获取数据并添加到 View</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">List&lt;View&gt; children = mFlowLayoutAdapter.getChildren();</div><div class="line"><span class="keyword">for</span> (View child : children) &#123;</div><div class="line">    addView(child);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>此时是不存在分隔线的</p><p>4、获取测量的参数</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> widthSize = MeasureSpec.getSize(widthMeasureSpec) - getPaddingLeft() - getPaddingRight();<span class="comment">// 去掉 padding，实际可用的宽度</span></div><div class="line"><span class="keyword">int</span> heightSize = MeasureSpec.getSize(heightMeasureSpec) - getPaddingTop() - getPaddingBottom();<span class="comment">// 去掉 padding，实际可用的高度</span></div><div class="line"><span class="keyword">int</span> widthMode = MeasureSpec.getMode(widthMeasureSpec);<span class="comment">// 获取父容器为 child 设置的宽的测量模式</span></div><div class="line"><span class="keyword">int</span> heightMode = MeasureSpec.getMode(heightMeasureSpec);<span class="comment">// 获取父容器为 child 设置的高的测量模式</span></div><div class="line"><span class="keyword">int</span> childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(widthSize, widthMode == MeasureSpec.EXACTLY ? MeasureSpec.AT_MOST : widthMode);</div><div class="line"><span class="keyword">int</span> childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(heightSize, heightMode == MeasureSpec.EXACTLY ? MeasureSpec.AT_MOST : heightMode);</div></pre></td></tr></table></figure><p>5、根据宽度，计算 child 的位置，并添加分隔线</p><p>（1）遍历 children，如果该 child 不可见，则放弃对其处理，继续处理下一个</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">View child = getChildAt(index);</div><div class="line"><span class="keyword">if</span> (child.getVisibility() == View.GONE) &#123;</div><div class="line">    index++;</div><div class="line">    <span class="keyword">continue</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>（2）如果 child 为一行中的第一个元素，则在 child 的前面添加一个分隔线，并将该分隔线添加到行中，并将行宽度加上该分隔线的宽度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> j = <span class="number">0</span>;</div><div class="line"><span class="keyword">if</span> (line == <span class="keyword">null</span>) &#123;</div><div class="line">    line = <span class="keyword">new</span> Line();</div><div class="line">    usedWidth = <span class="number">0</span>;</div><div class="line">    View dividerView = mFlowLayoutAdapter.getDividerView();</div><div class="line">    addView(dividerView, index);</div><div class="line">    line.addChild(dividerView, dividerViewWidth);</div><div class="line">    usedWidth += dividerViewWidth;</div><div class="line">    j++;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>（3）此时，child 必然已不是行的第一个元素，其前面必然有一个分隔线，此时，还需要加上分隔线到 child 的间距</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">usedWidth += dividerViewMinMargin;</div></pre></td></tr></table></figure><p>（4）然后，才是 child 的宽度，该宽度需要经过计算后再添加</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"><span class="keyword">int</span> childWidth = child.getMeasuredWidth();</div><div class="line">usedWidth += childWidth;</div></pre></td></tr></table></figure><p>（5）最后，在 child 后面还有一个分隔线和它们的间距需要加上</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">usedWidth += dividerViewMinMargin;</div><div class="line">usedWidth += dividerViewWidth;</div></pre></td></tr></table></figure><p>（6）注意，（3）~（5）只是计算添加一个 child 及其分隔线所需的宽度，并未实际将该 child 添加到行中，因为原有行宽度加上这部分宽度有可能导致宽度超过屏幕所能显示的极限，所以添加一个判断，当宽度之和小于宽度极限值时才将该 child 和分隔线加入行</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (usedWidth &lt;= widthSize) &#123;</div><div class="line">    line.addChild(child, childWidth);</div><div class="line">    View dividerView = mFlowLayoutAdapter.getDividerView();</div><div class="line">    addView(dividerView, index + j + <span class="number">1</span>);</div><div class="line">    line.addChild(dividerView, dividerViewWidth);</div><div class="line">    j++;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>（7）当（6）判断出宽度之和已超出宽度极限值时，则将已有行封闭，并将（3）~（5）计算的 child 作为新行的首个元素，在 child 前和后各添加一个分隔线</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">lineList.add(line);</div><div class="line"></div><div class="line">line = <span class="keyword">new</span> Line();</div><div class="line">usedWidth = <span class="number">0</span>;</div><div class="line"></div><div class="line">View dividerView = mFlowLayoutAdapter.getDividerView();</div><div class="line">addView(dividerView, index);</div><div class="line">line.addChild(dividerView, dividerViewWidth);</div><div class="line">usedWidth += dividerViewWidth;</div><div class="line">usedWidth += dividerViewMinMargin;</div><div class="line">j++;</div><div class="line"></div><div class="line">line.addChild(child, childWidth);</div><div class="line">usedWidth += childWidth;</div><div class="line">usedWidth += dividerViewMinMargin;</div><div class="line">View dividerView1 = mFlowLayoutAdapter.getDividerView();</div><div class="line">addView(dividerView1, index + j + <span class="number">1</span>);</div><div class="line"></div><div class="line">line.addChild(dividerView1, dividerViewWidth);</div><div class="line">usedWidth += dividerViewWidth;</div><div class="line">j++;</div></pre></td></tr></table></figure><p>（8）因为按照这种添加方法，当遍历到最后一个 child 时，也会在其后添加一个分隔线，如果循环条件为元素的数量时，会陷入死循环，所以可以判断到最后一个 child 时，将循环标记置为 false，取消后续的循环</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (index &lt; childCount &amp;&amp; !isLast) &#123;</div><div class="line">    <span class="keyword">if</span> (index == childCount - <span class="number">1</span>) &#123;</div><div class="line">        isLast = <span class="keyword">true</span>;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>（9）最后一行可能未满一行，也将其封闭</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!lineList.contains(line)) &#123;</div><div class="line">    lineList.add(line);<span class="comment">// 把最后一行添加到集合中</span></div><div class="line">&#125;</div></pre></td></tr></table></figure><p>6、遍历行的集合，累加其高度，并将宽、高设置为测量到的宽高</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> totalWidth = widthSize + getPaddingLeft() + getPaddingRight();</div><div class="line"><span class="keyword">this</span>.totalWidth = totalWidth;</div><div class="line"></div><div class="line"><span class="keyword">int</span> totalHeight = <span class="number">0</span>;</div><div class="line"><span class="keyword">int</span> lineListSize = lineList.size();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lineListSize; i++) &#123;</div><div class="line">    totalHeight += lineList.get(i).getHeight();</div><div class="line">&#125;</div><div class="line">totalHeight += (lineListSize - <span class="number">1</span>) * rowMargin;</div><div class="line">totalHeight += getPaddingTop();</div><div class="line">totalHeight += getPaddingBottom();</div><div class="line"><span class="keyword">this</span>.totalHeight = totalHeight;</div><div class="line"></div><div class="line">setMeasuredDimension(totalWidth, totalHeight);</div></pre></td></tr></table></figure><h2 id="重写-onLayout-方法"><a href="#重写-onLayout-方法" class="headerlink" title="重写 onLayout 方法"></a><strong>重写 onLayout 方法</strong></h2><p>将 paddingLeft 和 paddingTop 作为绘制的起始点，遍历行的集合，让每一行调用其自身方法再次计算其布局位置，相邻两行添加行高</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">left = getPaddingLeft();</div><div class="line">top = getPaddingTop();<span class="comment">// 注意：不是 top += getPaddingTop();</span></div><div class="line"><span class="keyword">int</span> rowMargin = mFlowLayoutAdapter.getRowMargin();</div><div class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>, size = lineList.size(); i &lt; size; i++) &#123;</div><div class="line">    Line line = lineList.get(i);</div><div class="line">    line.layout(left, top); <span class="comment">// 分配行的位置，然后再交给每个行去分配 child 的位置</span></div><div class="line">    top += line.getHeight();</div><div class="line">    top += rowMargin;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="行的布局"><a href="#行的布局" class="headerlink" title="行的布局"></a><strong>行的布局</strong></h3><p>1、当为左右对齐式流布局时，需要计算 child 到相邻分隔线的距离，即用总的可用距离除以 child 加上分隔线的数量之和</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> childListSize = childList.size();</div><div class="line"><span class="keyword">int</span> marginsWidth = getMeasuredWidth() - getPaddingLeft() - getPaddingRight() - width;</div><div class="line"><span class="keyword">int</span> marginWidth = marginsWidth / (childListSize - <span class="number">1</span>);</div></pre></td></tr></table></figure><p>此时，可能出现不能整除的情况，我这里做的处理是将余数部分平分，添加到两端的分隔线到最近的 child 之间的距离</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> offset = marginsWidth % (childListSize - <span class="number">1</span>);</div><div class="line"><span class="keyword">int</span> leftOffset = offset &gt;&gt; <span class="number">1</span>;</div><div class="line"><span class="keyword">int</span> rightOffset = offset - leftOffset;</div></pre></td></tr></table></figure><p>2、遍历所有元素。当为分隔线时，计算绘制的位置，如果对齐方式为左右对齐，且是最后一个分隔线，left 有可能略向右偏移，top 需要重新计算以便实现居中，right 为 left 加上分隔线的宽度，bottom 为 计算后的 top 加上分隔线的高度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (i % <span class="number">2</span> == <span class="number">0</span>) &#123;</div><div class="line">    <span class="keyword">if</span> (i == childListSize - <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (gravityMode == FlowLayoutAdapter.GRAVITY_MODE_LEFT_AND_RIGHT) &#123;</div><div class="line">            left += leftOffset;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    realTop = top + ((height - dividerViewHeight) &gt;&gt; <span class="number">1</span>);</div><div class="line">    right = left + dividerViewWidth;</div><div class="line">    bottom = realTop + dividerViewHeight;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>当为 child 时，计算绘制的位置，如果对齐方式为左右对齐，从第一个 child 起，所有 child 都可能略向左偏移，top 就是传递进来的 top，right 为 left 加上 child 测量出的宽度，bottom 为 top 加上 child 的高度</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">else</span> &#123;</div><div class="line">    realTop = top;</div><div class="line">    <span class="keyword">int</span> measuredWidth = child.getMeasuredWidth();</div><div class="line">    <span class="keyword">if</span> (i == <span class="number">1</span>) &#123;</div><div class="line">        <span class="keyword">if</span> (gravityMode == FlowLayoutAdapter.GRAVITY_MODE_LEFT_AND_RIGHT) &#123;</div><div class="line">            left += rightOffset;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    right = left + measuredWidth;</div><div class="line">    bottom = top + height;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>3、当一个分隔线或 child 布局计算结束后，左对齐的流布局需要加上最小间距，左右对齐的流布局需要加上平均间距</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">switch</span> (gravityMode) &#123;</div><div class="line">    <span class="keyword">case</span> FlowLayoutAdapter.GRAVITY_MODE_LEFT:</div><div class="line">        left += minMargin;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    <span class="keyword">case</span> FlowLayoutAdapter.GRAVITY_MODE_LEFT_AND_RIGHT:</div><div class="line">        left += marginWidth;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a><strong>源码地址</strong></h1><ul><li><a href="https://github.com/weichao66666/FlexboxLayoutDemo" title="https://github.com/weichao66666/FlexboxLayoutDemo" target="_blank" rel="external">FlexboxLayoutDemo</a></li><li><a href="https://github.com/weichao66666/FlowLayoutWithDividerDemo" title="https://github.com/weichao66666/FlowLayoutWithDividerDemo" target="_blank" rel="external">FlowLayoutWithDividerDemo</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;实现效果&quot;&gt;&lt;a href=&quot;#实现效果&quot; class=&quot;headerlink&quot; title=&quot;实现效果&quot;&gt;&lt;/a&gt;&lt;strong&gt;实现效果&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;1、左对齐式流布局&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://otkw6sse5.b
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>实现带有粘性头部的列表</title>
    <link href="http://www.weichao.io/2018/01/26/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E7%B2%98%E6%80%A7%E5%A4%B4%E9%83%A8%E7%9A%84%E5%88%97%E8%A1%A8/"/>
    <id>http://www.weichao.io/2018/01/26/实现带有粘性头部的列表/</id>
    <published>2018-01-25T18:17:53.000Z</published>
    <updated>2018-01-30T14:32:47.161Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="http://blog.csdn.net/cjm2484836553/article/details/53453982" title="http://blog.csdn.net/cjm2484836553/article/details/53453982" target="_blank" rel="external">Android-使用 RecyclerView 的 ItemDecoration 实现炫酷的吸顶效果</a></li></ul><hr><h1 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a><strong>实现效果</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E7%B2%98%E6%80%A7%E5%A4%B4%E9%83%A8%E7%9A%84%E5%88%97%E8%A1%A85a69f98ffbfdc162c1000000.gif" alt=""></p><hr><h1 id="实现过程"><a href="#实现过程" class="headerlink" title="实现过程"></a><strong>实现过程</strong></h1><h2 id="获取数据"><a href="#获取数据" class="headerlink" title="获取数据"></a><strong>获取数据</strong></h2><p>例如使用 Retrofit 访问接口获取数据：<a href="http://api.meituan.com/mmdb/movie/v2/list/rt/order/coming.json?ci=1&amp;limit=12&amp;token=&amp;__vhost=api.maoyan.com&amp;utm_campaign=AmovieBmovieCD-1&amp;movieBundleVersion=6801&amp;utm_source=xiaomi&amp;utm_medium=android&amp;utm_term=6.8.0&amp;utm_content=868030022327462&amp;net=255&amp;dModel=MI%205&amp;uuid=0894DE03C76F6045D55977B6D4E32B7F3C6AAB02F9CEA042987B380EC5687C43&amp;lat=40.100673&amp;lng=116.378619&amp;__skck=6a375bce8c66a0dc293860dfa83833ef&amp;__skts=1463704714271&amp;__skua=7e01cf8dd30a179800a7a93979b430b2&amp;__skno=1a0b4a9b-44ec-42fc-b110-ead68bcc2824&amp;__skcy=sXcDKbGi20CGXQPPZvhCU3%2FkzdE%3D" target="_blank" rel="external">http://api.meituan.com/mmdb/movie/v2/list/rt/order/coming.json?ci=1&amp;limit=12&amp;token=&amp;__vhost=api.maoyan.com&amp;utm_campaign=AmovieBmovieCD-1&amp;movieBundleVersion=6801&amp;utm_source=xiaomi&amp;utm_medium=android&amp;utm_term=6.8.0&amp;utm_content=868030022327462&amp;net=255&amp;dModel=MI%205&amp;uuid=0894DE03C76F6045D55977B6D4E32B7F3C6AAB02F9CEA042987B380EC5687C43&amp;lat=40.100673&amp;lng=116.378619&amp;__skck=6a375bce8c66a0dc293860dfa83833ef&amp;__skts=1463704714271&amp;__skua=7e01cf8dd30a179800a7a93979b430b2&amp;__skno=1a0b4a9b-44ec-42fc-b110-ead68bcc2824&amp;__skcy=sXcDKbGi20CGXQPPZvhCU3%2FkzdE%3D</a></p><p>同时可以将获取到的 JSON 格式的数据封装成 Bean 对象。</p><h2 id="使用数据"><a href="#使用数据" class="headerlink" title="使用数据"></a><strong>使用数据</strong></h2><h3 id="将数据放入-RecyclerView-中"><a href="#将数据放入-RecyclerView-中" class="headerlink" title="将数据放入 RecyclerView 中"></a><strong>将数据放入 RecyclerView 中</strong></h3><p>1、使用到的只是 Bean 对象中的 comingBeanList，所以先获取 comingBeanList：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">List&lt;DataResponseBean.DataBean.ComingBean&gt; comingBeanList = bean.getData().getComing();</div></pre></td></tr></table></figure><p>2、因为将日前作为分组的依据，同时将日期作为 title，所以先获取所有 comingBeanList 中元素的日期：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPullAction</span><span class="params">(List&lt;DataResponseBean.DataBean.ComingBean&gt; comingslist)</span> </span>&#123;</div><div class="line">    mTitleList = <span class="keyword">new</span> ArrayList&lt;&gt;();</div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; comingslist.size(); i++) &#123;</div><div class="line">        mTitleList.add(comingslist.get(i).getComingTitle());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>3、给 RecyclerView 设置 ItemDecoration，用于显示每组第一个元素的 title：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">mRecyclerView.addItemDecoration(<span class="keyword">new</span> SectionDecoration(<span class="keyword">this</span>, <span class="keyword">new</span> SectionDecoration.DecorationCallback() &#123;</div><div class="line">    <span class="comment">// 返回标记 id (即每一项对应的标志性的字符串)</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGroupId</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mTitleList.get(position);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 获取组的 title</span></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getGroupTitle</span><span class="params">(<span class="keyword">int</span> position)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mTitleList.get(position);</div><div class="line">    &#125;</div><div class="line">&#125;));</div></pre></td></tr></table></figure><p>4、给 RecyclerView 添加 adapter，显示列表数据：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mRecyclerView.setAdapter(<span class="keyword">new</span> MyRecyclerAdapter(<span class="keyword">this</span>, comingBeanList));</div></pre></td></tr></table></figure><h3 id="将数据分组，每组第一个元素显示-title，其余元素不显示-title"><a href="#将数据分组，每组第一个元素显示-title，其余元素不显示-title" class="headerlink" title="将数据分组，每组第一个元素显示 title，其余元素不显示 title"></a><strong>将数据分组，每组第一个元素显示 title，其余元素不显示 title</strong></h3><p>1、重写 getItemOffsets 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">getItemOffsets</span><span class="params">(Rect outRect, View view, RecyclerView parent, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.getItemOffsets(outRect, view, parent, state);</div><div class="line">    <span class="keyword">int</span> pos = parent.getChildAdapterPosition(view);</div><div class="line">    <span class="comment">// 只有是同一组的第一个 item 才显示悬浮栏</span></div><div class="line">    <span class="keyword">if</span> (isFirstInGroup(pos)) &#123;</div><div class="line">        outRect.top = barTopGap;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        outRect.top = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果判断出当前位置的元素是该组的第一个元素，则将 outRect.top 置为 barTopGap，即在元素的上方预留出高度为 barTopGap 的区域；反之，则不预留区域。</p><p>2、判断当前位置的元素是否为该组的第一个元素的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isFirstInGroup</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (pos == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        String groupId = mCallback.getGroupId(pos);<span class="comment">// 当前这个 item 的 id</span></div><div class="line">        String prevGroupId = mCallback.getGroupId(pos - <span class="number">1</span>);<span class="comment">// 前一个 item 的 id</span></div><div class="line">        Log.d(TAG, <span class="string">"pos:"</span> + pos + <span class="string">", "</span> + <span class="string">"groupId:"</span> + groupId + <span class="string">", "</span> + <span class="string">"prevGroupId:"</span> + prevGroupId);</div><div class="line">        <span class="keyword">return</span> !groupId.equals(prevGroupId);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果当前位置是 0，则必然是第一个元素；反之，则比较当前位置的元素及其前一个元素的 id 是否相同，此处，比较的是它们的 title。</p><h3 id="始终保持-RecyclerView-顶部有最上面显示的元素对应的组的-title"><a href="#始终保持-RecyclerView-顶部有最上面显示的元素对应的组的-title" class="headerlink" title="始终保持 RecyclerView 顶部有最上面显示的元素对应的组的 title"></a><strong>始终保持 RecyclerView 顶部有最上面显示的元素对应的组的 title</strong></h3><p>1、重写 onDrawOver 方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDrawOver</span><span class="params">(Canvas c, RecyclerView parent, RecyclerView.State state)</span> </span>&#123;</div><div class="line">    <span class="keyword">super</span>.onDrawOver(c, parent, state);</div><div class="line">    <span class="keyword">int</span> childCount = parent.getChildCount();<span class="comment">// 一屏显示的 item 数量</span></div><div class="line"></div><div class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; childCount; i++) &#123;</div><div class="line">        View view = parent.getChildAt(i);</div><div class="line">        <span class="keyword">int</span> position = parent.getChildAdapterPosition(view);</div><div class="line"></div><div class="line">        String title = mCallback.getGroupTitle(position).toUpperCase();</div><div class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(title)) &#123;</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">int</span> left = parent.getPaddingLeft();<span class="comment">// 悬浮栏左侧绘制的边界</span></div><div class="line">        <span class="keyword">int</span> right = parent.getWidth() - parent.getPaddingRight();<span class="comment">// 悬浮栏右侧绘制的边界</span></div><div class="line"></div><div class="line">        <span class="comment">// 第一个 item 特殊处理</span></div><div class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">// 组内最后一个 item</span></div><div class="line">            <span class="keyword">int</span> viewBottom = view.getBottom();</div><div class="line">            <span class="keyword">if</span> (isLastInGroup(position) &amp;&amp; viewBottom &lt; barTopGap) &#123;</div><div class="line">                c.drawRect(left, viewBottom - barTopGap, right, viewBottom, barPaint);</div><div class="line">                c.drawText(title, left, viewBottom - alignBottom, textPaint);</div><div class="line">            &#125; <span class="keyword">else</span></div><div class="line">            <span class="comment">// 非组内最后一个 item</span></div><div class="line">            &#123;</div><div class="line">                c.drawRect(left, <span class="number">0</span>, right, barTopGap, barPaint);</div><div class="line">                c.drawText(title, left, barTopGap - alignBottom, textPaint);</div><div class="line">            &#125;</div><div class="line">        &#125; <span class="keyword">else</span></div><div class="line">        <span class="comment">// 除了第一个 item</span></div><div class="line">        &#123;</div><div class="line">            <span class="comment">// 组内第一个 item</span></div><div class="line">            <span class="keyword">if</span> (isFirstInGroup(position)) &#123;</div><div class="line">                <span class="keyword">int</span> viewTop = view.getTop();</div><div class="line">                c.drawRect(left, viewTop - barTopGap, right, viewTop, barPaint);</div><div class="line">                c.drawText(title, left, viewTop - alignBottom, textPaint);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>遍历 RecyclerView 上能显示出的所有元素：</p><p>（1）第一个元素</p><p>判断该元素是不是该组的最后一个元素，并且其剩余高度已经小于悬浮栏的高度，对应的状态是：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E7%B2%98%E6%80%A7%E5%A4%B4%E9%83%A8%E7%9A%84%E5%88%97%E8%A1%A85a6a14b2fbfdc162c1000004.jpg" alt=""></p><p>悬浮栏绘制的高度不变，依然是 barTopGap，但是绘制的上下界变了，上界从 RecyclerView 外的区域开始绘制。</p><p>否则，保持在 RecyclerView 的顶部有一高度为 barTopGap 的悬浮栏，对应的状态是：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E7%B2%98%E6%80%A7%E5%A4%B4%E9%83%A8%E7%9A%84%E5%88%97%E8%A1%A85a6a1dcdfbfdc162c1000006.jpg" alt=""></p><p>（2）非第一个元素</p><p>判断该元素是不适该组的第一个元素，对应的状态是：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E7%B2%98%E6%80%A7%E5%A4%B4%E9%83%A8%E7%9A%84%E5%88%97%E8%A1%A85a6a1d2cfbfdc162c1000005.png" alt=""></p><p>显示标题，标题对应的悬浮栏位置在该元素的上方，高度为 barTopGap。</p><p>否则，不需要处理，对应的状态是：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E5%AE%9E%E7%8E%B0%E5%B8%A6%E6%9C%89%E7%B2%98%E6%80%A7%E5%A4%B4%E9%83%A8%E7%9A%84%E5%88%97%E8%A1%A85a6a1e68fbfdc162c1000007.jpg" alt=""></p><p>2、判断当前位置的元素是否为该组的最后一个元素的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isLastInGroup</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</div><div class="line">    String groupId = mCallback.getGroupId(pos);<span class="comment">// 当前这个 item 的 id</span></div><div class="line">    String nextGroupId = mCallback.getGroupId(pos + <span class="number">1</span>);<span class="comment">// 后一个 item 的 id</span></div><div class="line">    Log.d(TAG, <span class="string">"pos:"</span> + pos + <span class="string">", "</span> + <span class="string">"groupId:"</span> + groupId + <span class="string">", "</span> + <span class="string">"nextGroupId:"</span> + nextGroupId);</div><div class="line">    <span class="keyword">return</span> !groupId.equals(nextGroupId);</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a><strong>源码地址</strong></h1><p><a href="https://github.com/weichao66666/StickyNavigationBar" title="https://github.com/weichao66666/StickyNavigationBar" target="_blank" rel="external">StickyNavigationBar</a></p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://blo
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Hybrid App 返回键处理</title>
    <link href="http://www.weichao.io/2018/01/23/Hybrid-App-%E8%BF%94%E5%9B%9E%E9%94%AE%E5%A4%84%E7%90%86/"/>
    <id>http://www.weichao.io/2018/01/23/Hybrid-App-返回键处理/</id>
    <published>2018-01-23T15:44:55.000Z</published>
    <updated>2018-01-30T14:36:08.253Z</updated>
    
    <content type="html"><![CDATA[<h1 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a><strong>逻辑</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/Hybrid-App-%E8%BF%94%E5%9B%9E%E9%94%AE%E5%A4%84%E7%90%86QQ%E6%88%AA%E5%9B%BE20180124000230.png" alt=""></p><p>App启动后显示NormalFragment，在NormalFragment中有一个原生的对话框，通过按返回键会对退出App做二次确认，且默认为不退出，同时NormalFragment中有一个按钮，点击后可以跳转到WebWrapperFragment，在WebWrapperFragment中有一个WebView，WebView中有对话框，通过按返回键会对跳转到NormalFragment做二次确认，且默认为不退出。</p><hr><h1 id="NormalFragment"><a href="#NormalFragment" class="headerlink" title="NormalFragment"></a><strong>NormalFragment</strong></h1><h2 id="布局文件"><a href="#布局文件" class="headerlink" title="布局文件"></a><strong>布局文件</strong></h2><p>仅包含一个表示当前Fragment为NormalFragment的TextView和一个用于点击后跳转的按钮。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/tv_normal_fragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/normal_fragment"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_change2WebWrapperFragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@id/tv_normal_fragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/change2WebWrapperFragment"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="点击按钮跳转到WebWrapperFragment"><a href="#点击按钮跳转到WebWrapperFragment" class="headerlink" title="点击按钮跳转到WebWrapperFragment"></a><strong>点击按钮跳转到WebWrapperFragment</strong></h2><p>在NormalFragment中设置按钮的点击监听。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">mChange2WebWrapperFragmentBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (mMainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">            mMainActivity.change2WebWrapperFragment();</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            Log.e(TAG, <span class="string">"mMainActivity == null"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure><p>在MainActivity中跳转到WebWrapperFragment。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change2WebWrapperFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">    WebWrapperFragment fragment = (WebWrapperFragment) getSupportFragmentManager().findFragmentByTag(<span class="string">"WebWrapperFragment"</span>);</div><div class="line">    <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</div><div class="line">        fragment = WebWrapperFragment.newInstance();</div><div class="line">        FragmentUtil.addFragment(getSupportFragmentManager(), R.id.fragment, mFragment, fragment, <span class="string">"WebWrapperFragment"</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (mFragment != fragment) &#123;</div><div class="line">            FragmentUtil.showFragment(getSupportFragmentManager(), mFragment, fragment);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="WebWrapperFragment"><a href="#WebWrapperFragment" class="headerlink" title="WebWrapperFragment"></a><strong>WebWrapperFragment</strong></h1><h2 id="布局文件-1"><a href="#布局文件-1" class="headerlink" title="布局文件"></a><strong>布局文件</strong></h2><p>仅包含WebView。</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">WebView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/webView"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="加载html文件"><a href="#加载html文件" class="headerlink" title="加载html文件"></a><strong>加载html文件</strong></h2><p>此处以放在assets中的html文件为例。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">WebSettings webSettings = mWebView.getSettings();</div><div class="line"><span class="comment">// 解决在用户调整手机字体大小/用户调整浏览器字体大小后，布局错乱问题。</span></div><div class="line">webSettings.setTextZoom(<span class="number">100</span>);</div><div class="line"><span class="comment">// 设置 Java 可调用 JS 方法</span></div><div class="line">webSettings.setJavaScriptEnabled(<span class="keyword">true</span>);</div><div class="line"><span class="comment">// 打开本地缓存</span></div><div class="line">webSettings.setDomStorageEnabled(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">webSettings.setAppCacheEnabled(<span class="keyword">true</span>);</div><div class="line">webSettings.setCacheMode(WebSettings.LOAD_DEFAULT);</div><div class="line"><span class="comment">// 设置可以访问文件</span></div><div class="line">webSettings.setAllowFileAccess(<span class="keyword">true</span>);</div><div class="line">webSettings.setAllowContentAccess(<span class="keyword">true</span>);</div><div class="line">webSettings.setAllowFileAccessFromFileURLs(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">webSettings.setDatabaseEnabled(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">mWebView.setWebChromeClient(<span class="keyword">new</span> WebChromeClientWithFullLog());</div><div class="line">mWebView.setWebViewClient(<span class="keyword">new</span> WebViewClientWithFullLog());</div><div class="line"><span class="comment">// 设置 JS 可调用 Java 方法</span></div><div class="line">mWebView.addJavascriptInterface(<span class="keyword">new</span> WebWrapperJsInteration(<span class="keyword">this</span>), WebWrapperJsInteration.JAVA_INTERFACE);</div><div class="line"></div><div class="line">mWebView.loadUrl(<span class="string">"file:///android_asset/demo.html"</span>);</div><div class="line"></div><div class="line">mWebView.requestFocus();</div></pre></td></tr></table></figure><h3 id="demo-js"><a href="#demo-js" class="headerlink" title="demo.js"></a><strong>demo.js</strong></h3><p>clickBack为Java调用JS的方法，传入参数为str，当str是”web_wrapper”，会触发id是”web_wrapper_back”的点击事件。<br>back为JS调用Java的方法，传入参数为”web_wrapper”，当该JS文件被html引用时，会触发back方法。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">window</span>.clickBack = <span class="function"><span class="keyword">function</span> (<span class="params">str</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span>(str != <span class="literal">null</span> &amp;&amp; <span class="keyword">typeof</span> str == <span class="string">"string"</span>) &#123;</div><div class="line">        <span class="keyword">if</span>(str == <span class="string">"web_wrapper"</span>) &#123;</div><div class="line">        <span class="built_in">document</span>.getElementById(<span class="string">'web_wrapper_back'</span>).click();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">&#125;;</div><div class="line"><span class="built_in">window</span>.javaInterface.back(<span class="string">"web_wrapper"</span>);</div></pre></td></tr></table></figure><h3 id="demo-html"><a href="#demo-html" class="headerlink" title="demo.html"></a><strong>demo.html</strong></h3><p>仅包含表示当前Fragment为WebWrapperFragment的文字和一个用于点击后跳转的按钮。<br>该html引用了demo.js。<br>按钮的id是”web_wrapper_back”，当点击后会显示对话框，如果点击对话框中的确认会调用Java的exit方法，如果点击对话框中的取消会调用Java的back方法并传入参数”web_wrapper”，按返回键会默认触发取消。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">src</span>=<span class="string">"demo.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="undefined"></span></div><div class="line"><span class="javascript">        <span class="function"><span class="keyword">function</span> <span class="title">exitConfirm</span>(<span class="params"></span>)</span>&#123;</span></div><div class="line"><span class="javascript">            <span class="built_in">window</span>.javaInterface.removeBack(<span class="string">"web_wrapper"</span>);</span></div><div class="line"><span class="javascript">            <span class="keyword">var</span> r = confirm(<span class="string">"是否退出？"</span>);</span></div><div class="line"><span class="javascript">            <span class="keyword">if</span> (r == <span class="literal">true</span>) &#123;</span></div><div class="line"><span class="javascript">    <span class="comment">//          if(window.javaInterface &amp;&amp; window.javaInterface.resetBack)&#123;</span></span></div><div class="line"><span class="javascript">                    <span class="built_in">window</span>.javaInterface.exit();</span></div><div class="line"><span class="javascript">    <span class="comment">//          &#125;</span></span></div><div class="line"><span class="javascript">            &#125; <span class="keyword">else</span> &#123;</span></div><div class="line"><span class="javascript">    <span class="comment">//          if(window.javaInterface &amp;&amp; window.javaInterface.back)&#123;</span></span></div><div class="line"><span class="javascript">                    <span class="built_in">window</span>.javaInterface.back(<span class="string">"web_wrapper"</span>);</span></div><div class="line"><span class="javascript">    <span class="comment">//          &#125;</span></span></div><div class="line"><span class="undefined">            &#125;</span></div><div class="line"><span class="undefined">        &#125;</span></div><div class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></div><div class="line">这是 WebWrapper Fragment 页面<span class="tag">&lt;<span class="name">br</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">id</span>=<span class="string">"web_wrapper_back"</span> <span class="attr">onclick</span>=<span class="string">"exitConfirm()"</span> <span class="attr">value</span>=<span class="string">"后退到 Normal Fragment 页面"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></div></pre></td></tr></table></figure><h3 id="WebWrapperJsInteration-java"><a href="#WebWrapperJsInteration-java" class="headerlink" title="WebWrapperJsInteration.java"></a><strong>WebWrapperJsInteration.java</strong></h3><p>添加Java方法供JS调用。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String JAVA_INTERFACE = <span class="string">"javaInterface"</span>;</div><div class="line"></div><div class="line"><span class="meta">@JavascriptInterface</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">back</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"back("</span> + str + <span class="string">")"</span>);</div><div class="line">    mView.showToast(<span class="string">"back("</span> + str + <span class="string">")"</span>);</div><div class="line">    mView.addBackStack(str);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@JavascriptInterface</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeBack</span><span class="params">(String str)</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"removeBack("</span> + str + <span class="string">")"</span>);</div><div class="line">    mView.showToast(<span class="string">"removeBack("</span> + str + <span class="string">")"</span>);</div><div class="line">    mView.removeBackStack(str);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@JavascriptInterface</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">exit</span><span class="params">()</span> </span>&#123;</div><div class="line">    Log.d(TAG, <span class="string">"exit()"</span>);</div><div class="line">    mView.showToast(<span class="string">"exit()"</span>);</div><div class="line">    mView.onBackPressed();</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="返回键逻辑实现"><a href="#返回键逻辑实现" class="headerlink" title="返回键逻辑实现"></a><strong>返回键逻辑实现</strong></h1><p>重写MainActivity的onBackPressed方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (mFragment <span class="keyword">instanceof</span> NormalFragment) &#123;</div><div class="line">    NormalFragment fragment = (NormalFragment) mFragment;</div><div class="line">    <span class="keyword">if</span> (fragment.isDialogShown()) &#123;</div><div class="line">        finish();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fragment.showDialog();</div><div class="line">    &#125;</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFragment <span class="keyword">instanceof</span> WebWrapperFragment) &#123;</div><div class="line">    WebWrapperFragment fragment = (WebWrapperFragment) mFragment;</div><div class="line">    <span class="keyword">if</span> (fragment.isBackStackEmpty()) &#123;</div><div class="line">        change2NormalFragment();</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        fragment.goBackStack();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="显示NormalFragment的对话框"><a href="#显示NormalFragment的对话框" class="headerlink" title="显示NormalFragment的对话框"></a><strong>显示NormalFragment的对话框</strong></h2><p>当取消时将用于判断对话框是否为显示状态的标志置为false，按返回键会默认触发取消。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">AlertDialog.Builder builder = <span class="keyword">new</span> AlertDialog.Builder(getActivity());</div><div class="line">builder.setMessage(<span class="string">"是否退出？"</span>)</div><div class="line">        .setPositiveButton(<span class="string">"确定"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mMainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                    mMainActivity.onBackPressed();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"mMainActivity == null"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .setNegativeButton(<span class="string">"取消"</span>, <span class="keyword">new</span> DialogInterface.OnClickListener() &#123;</div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(DialogInterface dialog, <span class="keyword">int</span> id)</span> </span>&#123;</div><div class="line">                dialog.cancel();</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .setOnCancelListener(<span class="keyword">new</span> DialogInterface.OnCancelListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCancel</span><span class="params">(DialogInterface dialog)</span> </span>&#123;</div><div class="line">                mDialogShown = <span class="keyword">false</span>;</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .show();</div></pre></td></tr></table></figure><h2 id="WebWrapperFragment中后退栈的维护"><a href="#WebWrapperFragment中后退栈的维护" class="headerlink" title="WebWrapperFragment中后退栈的维护"></a><strong>WebWrapperFragment中后退栈的维护</strong></h2><p>1、WebView加载html时，JS会调用Java的back(“web_wrapper”)，则此时后退栈添加元素”web_wrapper”。</p><p>2、按返回键会先判断后退栈中是否有元素，因为有”web_wrapper”，然后Java会调用JS的clickBack(“web_wrapper”)，clickBack(“web_wrapper”)对应于html中按钮的点击事件，即会弹出对话框，同时JS会调用Java的removeBack(“web_wrapper”)，删除后退栈中的元素”web_wrapper”。</p><p>3、再次点击返回键会直接触发对话框的取消，同时JS会调用Java的back(“web_wrapper”)，则此时后退栈添加元素”web_wrapper”，又回到最初加载时的状态。</p><hr><h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a><strong>源码地址</strong></h1><p><a href="https://github.com/weichao66666/Hybrid_App_Back_Demo" title="https://github.com/weichao66666/Hybrid_App_Back_Demo" target="_blank" rel="external">Hybrid_App_Back_Demo</a></p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;逻辑&quot;&gt;&lt;a href=&quot;#逻辑&quot; class=&quot;headerlink&quot; title=&quot;逻辑&quot;&gt;&lt;/a&gt;&lt;strong&gt;逻辑&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;http://otkw6sse5.bkt.clouddn.com/Hybrid-App
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Fragment 返回键处理</title>
    <link href="http://www.weichao.io/2017/12/31/Fragment-%E8%BF%94%E5%9B%9E%E9%94%AE%E5%A4%84%E7%90%86/"/>
    <id>http://www.weichao.io/2017/12/31/Fragment-返回键处理/</id>
    <published>2017-12-31T05:39:49.000Z</published>
    <updated>2018-01-30T14:07:15.376Z</updated>
    
    <content type="html"><![CDATA[<h1 id="逻辑"><a href="#逻辑" class="headerlink" title="逻辑"></a><strong>逻辑</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/Fragment-%E8%BF%94%E5%9B%9E%E9%94%AE%E5%A4%84%E7%90%861514695944977_2.png" alt=""></p><p>启动后进入 FirstFragment，在 FirstFragment 按返回键退出，可以通过点击按钮显示 SecondFragment、ThirdFragment、FourthFragment：</p><ul><li>进入 SecondFragment 后，按返回键返回 FirstFragment，但是不更新 FirstFragment。</li><li>进入 ThirdFragment 后，按返回键退出，可以通过点击按钮显示 FourthFragment。</li><li>进入 FourthFragment 后，按返回键返回 FirstFragment 或 ThirdFragment（取决于从 FirstFragment 或 ThirdFragment 进入），同时更新 FirstFragment 或 ThirdFragment。</li></ul><hr><h1 id="点击按钮显示不同-Fragment"><a href="#点击按钮显示不同-Fragment" class="headerlink" title="点击按钮显示不同 Fragment"></a><strong>点击按钮显示不同 Fragment</strong></h1><h2 id="布局文件"><a href="#布局文件" class="headerlink" title="布局文件"></a><strong>布局文件</strong></h2><ul><li>fragment_first.xml</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">RelativeLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">"http://schemas.android.com/tools"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></div><div class="line"><span class="tag">    <span class="attr">tools:context</span>=<span class="string">"io.weichao.fragment_demo.activity.MainActivity"</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/tv_time"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_change2SecondFragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@id/tv_time"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/change2SecondFragment"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_change2ThirdFragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@id/btn_change2SecondFragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/change2ThirdFragment"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">Button</span></span></div><div class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/btn_change2FourthFragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:layout_below</span>=<span class="string">"@id/btn_change2ThirdFragment"</span></span></div><div class="line"><span class="tag">        <span class="attr">android:text</span>=<span class="string">"@string/change2FourthFragment"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">RelativeLayout</span>&gt;</span></div></pre></td></tr></table></figure><h2 id="添加点击监听"><a href="#添加点击监听" class="headerlink" title="添加点击监听"></a><strong>添加点击监听</strong></h2><ul><li>FirstFragment.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstFragment</span> <span class="keyword">extends</span> <span class="title">Fragment</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Button mChange2SecondFragmentBtn;</div><div class="line">    <span class="keyword">private</span> Button mChange2ThirdFragmentBtn;</div><div class="line">    <span class="keyword">private</span> Button mChange2FourthFragmentBtn;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> View <span class="title">onCreateView</span><span class="params">(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        RelativeLayout rootView = (RelativeLayout) inflater.inflate(R.layout.fragment_first, <span class="keyword">null</span>);</div><div class="line">        mChange2SecondFragmentBtn = rootView.findViewById(R.id.btn_change2SecondFragment);</div><div class="line">        mChange2ThirdFragmentBtn = rootView.findViewById(R.id.btn_change2ThirdFragment);</div><div class="line">        mChange2FourthFragmentBtn = rootView.findViewById(R.id.btn_change2FourthFragment);</div><div class="line">        <span class="keyword">return</span> rootView;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onActivityCreated</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onActivityCreated(savedInstanceState);</div><div class="line">        mChange2SecondFragmentBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mMainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                    mMainActivity.change2SecondFragment();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"mMainActivity == null"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mChange2ThirdFragmentBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mMainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                    mMainActivity.change2ThirdFragment();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"mMainActivity == null"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">        mChange2FourthFragmentBtn.setOnClickListener(<span class="keyword">new</span> View.OnClickListener() &#123;</div><div class="line">            <span class="meta">@Override</span></div><div class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">                <span class="keyword">if</span> (mMainActivity != <span class="keyword">null</span>) &#123;</div><div class="line">                    mMainActivity.change2FourthFragment();</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                    Log.e(TAG, <span class="string">"mMainActivity == null"</span>);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="添加点击响应"><a href="#添加点击响应" class="headerlink" title="添加点击响应"></a><strong>添加点击响应</strong></h2><ul><li>MainActivity.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">AppCompatActivity</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Fragment mBeforeFragment;</div><div class="line">    <span class="keyword">private</span> Fragment mFragment;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change2FirstFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        FirstFragment fragment = (FirstFragment) getSupportFragmentManager().findFragmentByTag(<span class="string">"FirstFragment"</span>);</div><div class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</div><div class="line">            fragment = FirstFragment.newInstance(<span class="keyword">this</span>);</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            bundle.putString(<span class="string">"time"</span>, DateUtil.getCurrentTime());</div><div class="line">            fragment.setArguments(bundle);</div><div class="line">            FragmentUtil.addFragment(getSupportFragmentManager(), R.id.fragment, mFragment, fragment, <span class="string">"FirstFragment"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mFragment != fragment) &#123;</div><div class="line">                FragmentUtil.showFragment(getSupportFragmentManager(), mFragment, fragment);</div><div class="line">            &#125;</div><div class="line">            fragment.update(DateUtil.getCurrentTime());</div><div class="line">        &#125;</div><div class="line">        mBeforeFragment = <span class="keyword">null</span>;</div><div class="line">        mFragment = fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change2SecondFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        SecondFragment fragment = (SecondFragment) getSupportFragmentManager().findFragmentByTag(<span class="string">"SecondFragment"</span>);</div><div class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</div><div class="line">            fragment = SecondFragment.newInstance(<span class="keyword">this</span>);</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            bundle.putString(<span class="string">"time"</span>, DateUtil.getCurrentTime());</div><div class="line">            fragment.setArguments(bundle);</div><div class="line">            FragmentUtil.addFragment(getSupportFragmentManager(), R.id.fragment, mFragment, fragment, <span class="string">"SecondFragment"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mFragment != fragment) &#123;</div><div class="line">                FragmentUtil.showFragment(getSupportFragmentManager(), mFragment, fragment);</div><div class="line">            &#125;</div><div class="line">            fragment.update(DateUtil.getCurrentTime());</div><div class="line">        &#125;</div><div class="line">        mBeforeFragment = mFragment;</div><div class="line">        mFragment = fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change2ThirdFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        ThirdFragment fragment = (ThirdFragment) getSupportFragmentManager().findFragmentByTag(<span class="string">"ThirdFragment"</span>);</div><div class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</div><div class="line">            fragment = ThirdFragment.newInstance(<span class="keyword">this</span>);</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            bundle.putString(<span class="string">"time"</span>, DateUtil.getCurrentTime());</div><div class="line">            fragment.setArguments(bundle);</div><div class="line">            FragmentUtil.addFragment(getSupportFragmentManager(), R.id.fragment, mFragment, fragment, <span class="string">"ThirdFragment"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mFragment != fragment) &#123;</div><div class="line">                FragmentUtil.showFragment(getSupportFragmentManager(), mFragment, fragment);</div><div class="line">            &#125;</div><div class="line">            fragment.update(DateUtil.getCurrentTime());</div><div class="line">        &#125;</div><div class="line">        mBeforeFragment = <span class="keyword">null</span>;</div><div class="line">        mFragment = fragment;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">change2FourthFragment</span><span class="params">()</span> </span>&#123;</div><div class="line">        FourthFragment fragment = (FourthFragment) getSupportFragmentManager().findFragmentByTag(<span class="string">"FourthFragment"</span>);</div><div class="line">        <span class="keyword">if</span> (fragment == <span class="keyword">null</span>) &#123;</div><div class="line">            fragment = FourthFragment.newInstance(<span class="keyword">this</span>);</div><div class="line">            Bundle bundle = <span class="keyword">new</span> Bundle();</div><div class="line">            bundle.putString(<span class="string">"time"</span>, DateUtil.getCurrentTime());</div><div class="line">            fragment.setArguments(bundle);</div><div class="line">            FragmentUtil.addFragment(getSupportFragmentManager(), R.id.fragment, mFragment, fragment, <span class="string">"FourthFragment"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            <span class="keyword">if</span> (mFragment != fragment) &#123;</div><div class="line">                FragmentUtil.showFragment(getSupportFragmentManager(), mFragment, fragment);</div><div class="line">            &#125;</div><div class="line">            fragment.update(DateUtil.getCurrentTime());</div><div class="line">        &#125;</div><div class="line">        mBeforeFragment = mFragment;</div><div class="line">        mFragment = fragment;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="返回键逻辑实现"><a href="#返回键逻辑实现" class="headerlink" title="返回键逻辑实现"></a><strong>返回键逻辑实现</strong></h1><ul><li>MainActivity.java</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onBackPressed</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mBeforeFragment == <span class="keyword">null</span>) &#123;</div><div class="line">        finish();</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFragment <span class="keyword">instanceof</span> SecondFragment) &#123;</div><div class="line">        FragmentUtil.showFragment(getSupportFragmentManager(), mFragment, mBeforeFragment);</div><div class="line">        mFragment = mBeforeFragment;</div><div class="line">        mBeforeFragment = <span class="keyword">null</span>;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mFragment <span class="keyword">instanceof</span> FourthFragment) &#123;</div><div class="line">        <span class="keyword">if</span> (mBeforeFragment <span class="keyword">instanceof</span> FirstFragment) &#123;</div><div class="line">            change2FirstFragment();</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (mBeforeFragment <span class="keyword">instanceof</span> ThirdFragment) &#123;</div><div class="line">            change2ThirdFragment();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h1 id="源码地址"><a href="#源码地址" class="headerlink" title="源码地址"></a><strong>源码地址</strong></h1><ul><li><a href="https://github.com/weichao66666/Fragment_Demo" title="https://github.com/weichao66666/Fragment_Demo" target="_blank" rel="external">Fragment_Demo</a></li></ul><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;逻辑&quot;&gt;&lt;a href=&quot;#逻辑&quot; class=&quot;headerlink&quot; title=&quot;逻辑&quot;&gt;&lt;/a&gt;&lt;strong&gt;逻辑&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;http://otkw6sse5.bkt.clouddn.com/Fragment-%
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>使用 Service 解耦 Activity</title>
    <link href="http://www.weichao.io/2017/11/15/%E4%BD%BF%E7%94%A8-Service-%E8%A7%A3%E8%80%A6-Activity/"/>
    <id>http://www.weichao.io/2017/11/15/使用-Service-解耦-Activity/</id>
    <published>2017-11-15T13:23:49.000Z</published>
    <updated>2018-01-30T14:36:55.215Z</updated>
    
    <content type="html"><![CDATA[<h1 id="需求"><a href="#需求" class="headerlink" title="需求"></a><strong>需求</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E4%BD%BF%E7%94%A8-Service-%E8%A7%A3%E8%80%A6-Activity_1.png" alt=""></p><h1 id="高耦合-Activity-搞定需求"><a href="#高耦合-Activity-搞定需求" class="headerlink" title="高耦合 Activity 搞定需求"></a><strong>高耦合 Activity 搞定需求</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E4%BD%BF%E7%94%A8-Service-%E8%A7%A3%E8%80%A6-Activity_2.png" alt=""></p><h1 id="解耦-Activity-搞定需求"><a href="#解耦-Activity-搞定需求" class="headerlink" title="解耦 Activity 搞定需求"></a><strong>解耦 Activity 搞定需求</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E4%BD%BF%E7%94%A8-Service-%E8%A7%A3%E8%80%A6-Activity_3.png" alt=""></p><h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a><strong>问题</strong></h2><p>在第一个 Activity（A）中启动第二个 Activity（B）后，未调用 finish()，所以在启动 B 后，A、B 是共存的，B 盖在 A 上面，用户可见的是 B。当用户点击【上传】后，需立刻显示 A，并进行上传，此时有几种选择：</p><p>1、直接杀掉 B，显示 A。该方式上传不能进行。</p><p>2、将图片通过 intent 或内置存储传递，在 A 上传。该方式受 intent 传递大小小于 1 MB 限制，通过内置存储传递写入、再读取的时间损失比较大。</p><p>3、等待上传完成，再杀掉 B。该方式不能立刻显示 A。</p><p>4、直接杀掉 A，在 B 中启动第一个 Activity（A’），等待上传完成，再杀掉 B，上传结果通过 BroadcastReceiver 告诉 A’。该方式可行，但是第一个 Activity 需要再初始化一次，且上传过程不易控（因为上传是在 B，现在切换到 A’ 了，而 A’ 和 B 交互比较麻烦）。</p><p>5、使用 Service。</p><h2 id="使用-Service-解决问题"><a href="#使用-Service-解决问题" class="headerlink" title="使用 Service 解决问题"></a><strong>使用 Service 解决问题</strong></h2><p><img src="http://otkw6sse5.bkt.clouddn.com/%E4%BD%BF%E7%94%A8-Service-%E8%A7%A3%E8%80%A6-Activity_4.png" alt=""></p><p>A 绑定 Service，并设置上传成功和失败的回调，当用户点击【上传】后，B 绑定 Service，将图片通过 Service 上传，并直接关闭 B。</p><p>1、用于上传的 Service（以存到内置存储中为例）</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> <span class="keyword">static</span> String TAG = <span class="string">"MyService"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> MyBinder mMyBinder = <span class="keyword">new</span> MyBinder();</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> mMyBinder;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> MyListener mMyListener;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setListener</span><span class="params">(MyListener myListener)</span> </span>&#123;</div><div class="line">            mMyListener = myListener;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> Bitmap bitmap)</span> </span>&#123;</div><div class="line">            <span class="keyword">if</span> (bitmap != <span class="keyword">null</span>) &#123;</div><div class="line">                <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">                    <span class="meta">@Override</span></div><div class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                        FileOutputStream out = <span class="keyword">null</span>;</div><div class="line">                        <span class="keyword">try</span> &#123;</div><div class="line">                            String filePath = Environment.getExternalStorageDirectory().getAbsolutePath() + File.separator + <span class="string">"temp.jpg"</span>;</div><div class="line">                            File file = <span class="keyword">new</span> File(filePath);</div><div class="line">                            file.createNewFile();</div><div class="line">                            out = <span class="keyword">new</span> FileOutputStream(filePath);</div><div class="line">                            bitmap.compress(Bitmap.CompressFormat.PNG, <span class="number">100</span>, out);</div><div class="line">                            out.flush();</div><div class="line">                            <span class="keyword">if</span> (mMyListener != <span class="keyword">null</span>) &#123;</div><div class="line">                                mMyListener.onSuccess();</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                            <span class="keyword">if</span> (mMyListener != <span class="keyword">null</span>) &#123;</div><div class="line">                                mMyListener.onFailed(e.getMessage());</div><div class="line">                            &#125;</div><div class="line">                        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">                            <span class="keyword">if</span> (out != <span class="keyword">null</span>) &#123;</div><div class="line">                                <span class="keyword">try</span> &#123;</div><div class="line">                                    out.close();</div><div class="line">                                &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">                                    e.printStackTrace();</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;).start();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyListener</span> </span>&#123;</div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(String msg)</span></span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2、A 绑定 Service，并设置上传成功和失败的回调</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceConnection mServiceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">        mMyBinder = (MyService.MyBinder) service;</div><div class="line">        mMyBinder.setListener(MainActivity.<span class="keyword">this</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">        mMyBinder.setListener(<span class="keyword">null</span>);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindService</span><span class="params">()</span> </span>&#123;</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</div><div class="line">    bindService(intent, mServiceConnection, BIND_AUTO_CREATE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unbindService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mServiceConnection != <span class="keyword">null</span>) &#123;</div><div class="line">        unbindService(mServiceConnection);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onSuccess</span><span class="params">()</span> </span>&#123;</div><div class="line">    runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"success!"</span>, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailed</span><span class="params">(<span class="keyword">final</span> String msg)</span> </span>&#123;</div><div class="line">    runOnUiThread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            Toast.makeText(MainActivity.<span class="keyword">this</span>, <span class="string">"failed!"</span> + msg, Toast.LENGTH_SHORT).show();</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>3、当用户点击【上传】后，B 绑定 Service，将图片通过 Service 上传，并直接关闭 B</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> ServiceConnection mServiceConnection;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">bindService</span><span class="params">()</span> </span>&#123;</div><div class="line">    Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, MyService.class);</div><div class="line">    bindService(intent, mServiceConnection, BIND_AUTO_CREATE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unbindService</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (mServiceConnection != <span class="keyword">null</span>) &#123;</div><div class="line">        unbindService(mServiceConnection);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">submit</span><span class="params">(<span class="keyword">final</span> Bitmap bitmap)</span> </span>&#123;</div><div class="line">    mServiceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</div><div class="line">            mMyBinder = (MyService.MyBinder) service;</div><div class="line">            mMyBinder.submit(bitmap);</div><div class="line">            CameraActivity.<span class="keyword">this</span>.finish();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    bindService();</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;需求&quot;&gt;&lt;a href=&quot;#需求&quot; class=&quot;headerlink&quot; title=&quot;需求&quot;&gt;&lt;/a&gt;&lt;strong&gt;需求&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;http://otkw6sse5.bkt.clouddn.com/%E4%BD%BF%
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>相机的分辨率</title>
    <link href="http://www.weichao.io/2017/10/22/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87/"/>
    <id>http://www.weichao.io/2017/10/22/相机的分辨率/</id>
    <published>2017-10-22T13:12:11.000Z</published>
    <updated>2018-01-30T14:42:50.614Z</updated>
    
    <content type="html"><![CDATA[<h1 id="显示区域"><a href="#显示区域" class="headerlink" title="显示区域"></a><strong>显示区域</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87_1.png" alt=""></p><p>如图所示，长、宽同一比例的分辨率显示的区域相同，不同比例对应圆中不同的最大的内接矩形。</p><hr><h1 id="预览分辨率"><a href="#预览分辨率" class="headerlink" title="预览分辨率"></a><strong>预览分辨率</strong></h1><h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a><strong>需求</strong></h2><p>1、全屏预览</p><p>2、预览尽可能没有拉伸</p><p>3、预览尽可能清晰</p><h2 id="全屏预览"><a href="#全屏预览" class="headerlink" title="全屏预览"></a><strong>全屏预览</strong></h2><h3 id="隐藏状态栏、标题栏、虚拟按键栏"><a href="#隐藏状态栏、标题栏、虚拟按键栏" class="headerlink" title="隐藏状态栏、标题栏、虚拟按键栏"></a><strong>隐藏状态栏、标题栏、虚拟按键栏</strong></h3><p>1、在 activity 中加入代码</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt; <span class="number">11</span> &amp;&amp; Build.VERSION.SDK_INT &lt; <span class="number">19</span>) &#123;</div><div class="line">    getWindow().getDecorView().setSystemUiVisibility(View.GONE);</div><div class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">19</span>) &#123;</div><div class="line">    View decorView = getWindow().getDecorView();</div><div class="line">    <span class="keyword">int</span> uiOptions = View.SYSTEM_UI_FLAG_HIDE_NAVIGATION</div><div class="line">            | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY</div><div class="line">            | View.SYSTEM_UI_FLAG_FULLSCREEN;</div><div class="line">    decorView.setSystemUiVisibility(uiOptions);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="获取屏幕分辨率"><a href="#获取屏幕分辨率" class="headerlink" title="获取屏幕分辨率"></a><strong>获取屏幕分辨率</strong></h3><p>1、HardwareInfoUtil 的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DisplayMetrics <span class="title">getRealDisplayMetrics</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line">    DisplayMetrics displayMetrics = <span class="keyword">new</span> DisplayMetrics();</div><div class="line">    WindowManager wm = (WindowManager) context.getSystemService(Context.WINDOW_SERVICE);</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">        Class clazz = Class.forName(<span class="string">"android.view.Display"</span>);</div><div class="line">        Method method = clazz.getMethod(<span class="string">"getRealMetrics"</span>, DisplayMetrics.class);</div><div class="line">        method.invoke(wm.getDefaultDisplay(), displayMetrics);</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        e.printStackTrace();</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> displayMetrics;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2、调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">DisplayMetrics displayMetrics = HardwareInfoUtil.getRealDisplayMetrics(context);</div><div class="line"><span class="keyword">int</span> height = displayMetrics.heightPixels;</div><div class="line"><span class="keyword">int</span> width = displayMetrics.widthPixels;</div><div class="line">Log.i(TAG, <span class="string">"屏幕分辨率:（"</span> + width + <span class="string">","</span> + height + <span class="string">")"</span>);</div></pre></td></tr></table></figure><h2 id="预览尽可能没有拉伸"><a href="#预览尽可能没有拉伸" class="headerlink" title="预览尽可能没有拉伸"></a><strong>预览尽可能没有拉伸</strong></h2><h3 id="获取设备支持的预览分辨率"><a href="#获取设备支持的预览分辨率" class="headerlink" title="获取设备支持的预览分辨率"></a><strong>获取设备支持的预览分辨率</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Camera.Parameters parameters = camera.getParameters();</div><div class="line">List&lt;Camera.Size&gt; rawSupportedSizes = parameters.getSupportedPreviewSizes();</div></pre></td></tr></table></figure><p>如果获取不到设备支持的预览分辨率，则获取默认的预览分辨率，再判断该分辨率是否存在，如果存在，则使用该分辨率作为预览分辨率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (rawSupportedSizes == <span class="keyword">null</span>) &#123;</div><div class="line">    Log.w(TAG, <span class="string">"Device returned no supported preview sizes; using default"</span>);</div><div class="line">    Camera.Size defaultSize = parameters.getPreviewSize();</div><div class="line">    <span class="keyword">if</span> (defaultSize == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Parameters contained no preview size!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Point(defaultSize.width, defaultSize.height);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果能获取到设备支持的预览分辨率，则打印所有预览分辨率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Log.isLoggable(TAG, Log.INFO)) &#123;</div><div class="line">    StringBuilder previewSizesString = <span class="keyword">new</span> StringBuilder();</div><div class="line">    <span class="keyword">for</span> (Camera.Size size : rawSupportedSizes) &#123;</div><div class="line">        previewSizesString.append(size.width).append(<span class="string">'x'</span>).append(size.height).append(<span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line">    Log.i(TAG, <span class="string">"Supported preview sizes: "</span> + previewSizesString);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="选择和屏幕分辨率比例最接近的预览分辨率"><a href="#选择和屏幕分辨率比例最接近的预览分辨率" class="headerlink" title="选择和屏幕分辨率比例最接近的预览分辨率"></a><strong>选择和屏幕分辨率比例最接近的预览分辨率</strong></h3><p>最佳的预览分辨率就是屏幕分辨率，所以先判断设备支持的预览分辨率中是否包含屏幕分辨率，如果包含，则直接使用该分辨率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Camera.Size bestSize = camera.new Size(screenResolution.x, screenResolution.y);</div><div class="line"><span class="keyword">if</span> (rawSupportedSizes.contains(bestSize)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Point(bestSize.width, bestSize.height);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果设备支持的预览分辨率中不包含屏幕分辨率，则需要遍历预览分辨率，计算每个分辨率的长、宽比，选择其中和屏幕分辨率长、宽比最接近的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">bestSize = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">float</span> screenRatio = screenResolution.y * <span class="number">1.0f</span> / screenResolution.x;</div><div class="line"><span class="keyword">float</span> bestRatio = Integer.MAX_VALUE;</div><div class="line"><span class="keyword">for</span> (Camera.Size size : rawSupportedSizes) &#123;</div><div class="line">    <span class="keyword">float</span> aspectRatio = size.height * <span class="number">1.0f</span> / size.width;</div><div class="line">    <span class="keyword">float</span> ratioSub = Math.abs(aspectRatio - screenRatio);</div><div class="line">    <span class="keyword">if</span> (ratioSub &lt; bestRatio) &#123;</div><div class="line">        bestRatio = ratioSub;</div><div class="line">        bestSize = size;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><h2 id="预览尽可能清晰"><a href="#预览尽可能清晰" class="headerlink" title="预览尽可能清晰"></a><strong>预览尽可能清晰</strong></h2><h3 id="选择比屏幕分辨率稍高或接近的预览分辨率"><a href="#选择比屏幕分辨率稍高或接近的预览分辨率" class="headerlink" title="选择比屏幕分辨率稍高或接近的预览分辨率"></a><strong>选择比屏幕分辨率稍高或接近的预览分辨率</strong></h3><p>在上面的基础上添加处理，如果预览分辨率的长、宽比一样，且都是最接近屏幕分辨率的长、宽比时，比较预览分辨率宽距离屏幕宽的差，如果差不一样，选择差小的，如果差一样，选择预览分辨率大的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">bestSize = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">float</span> screenRatio = screenResolution.y * <span class="number">1.0f</span> / screenResolution.x;</div><div class="line"><span class="keyword">float</span> bestRatio = Integer.MAX_VALUE;</div><div class="line"><span class="keyword">for</span> (Camera.Size size : rawSupportedSizes) &#123;</div><div class="line">    <span class="keyword">float</span> aspectRatio = size.height * <span class="number">1.0f</span> / size.width;</div><div class="line">    <span class="keyword">float</span> ratioSub = Math.abs(aspectRatio - screenRatio);</div><div class="line">    <span class="keyword">if</span> (ratioSub &lt; bestRatio) &#123;</div><div class="line">        bestRatio = ratioSub;</div><div class="line">        maxHeight = size.height;</div><div class="line">        bestSize = size;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ratioSub == bestRatio) &#123;</div><div class="line">        <span class="keyword">int</span> sizeHeight2ScreenHeight = Math.abs(size.height - screenResolution.y);</div><div class="line">        <span class="keyword">int</span> maxHeight2ScreenHeight = Math.abs(maxHeight - screenResolution.y);</div><div class="line">        <span class="keyword">if</span> ((sizeHeight2ScreenHeight &lt; maxHeight2ScreenHeight) || (sizeHeight2ScreenHeight == maxHeight2ScreenHeight &amp;&amp; size.height &gt; screenResolution.y)) &#123;</div><div class="line">            maxHeight = size.height;</div><div class="line">            bestSize = size;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr><h1 id="拍照分辨率"><a href="#拍照分辨率" class="headerlink" title="拍照分辨率"></a><strong>拍照分辨率</strong></h1><h2 id="需求-1"><a href="#需求-1" class="headerlink" title="需求"></a><strong>需求</strong></h2><p>1、裁剪图片在预览区域中指定方框中的区域，例如：</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87_2.png" alt=""></p><p>黑框表示全屏预览的区域，红框表示裁剪区域，红框边长为屏幕高度的 2/3，水平、垂直方向均居中。</p><p>2、裁剪区域的图片分辨率为 1080x1080</p><p>3、裁剪区域的图片尽量不失真</p><h2 id="裁剪图片在预览区域中指定方框中的区域"><a href="#裁剪图片在预览区域中指定方框中的区域" class="headerlink" title="裁剪图片在预览区域中指定方框中的区域"></a><strong>裁剪图片在预览区域中指定方框中的区域</strong></h2><h3 id="获取设备支持的拍照分辨率"><a href="#获取设备支持的拍照分辨率" class="headerlink" title="获取设备支持的拍照分辨率"></a><strong>获取设备支持的拍照分辨率</strong></h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Camera.Parameters parameters = camera.getParameters();</div><div class="line">List&lt;Camera.Size&gt; rawSupportedSizes = parameters.getSupportedPictureSizes();</div></pre></td></tr></table></figure><p>如果获取不到设备支持的拍照分辨率，则获取默认的拍照分辨率，再判断该分辨率是否存在，如果存在，则使用该分辨率作为拍照分辨率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (rawSupportedSizes == <span class="keyword">null</span>) &#123;</div><div class="line">    Log.w(TAG, <span class="string">"Device returned no supported picture sizes; using default"</span>);</div><div class="line">    Camera.Size defaultSize = parameters.getPictureSize();</div><div class="line">    <span class="keyword">if</span> (defaultSize == <span class="keyword">null</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Parameters contained no picture size!"</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Point(defaultSize.width, defaultSize.height);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>如果能获取到设备支持的拍照分辨率，则打印所有拍照分辨率。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (Log.isLoggable(TAG, Log.INFO)) &#123;</div><div class="line">    StringBuilder pictureSizesString = <span class="keyword">new</span> StringBuilder();</div><div class="line">    <span class="keyword">for</span> (Camera.Size size : rawSupportedSizes) &#123;</div><div class="line">        pictureSizesString.append(size.width).append(<span class="string">'x'</span>).append(size.height).append(<span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line">    Log.i(TAG, <span class="string">"Supported picture sizes: "</span> + pictureSizesString);</div><div class="line">&#125;</div></pre></td></tr></table></figure><h3 id="裁剪图片在预览区域中指定方框中的区域-1"><a href="#裁剪图片在预览区域中指定方框中的区域-1" class="headerlink" title="裁剪图片在预览区域中指定方框中的区域"></a><strong>裁剪图片在预览区域中指定方框中的区域</strong></h3><h4 id="预览分辨率和拍照分辨率一致"><a href="#预览分辨率和拍照分辨率一致" class="headerlink" title="预览分辨率和拍照分辨率一致"></a><strong>预览分辨率和拍照分辨率一致</strong></h4><p>1、BitmapUtil 的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">createSquareCropBitmap</span><span class="params">(Bitmap bitmap)</span> </span>&#123;</div><div class="line">    <span class="keyword">int</span> width = bitmap.getWidth();</div><div class="line">    <span class="keyword">int</span> height = bitmap.getHeight();</div><div class="line"></div><div class="line">    <span class="keyword">int</span> cropWidthIndex = <span class="number">0</span>, cropHeightIndex = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> cropWidth = width;</div><div class="line">    <span class="keyword">int</span> cropHeight = height;</div><div class="line">    <span class="keyword">if</span> (width == height) &#123;</div><div class="line">        <span class="keyword">return</span> bitmap;</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (width &gt; height) &#123;</div><div class="line">        cropWidthIndex = (width - height) &gt;&gt; <span class="number">1</span>;</div><div class="line">        cropWidth = height;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        cropHeightIndex = (height - width) &gt;&gt; <span class="number">1</span>;</div><div class="line">        cropHeight = width;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> Bitmap.createBitmap(bitmap, cropWidthIndex, cropHeightIndex, cropWidth, cropHeight);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Bitmap <span class="title">createCropBitmap</span><span class="params">(Bitmap bitmap, <span class="keyword">float</span> cropXPercent, <span class="keyword">float</span> cropYPercent)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (cropXPercent &lt; <span class="number">0</span>) &#123;</div><div class="line">        cropXPercent = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (cropYPercent &lt; <span class="number">0</span>) &#123;</div><div class="line">        cropYPercent = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">int</span> width = bitmap.getWidth();</div><div class="line">    <span class="keyword">int</span> height = bitmap.getHeight();</div><div class="line">    <span class="keyword">int</span> cropWidthIndex = (<span class="keyword">int</span>) (width * cropXPercent);</div><div class="line">    <span class="keyword">int</span> cropHeightIndex = (<span class="keyword">int</span>) (height * cropYPercent);</div><div class="line">    <span class="keyword">int</span> cropWidth = width - (cropWidthIndex &lt;&lt; <span class="number">1</span>);</div><div class="line">    <span class="keyword">int</span> cropHeight = height - (cropHeightIndex &lt;&lt; <span class="number">1</span>);</div><div class="line">    <span class="keyword">return</span> Bitmap.createBitmap(bitmap, cropWidthIndex, cropHeightIndex, cropWidth, cropHeight);</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>2、调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Bitmap squareCropBitmap = BitmapUtil.createSquareCropBitmap(bitmap);</div><div class="line">Bitmap cropBitmap = BitmapUtil.createCropBitmap(squareCropBitmap, CameraActivity.RED_LINE_MARGIN, CameraActivity.RED_LINE_MARGIN);</div></pre></td></tr></table></figure><h4 id="预览分辨率和拍照分辨率不一致"><a href="#预览分辨率和拍照分辨率不一致" class="headerlink" title="预览分辨率和拍照分辨率不一致"></a><strong>预览分辨率和拍照分辨率不一致</strong></h4><p>1、获取预览分辨率，比如 previewRatio（在上面设置预览分辨率时保存，且值为宽:长，因为容易整除），拍照分辨率 pictureRatio</p><p>2、获取因拍照分辨率和预览分辨率不一致导致的自动被裁剪/添加的区域，比如预览分辨率是 16:9，拍照分辨率是 4:3</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87_3.png" alt=""></p><p>实际拍出的照片区域和在屏幕中预览的区域不一致，再按照原来的比例在图片中裁剪，裁剪所得的照片并不是预览时方框中显示的区域，垂直方向需要多裁剪 x，水平方向需要少裁剪 y。</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87_4.png" alt=""></p><p>3、x 计算</p><p>为了有助于计算，添加一个辅助矩形，该矩形和预览分辨率有相同长，但比例为 4:3，所以<br>$$lx’ = \frac{16a * pictureRatio}{2}$$<br>，如果不是因为相机传感器是圆形的，实际 x 应该是<br>$$x’ = \frac{16a * pictureRatio - 16a * previewRatio}{2 * 16a * pictureRatio} = \frac{pictureRatio - previewRatio}{2 * pictureRatio}$$</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87_5.png" alt=""></p><p>由于相机传感器是圆形的，所以 lx’ 缩小成 lx，x’ 缩小成 x</p><p><img src="http://otkw6sse5.bkt.clouddn.com/%E7%9B%B8%E6%9C%BA%E7%9A%84%E5%88%86%E8%BE%A8%E7%8E%87_6.png" alt=""></p><p>因为圆，所以<br>$$t1 = t4$$<br>即<br>$$t2^2 + t3^2 = t5^2 + t6^2$$<br>因为<br>$$t2 = t3 * pictureRatio，t5 = t6 * previewRatio$$<br>所以<br>$${(t3 * pictureRatio)}^2 + t3^2 = {(t6 * previewRatio)}^2 + t6^2$$<br>即<br>$${(1 + pictureRatio)}^2 * t3^2 = {(1 + previewRatio)}^2 * t6^2$$<br>即<br>$$\frac{t3}{t6} = \sqrt{\frac{(1 + previewRatio)}{(1 + pictureRatio)}}$$<br>因为三角形相似，所以<br>$$\frac{lx}{lx’} = \frac{t3}{t6} = \sqrt{\frac{(1 + previewRatio)}{(1 + pictureRatio)}}$$<br>则<br>$$x = x’ - \frac{lx’ - lx}{lx’} = x’ - 1 + \frac{lx}{lx’} = \frac{pictureRatio - previewRatio}{2 * pictureRatio} - 1 + \sqrt{\frac{(1 + previewRatio)}{(1 + pictureRatio)}}$$</p><p>4、y 计算</p><p>$$y = \frac{t6 - t3}{t3} = \frac{t6}{t3} - 1 = \frac{1}{\sqrt{\frac{(1 + previewRatio)}{(1 + pictureRatio)}}} - 1$$</p><p>5、BitmapUtil 的方法</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> AutoCropPercent <span class="title">getPreview2PictureAutoCropPercent</span><span class="params">(<span class="keyword">float</span> pictureRatio, <span class="keyword">float</span> previewRatio)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (pictureRatio == previewRatio) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AutoCropPercent(<span class="number">0</span>, <span class="number">0</span>);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">float</span> sqrt = (<span class="keyword">float</span>) (Math.sqrt((<span class="number">1</span> + previewRatio) / (<span class="number">1</span> + pictureRatio)));</div><div class="line">        <span class="keyword">float</span> ap = (pictureRatio - previewRatio) / (<span class="number">2</span> * pictureRatio) - <span class="number">1</span> + sqrt;</div><div class="line">        <span class="keyword">float</span> bp = <span class="number">1.0f</span> / sqrt - <span class="number">1</span>;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> AutoCropPercent(-bp, ap);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure><p>6、调用</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">BitmapUtil.AutoCropPercent autoCropPercent = BitmapUtil.getPreview2PictureAutoCropPercent(aspectRatio, ratio);</div><div class="line">Bitmap cropBitmap = BitmapUtil.createCropBitmap(bitmap, <span class="number">0</span>, CameraActivity.RED_LINE_MARGIN + autoCropPercent.getYp());</div><div class="line">cropBitmap = BitmapUtil.createSquareCropBitmap(cropBitmap);</div></pre></td></tr></table></figure><h2 id="裁剪区域的图片分辨率为-1080x1080"><a href="#裁剪区域的图片分辨率为-1080x1080" class="headerlink" title="裁剪区域的图片分辨率为 1080x1080"></a><strong>裁剪区域的图片分辨率为 1080x1080</strong></h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Bitmap.createScaledBitmap(cropBitmap, CameraActivity.PICTURE_WIDTH, CameraActivity.PICTURE_WIDTH, <span class="keyword">false</span>);</div></pre></td></tr></table></figure><h2 id="裁剪区域的图片尽量不失真"><a href="#裁剪区域的图片尽量不失真" class="headerlink" title="裁剪区域的图片尽量不失真"></a><strong>裁剪区域的图片尽量不失真</strong></h2><p>遍历设备支持的拍照分辨率，获取拍照分辨率相对于预览分辨率由于长、宽比例变化（如果有的话）导致的水平、垂直方向裁剪比例的变化，将该变化计算到图片裁剪后的高度，确保图片宽&gt;=1080（因为长&gt;=宽，所以不用考虑长）。在未找到能获取宽&gt;=1080的分辨率时，保留能获取宽最大的拍照分辨率，已找到能获取宽&gt;=1080的分辨率后，保留规格最小的。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span> minLength = Integer.MAX_VALUE;</div><div class="line"><span class="keyword">int</span> maxY = <span class="number">0</span>;</div><div class="line">bestSize = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">boolean</span> hasLegalBestSize = <span class="keyword">false</span>;</div><div class="line">HashMap&lt;Float, BitmapUtil.AutoCropPercent&gt; autoCropPercentMap = <span class="keyword">new</span> HashMap&lt;&gt;();</div><div class="line">StringBuilder pictureFitPreviewSizesString = <span class="keyword">new</span> StringBuilder();</div><div class="line"><span class="keyword">for</span> (Camera.Size size : rawSupportedSizes) &#123;</div><div class="line">    <span class="keyword">float</span> aspectRatio = size.height * <span class="number">1.0f</span> / size.width;</div><div class="line"></div><div class="line">    BitmapUtil.AutoCropPercent autoCropPercent;</div><div class="line">    <span class="keyword">if</span> (autoCropPercentMap.containsKey(aspectRatio)) &#123;</div><div class="line">        autoCropPercent = autoCropPercentMap.get(aspectRatio);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        autoCropPercent = BitmapUtil.getPreview2PictureAutoCropPercent(aspectRatio, ratio);</div><div class="line">        autoCropPercentMap.put(aspectRatio, autoCropPercent);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">float</span> yMargin = CameraActivity.RED_LINE_MARGIN + autoCropPercent.getYp();</div><div class="line">    <span class="keyword">int</span> y = (<span class="keyword">int</span>) (size.height * (<span class="number">1</span> - <span class="number">2</span> * yMargin) + <span class="number">0.5f</span>);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasLegalBestSize &amp;&amp; y &lt; CameraActivity.PICTURE_WIDTH) &#123;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (!hasLegalBestSize &amp;&amp; y &gt;= CameraActivity.PICTURE_WIDTH) &#123;</div><div class="line">        hasLegalBestSize = <span class="keyword">true</span>;</div><div class="line">        pictureFitPreviewSizesString.append(size.width).append(<span class="string">'x'</span>).append(size.height).append(<span class="string">' '</span>);</div><div class="line">        minLength = size.height * size.width;</div><div class="line">        bestSize = size;</div><div class="line">        mAutoCropPercent = autoCropPercent;</div><div class="line">        <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasLegalBestSize) &#123;</div><div class="line">        pictureFitPreviewSizesString.append(size.width).append(<span class="string">'x'</span>).append(size.height).append(<span class="string">' '</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hasLegalBestSize) &#123;</div><div class="line">        <span class="keyword">int</span> length = size.height * size.width;</div><div class="line">        <span class="keyword">if</span> (length &lt; minLength) &#123;</div><div class="line">            minLength = length;</div><div class="line">            bestSize = size;</div><div class="line">            mAutoCropPercent = autoCropPercent;</div><div class="line">        &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">if</span> (y &gt; maxY) &#123;</div><div class="line">            maxY = y;</div><div class="line">            bestSize = size;</div><div class="line">            mAutoCropPercent = autoCropPercent;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">Log.i(TAG, <span class="string">"Supported picture fit preview sizes: "</span> + pictureFitPreviewSizesString);</div><div class="line"></div><div class="line"><span class="keyword">if</span> (bestSize != <span class="keyword">null</span>) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Point(bestSize.width, bestSize.height);</div><div class="line">&#125;</div></pre></td></tr></table></figure><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;显示区域&quot;&gt;&lt;a href=&quot;#显示区域&quot; class=&quot;headerlink&quot; title=&quot;显示区域&quot;&gt;&lt;/a&gt;&lt;strong&gt;显示区域&lt;/strong&gt;&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;http://otkw6sse5.bkt.clouddn.com/%E
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>编译、运行源码</title>
    <link href="http://www.weichao.io/2017/10/15/%E7%BC%96%E8%AF%91%E3%80%81%E8%BF%90%E8%A1%8C%E6%BA%90%E7%A0%81/"/>
    <id>http://www.weichao.io/2017/10/15/编译、运行源码/</id>
    <published>2017-10-15T06:18:51.000Z</published>
    <updated>2017-10-23T14:21:04.161Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://source.android.com/" title="https://source.android.com/" target="_blank" rel="external">Android Open Source Project</a></li><li><a href="http://blog.csdn.net/gjy211/article/details/53488377" title="http://blog.csdn.net/gjy211/article/details/53488377" target="_blank" rel="external">手动编译 Android 源码</a></li><li><a href="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/" title="https://mirrors.tuna.tsinghua.edu.cn/help/AOSP/" target="_blank" rel="external">Android 镜像使用帮助</a></li></ul><hr><h1 id="软、硬件环境"><a href="#软、硬件环境" class="headerlink" title="软、硬件环境"></a><strong>软、硬件环境</strong></h1><ol><li><p>PC</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/%E7%BC%96%E8%AF%91%E3%80%81%E8%BF%90%E8%A1%8C%E6%BA%90%E7%A0%81_1.png" alt=""></p></li><li><p>手机</p><p> Pixel XL 欧版 32GB 银色</p></li></ol><hr><h1 id="构建编译环境"><a href="#构建编译环境" class="headerlink" title="构建编译环境"></a><strong>构建编译环境</strong></h1><h2 id="安装-Git-并配置用户名、密码"><a href="#安装-Git-并配置用户名、密码" class="headerlink" title="安装 Git 并配置用户名、密码"></a><strong>安装 Git 并配置用户名、密码</strong></h2><p>在命令行运行：</p><pre><code>$ sudo apt-get install git $ git config --global user.email &quot;xx@xx.com&quot;$ git config --global user.name &quot;xx&quot;</code></pre><h2 id="安装-JDK"><a href="#安装-JDK" class="headerlink" title="安装 JDK"></a><strong>安装 JDK</strong></h2><p>在命令行运行：</p><pre><code>$ sudo apt-get update$ sudo apt-get install openjdk-8-jdk</code></pre><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a><strong>安装依赖</strong></h2><p>在命令行运行：</p><pre><code>$ sudo apt-get install libx11-dev:i386 libreadline6-dev:i386 libgl1-mesa-dev g++-multilib $ sudo apt-get install -y git flex bison gperf build-essential libncurses5-dev:i386 $ sudo apt-get install tofrodos python-markdown libxml2-utils xsltproc zlib1g-dev:i386 $ sudo apt-get install dpkg-dev libsdl1.2-dev libesd0-dev$ sudo apt-get install git-core gnupg flex bison gperf build-essential  $ sudo apt-get install zip curl zlib1g-dev gcc-multilib g++-multilib $ sudo apt-get install libc6-dev-i386 $ sudo apt-get install lib32ncurses5-dev x11proto-core-dev libx11-dev $ sudo apt-get install libgl1-mesa-dev libxml2-utils xsltproc unzip m4$ sudo apt-get install lib32z-dev ccache</code></pre><hr><h1 id="下载源码"><a href="#下载源码" class="headerlink" title="下载源码"></a><strong>下载源码</strong></h1><h2 id="安装-Repo-工具"><a href="#安装-Repo-工具" class="headerlink" title="安装 Repo 工具"></a><strong>安装 Repo 工具</strong></h2><blockquote><p>Repo 工具通过调用 Git 命令实现对 AOSP 的管理。</p></blockquote><ol><li><p>确保主目录下有一个 bin/ 目录，并且该目录包含在路径中</p><p> 在命令行运行：</p><pre><code>$ mkdir ~/bin$ PATH=~/bin:$PATH</code></pre></li><li><p>下载 Repo 工具，并确保它可执行</p><p> 在命令行运行：</p><pre><code>$ curl https://storage.googleapis.com/git-repo-downloads/repo &gt; ~/bin/repo$ chmod a+x ~/bin/repo</code></pre></li><li><p>注意！以下 URL 不可用：</p><pre><code>$ curl https://storage-googleapis.lug.ustc.edu.cn/git-repo-downloads/repo &gt; ~/bin/repo</code></pre><p> 否则会报错：</p><pre><code>line 1: html: No such file or directoryline 2: syntax error near unexpected token `&lt;&apos;line 2: `&lt;head&gt;&lt;title&gt;301 Moved Permanently&lt;/title&gt;&lt;/hea&apos;&gt;</code></pre></li><li><p>如果下载失败，原因是未翻墙，可在别处下载好并复制到特定目录中</p><p> 在命令行运行：</p><pre><code>$ cp repo ~/bin</code></pre></li></ol><h2 id="同步源码"><a href="#同步源码" class="headerlink" title="同步源码"></a><strong>同步源码</strong></h2><ol><li><p>下载初始化包</p><p> 在命令行运行：</p><pre><code>$ wget https://mirrors.tuna.tsinghua.edu.cn/aosp-monthly/aosp-latest.tar</code></pre></li><li><p>解压缩下载的 tar 文件</p><p> 在命令行运行：</p><pre><code>$ tar xf aosp-latest.tar</code></pre></li><li><p>进入 aosp 目录</p><p> 在命令行运行：</p><pre><code>$ cd aosp</code></pre></li><li><p>修改 repo 文件</p><p> 在命令行运行：</p><pre><code>$ sudo gedit ~/bin/repo</code></pre><p> 修改<code>REPO_URL = &#39;https://gerrit.googlesource.com/git-repo&#39;</code>为<code>REPO_URL = &#39;https://gerrit-google.tuna.tsinghua.edu.cn/git-repo&#39;</code></p><p> 否则同步源码树时会报错：</p><pre><code>fatal: unable to access &apos;https://gerrit.googlesource.com/git-repo/&apos;: Failed to connect to gerrit.googlesource.com port 443: Connection timed outfatal: unable to access &apos;https://gerrit.googlesource.com/git-repo/&apos;: Failed to connect to gerrit.googlesource.com port 443: Connection timed outerror: Cannot fetch repo</code></pre></li><li><p>查询版本</p><p> 登录<a href="https://source.android.com/source/build-numbers#source-code-tags-and-builds" title="https://source.android.com/source/build-numbers#source-code-tags-and-builds" target="_blank" rel="external">源代码标记和细分版本</a>查看，比如 Pixel XL 最新的是 android-7.1.1_r26。</p></li><li><p>设置获取的源码的版本</p><p> 在命令行运行：</p><pre><code>$ repo init -b android-7.1.1_r26</code></pre></li><li><p>同步源码树</p><p> 在命令行运行：</p><pre><code>$ repo sync</code></pre></li><li><p>同步完成后 aosp 会显示内容</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/%E7%BC%96%E8%AF%91%E3%80%81%E8%BF%90%E8%A1%8C%E6%BA%90%E7%A0%81_2.png" alt=""></p></li></ol><hr><h1 id="编译源码"><a href="#编译源码" class="headerlink" title="编译源码"></a><strong>编译源码</strong></h1><h2 id="设置环境"><a href="#设置环境" class="headerlink" title="设置环境"></a><strong>设置环境</strong></h2><ol><li><p>执行 envsetup.sh 脚本</p><p> 在命令行运行：</p><pre><code>$ source build/envsetup.sh</code></pre></li></ol><h2 id="设置目标"><a href="#设置目标" class="headerlink" title="设置目标"></a><strong>设置目标</strong></h2><ol><li><p>获取目标</p><blockquote><p>目标就是生成的镜像要运行在什么样的设备上。</p><p>登录<a href="https://source.android.com/source/running#selecting-device-build" title="https://source.android.com/source/running#selecting-device-build" target="_blank" rel="external">选择设备编译系统</a>查看，BUILD 为 <code>aosp_x86_64</code> 对应 Intel 平台的模拟器，BUILD 为 <code>aosp_marlin</code> 对应 Pixel XL。</p><p>BUILD 包含 <code>arm</code>，表示系统运行在 arm 架构的处理器上，<code>arm64</code> 表示系统运行在 64 位 arm 架构的处理器上。<code>x86</code> 和 <code>mips</code> 同理。</p><p>BUILDTYPE 是 <code>user</code>，表示编译出的系统镜像是可以用来正式发布到市场的版本，没有 root 权限和 debug 权限。<code>userdebug</code> 表示有 root 权限和 debug 权限。<code>eng</code> 表示系统镜像是开发版，有最大的权限。</p></blockquote><p> 在命令行运行：</p><pre><code>$ lunch</code></pre><p> 会打印出所有目标，通过输入序号可以选择目标：</p><pre><code>You&apos;re building on LinuxLunch menu... pick a combo:     1. aosp_arm-eng     2. aosp_arm64-eng     3. aosp_mips-eng     4. aosp_mips64-eng     5. aosp_x86-eng     6. aosp_x86_64-eng     7. full_fugu-userdebug     8. aosp_fugu-userdebug     9. car_emu_arm64-userdebug     10. car_emu_arm-userdebug     11. car_emu_x86_64-userdebug     12. car_emu_x86-userdebug     13. mini_emulator_arm64-userdebug     14. m_e_arm-userdebug     15. m_e_mips64-eng     16. m_e_mips-userdebug     17. mini_emulator_x86_64-userdebug     18. mini_emulator_x86-userdebug     19. uml-userdebug     20. aosp_dragon-userdebug     21. aosp_dragon-eng     22. aosp_marlin-userdebug     23. aosp_marlin_svelte-userdebug     24. aosp_sailfish-userdebug     25. aosp_angler-userdebug     26. aosp_bullhead-userdebug     27. aosp_bullhead_svelte-userdebug     28. hikey-userdebug     29. hikey960-userdebugWhich would you like? [aosp_arm-eng] 6============================================PLATFORM_VERSION_CODENAME=PPLATFORM_VERSION=PTARGET_PRODUCT=aosp_x86_64TARGET_BUILD_VARIANT=engTARGET_BUILD_TYPE=releaseTARGET_PLATFORM_VERSION=PPR1TARGET_BUILD_APPS=TARGET_ARCH=x86_64TARGET_ARCH_VARIANT=x86_64TARGET_CPU_VARIANT=TARGET_2ND_ARCH=x86TARGET_2ND_ARCH_VARIANT=x86_64TARGET_2ND_CPU_VARIANT=HOST_ARCH=x86_64HOST_2ND_ARCH=x86HOST_OS=linuxHOST_OS_EXTRA=Linux-4.4.0-59-generic-x86_64-Ubuntu-16.04.1-LTSHOST_CROSS_OS=windowsHOST_CROSS_ARCH=x86HOST_CROSS_2ND_ARCH=x86_64HOST_BUILD_TYPE=releaseBUILD_ID=OCOUT_DIR=outAUX_OS_VARIANT_LIST=============================================</code></pre></li><li><p>也可以直接选择目标</p><p> 在命令行运行：</p><pre><code>$ lunch aosp_x86_64-eng</code></pre></li><li><p>设置 8 个线程参与编译，并开始编译</p><p> 在命令行运行：</p><pre><code>$ make -j8</code></pre><p> 当看到<code>#### build completed successfully (01:45:47 (hh:mm:ss)) ####</code>即表示编译成功，括号内为编译共计耗时。</p></li></ol><hr><h1 id="运行"><a href="#运行" class="headerlink" title="运行"></a><strong>运行</strong></h1><h2 id="在模拟器中运行"><a href="#在模拟器中运行" class="headerlink" title="在模拟器中运行"></a><strong>在模拟器中运行</strong></h2><ol><li><p>如果不是刚刚执行过编译，则需要在命令行运行：</p><pre><code>$ source build/envsetup.sh$ lunch aosp_x86_64-eng</code></pre></li><li><p>运行</p><p> 在命令行运行：</p><pre><code>$ emulator -memory 2048 -partition-size 4096</code></pre><p> 运行成功：</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/%E7%BC%96%E8%AF%91%E3%80%81%E8%BF%90%E8%A1%8C%E6%BA%90%E7%A0%81_3.png" alt=""></p></li></ol><h3 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a><strong>配置参数</strong></h3><ol><li><p>增加 system/data 分区大小</p><p> 在命令行运行：</p><pre><code>$ emulator -partition-size 4096</code></pre><p> 否则会报错：</p><pre><code>emulator: WARNING: system partition size adjusted to match image file (2048 MB &gt; 200 MB)emulator: WARNING: data partition size adjusted to match image file (550 MB &gt; 200 MB)</code></pre></li><li><p>增加 RAM 大小</p><p> 在命令行运行：</p><pre><code>$ emulator -memory 2048</code></pre><p> 否则会报错：</p><pre><code>emulator: WARNING: Increasing RAM size to 1GB</code></pre><p> 设置成功：</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/%E7%BC%96%E8%AF%91%E3%80%81%E8%BF%90%E8%A1%8C%E6%BA%90%E7%A0%81_4.png" alt=""></p></li></ol><blockquote><p>模拟器运行所需要的 4 个文件包括：<code>Linux Kernel</code>、<code>system.img</code>、<code>userdate.img</code>、<code>ramdisk.img</code>。</p><p>aosp_arm-eng 使用的是 prebuilds/qemu-kernel/arm/kernel-qemu 目录中的 <code>Linux Kernel</code>，out/target/product/generic 目录中的 <code>system.img</code>、<code>userdate.img</code>、<code>ramdisk.img</code>。</p><p>aosp_arm64-eng 使用的是 prebuilds/qemu-kernel/arm64/kernel-qemu 目录中的 <code>Linux Kernel</code>，out/target/product/generic64 目录中的 <code>system.img</code>、<code>userdate.img</code>、<code>ramdisk.img</code>。</p></blockquote><h2 id="模块编译"><a href="#模块编译" class="headerlink" title="模块编译"></a><strong>模块编译</strong></h2><ol><li><p>编译 Launcher2 模块</p><p> 在命令行运行：</p><pre><code>$ mmm packages/apps/Launcher2/</code></pre><p> 编译生成的 apk 文件位置：</p><pre><code>out/target/product/对应平台的generic文件夹/data/app/LauncherRotationStressTest/LauncherRotationStressTest.apk</code></pre><p> <em>TODO</em></p><ol><li>执行 <code>mmm packages/apps/Launcher2/</code> 应该生成 <code>out/target/product/gereric/system/app/Launcher2.apk</code>，但是实际生成的是 <code>out/target/product/generic_x86_64/data/app/LauncherRotationStressTest/LauncherRotationStressTest.apk</code>，经查询，该文件对应的是 Launcher3。</li></ol></li><li><p>编译 Launcher3 模块</p><p> 在命令行运行：</p><pre><code>$ mma packages/apps/Launcher3/</code></pre><p> 不能使用 <code>mmm packages/apps/Launcher3/</code>，否则会报错：</p><pre><code>ninja: error: &apos;out/host/linux-x86/framework/host-libprotobuf-java-nano.jar&apos;, needed by &apos;out/host/common/obj/JAVA_LIBRARIES/launcher_proto_lib_intermediates/classes-full-debug.jar&apos;, missing and no known rule to make itbuild/core/ninja.mk:148: recipe for target &apos;ninja_wrapper&apos; failed</code></pre><p> <em>TODO</em></p><ol><li>找不到 apk 文件。</li></ol></li><li><p>安装 apk 文件</p><p> 在命令行运行（比如 64 位 Intel 平台）：</p><pre><code>adb install out/target/product/generic_x86_64/data/app/LauncherRotationStressTest/LauncherRotationStressTest.apk</code></pre></li><li><p>重新打包 apk 文件到系统镜像中</p><p> 在命令行运行：</p><pre><code>make snod</code></pre></li></ol><blockquote><p>系统自带应用的 apk 文件的位置: out/target/product/对应平台的generic文件夹/system/app</p><p>可执行文件的位置: out/target/product/对应平台的generic文件夹/system/bin</p><p>动态链接库文件的位置: out/target/product/对应平台的generic文件夹/system/lib</p><p>硬件抽象层文件的位置: out/target/product/对应平台的generic文件夹/system/lib/hw</p></blockquote><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://so
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Pixel XL 刷机</title>
    <link href="http://www.weichao.io/2017/10/11/Pixel-XL-%E5%88%B7%E6%9C%BA/"/>
    <id>http://www.weichao.io/2017/10/11/Pixel-XL-刷机/</id>
    <published>2017-10-11T12:49:25.000Z</published>
    <updated>2017-10-23T14:21:04.157Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://sspai.com/post/38319" title="https://sspai.com/post/38319" target="_blank" rel="external">从 Bootloader 解锁到必备应用推荐：我的 Google Pixel 折腾手记</a></li></ul><hr><h1 id="手动刷入工厂镜像"><a href="#手动刷入工厂镜像" class="headerlink" title="手动刷入工厂镜像"></a><strong>手动刷入工厂镜像</strong></h1><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a><strong>操作步骤</strong></h2><h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a><strong>下载文件</strong></h3><ol><li><p>从<a href="https://developers.google.cn/android/images" title="https://developers.google.cn/android/images" target="_blank" rel="external">工厂镜像官网</a>下载对应版本的 zip 文件</p><p><img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E5%88%B7%E6%9C%BA_1.png" alt=""></p></li></ol><h3 id="刷机"><a href="#刷机" class="headerlink" title="刷机"></a><strong>刷机</strong></h3><ol><li><p>解压 zip 文件</p><p> 比如将 zip 文件解压到 f 盘根目录。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E5%88%B7%E6%9C%BA_2.png" alt=""></p></li><li><p>修改文件，用于刷机时保留系统数据</p><p> 使用文本编辑器修改 <code>flash-all.bat</code> 中的 <code>fastboot -w update image-marlin-opr3.170623.008.zip</code> 为 <code>fastboot update image-marlin-opr3.170623.008.zip</code>，即去掉 <code>-w</code>。</p></li><li><p>通过 USB 线连接手机和 PC</p></li><li><p>让手机进入 fastboot 模式</p><p> 在命令行中执行<code>adb reboot bootloader</code>。</p></li><li><p>进入 <code>flash-all.bat</code> 所在目录</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E5%88%B7%E6%9C%BA_3.png" alt=""></p></li><li><p>执行 <code>flash-all.bat</code>，等待刷机完成</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E5%88%B7%E6%9C%BA_4.png" alt=""></p><p> 重启后进入<code>设置</code>-&gt;<code>系统</code>可以看到系统版本。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E5%88%B7%E6%9C%BA_5.png" alt=""></p></li></ol><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://ss
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>Pixel XL 解锁</title>
    <link href="http://www.weichao.io/2017/10/10/Pixel-XL-%E8%A7%A3%E9%94%81/"/>
    <id>http://www.weichao.io/2017/10/10/Pixel-XL-解锁/</id>
    <published>2017-10-10T13:03:07.000Z</published>
    <updated>2017-10-23T14:21:04.158Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a><strong>Reference</strong></h1><ul><li><a href="https://sspai.com/post/38319" title="https://sspai.com/post/38319" target="_blank" rel="external">从 Bootloader 解锁到必备应用推荐：我的 Google Pixel 折腾手记</a></li></ul><hr><h1 id="Pixel-XL"><a href="#Pixel-XL" class="headerlink" title="Pixel XL"></a><strong>Pixel XL</strong></h1><p><img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_1.jpg" alt=""></p><hr><h1 id="解锁-BootLoader"><a href="#解锁-BootLoader" class="headerlink" title="解锁 BootLoader"></a><strong>解锁 BootLoader</strong></h1><h2 id="必要性"><a href="#必要性" class="headerlink" title="必要性"></a><strong>必要性</strong></h2><ul><li>只有解锁了 BootLoader，才能安装第三方的 Recovery。</li></ul><h2 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a><strong>操作步骤</strong></h2><h3 id="让手机具备翻墙能力"><a href="#让手机具备翻墙能力" class="headerlink" title="让手机具备翻墙能力"></a><strong>让手机具备翻墙能力</strong></h3><ol><li><p>用 PC 下载 SS 的 Android 版 App</p></li><li><p>安装 App</p><p> Pixel XL 默认没有安装<code>文件管理器</code>等类似的 App，所以不能通过将 apk 文件导入内部存储空间后再使用<code>文件管理器</code>安装的方式进行安装。</p><p> 可将 apk 文件（比如 ss.apk）放到某个位置（比如 d 盘根目录）下，通过在命令行中执行<code>adb install d:/ss.apk</code>的方式进行安装。</p></li><li><p>安装好 App 后，打开并配置服务器，连接网络</p><p> 配置完成后状态栏会出现一个钥匙的标志。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_2.png" alt=""></p></li></ol><h3 id="解锁-OEM"><a href="#解锁-OEM" class="headerlink" title="解锁 OEM"></a><strong>解锁 OEM</strong></h3><ol><li><p>打开<code>开发者选项</code></p><p> <code>设置</code>-&gt;<code>关于手机</code>，连续多次点击<code>版本号</code>。</p></li><li><p>点击<code>OEM 解锁</code>（必须已联网，必须设定了图形锁或密码锁）</p></li></ol><h3 id="解锁-BootLoader-1"><a href="#解锁-BootLoader-1" class="headerlink" title="解锁 BootLoader"></a><strong>解锁 BootLoader</strong></h3><ol><li><p>通过 USB 线连接手机和 PC</p><p> 如果没弹出调试许可，在命令行中执行<code>adb shell</code>。</p></li><li><p>让手机进入 fastboot 模式</p><p> 在命令行中执行<code>adb reboot bootloader</code>。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_3.jpg" alt=""></p></li><li><p>进入 BootLoader 解锁界面</p><p> 在命令行中执行<code>fastboot oem unlock</code>。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_4.jpg" alt=""></p></li><li><p>解锁</p><p> 使用音量键控制选择<code>Yes</code>，使用电源键确定。</p><p> 解锁完成后，最后一行是<code>Device is UNLOCKED</code>。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_5.jpg" alt=""></p></li></ol><hr><h1 id="刷第三方-Recovery——TWRP"><a href="#刷第三方-Recovery——TWRP" class="headerlink" title="刷第三方 Recovery——TWRP"></a><strong>刷第三方 Recovery——TWRP</strong></h1><h2 id="操作步骤-1"><a href="#操作步骤-1" class="headerlink" title="操作步骤"></a><strong>操作步骤</strong></h2><h3 id="下载文件"><a href="#下载文件" class="headerlink" title="下载文件"></a><strong>下载文件</strong></h3><ol><li>在 <a href="https://twrp.me/" title="https://twrp.me/" target="_blank" rel="external">TWRP 官网</a>中找到 <a href="https://eu.dl.twrp.me/marlin/" title="https://eu.dl.twrp.me/marlin/" target="_blank" rel="external">TWRP for marlin</a>，下载最新版的 zip 文件和 img 文件。</li></ol><h3 id="刷-TWRP"><a href="#刷-TWRP" class="headerlink" title="刷 TWRP"></a><strong>刷 TWRP</strong></h3><ol><li><p>将 zip 文件放入手机的内部存储空间中</p></li><li><p>让手机进入 fastboot 模式</p><p> 在命令行中执行<code>adb reboot bootloader</code>。</p></li><li><p>进入临时 TWRP</p><p> 可将 img 文件（比如 twrp-3.1.1-1-fastboot-marlin.img）放到某个位置（比如 d 盘根目录）下，在命令行中执行<code>fastboot boot d:/twrp-3.1.1-1-fastboot-marlin.img</code>，等待重启。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_6.jpg" alt=""></p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_7.jpg" alt=""></p></li><li><p>刷 TWRP</p><p> 选择<code>Install</code>，选择内部存储空间中的 zip 文件并刷入。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_8.jpg" alt=""></p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_9.jpg" alt=""></p></li></ol><hr><h1 id="获取-ROOT-权限"><a href="#获取-ROOT-权限" class="headerlink" title="获取 ROOT 权限"></a><strong>获取 ROOT 权限</strong></h1><h2 id="操作步骤-2"><a href="#操作步骤-2" class="headerlink" title="操作步骤"></a><strong>操作步骤</strong></h2><h3 id="下载文件-1"><a href="#下载文件-1" class="headerlink" title="下载文件"></a><strong>下载文件</strong></h3><ol><li>在 <a href="http://www.supersu.com/" title="http://www.supersu.com/" target="_blank" rel="external">SuperSU 官网</a>的 <a href="http://www.supersu.com/download" title="http://www.supersu.com/download" target="_blank" rel="external">Download</a> 中下载最新版的 zip 文件。</li></ol><h3 id="刷-SuperSU"><a href="#刷-SuperSU" class="headerlink" title="刷 SuperSU"></a><strong>刷 SuperSU</strong></h3><ol><li><p>将 zip 文件放入手机的内部存储空间中</p></li><li><p>让手机进入 TWRP 模式</p><p> 在命令行中执行<code>adb reboot bootloader</code>，等待重启。</p><p> 使用音量键控制选择<code>Recovery Mode</code>。</p></li><li><p>刷 SuperSU</p><p> 选择内部存储空间中的 zip 文件并刷入。</p><p> <img src="http://otkw6sse5.bkt.clouddn.com/Pixel-XL-%E8%A7%A3%E9%94%81_10.jpg" alt=""></p></li></ol><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Reference&quot;&gt;&lt;a href=&quot;#Reference&quot; class=&quot;headerlink&quot; title=&quot;Reference&quot;&gt;&lt;/a&gt;&lt;strong&gt;Reference&lt;/strong&gt;&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://ss
      
    
    </summary>
    
    
  </entry>
  
</feed>
